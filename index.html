<!-- index_AK_JM_065_abundanceIso.html - An Escher map with metabolite structures.
The MIT License (MIT)
This software is Copyright Â© 2015 The Regents of the University of
California. All Rights Reserved.
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
-->


<!-- //AK:  To follow the script linearly I would start by looking at line 2316-->
<!DOCTYPE html>
<html>
  <title>Escher Structures</title>
  <!-- Bootstrap dependencies for the menu and buttons -->

    
 
<!-- JS -->  
 <!--   <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>    
    <script src="long-press-event.js"></script>-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script> <!-- jquery --> 
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script> <!-- escher --> 
    <script src="https://unpkg.com/mathjs@5.1.1/dist/math.min.js"></script><!-- Math --> 
    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script><!-- DataTables -->     
    <script src="https://d3js.org/d3.v4.min.js"></script><!-- d3 -->     
    <script src="escher.js" charset="utf-8"></script><!-- escher --> 
    <script src="d3.contextMenu5.js"></script><!-- context menu --> 
    <!--<script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>-->
   <!-- <script src="html5sortable.js"></script>  sortable --> 
    <script src="FileSaver_ed1.js"></script> <!-- FileSaver --> 
    <script src="saveSvgAsPng.js"></script> <!-- saveSVGAsPng -->
    <script src="jscolor.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/jszip-2.5.0/dt-1.10.18/b-1.5.6/b-flash-1.5.6/b-html5-1.5.6/fc-3.2.5/datatables.min.js"></script> 

<script src="Sortable.js"></script> <!-- sortable -->         
<script src="https://cdn.jsdelivr.net/npm/jquery-sortablejs@latest/jquery-sortable.js"></script>
    

 
   <!-- <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>-->

<!-- CSS -->      
  <script src="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css"></script><!-- DataTables -->         
  <link rel="stylesheet" type="text/css" href="mycss.css"><!-- DataTables -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/><!--  escher --> 
  <link rel="stylesheet" href="builder.css"/><!--  escher --> 
  <link rel="stylesheet" href="d3.contextMenu3.css" /><!-- context menu --> 
  <link rel="stylesheet" href="basscss.css"><!-- Used for buttons + paragraphs -->
  <link rel="stylesheet" href="loading_screen.css"><!-- Used for buttons + paragraphs -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/jszip-2.5.0/dt-1.10.18/b-1.5.6/b-flash-1.5.6/b-html5-1.5.6/fc-3.2.5/datatables.min.css"/>    
    
  <style>


      
  .titlelabel{
      fill: black;
      font-weight: bold;
      font-family: sans-serif; 
  }
  .titlelabel:hover { 
      fill: red;
      cursor: text;
}      
  .legendlabel{
      fill: black;
      font-weight: normal;
      font-family: sans-serif;       
    }
  .y_axis_label{
      fill: black;
      font-weight: bold;
      font-family: sans-serif;       
   }
  .y_axis_label:hover { 
      fill: red;
      cursor: text;
}
  .x_axis_tick:hover { 
      fill: red;
      cursor: text;
}      
   #structures-buttons {
     position: absolute;
     bottom: 5px;
     right: 5px;
   }
    div#popupContact {
        position:absolute;
        left:50%;    
        transform: translate(-50%, 10px);       
        background-color:#fff;      
        opacity:1;
        border-radius: 8px;
        border: 4px solid #337ab7;
        /*max-height:95%*/
        }

    div#popupContact_slider {
        position:absolute;
        left:50%;
        width: 200px;
        transform: translate(-50%, 50%);       
        background-color:#fff;
        }       
    .PopUp {
        width:100%;
        height:100%;
        top:0;
        left:0;
        display:none;
        position:fixed;
        background-color: rgba(49,49,49,0.95);
        overflow:auto
        } 
      
    .PopUp_slider {
        width:250px;
        height:200px;
        opacity:.95;
        top:25%;
        left:50%;
        display:none;
        position:fixed;
        background-color:#337ab7;
        overflow:auto
        }
      
      .PopUp_descriptive_paragraph{
          font-size: medium;
          overflow:hidden;
          overflow-y:auto;
          /*max-height: 350px;
          margin-top: 1rem;*/
          padding: 1rem;
      }
      
      .PopUp_title{
          font-size: x-large;
          font-weight: bold;
          overflow:hidden;
          text-align: center;
          padding-left: 1rem;
          padding-right: 1rem;          
      }
      
    .submit_button {
        text-decoration:none;
        width:100%;
        text-align:center;
        display:block;
        background-color:#337ab7;
        color:#fff;
        border:5px solid #FFFFFF;
        padding:10px 0;
        font-size:20px;
        cursor:pointer;
        border-radius:10px
        }
    .submit_file_button {
        line-height: 1.5rem;
        text-decoration:none;
        width:55%;
        text-align:center;
        display:block;
        background-color:#337ab7;
        color:#fff;
        border:1px solid #337ab7;
        padding:8px 0;
        font-size:15px;
        cursor:pointer;
        border-radius:5px;
        margin: auto;   
        margin-top: 1rem;
        }      
    img.close_popup {
        position:absolute;
        right:-30px;
        top: -30px;
        width:30px;
        height:30px;
        cursor:pointer
        }
    .close_popup_span{
        position:absolute;
        right:-30px;
        top: -30px;
        width:30px;
        height:30px;
        cursor:pointer;
        font-size: small
        }

    .table_title{
        font-size: small;
        text-align: center;
    } 
      
    .table_element{
        font-size: small;
        text-align: center;
        font-family: Arial, Helvetica, sans-serif;
    }
    
   td{
        text-align: center;
   } 
      
   table.dataTable tbody th, table.dataTable tbody td{
        padding: 4px 10px;
   }
      
   th{
        text-align: center;
   }       
      
    .data_display_Table_column{
          width: 40px;
    }
    .group_list{
        display:inline-block;
        border:1px solid #000;
        word-break:  break-word;
        /*padding:20px*/
      }
    .sortable_list_item{
        border-radius: 5px;
        position: relative;
        z-index: 10;
        font-size: medium;
        background-color: #F5AA5F;
        word-wrap: break-word;
        cursor: move;        
     }
      
    .sortable-ghost{
        margin-bottom: .5rem;
        background-color: #001f3f;
          border-style: solid;
          border-width: 1px;
          border-color: rgba(0,0,0,.125); 
          border-color: #ffdc00;
      }        
      
      
    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 10px;
      border-radius: 5px;   
      background: #d3d3d3;
      outline: none;
      opacity: 0.7;
      -webkit-transition: .2s;
      transition: opacity .2s;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 25px;
      height: 25px;
      border-radius: 50%; 
      background: #C7C7C7;
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: #C7C7C7;
      cursor: pointer;
    }
      
    /*.context_button[title] {
      content: "click for additional options";
     }*/
      
    /*MENU STUFF WITH WACK STUFF
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
    body {
        font-family: "Lato", sans-serif;
    }*/
   /*   .sidenav_title{
        height: relative;
        width: 200px;
        position: fixed;
        z-index: 0;
        top: 9%;
     
          
          
        font-size: large;
        color: blue;
        text-align: center;
        font-weight: bold;
        text-decoration: underline;
      }   */
            
      .sidenav_title{
        height: relative;
        width: 200px;
        position: absolute;
        z-index: 0;
        top: -25px;
        font-style: italic;
        font-size: large;
        color: #337ab7;
        text-align: center;
        font-weight: bold;
       /* position: relative;
        top: -20px;*/
        text-decoration: underline;
      }
      
      .sidenav_menu{
        background-color: #FEFEFE;
        padding-top: 5px;
        border-style: solid;
        border-color: lightgray;
        border-width: 1px; 
        overflow-x: hidden;
          
      }

      
    /* Fixed sidenav, full height */
    .sidenav {
        height: relative;
        width: 200px;
        position: fixed;
        z-index: 0;
        top: 15%;
    }
    /*  
    .sidenav {
        height: relative;
        width: 200px;
        position: fixed;
        z-index: 0;
        top: 10%;
        background-color: #FEFEFE;
        overflow-x: hidden;
        padding-top: 5px;
        border-style: solid;
        border-color: lightgray;
        border-width: 1px;
    }*/
      

    /* Style the sidenav links and the dropdown button */
    .sidenav a, .dropdown-btn {
        padding: 6px 8px 6px 16px;
        text-decoration: none;
        font-size: 14px;
        color: #337ab7;
        display: block;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
        outline: none;
    }


    .dropdown-data {
        padding: 6px 8px 6px 16px;
        text-decoration: none;
        font-size: 12px;
        color: #337ab7;
        display: block;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
        outline: none;
        bottom: 100px;
    }

    /* On mouse-over */
    .sidenav a:hover, .dropdown-btn:hover, .dropdown-data:hover {
        color: #337ab7;
        text-decoration: underline;
        background-color: #F0F0F0;
    }

    /* Main content */
    .main {
        margin-left: 200px; /* Same as the width of the sidenav */
        font-size: 18px; /* Increased text to enable scrolling */
        padding: 0px 10px;
    }

    /* Add an active class to the active dropdown button */
    .active {
        background-color: transparent;
        color: #337ab7;
    }

    /* Dropdown container (hidden by default). Optional: add a lighter background color and some left padding to change the design of the dropdown content */
    .dropdown-container {
        display: none;
        background-color: transparent;
        padding-left: 8px;
        bottom: 100%;
    }


    /* Optional: Style the caret down icon */
    .fa-caret-right {
        float: right;
        padding-right: 8px;
    }
    .active .fa-caret-right {
            padding-right: 8px;
            transform: translate(0,6px) rotate(90deg);
        }
    
    .active_context_1st .fa-caret-right {
            padding-right: 8px;
            transform: translate(0,6px) rotate(90deg);
        } 
      
    .fa-caret-square-o-right {
        float: right;
        padding-right: 8px;
    }      
      
    .active_context_2nd .fa-caret-square-o-right {
            padding-right: 8px;
            transform: translate(0,6px) rotate(90deg);
        }        
      
    .context_button:hover {
        fill: rgb(224, 134, 91);
        font-weight: 600;
        
            /*float: right;        
            padding-right: 8px;*/
        }
    .active_context_button {
           /* padding-right: 8px;
            transform: translate(0,6px) rotate(90deg);*/
            transform: translate(-100px,-35px) rotate(90deg);
        }      
    /* Some media queries for responsiveness */
    @media screen and (max-height: 450px) {
        .sidenav {padding-top: 15px;}
        .sidenav a {font-size: 18px;}
    }
      
    .selected {
      background-color: #f9c7c8 !important;
      border: solid red 1px !important;
      z-index: 1 !important;
    }        
      

        
  
    /*End CSS For MENU STUFF      

      
  </style>

  <link rel="shortcut icon" href="https://escher.github.io/escher/resources/favicon.ico" />

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, height=device-height,
                                 initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"/>
  <body>
      
    <div id="map_container"></div>
    <div id="loading-background" class="lds-background" style="display:none;">
        <div class="lds-loading-text">Loading...</div>
        <div id="loading-dots" class="lds-grid"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>      
    </div>    

      
    <div id="structures-buttons">
    
    <!--<button id="13C_circles" class="submit_button" style="display:block;">13C Circles</button>-->

    <button id="enter_data" class="submit_button" style="display:block;">Import Tracing Data</button>
       
 <!--       
    <input type="file" id="selectFiles" value="Import" style="display:block;" /> 
    <button id="import" style="display:block;">Import JSON Data File</button>
        
    <input type="file" id="selectFiles_csv" value="Import" style="display:block;" /> 
    <button id="import_csv" style="display:block;">Import CSV Data File</button>    
 -->
        
      <a href="https://escher.github.io/" class="btn btn-default btn-md">
        Escher home
      </a>
      <a href="https://github.com/escher/escher-demo" class="btn btn-default btn-md">
        View the code
      </a>

<!--END AK Button div's  --> 
        
        <!--Jack's Menu HTML -->
        <!--Figure out how to flip caret upside down when clicked and flip back after -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">        

   <!-- <div id="menu_holder">
    <span class="sidenav_title">Escher Trace Menu</span>   
    <div class="sidenav" id="sidenav" style="display:none;">-->
        
    <div class="sidenav" id="sidenav" style="display:none;">
    <span class="sidenav_title">Escher Trace Menu</span>   
    <div class="sidenav_menu">        
        <a id="exportJSON" class="dropdown-btn">Save Workspace<i class="icon-download" ></i></a>  
        
        
    <button class="dropdown-btn">Graph Type<i class="fa fa-caret-right"></i>
      </button>
          <div class = "dropdown-container">
              <button id ="MID_button" class = "dropdown-data">MID</button>
              <button id = "Stacked_MID_button" class = "dropdown-data">Stacked MID</button>
              <button id = "Abundance_button" class = "dropdown-data">Abundance</button>
              <button id = "Stacked_Abundance_button" class = "dropdown-data">Stacked Abundance</button>
              <button id = "Total_Abundance_button" class = "dropdown-data">Total Abundance</button>
              <button id = "MPE_button" class = "dropdown-data">MPE</button>
              <button id = "Kin_abundance_button" class = "dropdown-data" style="display:none">Kinetic Abundance</button>
              <button id = "Kin_MPE_button" class = "dropdown-data" style="display:none">Kinetic MPE</button>
        </div>

      <button class="dropdown-btn">Graph Attributes<i class="fa fa-caret-right"></i></button>
        <div class="dropdown-container">
          <button class="dropdown-data" id = "Total_Size_slide_graphs_button">Size</button>
          <button id = "color_picker_button" class = "dropdown-data">Color Scheme</button>
          <button id = "label_switch" class = "dropdown-data">Remove Bar Labels</button>
          <button id = "legend_metrics" class = "dropdown-data">Remove Legend Metrics</button>
            
         <!-- <button class="dropdown-data" id = "Height_slide_graphs_button">Height</button>
          <button class="dropdown-data" id = "Width_slide_graphs_button">Width</button>-->
          <!--<div class = "dropdown-container">
              <button id = "Bigger_graphs_button" class = "dropdown-data" >Bigger</button>
              <button id = "Smaller_graphs_button" class = "dropdown-data">Smaller</button>
              <button id = "Size_slide_graphs_button" class = "dropdown-data">Slider</button>
          </div>-->
          <!--<button class="dropdown-btn">Change Colors<i class ="fa fa-caret-right"></i></button>
          <div class = "dropdown-container">
              <button id = "color_picker_button" class = "dropdown-data">Color Scheme</button>
              <button id = "Colors_button" class = "dropdown-data">All</button>
              <button id = "Iso_Colors_button" class = "dropdown-data">Only Isotopologues</button>
              <button id = "Condition_Colors_button" class = "dropdown-data">Only Conditions</button>
          </div> -->           
        </div>

    <button class="dropdown-btn">Data Displayed<i class="fa fa-caret-right"></i></button>
    <div class="dropdown-container">
        <button id = "metabolite_display_button" class = "dropdown-data" >Metabolites to Display</button>
        <button id = "isotopologue_display_button" class = "dropdown-data">Isotopologues to Display</button>
        <button id = "13C_circles" class = "dropdown-data">Create Carbon Diagram</button>
        <!--<button id = "quant_standard_display_button" class = "dropdown-data">Quantitative Standards</button>-->
    </div>
    
    <button class="dropdown-btn">Analysis<i class="fa fa-caret-right"></i></button>
    <div class="dropdown-container">
        <button id = "custom_graph_button" class = "dropdown-data">Compare Metabolites</button>
        <button id = "CellNumber_button" class = "dropdown-data">Normalize Abundances</button>
        <button id = "Timecourse_button" class = "dropdown-data">Enter Time Points</button>
        <button id = "quant_standard_display_button" class = "dropdown-data">Enter Quantitative Standards</button>
        
    </div>          
        
    <button class="dropdown-btn">Edit Data<i class="fa fa-caret-right"></i></button>
    <div class="dropdown-container">
        <button id = "group_order_button" class = "dropdown-data">Reorder Conditions</button>
        <button id = "file_order_button" class = "dropdown-data">Reorder Files</button>
        <button id = "ConditionName_button" class = "dropdown-data">Edit Condition Names</button>

    </div>
    
    </div>
    </div>
    <!--End Jack Menu HTML -->  
        
    <!-- Slider HTML -->    

<!-- Modal -->
<!--<div id="PopUp_slider" class="modal fade" role="dialog">-->
        
        
<!--Start AK Pupup (for custom_graph data) div's  --> 
    <div id="PopUp_13Ccircle" class="PopUp">
    <!-- Popup Div Starts Here -->
        <div id="popupContact" style="width: 90%;">
            <div class="modal-header" style="padding: 5px">
                <button id="close_popup_13C" type="button" class="close" data-dismiss="modal">&times;</button>
            </div>              
            <!--<img id="close_popup_13C" class="close_popup" src="close_x.png">-->        
            <div class="px2 sm-px3 py2 mb3 mx-auto">
                <div class="col-12">

                    <div class="col-12" style="float: left">

                        <div class="clearfix bg-white blue">

                            <div class="col col-3">
                                <h2 class="h3 m0 PopUp_title" style="padding-top: 1rem;">
                                <!--<h2 style="font-size: x-large; font-weight: bold;">-->
                                    <sup>13</sup>C Carbon Diagram Creator
                                </h2>
                                <p class="PopUp_descriptive_paragraph">
                                <!--<p style="font-size: medium">-->
                                    Create a carbon structure using the arrow keys to add a circle in the direction corresponding to the arrow. Once finished creating your structure click "Add to Map" to have the diagram appear on the Escher Map. The circles in the diagram can be clicked to indicate label, and can be moved across the Escher Map.</p>
                            </div>
                            <div class="col col-7 p2">
                                <svg id="_13C_svg_holder" style="width: 100%; height: 350px; border: 4px solid #337ab7"></svg>

                            </div>
                            <div class="col col-2">
                                <p style="font-size: small; margin-top:1rem">Remove carbon circles by clicking "Remove Carbon" and then clicking the circle you would like to remove</p>                            
                                <button id="remove_carbon_circle" class="submit_button" style="font-size: 13px;">Remove Carbon</button><br>
                                <br>
                                <br>
                                <p style="font-size: small">Add a label to the diagram by inserting text into the the input below and clicking "Add Text Label." Click and drag the label to the desired location.</p>                            
                                <p style="font-size: medium">Text Label: </p>
                                <input type="text" id="popup_13C_textlabel" style="width: 100%; font-size: 13px;"/>
                                <button id="13C_textlabel_submit"  class="submit_button" style="font-size: 13px;">Add Text Label</button>
                            </div>

                        </div>
                    </div>    


                </div>
            </div>
                    <button id="submit_carbon_circle" class="submit_button col-12">Add Structure to Map</button>    
            
         </div>
        <!-- Popup Div Ends Here -->
    </div>   
                
        
        
        
        
        
        
        
<div id="PopUp_slider" style="top: 0%;; left: 40%; position:fixed; display: none;" role="dialog">
  <div class="modal-dialog" style="width: 300px">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header" style="padding: 5px">
        <button id="close_popup_slider" type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title" style="font-size: medium;">Graph Size</h4>
      </div>
        <p style="font-size: medium; padding: 10px">Height</p>
        
      <div class="modal-body" style="padding: 10px">
              <input type="range" style="background-color:#337ab7;" class="slider" min="3" max="17" value="7" id="height_range" >

              <p style="font-size: small;">Value: <span id="height_range_display"></span></p>
      </div> 
        <p style="font-size: medium; padding: 10px">Width</p>
      <div class="modal-body" style="padding: 10px">
              <input type="range" style="background-color:#337ab7;" class="slider" min="3" max="17" value="7" id="width_range" >

              <p style="font-size: small;">Value: <span id="width_range_display"></span></p>
      </div>         
      
    </div>

  </div>
</div>  
        

<div id="PopUp_one_slider" style="top: 0%;; left: 40%; position:fixed; display: none;" role="dialog">
  <div class="modal-dialog" style="width: 300px">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header" style="padding: 5px">
        <button id="close_popup_one_slider" type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title" style="font-size: medium;">Carbon Diagram Size</h4>
      </div>
        <p style="font-size: medium; padding: 10px">Size</p>
        
      <div class="modal-body" style="padding: 10px">
              <input type="range" style="background-color:#337ab7;" class="slider" min="1" max="12" value="4" id="size_range" >

              <p style="font-size: small;">Value: <span id="size_range_display"></span></p>
      </div>      
      
    </div>

  </div>
</div>      
        

<div id="PopUp_carbon_color_picker" style="top: 0%;; left: 40%; position:fixed; display: none;" role="dialog">
  <div class="modal-dialog" style="width: 300px">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header" style="padding: 5px">
        <button id="close_popup_carbon_color_picker" type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title" style="font-size: medium;">Carbon Diagram Color</h4>
      </div>
        
      <div class="modal-body" style="padding: 10px">
        <span style="font-size: medium; padding: 0px">Unlabeled Color: </span>
        <input class="jscolor" value="ab2567" id="popup_unlabeled_color">
     </div>     
        
        
      <div class="modal-body" style="padding: 10px">
        <span style="font-size: medium; padding: 0px">Labeled Color: </span>          
        <input class="jscolor" value="ab2567" id="popup_labeled_color">
      </div>          
            
     <button id="submit_carbon_color_picker_button" class="submit_button" type="submit">Submit Colors</button>
    </div>

  </div>
</div>           
        
        
        

<!--Start AK Pupup (for display data) div's  --> 
    <div id="PopUp_Upload_Data" class="PopUp">
    <!-- Popup Div Starts Here -->
        <!-- <div id="popupContact_sort"> -->
        <div id="popupContact" style="width: 80%;">
            <div class="modal-header" style="padding: 5px">
                <button id="close_popup_upload_data" type="button" class="close" data-dismiss="modal">&times;</button>
            </div>            
            <!-- <img id="close_popup_upload_data" class="close_popup" src="close_x.png">
        Contact Us Form -->
            <div class="p3 clearfix bg-white blue">

                <div class="col col-6" style="padding:1rem; border-right:1px solid #337ab7;">
                    <h2 style="font-size: large; text-align:center; margin-top:0px; padding: 0px">
                            Initial Data Upload
                    </h2>
                    <div>
                         <p style="font-size: small">Baseline corrected MS data can be uploaded in CSV format. The proper CSV schema is located <a href="url">here</a>  </p>

                        <input type="file" id="selectFiles_csv" value="Import" style="display:block; font-size: small; margin: auto" /> 

                        <button id="import_csv" class="submit_file_button">Import Uncorrected CSV Data File</button>
                    </div>
                    
                    <div style="margin-top:2.5rem">
                         <p style="font-size: small">Natural isotope abundance corrected data uploaded in CSV format. The proper CSV schema is located <a href="url">here</a>  </p>

                        <input type="file" id="select_corrected_Files_csv" value="Import" style="display:block; font-size: small; margin: auto" /> 

                        <button id="import_corrected_csv" class="submit_file_button">Import Corrected CSV Data File</button>                     
                    </div>                                        
                </div>
                
                <div class="col col-6" style="padding:1rem;">
                    <h2 style="font-size: large; text-align:center; margin-top:0px; padding: 0px">
                            Reupload Workspace
                    </h2>
                     <p style="font-size: small">Previously saved workspaces will be in JSON format. The proper JSON schema is located <a href="url">here</a>   </p>
                    
                    <input type="file" id="selectFiles" value="Import" style="display:block; font-size: small; margin: auto" /> 

                    <button id="import" class="submit_file_button">Import JSON Data File</button>           
                    
                </div>                
            </div>
            

        </div>
        <!-- Popup Div Ends Here -->
    </div>
    <!-- Display Popup Button -->          
        
        
<!--Start AK Pupup (for timecourse data) div's  --> 
    <div id="PopUp_TimePoint_Table" class="PopUp">
    <!-- Popup Div Starts Here -->
        <div id="popupContact">
            
            <div class="modal-header" style="padding: 5px">
                <button id="close_popup" type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!--<img id="close_popup" class="close_popup" src="close_x.png">
         Contact Us Form -->
            <div class="px2 sm-px3 py2 mb3 mx-auto">
                <div class="clearfix bg-white blue col col-5">
                        <h2 class="h3 m0 PopUp_title">
                        <!--<h2 class="h3 m0" style="font-size: x-large; font-weight: bold; overflow:hidden">-->
                                Enter Time Points
                        </h2>
          
                        <p class="PopUp_descriptive_paragraph">
                         <!--<p style="font-size: medium; overflow:hidden; overflow-y:auto; max-height: 350px; margin-top: 1rem;">-->
                            Entering time point information will allow access to kinetic line graphs of enrichment, abundance, and isotopologue labeling in the Escher Trace menu as well as right-click menu of each graph. Enter a Condition Name and corresponding Time Point for each group. Enter the units of time in the input above the table. Apply changes by clicking "Submit Form."
                        </p>

                </div>  
                <div class="col col-7" style="height: 100%;">            
                    <div style="font-size: 15px; font-weight: bold; color:black; margin-bottom: 1rem">
                    Time Units: <input type='text' id='UserInputTimeUnits' />
                    </div>            
                    <div style="border:1px solid #000;">
                        <table id="TimePoint_Table" class="display" style="width:100%;">
                            <thead>
                                <tr class="table_title" style="text-align: center;"> <!-- set header of the table in the popup -->
                                    <th>Group</th>
                                    <th>Condition Name</th>
                                    <th>Time Point</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>

                        </table>
                    </div>
                    
                </div>
            </div>
            <button id="submit_TimePoint_Table_button" class="submit_button" type="submit">Submit Form</button>

        </div>
        <!-- Popup Div Ends Here -->
    </div>
    <!-- Display Popup Button -->
<!--End AK Pupup (for cell number data) div's  --> 
        
<!--Start AK Pupup (for ConditionName data) div's  --> 
    <div id="PopUp_ConditionName_Table" class="PopUp">
    <!-- Popup Div Starts Here -->
        <div id="popupContact" style="max-width: 650px">
            
            <div class="modal-header" style="padding: 5px">
                <button id="close_popup_conditionname" type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            
            <!--<img id="close_popup_conditionname" class="close_popup" src="close_x.png">
         Contact Us Form -->
            <div class="px2 sm-px3 py2 mb3 mx-auto">
                <div class="clearfix bg-white blue col col-4">
                        <h2 class="h3 m0 PopUp_title">
                        <!--<h2 class="h3 m0" style="font-size: x-large; font-weight: bold; overflow:hidden">-->
                                Rename Conditions
                        </h2>
          
                        <p class="PopUp_descriptive_paragraph">
                         <!--<p style="font-size: medium; overflow:hidden; overflow-y:auto; max-height: 350px; margin-top: 1rem;">-->
                            Rename a condition by changing the input next to the respective condition name. Apply changes by clicking "Submit Form"
                        </p>

                </div>  
                <div class="col col-8" style="height: 100%; border:1px solid #000; ">
                
                    <table id="ConditionName_Table" class="display" style="width:100%">
                        <thead>
                            <tr> <!-- set header of the table in the popup -->
                                <th style="font-size: small;">Current Condition Name</th>
                                <th style="font-size: small;">Updated Condition Name</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>

                    </table>


                </div>
            </div>
            <button id="submit_ConditionName_Table_button" class="submit_button" type="submit">Submit Form</button>

        </div>
        <!-- Popup Div Ends Here -->
    </div>
    <!-- Display Popup Button -->
<!--End AK Pupup (for ConditionName data) div's  -->        
        
        
<!--Start AK Pupup (for timecourse data) div's  --> 
    <div id="PopUp_CellNumber_Table" class="PopUp">
    <!-- Popup Div Starts Here -->
        <div id="popupContact">
            <div class="modal-header" style="padding: 5px">
                <button id="close_popup_cellnumber" type="button" class="close" data-dismiss="modal">&times;</button>
            </div>            
            <!--<img id="close_popup_cellnumber" class="close_popup" src="close_x.png">
             Contact Us Form -->
            <div class="px2 sm-px3 py2 mb3 mx-auto">
                <div class="clearfix bg-white blue col col-5">
                        <h2 class="h3 m0 PopUp_title">
                        <!--<h2 class="h3 m0" style="font-size: x-large; font-weight: bold; overflow:hidden">-->
                                Normalize Abundances
                        </h2>
          
                        <p class="PopUp_descriptive_paragraph">
                         <!--<p style="font-size: medium; overflow:hidden; overflow-y:auto; max-height: 350px; margin-top: 1rem;">-->
                            Select your normalizing experimental condition and/or metabolite if applicable, if not select 'N/A.' Enter relevant cell numbers or sample masses, if not applicable enter "1". All entered fields will be used to normalize metabolite abundances. Changes will be reflected in all abundance related graphs. Apply changes by clicking "Submit Form"
                        </p>

                </div>  
                <div class="col col-7" style="height: 100%;">
                
                    <table id="Normalize_Condition_Table" class="display" style="width:100%; border:1px solid #000; ">
                            <thead>
                                <tr class="table_title"> <!-- set header of the table in the popup -->
                                    <th>Condition to Normalize to:</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>

                     </table>            
                    <table id="Normalize_Table" class="display" style="width:100%; border:1px solid #000; ">
                            <thead>
                                <tr class="table_title"> <!-- set header of the table in the popup -->
                                    <th>Metabolite to Normalize to:</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>

                     </table>
                    <div style="border:1px solid #000; ">
                    <table id="CellNumber_Table" class="display" style="width:100%;">
                            <thead>
                                <tr class="table_title"> <!-- set header of the table in the popup -->
                                    <th>Conditions</th>
                                    <th>Cell Number or Sample Mass</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>

                     </table>
                    </div>    
                </div>
            </div>
            <button id="submit_CellNumber_Table_button" class="submit_button" type="submit">Submit Form</button>

        </div>
        <!-- Popup Div Ends Here -->
    </div>
    <!-- Display Popup Button -->        
        
<!--End AK Pupup (for cell number data) div's  -->
        
<!--Start AK Pupup (for display data) div's  --> 
    <div id="PopUp_time_group_display_List" class="PopUp">
    <!-- Popup Div Starts Here -->
    <!--    <div id="popupContact_sort"> -->
        <div id="popupContact">
            <div class="modal-header" style="padding: 5px">
                <button id="close_popup_time_group_display" type="button" class="close" data-dismiss="modal">&times;</button>
            </div>             
            <!--<img id="close_popup_time_group_display" class="close_popup" src="close_x.png">
         Contact Us Form -->
            <div class="px2 sm-px3 py2 mb3 mx-auto">
            
                <div class="clearfix bg-white blue">
                    <div class="col col-4">
                        <!--<h2 class="h3 m0" style="font-size: large">-->
                        <h2 class="h3 m0 PopUp_title">
                        <!--<h2 style="font-size: x-large; font-weight: bold;">-->
                                Order Conditions
                        </h2>
                         <p class="PopUp_descriptive_paragraph">                    
                         <!--<p style="font-size: medium">-->
                             Click and drag conditions to display to the "To Graph" list. Multiple conditions can be moved at the same time by first clicking them individually, turning them red, and then dragging them. Order them as you would like them to be displayed then click Submit</p>
                    </div>
                    <div class="col col-4">
                        <span style="font-size: medium; font-weight: bold; display: block;" class="ml4">Condition List</span>            
                        <ul id="all-time-groups-list" class="ml4 all-time-groups-list sortable list flex flex-column list-reset group_list" style="overflow:hidden; overflow-y:auto; max-height: 390px; padding: 2px; width:80%;">
                           <!-- <li class="disabled p1 mb1 navy" style="position: absolute; margin-top: -20px;  z-index: 10">Condition List</li>-->
                        </ul>
                    </div>
                    <div class="col col-4">
                        <span style="font-size: medium; font-weight: bold; display: block;" class="ml4">To Graph</span>                                
                        <ul id="graph-time-groups-list" class="ml4 graph-time-groups-list sortable list flex flex-column list-reset group_list" style="margin-top:10px; overflow:hidden; overflow-y:auto; max-height: 390px; padding: 2px; width:80%;">
                                <!--<li class="mb1 bg-navy ghost border border-yellow" style="position: absolute; z-index: 1; margin-top: -49px; height: 40px; display: block;">To Graph</li>-->
                                <!--<li class="disabled p1 mb1 navy" style="position: absolute; margin-top: -20px;  z-index: 10">To Graph</li>-->
                        </ul>
                    </div>
                </div>
            </div>
            <button id="submit_graph_time_groups_button" class="submit_button">Submit</button>
        </div>
        <!-- Popup Div Ends Here -->
    </div>
    <!-- Display Popup Button -->         
        
        
 
    <!--Start AK Pupup (for display data) div's  --> 
        <div id="PopUp_group_display_List" class="PopUp">
        <!-- Popup Div Starts Here -->
        <!--    <div id="popupContact_sort"> -->
            <div id="popupContact">
            <div class="modal-header" style="padding: 5px">
                <button id="close_popup_group_display" type="button" class="close" data-dismiss="modal">&times;</button>
            </div>             
            <!--<img id="close_popup_group_display" class="close_popup" src="close_x.png">
         Contact Us Form -->
                <div class="px2 sm-px3 py2 mb3 mx-auto">
            
                <div class="clearfix bg-white blue">
                    <div class="col col-4">
                        <!--<h2 class="h3 m0" style="font-size: large">-->
                        <h2 class="h3 m0 PopUp_title">
                        <!--<h2 style="font-size: x-large; font-weight: bold;">-->
                                Order Conditions
                        </h2>
                         <p class="PopUp_descriptive_paragraph">                                        
                         <!--<p style="font-size: medium">-->
                             Click and drag conditions to display to the "To Graph" list. Multiple conditions can be moved at the same time by first clicking them individually, turning them red, and then dragging them. Order them as you would like them to be displayed then click Submit</p>
                    </div>
                    <div class="col col-4">
                        <span style="font-size: medium; font-weight: bold; display: block;" class="ml4">Condition List</span>     
                        <ul id="all-groups-list" class="ml4 all-groups-list sortable list flex flex-column list-reset group_list" style="margin-top:10px; overflow:hidden; overflow-y:auto; max-height: 390px; padding: 2px; width:80%;">
                        
                        <!--<ul id="all-groups-list" class="ml4 all-groups-list sortable list flex flex-column list-reset" style="overflow:hidden; overflow-y:auto; max-height: 390px; margin-top:10px; border:1px solid #000; padding: 2px">
                            
                        <ul id="all-groups-list" class="ml4 all-groups-list sortable list flex flex-column list-reset" style="margin-top:10px; border:1px solid #000; overflow:hidden; overflow-y:auto; max-height: 390px; padding: 2px">-->
                            
                           <!-- <li class="disabled p1 mb1 navy" style="position: absolute; margin-top: -20px;  z-index: 10">Condition List</li>-->
                        </ul>
                    </div>
                    <div class="col col-4">
                        <span style="font-size: medium; font-weight: bold; display: block;" class="ml4">To Graph</span>   
                        <ul id="graph-groups-list" class="ml4 graph-groups-list sortable list flex flex-column list-reset group_list" style="margin-top:10px; overflow:hidden; overflow-y:auto; max-height: 390px; padding: 2px; width:80%;">
                        
                        <!--<ul id="graph-groups-list" class="ml4 graph-groups-list sortable list flex flex-column list-reset" style="margin-top:10px; border:1px solid #000; overflow:hidden; overflow-y:auto; max-height: 390px; padding: 2px">
                                <li class="mb1 bg-navy ghost border border-yellow" style="position: absolute; z-index: 1; margin-top: -49px; height: 40px; display: block;">To Graph</li>-->
                                <!--<li class="disabled p1 mb1 navy" style="position: absolute; margin-top: -20px;  z-index: 10">To Graph</li>-->
                        </ul>
                    </div>
                </div>
            </div>
            <button id="submit_graph_groups_button" class="submit_button">Submit</button>

        </div>
        <!-- Popup Div Ends Here -->
    </div>
    <!-- Display Popup Button -->  
        <!-- Display Popup Button -->           
        
        


<!--Start AK Pupup (for display data) div's  --> 
    <div id="PopUp_file_display_List" class="PopUp">
    <!-- Popup Div Starts Here -->
     <!--   <div id="popupContact_sort_file"> -->
        <div id="popupContact" style="width: 90%;">
            <div class="modal-header" style="padding: 5px">
                <button id="close_file_organize_display" type="button" class="close" data-dismiss="modal">&times;</button>
            </div>            
            <!--<img id="close_file_organize_display" class="close_popup" src="close_x.png">
         Contact Us Form -->
            <div class="px2 sm-px3 py2 mb3 mx-auto">
                <div class="clearfix bg-white blue col col-3">
                        <h2 class="h3 m0 PopUp_title">
                        <!--<h2 class="h3 m0" style="font-size: x-large; font-weight: bold; ">-->
                                Sample Groups
                        </h2>
                        <p class="PopUp_descriptive_paragraph">                    
                             Data will be averaged across samples within user defined groups. To group samples enter a group (Condition) name (for example, (+)Drug) and click "Add Group". At this point a new column heading will appear with the entered title. To add samples to the new group, click and drag them to the new group heading. Multiple samples can be moved at the same time by first clicking them individually, turning them red, and then dragging them. Repeat this till all desired groups and files have been ordered then click "Submit Form".
                        </p>
                            <div style="font-size: 15px; font-weight: bold; color:black">
                            Condition Name: <input type='text' id='UserInputGroupName' />
                            </div>
                            <button id="Add_List" class="submit_file_button" style="font-size: medium">Add Group</button>
                        
                        <!--<div class="col col-5">-->
                </div>
                <div class="col col-3" style="height: 100%; ">
                        <span style="font-size: medium; font-weight: bold" class="ml2">File List</span>
                        <ul class="col-10 ml2 all-file-list sortable list flex flex-column list-reset group_list" id="all-file-list" style="overflow:hidden; overflow-y:auto; max-height: 390px; padding: 2px">
                    
                        <!--<ul class="col-10 ml2 all-file-list sortable list flex flex-column list-reset group_list" id="all-file-list">-->
                            <!--<span style="font-size: medium; font-weight: bold">File List</span>-->

                            <!--<li class="p1 mb1 navy" style="position: relative; margin-top: -25px; z-index: 10">File List</li>-->
                        </ul>
                </div>  
                <div class="col col-6" style="height: 100%; ">
                        <span style="font-size: medium; font-weight: bold" class="ml2">   </span>
                    
                        <div class="list-of-lists p1 clearfix bg-white blue" style="overflow:hidden; overflow-y:auto; max-height: 390px;">


                        </div>
                </div>                 
                
                

            </div>
            

            <!-- <div></div>
            <div></div>-->
            <button id="submit_file_organizer_button" class="submit_button" type="submit">Submit Form</button>
        </div>
            <!-- Popup Div Ends Here -->
    </div>
    <!-- Display Popup Button -->       
 
        
<!--Start AK Pupup (for display data) div's  --> 
    <div id="PopUp_metabolite_display_Table" class="PopUp">
    <!-- Popup Div Starts Here -->
        <div id="popupContact" style="max-width: 600px">
            <div class="modal-header" style="padding: 5px">
                <button id="close_popup_metabolite_display" type="button" class="close" data-dismiss="modal">&times;</button>
            </div>               
            <!--<img id="close_popup_metabolite_display" class="close_popup" src="close_x.png">
         Contact Us Form -->
                <div class="px2 sm-px3 py2 mb3 mx-auto">
                    <div class="clearfix bg-white blue col col-5">
                            <h2 class="h3 m0 PopUp_title">
                            <!--<h2 class="h3 m0" style="font-size: x-large; font-weight: bold; overflow:hidden">-->
                                    Metabolites to Display
                            </h2>

                            <p class="PopUp_descriptive_paragraph">
                             <!--<p style="font-size: medium; overflow:hidden; overflow-y:auto; max-height: 350px; margin-top: 1rem;">-->
                                Choose which metabolites will have data displayed on the Escher map by selecting them in the table. Only graphs for selected (checked) metabolites will be visible on the Escher Map. Apply changes by clicking "Submit Form"
                            </p>

                    </div>  
                    <div class="col col-7" style="height: 100%; border:1px solid #000; ">            

                        <div id="holder_metabolite_display_Table">    
                        <!-- <table id="metabolite_display_Table" class="display" style="cellspacing:0" style="width:100%">
                            <thead>
                                <tr class="table_title"> 
                                 <th style="font-size: small; text-align: center">Name</th>
                                 <th style="font-size: small; text-align: center"><input name="select_all" value="0" id="metabolite_display_Table-select-all" type="checkbox" /> Select All</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>

                         </table> -->
                        </div>
                    </div>
                </div>
            <button id="submit_metabolite_display_Table_button" class="submit_button" type="submit">Submit Form</button>

        </div>
        <!-- Popup Div Ends Here -->
    </div>
    <!-- Display Popup Button -->            
        
<!--End AK Pupup (for display data) div's  -->         

<!--Start AK Pupup (for isotopologue display data) div's  --> 
    <div id="PopUp_isotopologue_display_Table" class="PopUp">
    <!-- Popup Div Starts Here -->
        <div id="popupContact" style="max-width: 600px">
            <div class="modal-header" style="padding: 5px">
                <button id="close_popup_isotopologue_display" type="button" class="close" data-dismiss="modal">&times;</button>
            </div>             
            <!--<img id="close_popup_isotopologue_display" class="close_popup" src="close_x.png">
         Contact Us Form -->
                <div class="px2 sm-px3 py2 mb3 mx-auto">
                    <div class="clearfix bg-white blue col col-5">
                            <h2 class="h3 m0 PopUp_title">
                            <!--<h2 class="h3 m0" style="font-size: x-large; font-weight: bold; overflow:hidden">-->
                                    Isotopologues to Display
                            </h2>

                            <p class="PopUp_descriptive_paragraph">
                             <!--<p style="font-size: medium; overflow:hidden; overflow-y:auto; max-height: 350px; margin-top: 1rem;">-->
                                To limit the isotopologues which are included in all Escher Trace graphs, select the maximum isotopologue to be displayed for each metabolite. The selected isotopologue limit is used as the total number of carbons present in the calculation of metabolite enrichments. Apply changes by clicking "Submit Form"
                            </p>

                    </div>  
                    <div class="col col-7" style="height: 100%; border:1px solid #000; ">             

                        <table id="isotopologue_display_Table" class="display" style="cellspacing:0" style="width:100%">
                            <thead>
                                <tr class="table_title"> <!-- set header of the table in the popup -->
                                 <th>Name</th>
                                 <th>Isotopologue Limit</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>

                         </table>
                    </div>
                </div>
            <button id="submit_isotopologue_display_Table_button" class="submit_button" type="submit">Submit Form</button>

        </div>
        <!-- Popup Div Ends Here -->
    </div>
    <!-- Display Popup Button -->            
        
<!--End AK Pupup (for isotopologue display data) div's  -->          

<!--Start AK Pupup (for isotopologue display data) div's  --> 
    <div id="PopUp_quant_standard_display_Table" class="PopUp">
    <!-- Popup Div Starts Here -->
        <div id="popupContact" style="min-width: 675px">
            <div class="modal-header" style="padding: 5px">
                <button id="close_popup_quant_standard_display" type="button" class="close" data-dismiss="modal">&times;</button>
            </div>             
        <!--<   img id="close_popup_quant_standard_display" class="close_popup" src="close_x.png">
     Contact Us Form -->
            <div class="px2 sm-px3 py2 mb3 mx-auto">
                <div class="clearfix bg-white blue col col-5" style="height: 100%;">
                        <h2 class="h3 m0 PopUp_title">
                        <!--<h2 class="h3 m0" style="font-size: x-large; font-weight: bold; overflow:hidden">-->
                                Quantitative Standards
                        </h2>
          
                        <p class="PopUp_descriptive_paragraph">
                         <!--<p style="font-size: medium; overflow:hidden; overflow-y:auto; max-height: 350px; margin-top: 1rem;">-->
                            Enter information of any labeled standards used to quantify metabolite abundances. For metabolites to be quantified, select the isotopologue of the labeled standard and enter its concentration. Metabolite abundancees will be quantified by taking the ratio of the unlabeled fraction (M0) over the labeling corresponding to the standard isotopologue and multiplying by the standard concentration. Apply changes by clicking "Submit Form." 
                        </p>

                </div>  
                <div class="col col-7" style="height: 100%; ">              
            
                    <div style="font-size: 15px; font-weight: bold; color:black; margin-bottom: 1rem">
                    Concentration Units: <input type='text' id='UserInputConcentrationUnits' />
                    </div>    
                    <div style="border:1px solid #000;">                    
                        <table id="quant_standard_display_Table" class="display" style="cellspacing:0; width:100%;">
                            <thead>
                                <tr class="table_title"> <!-- set header of the table in the popup -->
                                 <th>Name</th>
                                 <th>Standard Isotopologue</th>
                                 <th>Standard Concentration</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>

                         </table>
                    </div>
                </div>
            </div>
        <button id="submit_quant_standard_display_Table_button" class="submit_button" type="submit">Submit Form</button>

        </div>
        <!-- Popup Div Ends Here -->
    </div>
    <!-- Display Popup Button -->            
        
<!--End AK Pupup (for isotopologue display data) div's  -->          

   
        
        
<!--Start AK Pupup (for custom_graph data) div's  --> 
    <div id="PopUp_custom_graph" class="PopUp">
    <!-- Popup Div Starts Here -->
        <div id="popupContact" style="width: 95%;">
            <div class="modal-header" style="padding: 5px">
                <button id="close_popup_custom_graph" type="button" class="close" data-dismiss="modal">&times;</button>
            </div>                  
        <!--<img id="close_popup_custom_graph" class="close_popup" src="close_x.png"> -->       
            <div class="px2 sm-px3 py2 mb3 mx-auto">
                <div class="col-12">

                    <div class="col-6" style="float: left">

                        <div class="clearfix bg-white blue">
                            <div class="col col-4">
                                <h2 class="h3 m0 PopUp_title">
                                <!--<h2 class="h3 m0" style="font-size: x-large; font-weight: bold; ">-->
                                        Compare Metabolites
                                </h2>
                                <p class="PopUp_descriptive_paragraph">  
                                     Click and drag conditions that will be included in the graph from "Condition List" to the "To Graph" list. Multiple conditions can be moved at the same time by first clicking them individually, turning them red, and then dragging them. Order them as you would like them to be displayed.
                                </p>
                            </div>
                            <div class="col col-4">
                                <span style="font-size: medium; font-weight: bold; display: block;" class="ml4">Condition List</span>     
                                <ul id="CG_all-groups-list" class="ml4 CG_all-groups-list sortable list flex flex-column list-reset group_list" style="margin-top:10px; overflow:hidden; overflow-y:auto; max-height: 390px; width: 70%; padding: 2px">
                                    <!--<li class="disabled p1 mb1 navy" style="position: absolute; margin-top: -20px;  z-index: 10">Condition List</li>-->
                                </ul>
                            </div>
                            <div class="col col-4">
                                <span style="font-size: medium; font-weight: bold; display: block;" class="ml4">To Graph</span>
                                <ul id="CG_graph-groups-list" class="CG_graph-groups-list ml4 sortable list flex flex-column list-reset group_list" style="margin-top:10px; overflow:hidden; overflow-y:auto; max-height: 390px; width: 70%; padding: 2px">
                                        <!--<li class="mb1 bg-navy ghost border border-yellow" style="position: absolute; z-index: 1; margin-top: -49px; height: 40px; display: block;">To Graph</li>-->
                                        <!--<li class="disabled p1 mb1 navy" style="position: absolute; margin-top: -20px;  z-index: 10">To Graph</li>-->
                                </ul>
                            </div>
                        </div>
                    </div>    


                     <!-- END Group order/drag here-->        

                    <div class="col-6" style="float: left">

                        <!-- <div class="px2 sm-px3 py2 mb3 mx-auto"> -->
                            <div class="clearfix bg-white blue">
                                <div class="col col-6">
                                    <h2 class="h3 m0 PopUp_title">
                                    <!--<h2 class="h3 m0" style="font-size: x-large; font-weight: bold; ">-->
                                            Select Data
                                    </h2>
                                    <p class="PopUp_descriptive_paragraph">                    
                                         Select a Metabolite, Fragment, and Data Type you would like to include in the graph and click "Add Data" add it to the Data List. After all data is entered, click Submit Metabolite Selections to generate the graph.
                                    </p>

                                    <div style="margin-bottom: 1rem; text-align:center;">
                                        <span style="font-size: small;">1. </span>
                                        <select id="choose-metab" style="font-size: small; height: 30px; width: 80%"><option selected value="base">Metabolite</option></select>
                                    </div>

                                    <div style="margin-bottom: 1rem; text-align:center;">
                                        <span style="font-size: small;">2. </span>
                                        <select id="choose-frag" style="font-size: small; height: 30px; width: 80%"><option>Fragment</option></select>    
                                    </div>    

                                    <div style="margin-bottom: 0rem; text-align:center;">
                                        <span style="font-size: small;">3. </span>                             
                                        <select id="choose-iso" style="font-size: small; height: 30px; width: 80%"><option>Data Type</option></select>                         
                                    </div>
                                <!--    <select id="choose-metab" style="font-size: small; height: 30px"><option selected value="base">Metabolite</option></select>
                                    <select id="choose-frag" style="font-size: small; height: 30px"><option>Fragment</option></select>    
                                    <select id="choose-iso" style="font-size: small; height: 30px"><option>Data Type</option></select>      -->
                                    <br>
                                    <button id="submit_custom_data_selection" class="submit_button col-12" style="display: none; padding: 7px 0; font-size: 15px">Add Data</button>

                                    <h2 class="h3 m0 PopUp_title" style="margin-top: 1rem">
                                    <!--<h2 class="h3 m0" style="font-size: x-large; font-weight: bold; ">-->
                                        Normalizing Condition
                                    </h2>
                                    <p class="PopUp_descriptive_paragraph">                    
                                         Select a condition you would like to normalize data to. 
                                    </p>  
                                    <div style="margin-bottom: 0rem; text-align:center;">
                                        <select id="choose-norm-metab" style="font-size: small; height: 30px; width: 80%"><option selected value="base">N/A</option></select>
                                    </div>

                                </div>
                                    <!--<div class="col col-5">-->
                                <div class="col col-6">
                                    <span style="font-size: medium; font-weight: bold" class="ml4">Data List</span>

                                    <ul id="CG_select-data-type-list" class="ml4 CG_select-data-type-list sortable list flex flex-column list-reset" style="padding: 2px">
                                        <!--<span style="font-size: medium; font-weight: bold">Data List</span>

                                        <li class="p1 mb1 navy" style="position: relative; margin-top: -25px; z-index: 10">File List</li>-->
                                    </ul>
                                </div>

                            </div>
                        <!-- </div> -->
                    </div>

                </div>  
             </div>
                    <button id="submit_custom_graph_button" class="submit_button col-12">Submit Metabolite Selections</button>    
            
         </div>
        <!-- Popup Div Ends Here -->
    </div>   
        
        
        
        
<!--Start AK Pupup (for display data) div's  --> 
    <div id="PopUp_color_picker" class="PopUp">
    <!-- Popup Div Starts Here -->
    <!--    <div id="popupContact_sort"> -->
        <div id="popupContact" style="left: 20%; transform: translate(-15%, 35px)">
            <div class="modal-header" style="padding: 5px">
                <button id="close_popup_color_picker" type="button" class="close" data-dismiss="modal">&times;</button>
            </div>               
            <!--<img id="close_popup_color_picker" class="close_popup" src="close_x.png">
         Contact Us Form -->
            <div class="clearfix bg-white blue">
                <div class="col col-4">
                    <!--<h2 class="h3 m0" style="font-size: large">-->
                    <h2 class="PopUp_title" style="font-size: x-large; font-weight: bold;">
                            Choose Color Scheme
                    </h2>
                     <p class="PopUp_descriptive_paragraph">                    
                         Select desired color scheme. Change any scheme by clicking and choosing desired color or entering in a HEX code. Define a new scheme by clicking Add Color. Click Submit after you have chosen your color scheme. </p>
                </div>
                <div class="col col-8" style="padding-top: 60px;">
                    <ul id="all-color-schemes" class="color_list"></ul>
                    <button id="add_color" class="submit_button col-12" style="padding: 7px 0; font-size: 15px">Add Color</button>
        
                </div>
            </div>
            <button id="submit_color_picker_button" class="submit_button">Submit</button>

        </div>
        <!-- Popup Div Ends Here -->
    </div>
    <!-- Display Popup Button -->         
        
        
        
        
        
        
        
<!--Start AK Pupup (for display_data) div's  --> 
    <div id="PopUp_data_display_Table" class="PopUp">
    <!-- Popup Div Starts Here -->
        <div id="popupContact" style="width:70%; word-wrap: break-word">
            <div class="modal-header" style="padding: 5px">
                <button id="close_popup_data_display" type="button" class="close" data-dismiss="modal">&times;</button>
            </div>             
            <!--<img id="close_popup_data_display" class="close_popup" src="close_x.png">-->
            <div id="insert_table">
            </div>
    <!-- Contact Us Form
        <table id="data_display_Table" class="display compact cell-border" style="cellspacing:0; width:100%; word-wrap: break-word">
            <thead>
                <tr id="data_display_ConditionNames" class="table_title">
                    
                </tr>
                <tr id="data_display_FileNames">
                </tr>                
            </thead>
            
            <tbody class="table_element">                
            </tbody>

         </table> -->
        </div>
        <!-- Popup Div Ends Here -->
    </div> 
</body>

<!-- JAVA SCRIPT BELOW  --> 
      
  <script>
      
      //JACK MENU JS
      /* Loop through all dropdown buttons to toggle between hiding and showing its dropdown content - This allows the user to have multiple dropdowns without any conflict */
    
var dropdown = document.getElementsByClassName("dropdown-btn");
for (i = 0; i < dropdown.length; i++) {
  dropdown[i].addEventListener('click', function() {
      
      toggle_status=this.nextElementSibling.style.display

      for(k=0;k<this.parentElement.children.length;k++){
          if(this.parentElement.children[k].tagName =="DIV"){
            this.parentElement.children[k].style.display = "none";
          }else{
            this.parentElement.children[k].classList.remove('active')
          //this.parentElement.children[k].classList.removeClass('active')
              //.removeClass('active')
          }
      }
      
    var dropdownContent = this.nextElementSibling;      
      
    if (toggle_status == "block") {
      dropdownContent.style.display = "none";
    } else {
      this.classList.toggle("active");        
      dropdownContent.style.display = "block";
    }
  });
}
      
      

//AK: Meat of the functionality is contained in add_structures, result is the data passed from the user uploaded json file
function add_structures(result) {
    console.log(result)
    var FileMIDs=result.FileMIDs
    console.log(FileMIDs)
    FileMIDs=processFileMIDs(FileMIDs) //corrects any uncompatible metabolite and fragment names
    console.log(FileMIDs)
    
    var FileNames=result.FileNames
    
    var MIDs=result.MIDs
    var All_MIDs=result.All_MIDs
    var Graph_Location=result.Graph_Location 
    var Graph_Attribute=result.Graph_Attribute 
    var ConditionNames=result.ConditionNames
    var All_ConditionNames=result.All_ConditionNames
    var Group_Names=result.Group_Names
    var All_Group_Names=result.All_Group_Names
    //var color_set=result.color_set
    var graph_scale_set=result.graph_scale_set
    var Condition_Times=result.Condition_Times;
    var graph_edited=result.graph_edited;
    var Isotopologue_Limit=result.Isotopologue_Limit
    var Std_Concentration=result.Std_Concentration
    var clickcount={
                 "Colors_button" : 1,   //allows for cycling of color combinations for graphs
                 "Iso_Colors_button" : 1,    //allows for cycling of color combinations for graphs
                 "Condition_Colors_button" : 1    //allows for cycling of color combinations for graphs
    }
    var Cell_Numbers=result.Cell_Numbers
    var All_Cell_Numbers=result.All_Cell_Numbers

    var ConditionIndex=0;  //Refers to MID1 or MID2 or etc. in the BIGGCarbonJSON file
    var ConditionAmount=0; //stores the total number of conditions
    var selectMID=[];  //selects MID data of the first condition 

    var map_metabolites=[] //array that contains all the bigg_ids of metabolites included in the escher Map
    var unmapped_metabolites=[] //array that contains all the bigg_ids of metabolites excluded from the escher Map       

    var fileorganizer=result.fileorganizer
    var norm_frag=result.norm_frag
    var norm_metab=result.norm_metab
    var norm_cond=result.norm_cond    
    var color_scheme_obj=result.color_scheme_obj
    var CustomMIDs=result.CustomMIDs
    var CG_container=result.CG_container
    var UserInputConcentrationUnits=result.UserInputConcentrationUnits
    var UserInputTimeUnits=result.UserInputTimeUnits
    var display_bar_label=result.display_bar_label
    var display_legend_metrics=result.display_legend_metrics
    var sel_color_index=0;
    var carbon_circle_location=result.carbon_circle_location;
    
    if(typeof display_bar_label == "undefined"){
        display_bar_label=true
    }     
    if(typeof display_legend_metrics == "undefined"){
        display_legend_metrics=true
    }    
    if(typeof norm_frag == "undefined"){
        norm_frag="undefined"
    }
    if(typeof norm_metab == "undefined"){
        norm_metab="undefined"
    }
    if(typeof norm_cond == "undefined"){
        norm_cond="undefined"
    }    
    if(typeof fileorganizer == "undefined"){
        fileorganizer={}
    }
    if(typeof CustomMIDs == "undefined"){
        CustomMIDs={}
    }    
    if(typeof CG_container == "undefined"){
        CG_container=[]
    }
    if(typeof carbon_circle_location == "undefined"){
        carbon_circle_location={}
    }    
    
    
function processFileMIDs(FileMIDs){
    var rename_metabolite=''
    var rename_fragment=''

    for(file in FileMIDs){
        for(metabolite in FileMIDs[file]){

            if(/[0-9]+/g.test(metabolite[0])){ //checks if the first character in metabolite is a number
                rename_metabolite=("_".concat(metabolite)) //adds an underscore as the first character of metabolite
                if(rename_metabolite!=metabolite){ 
                    FileMIDs[file][rename_metabolite]=FileMIDs[file][metabolite]
                    delete FileMIDs[file][metabolite]
                }
            }      
        }
    }



    for(file in FileMIDs){
        for(metabolite in FileMIDs[file]){

 //           if(/[\W_]+/g.test(metabolite)){ //checks for non-alphanumeric characters
//                rename_metabolite=metabolite.replace(/[\W_]+/g,"_") //replaces non-alphanumeric characters with _
            if(/[\W]+/g.test(metabolite)){ //checks for non-alphanumeric characters
                rename_metabolite=metabolite.replace(/[\W]+/g,"_") //replaces non-alphanumeric characters with _                
                if(rename_metabolite!=metabolite){ 
                    FileMIDs[file][rename_metabolite]=FileMIDs[file][metabolite]
                    delete FileMIDs[file][metabolite]
                }

            }        
        }
    }    



    for(file in FileMIDs){
        for(metabolite in FileMIDs[file]){
            for(fragment in FileMIDs[file][metabolite]){

                if(/[0-9]+/g.test(fragment[0])){ //checks if the first character in fragment is a number
                    rename_fragment=("_".concat(fragment)) //adds an underscore as the first character of fragment
                    if(rename_fragment!=fragment){ 
                        FileMIDs[file][metabolite][rename_fragment]=FileMIDs[file][metabolite][fragment]                
                        delete FileMIDs[file][metabolite][fragment]
                    }
                }

            }
        }
    } 


    for(file in FileMIDs){
        for(metabolite in FileMIDs[file]){
            for(fragment in FileMIDs[file][metabolite]){           

 //               if(/[\W_]+/g.test(fragment)){ //checks for non-alphanumeric characters
//                    rename_fragment=fragment.replace(/[\W_]+/g,"_") //replaces non-alphanumeric characters with _
                if(/[\W]+/g.test(fragment)){ //checks for non-alphanumeric characters
                    rename_fragment=fragment.replace(/[\W]+/g,"_") //replaces non-alphanumeric characters with _                    
                    if(rename_fragment!=fragment){
                        FileMIDs[file][metabolite][rename_fragment]=FileMIDs[file][metabolite][fragment]                
                        delete FileMIDs[file][metabolite][fragment]
                    }

                }
            }
        }
    }  
    
    return FileMIDs

}
    
function define_undefined(){
        
    
    if(typeof Graph_Location == "undefined"){   //defines Group_Location in case it is not included in the user uploaded file, likely the case if the user is uploading data for the first time
        Graph_Location={} //stores the x,y coordinates of all graphs displayed on the page
        //Initially all locations of graphs are stored in Graph_Location as {"x":"X","y":"X"}
        for(var metabolite_name in selectMID){
            Graph_Location[metabolite_name]={}    //defines Graph_Location[metabolite_name] as an object
            for(var fragment_name in selectMID[metabolite_name]){
                Graph_Location[metabolite_name][fragment_name]= {
                                                 "MID" :{"x":"X","y":"X"},
                                                 "stacked_MID" :{"x":"X","y":"X"},
                                                 "abundance" :{"x":"X","y":"X"},
                                                 "stacked_abundance" :{"x":"X","y":"X"},
                                                 "total_abundance" :{"x":"X","y":"X"},
                                                 "MPE" :{"x":"X","y":"X"},
                                                 "Kin_abundance" :{"x":"X","y":"X"},
                                                 "Kin_MPE" :{"x":"X","y":"X"}
                                                };
                for(M_index=0; M_index< selectMID[metabolite_name][fragment_name].length; M_index++){ //adds MID and abundance locations for individual mass isotopologues to Graph_Locations
                     select_iso_MID_location="MID_M"+M_index.toString();
                     select_kin_iso_MID_location="Kin_MID_M"+M_index.toString();
                     select_iso_abundance_location="abundance_M"+M_index.toString();
                     select_kin_iso_abundance_location="Kin_abundance_M"+M_index.toString();                    
                     Graph_Location[metabolite_name][fragment_name][select_iso_MID_location]={"x":"X","y":"X"}
                     Graph_Location[metabolite_name][fragment_name][select_kin_iso_MID_location]={"x":"X","y":"X"}
                     Graph_Location[metabolite_name][fragment_name][select_iso_abundance_location]={"x":"X","y":"X"}
                     Graph_Location[metabolite_name][fragment_name][select_kin_iso_abundance_location]={"x":"X","y":"X"}
                }
            }
        }
    } 

    if(typeof Graph_Attribute == "undefined"){   //defines Group_Location in case it is not included in the user uploaded file, likely the case if the user is uploading data for the first time
        Graph_Attribute={} //stores the x,y coordinates of all graphs displayed on the page
        //Initially all locations of graphs are stored in Graph_Attribute as {"x":"X","y":"X"}
        for(var metabolite_name in selectMID){
            Graph_Attribute[metabolite_name]={}    //defines Graph_Attribute[metabolite_name] as an object
            for(var fragment_name in selectMID[metabolite_name]){
                fragment_name_cap=fragment_name.charAt(0).toUpperCase() + fragment_name.slice(1)
                Graph_Attribute[metabolite_name][fragment_name]= {
                                                 "MID" :{"scale":1.75,"height_scale":1,"width_scale":1,"color_index":0, "title":fragment_name_cap+" MID", "yaxis_label":"% Label"},
                                                 "stacked_MID" :{"scale":1.75,"height_scale":1,"width_scale":1,"color_index":0, "title":fragment_name_cap+" MID", "yaxis_label":"% Label"},
                                                 "abundance" :{"scale":1.75,"height_scale":1,"width_scale":1,"color_index":0, "title":fragment_name_cap+" Abundance", "yaxis_label":"Counts"},
                                                 "stacked_abundance" :{"scale":1.75,"height_scale":1,"width_scale":1,"color_index":0, "title":fragment_name_cap+" Abundance", "yaxis_label":"Counts"},
                                                 "total_abundance" :{"scale":1.75,"height_scale":1,"width_scale":1,"color_index":0, "title":fragment_name_cap+" Abundance", "yaxis_label":"Counts"},
                                                 "MPE" :{"scale":1.75,"height_scale":1,"width_scale":1,"color_index":0, "title":fragment_name_cap+" MPE", "yaxis_label":"% Enrichment"},
                                                 "Kin_abundance" :{"scale":1.75,"height_scale":1,"width_scale":1,"color_index":0, "title":fragment_name_cap+" Kinetic Abundance", "yaxis_label":"Counts"},
                                                 "Kin_MPE" :{"scale":1.75,"height_scale":1,"width_scale":1,"color_index":0, "title":fragment_name_cap+" Kinetic MPE", "yaxis_label":"% Enrichment"}                    
                                                };
                for(M_index=0; M_index< selectMID[metabolite_name][fragment_name].length; M_index++){ //adds MID and abundance locations for individual mass isotopologues to Graph_Attributes
                     select_iso_MID_location="MID_M"+M_index.toString();
                     select_kin_iso_MID_location="Kin_MID_M"+M_index.toString();
                     select_iso_abundance_location="abundance_M"+M_index.toString();
                     select_kin_iso_abundance_location="Kin_abundance_M"+M_index.toString();
                     Graph_Attribute[metabolite_name][fragment_name][select_iso_MID_location]={"scale":1.75,"height_scale":1,"width_scale":1,"color_index":0, "title":fragment_name_cap+" M"+M_index.toString(), "yaxis_label":"% Label"}
                     Graph_Attribute[metabolite_name][fragment_name][select_kin_iso_MID_location]={"scale":1.75,"height_scale":1,"width_scale":1,"color_index":0, "title":"Kinetic "+fragment_name_cap+" M"+M_index.toString(), "yaxis_label":"% Label"}
                     Graph_Attribute[metabolite_name][fragment_name][select_iso_abundance_location]={"scale":1.75,"height_scale":1,"width_scale":1,"color_index":0, "title":fragment_name_cap+" M"+M_index.toString()+" Abundance", "yaxis_label":"Counts"}
                     Graph_Attribute[metabolite_name][fragment_name][select_kin_iso_abundance_location]={"scale":1.75,"height_scale":1,"width_scale":1,"color_index":0, "title":"Kinetic "+fragment_name_cap+" M"+M_index.toString()+" Abundance", "yaxis_label":"Counts"}
                    
                }
            }
        }
    }  
    
    /*if(typeof color_set == "undefined"){   //defines color_set in case it is not included in the user uploaded file
       color_set=
          {"MID":["#4F5060","#67819D","#ADBD37","#588133","purple","gold","silver","light brown"],
          "stacked_MID":["#4F5060","#67819D","#ADBD37","#588133","purple","gold","silver","light brown"],
           "abundance":["#4F5060","#67819D","#ADBD37","#588133","purple","gold","silver","light brown"],
           "stacked_abundance":["#4F5060","#67819D","#ADBD37","#588133","purple","gold","silver","light brown"],
           "MPE":["#4F5060","#67819D","#ADBD37","#588133","purple","gold","silver","light brown"]}          

    }*/
    
    
    if(typeof color_scheme_obj == "undefined"){   //defines color_scheme_obj in case it is not included in the user uploaded file
        color_scheme_obj=[
        ["#9F9FA3","#5D77BA","#DBE3E1","#377EB8","#4DAF4A","#984EA3","#FF7F00","#FFFF33","#A65628","#F781BF"],
        ["#000000","#A9A9A9","#808080","#D3D3D3","#C0C0C0"],
        ["red","white","blue","yellow","lightblue","pink","green"],
        ["#0077B5","#66418C","#DD5143","#BD5C14","#00AEB3","#EDB220","#DC4B89","#5B912D","#606264"],
        ["#0457ac","#308fac","#37bd79","#a7e237","#f4e604","#E68523"],
        ["#281663","#e6e9ff","#edfcff","#e4f5ff","#242527"],
        ["purple","#4F5060","#67819D","#ADBD37","#588133"], ["#B50303","#8C5200","#DDC400","#ADBD01","#81BD01","#35BD00","#01A70A","#01BD8F","#00ACBD","#0174BD","#003BBD","#6061B4","#5201B4","#A000B4","#FF0014"]            
    ];
    }
    

    if(typeof graph_scale_set == "undefined"){   //defines graph_scale_set in case it is not included in the user uploaded file
        graph_scale_set={"MID":1.75,"stacked_MID":1.75,"abundance":1.75,"stacked_abundance":1.75,"MPE":1.75}        
    }

    if(typeof Condition_Times == "undefined"){ 
        Condition_Times=[];
    }
    

    if(typeof Group_Names == "undefined"){ 
        Group_Names=[];
    }


    if(typeof All_Group_Names == "undefined"){ 
        All_Group_Names=[];
    }    

    if(Condition_Times != ''){
        document.getElementById("Kin_MPE_button").style.display = "block";       
        document.getElementById("Kin_abundance_button").style.display = "block";       
    }    

    if(typeof graph_edited == "undefined"){ 
        graph_edited=[];
    }
/*
    if(typeof All_ConditionNames == "undefined"){ 
        All_ConditionNames=ConditionNames;
    } */



    if(typeof Cell_Numbers == "undefined" || Cell_Numbers.length<ConditionAmount){ 
        Cell_Numbers=[];
        for(i=0;i<ConditionAmount;i++){
           Cell_Numbers[i]=1;
        }
    }
/*    
    if(typeof All_Cell_Numbers == "undefined"){ 
        All_Cell_Numbers=[];
        for(i=0;i<All_ConditionNames.length;i++){
           All_Cell_Numbers[i]=1;
        }
    } */       

    if(typeof Isotopologue_Limit == "undefined"){
        Isotopologue_Limit={}    
        for(metab in selectMID){
            for(frag in selectMID[metab]){
                last_iso=selectMID[metab][frag].length-1
                Isotopologue_Limit[frag]=selectMID[metab][frag][last_iso].fragment
            }
        }
        //Isotopologue_Limit.pyr174="M1"
        console.log(Isotopologue_Limit)
    }

    if(typeof Std_Concentration == "undefined"){
        Std_Concentration={}    
        for(metab in selectMID){
            for(frag in selectMID[metab]){
                Std_Concentration[frag]={std_iso: "NA", std_conc:"NA"}
            }
        }
        //Isotopologue_Limit.pyr174="M1"
        console.log(Std_Concentration)
    }
    
    
    if(typeof UserInputTimeUnits == "undefined"){
        UserInputTimeUnits="";
    }
    
    if(typeof UserInputConcentrationUnits == "undefined"){
        UserInputConcentrationUnits="";
    }        
    
}//END define_undefined()
    
    if(typeof MIDs == "undefined"){
        MIDs={} //CHANGE //need to fully define a shell MIDs 
        ConditionNames=[]
        if(typeof All_MIDs == "undefined"|| All_MIDs.length<ConditionAmount){ 
            All_MIDs=MIDs;
        }         
        div_show('PopUp_file_display_List')   
    }else{
        ConditionIndex=0;  //Refers to MID1 or MID2 or etc. in the BIGGCarbonJSON file
        ConditionAmount=Object.keys(MIDs).length; //stores the total number of conditions
        selectMID=MIDs[Object.keys(MIDs)[0]];  //selects MID data of the first condition
        if(typeof All_MIDs == "undefined"|| All_MIDs.length<ConditionAmount){ 
            All_MIDs=MIDs;
        }         
        document.getElementById("selectFiles").style.display = "none";   
        document.getElementById("import").style.display = "none"; 
        document.getElementById("selectFiles_csv").style.display = "none";   
        document.getElementById("import_csv").style.display = "none";   
        document.getElementById("select_corrected_Files_csv").style.display = "none";   
        document.getElementById("import_corrected_csv").style.display = "none";         
        document.getElementById("sidenav").style.display = "block";  
        define_undefined()
        begin_graph_display() //replace w/ initilize_graphs
        initilize_graphs()        
    }
    


    function add_sortableJS_functions(e) {
        //Adds functionality of including a place_holder which communicates to the user to insert items below the place holder when sortable lists are empty

        //$(e.detail.item).css("display", "block") //makes dragged item appear in new list
        
        if (e.from.children.length < 1) { //checks to see if list where item was dragged from has less then 1 entry in it, if so adds item_place_holder list item
            if ($('#' + e.from.id).children('#item_place_holder').length < 1) { //checks to see if there are any item_place_holders located in the destination list, if not one will be added 

                $('#' + e.from.id).append(
                    '<li id="item_place_holder" class="p1 mb1 navy item sortable_list_item">Insert Items Below</li>'
                )
            }
        }
        
        if (e.to.children.length > 1) { //checks to see if list where item was dragged from has less then 1 entry in it, if so adds item_place_holder list item
            if ($('#' + e.to.id).children('#item_place_holder').length > 0) { //checks to see if there are any item_place_holders located in the destination list, if not one will be added 

                $('#' + e.to.id).children('#item_place_holder').remove()
            }
        }

    }      
    
     
    
    ///////////////File Display functions EDITED 19-05-28
    $(document).ready(function() {   
        for(i=0; i<FileNames.length; i++){ //build the list of all groups/conditions in the dataset
            $( ".all-file-list" ).append(
                    '<li class="p1 mb1 navy item sortable_list_item" data-id="'+ FileNames[i] +'" style="font-size: small;">' + FileNames[i] + '</li>');
        }
        allow_keystrokes("UserInputGroupName")          

        $('.all-file-list').sortable({        
            group: 'file-shared', // set both lists to same group
            ghostClass: "sortable-ghost",
            multiDrag: true, // Enable the plugin
            selectedClass: "selected", // Class name for selected item            
    	    //delay: 5000, // time in milliseconds to define when the sorting should start
	        //delayOnTouchOnly: true, // only delay if user is using touch        
            animation: 150,
            onSort: function (evt) {
                add_sortableJS_functions(evt)
            }
        });

        var clickcounts=0
        var list_classes=[];
        //document.querySelector('.file_organizer_submit').addEventListener('click', function () {
        document.querySelector('#submit_file_organizer_button').addEventListener('click', function () {
            /*document.getElementById("selectFiles").style.display = "none";   
            document.getElementById("import").style.display = "none";   
            document.getElementById("selectFiles_csv").style.display = "none";   
            document.getElementById("import_csv").style.display = "none";
            document.getElementById("select_corrected_Files_csv").style.display = "none";   
            document.getElementById("import_corrected_csv").style.display = "none";*/
            
        
            
            remove_graphs("remove_graphs_only")//removes all currently displayed graphs
            fileorganizer={}
            ConditionNames=[]
            for(j=1;j<list_classes.length+1;j++){
               /* var classString=list_classes[j-1] 
                let serialized = sortable('#'+classString, 'serialize') //stores the file names of the current list selection
                var items_to_reorder=[]
                this_list=classString.replace('_','_title_') //obtains the list ID of the current list selection
                this_condition=document.getElementById(this_list).innerText //obtains the condition name from the span of this_list
                ConditionNames.push(this_condition)
                fileorganizer[this_condition]=[] //initializes an object (named after the condition name) that will store the file names corresponding to this_condition                 

                for (i=0; i<serialized[0].items.length;i++){ //loop through the file names located in the current list selection and store the filenames in fileorganizer[this_condition]
                    items_to_reorder[i]=serialized[0].items[i].name
                    fileorganizer[this_condition].push(items_to_reorder[i])
                }//create some mechanism for storing groups and group names
                */
                var classString=list_classes[j-1] 
                //let serialized = sortable('#'+classString, 'serialize') //stores the file names of the current list selection
                
                serialized = $('#'+classString)[0].children
                var items_to_reorder=[] //will contain the user specified groups to visualize in order                    
                for (i=0; i<serialized.length;i++){
                    items_to_reorder[i]=serialized[i].innerText
                }                   
                
                //var items_to_reorder = $('#'+classString).sortable('toArray')
                this_list=classString.replace('_','_title_') //obtains the list ID of the current list selection
                this_condition=document.getElementById(this_list).innerText //obtains the condition name from the span of this_list
                ConditionNames.push(this_condition)
                fileorganizer[this_condition]=[] //initializes an object (named after the condition name) that will store the file names corresponding to this_condition                 

                for (i=0; i<items_to_reorder.length;i++){ //loop through the file names located in the current list selection and store the filenames in fileorganizer[this_condition]
                    fileorganizer[this_condition].push(items_to_reorder[i])
                }//create some mechanism for storing groups and group names
                
                                
            }
            
            Condition_Times=[]
	        Group_Names=[]
            All_Group_Names=[]            
            Graph_Location=reset_kinetic_graph_locations()
            graph_edited=false
            load_TimeGroupDisplay_PopUp()
            document.getElementById("Kin_MPE_button").style.display = "none";       
            document.getElementById("Kin_abundance_button").style.display = "none";            
	        //Graph_Location=[]            
            
            All_ConditionNames=ConditionNames
            Generate_MIDs_Shell()
            //if(document.getElementById("import").style.display=="block"){
            if(document.getElementById("sidenav").style.display!="block"){
                GenerateMID(fileorganizer,"first_run")
            }else{
                GenerateMID(fileorganizer,"reinitilize")
            }

            //GenerateMID(fileorganizer)
            //sortable('.sortable', 'disable'); //AKSortTest
            div_hide('PopUp_file_display_List')   
            document.getElementById("sidenav").style.display = "block"; 
            


        })
        
        function reset_kinetic_graph_locations(){

                for(met_name_reset in Graph_Location){
                    //Graph_Location[met_name_reset]={}    //defines Graph_Location[met_name_reset] as an object
                    for(frag_name_reset in Graph_Location[met_name_reset]){
                        Graph_Location[met_name_reset][frag_name_reset].Kin_abundance={"x":'X', "y":'X'}
                        Graph_Location[met_name_reset][frag_name_reset].Kin_MPE={"x":'X', "y":'X'}

                        for(M_index_reset=0; M_index_reset< Graph_Location[met_name_reset][frag_name_reset].length; M_index_reset++){ //adds MID and abundance locations for individual mass isotopologues to Graph_Locations
                             select_iso_MID_location="MID_M"+M_index_reset.toString();
                             select_kin_iso_MID_location="Kin_MID_M"+M_index_reset.toString();
                             select_iso_abundance_location="abundance_M"+M_index_reset.toString();
                             select_kin_iso_abundance_location="Kin_abundance_M"+M_index_reset.toString();
                             Graph_Location[met_name_reset][frag_name_reset][select_iso_MID_location]={"x":"X","y":"X"}
                             Graph_Location[met_name_reset][frag_name_reset][select_kin_iso_MID_location]={"x":"X","y":"X"}
                             Graph_Location[met_name_reset][frag_name_reset][select_iso_abundance_location]={"x":"X","y":"X"}
                             Graph_Location[met_name_reset][frag_name_reset][select_kin_iso_abundance_location]={"x":"X","y":"X"}
                        }
                    }
                }
            return Graph_Location
        }
        

        //document.querySelector('.Add_List').addEventListener('click', function () {
        document.getElementById('Add_List').addEventListener('click', function () {
            clickcounts++
            var UserInputGroupName = document.getElementById("UserInputGroupName").value; //.value gets input values
            document.getElementById("UserInputGroupName").value = ""; //reset the UserInputGroupName input field
            
            $( ".list-of-lists").append(
                //'<div class="col col-2">'+
                '<div class="col col-4">'+
                    '<span id=list_title_'+clickcounts.toString()+' style="font-size: medium; font-weight: bold" class="ml2">'+UserInputGroupName+'</span>'+
                   /* '<ul class="ml2 col-10 list_'+ clickcounts.toString() +' sortable list flex flex-column list-reset group_list" id="new_list">'+*/
                    '<ul class="ml2 col-10 new_list sortable list flex flex-column list-reset group_list" id="list_'+ clickcounts.toString() +'">'+                
                            '<li id="item_place_holder" class="p1 mb1 navy item sortable_list_item">Insert Items Below</li>'+
                           /* '<li id=list_title_'+clickcounts.toString()+' draggable="false" style="z-index: 10; position: absolute; font-size: medium; font-weight: bold">'+UserInputGroupName+'</li>'+ */               
                            /*'<li class="p1 mb1 navy" style="position: relative; margin-top: -25px; z-index: 10" id=list_title_'+clickcounts.toString()+'>'+ UserInputGroupName +'</li>'+*/
                    '</ul>'+
                '</div> '      
            );            

            list_classes.push('list_'+ clickcounts.toString())

            //START Add remove button to group Name
            var entry=document.getElementById('list_title_'+clickcounts.toString())
            var removeGroupImg = document.createElement('img'); 
                removeGroupImg.setAttribute('src','close_x.png');
                removeGroupImg.setAttribute('height','15px');
                removeGroupImg.setAttribute('width','15px');
                //removeGroupImg.setAttribute('onclick','removeGroup("'+'list_'+clickcounts.toString()+'")');
                removeGroupImg.onclick=function(){
                    
                    //ul_class=$(this).parent().attr('id');
                    ul_class=$(this).parent().attr('id').replace("title_","") //19-05-27 will likeley need to alter this as well since moving span from in laist to outside of list
                    removeGroup(ul_class,list_classes)
                }
                entry.appendChild(removeGroupImg);
            //END Add remove button to group Name

            $('.new_list').sortable({
                group: 'file-shared',
                ghostClass: "sortable-ghost", 
                multiDrag: true, // Enable the plugin
                selectedClass: "selected", // Class name for selected item                  
                animation: 150,
                onSort: function (evt) {
                    add_sortableJS_functions(evt)
                }            
            });          
            //document.getElementById("list_"+ clickcounts.toString()).addEventListener('sortupdate', function(e) {

        })

        $('#close_file_organize_display').click( function() {
            //sortable('.sortable', 'disable'); //AKSortTest            
            div_hide('PopUp_file_display_List')            
        });
    })

    
    
    function removeGroup(ul_id,list_classes){
        list_classes.splice(list_classes.indexOf(ul_id), 1);
        
        //order1 = $('.'+ul_class).sortable('toArray')
        //let serialized = sortable('#'+ul_class, 'serialize')
        
        serialized = $('#'+ul_id)[0].children
        var items_to_reorder=[] //will contain the user specified groups to visualize in order                    
        for (i=0; i<serialized.length;i++){
            items_to_reorder[i]=serialized[i].innerText
        }         
        
        
        //var items_to_reorder = $('#'+ul_id).sortable('toArray')
        //var items_to_reorder=[] //will contain the user specified groups to visualize in order
          //for (i=0; i<serialized[0].items.length;i++){
        /*for (i=0; i<serialized[0].items.length;i++){ 
              items_to_reorder[i]=serialized[0].items[i].name
        }*/
               

        for(k=0;k<items_to_reorder.length;k++){//return list items from the canceled list to the list of files
             $( ".all-file-list").append(
                            '<li class="p1 mb1 navy item sortable_list_item" style="font-size: small;" id='+items_to_reorder[k]+' data-id='+items_to_reorder[k]+'>'+ items_to_reorder[k] +'</li>'
             );
        }

        
        var elem = document.querySelector('#'+ul_id);
        $(elem.parentNode).remove() //removes this selected list (ul) and list title (span)
        //elem.parentNode.removeChild(elem);
        //sortable('.sortable');
    }
       
    function Generate_MIDs_Shell(){
        MIDs={} //reset MIDs
        var group_counter=1;
        for(n=1;n<ConditionNames.length+1;n++){
            MIDs["MID"+n.toString()]={}
            for(metab in FileMIDs.File1){
                MIDs["MID"+n.toString()][metab]={}
                for(frag in FileMIDs.File1[metab]){
                    MIDs["MID"+n.toString()][metab][frag]=[]
                    for(j=0; j<FileMIDs.File1[metab][frag].labeling.length;j++){
                        if(j==0){
                        MIDs["MID"+n.toString()][metab][frag][j]={"fragment": "M"+(j+1).toString(),"frequency": 0, "error": 0, "abundance":0, "abundance_error":0, "total_abundance":0, "total_abundance_error":0}
                            
                        }else{
                        MIDs["MID"+n.toString()][metab][frag][j]={"fragment": "M"+(j+1).toString(),"frequency": 0, "error": 0, "abundance":0, "abundance_error":0}
                        }
                    }
                }
            }
        }
    }  

    function GenerateMID(fileorganizer,mode){
        
        ConditionIndex=0;  //Refers to MID1 or MID2 or etc. in the BIGGCarbonJSON file
        ConditionAmount=ConditionNames.length; //stores the total number of conditions
        
        
        if(typeof All_ConditionNames == "undefined"){ 
            All_ConditionNames=ConditionNames;
        }         
        
        
        if(typeof Cell_Numbers == "undefined" || Cell_Numbers.length<ConditionAmount){ 
            Cell_Numbers=[];
            for(i=0;i<ConditionAmount;i++){
               Cell_Numbers[i]=1;
            }
        }   
        if(typeof All_Cell_Numbers == "undefined"){ 
            All_Cell_Numbers=[];
            for(i=0;i<All_ConditionNames.length;i++){
               All_Cell_Numbers[i]=1;
            }
        }
           
        
        
        console.log(MIDs)
        for(var metab in FileMIDs.File1){
            for(var frag in FileMIDs.File1[metab]){                
                for(j=0; j<FileMIDs.File1[metab][frag].labeling.length;j++){
                    var total_abundance_array=[]                    
                    var isotopologue=FileMIDs.File1[metab][frag].labeling[j].fragment
                    MIDcount=0;
                    //for(var file_cat in fileorganizer){
                    for(c_i=0; c_i<ConditionNames.length; c_i++){
                        file_cat=ConditionNames[c_i]
                    
                        MIDcount++
                        var frequency_array=[]
                        var abundance_array=[]
                        var total_abundance_array=[]
                        for(l=0;l< fileorganizer[file_cat].length; l++){
                            file_id=fileorganizer[file_cat][l]
                            file_index=FileNames.indexOf(file_id)
                            file_string="File"+(file_index+1).toString()
                            frequency_array.push(FileMIDs[file_string][metab][frag].labeling[j].frequency)
                            if(norm_frag!="undefined"){      
                                abundance_array.push(FileMIDs[file_string][metab][frag].abundance/FileMIDs[file_string][norm_metab][norm_frag].abundance*FileMIDs[file_string][metab][frag].labeling[j].frequency)
                                    if(j==0){
                                        total_abundance_array.push(FileMIDs[file_string][metab][frag].abundance/FileMIDs[file_string][norm_metab][norm_frag].abundance)
                                    }
                            }else{
                                abundance_array.push(FileMIDs[file_string][metab][frag].abundance*FileMIDs[file_string][metab][frag].labeling[j].frequency)
                                if(j==0){
                                    total_abundance_array.push(FileMIDs[file_string][metab][frag].abundance)
                                }
                            } 
                        }
                        MIDs["MID"+MIDcount.toString()][metab][frag][j].fragment=isotopologue
                        MIDs["MID"+MIDcount.toString()][metab][frag][j].frequency=math.round(math.mean(frequency_array),5)
                        MIDs["MID"+MIDcount.toString()][metab][frag][j].error=math.round(math.std(frequency_array),5)
                        //MIDs["MID"+MIDcount.toString()][metab][frag][j].abundance=math.mean(abundance_array)
                        //MIDs["MID"+MIDcount.toString()][metab][frag][j].abundance_error=math.std(abundance_array)
                        MIDs["MID"+MIDcount.toString()][metab][frag][j].abundance=roundTo((math.mean(abundance_array)/Cell_Numbers[MIDcount-1]),5)
                        MIDs["MID"+MIDcount.toString()][metab][frag][j].abundance_error=roundTo(math.std(abundance_array)/Cell_Numbers[MIDcount-1],5)                        
                        //MIDs["MID"+MIDcount.toString()][metab][frag][j].abundance=math.round(math.mean(abundance_array))
                        //MIDs["MID"+MIDcount.toString()][metab][frag][j].abundance_error=math.round(math.std(abundance_array))
                        if(j==0){
                            //MIDs["MID"+MIDcount.toString()][metab][frag][j].total_abundance=math.mean(total_abundance_array)
                            //MIDs["MID"+MIDcount.toString()][metab][frag][j].total_abundance_error=math.std(total_abundance_array)
                            //MIDs["MID"+MIDcount.toString()][metab][frag][j].total_abundance=math.round(math.mean(total_abundance_array))
                            //MIDs["MID"+MIDcount.toString()][metab][frag][j].total_abundance_error=math.round(math.std(total_abundance_array))
                            MIDs["MID"+MIDcount.toString()][metab][frag][j].total_abundance=roundTo(math.mean(total_abundance_array)/Cell_Numbers[MIDcount-1],5)
                            MIDs["MID"+MIDcount.toString()][metab][frag][j].total_abundance_error=roundTo(math.std(total_abundance_array)/Cell_Numbers[MIDcount-1],5)                            
                            
                        }
                    }
                }
            }
        }

        //normalize abundances to normalizing condition (norm_cond)
        if(norm_cond!="undefined" && All_ConditionNames.indexOf(norm_cond)!=-1){ //ensures that norm_cond isn't undefined and that it is located in All_ConditionNames inorder to continue
            var norm_cond_all_index=All_ConditionNames.indexOf(norm_cond) //    MAY STILL NEED TO MODIFY THE SCRIPT BELOW TO ALTER All_MIDs AS WELL TO ACCOUNT FOR
            var norm_cond_index=ConditionNames.indexOf(norm_cond)
            var norm_MIDname="MID"+(norm_cond_index+1).toString()
           // var MID_norm=MIDs[norm_MIDname] //this doesn't work because all this is doing is creating a variable which references the same object
            MID_norm=JSON.parse(JSON.stringify(MIDs[norm_MIDname])) //to create a "deep copy" of an object which is independent, need to perform a parse+stringify to effectively copy the object and save it on its own
            
            var norm_cond_total_abundance=0
            var norm_cond_total_abundance_error=0
            
            for(var MIDcount in MIDs){
                for(var metab in MIDs[MIDcount]){
                    for(var frag in MIDs[MIDcount][metab]){
                        norm_cond_total_abundance=MID_norm[metab][frag][0].total_abundance
                        norm_cond_total_abundance_error=MID_norm[metab][frag][0].total_abundance_error
                        for(j=0; j<MIDs[MIDcount][metab][frag].length;j++){
                            MIDs[MIDcount][metab][frag][j].abundance=roundTo(MIDs[MIDcount][metab][frag][j].abundance/norm_cond_total_abundance,5)
                            MIDs[MIDcount][metab][frag][j].abundance_error=roundTo(MIDs[MIDcount][metab][frag][j].abundance_error/norm_cond_total_abundance,5) //currently simply scaling error down by the norm_cond_total_abundance
                            if(j==0){
                                MIDs[MIDcount][metab][frag][j].total_abundance=roundTo(MIDs[MIDcount][metab][frag][j].total_abundance/norm_cond_total_abundance,5)
                                MIDs[MIDcount][metab][frag][j].total_abundance_error=roundTo(MIDs[MIDcount][metab][frag][j].total_abundance_error/norm_cond_total_abundance,5) //currently simply scaling error down by the norm_cond_total_abundance
                            }                            
                        }

                    }
                }

            }
            
            //normalize All_MIDs to the norm MID, not sure if this is neccessary as no normalization occurs on All_MIDs, think about this further and relationship between fileorganizer+All_MIDs
            /*for(var MIDcount in All_MIDs){
                for(var metab in All_MIDs[MIDcount]){
                    for(var frag in All_MIDs[MIDcount][metab]){
                        norm_cond_total_abundance=MID_norm[metab][frag][0].total_abundance
                        norm_cond_total_abundance_error=MID_norm[metab][frag][0].total_abundance_error
                        for(j=0; j<All_MIDs[MIDcount][metab][frag].length;j++){
                            All_MIDs[MIDcount][metab][frag][j].abundance=roundTo(All_MIDs[MIDcount][metab][frag][j].abundance/norm_cond_total_abundance,5)
                            All_MIDs[MIDcount][metab][frag][j].abundance_error=roundTo(All_MIDs[MIDcount][metab][frag][j].abundance_error/norm_cond_total_abundance,5) //currently simply scaling error down by the norm_cond_total_abundance
                            if(j==0){
                                All_MIDs[MIDcount][metab][frag][j].total_abundance=roundTo(All_MIDs[MIDcount][metab][frag][j].total_abundance/norm_cond_total_abundance,5)
                                All_MIDs[MIDcount][metab][frag][j].total_abundance_error=roundTo(All_MIDs[MIDcount][metab][frag][j].total_abundance_error/norm_cond_total_abundance,5) //currently simply scaling error down by the norm_cond_total_abundance
                            }                            
                        }

                    }
                }

            }*/            
            
            
            
        }else{
            norm_cond="undefined" //ensures norm_cond="undefined" if it was not located in All_Conditions
        }
        
        /*
        ConditionIndex=0;  //Refers to MID1 or MID2 or etc. in the BIGGCarbonJSON file
        ConditionAmount=Object.keys(MIDs).length; //stores the total number of conditions
        if(typeof Cell_Numbers == "undefined" || Cell_Numbers.length<ConditionAmount){ 
            Cell_Numbers=[];
            for(i=0;i<ConditionAmount;i++){
               Cell_Numbers[i]=1;
            }
        }   
        if(typeof All_Cell_Numbers == "undefined"){ 
            All_Cell_Numbers=[];
            for(i=0;i<All_ConditionNames.length;i++){
               All_Cell_Numbers[i]=1;
            }
        }        
        */
        
        
        selectMID=MIDs[Object.keys(MIDs)[0]];  //selects MID data of the first condition
        All_MIDs=MIDs
        console.log(MIDs)
        define_undefined()
        
        
        if(mode=="first_run"){
            begin_graph_display()
            initilize_graphs()            
        //div_hide('PopUp_file_display_List')
        }
        
        if(mode=="reinitilize"){
            load_PopUps()
            initilize_graphs("CG_present")//by inputing "CG_present", custom graphs will not be reprinted
        }
        
    }   
  
///////////////END File Display Stuff        

       
    //Function to Show Popup
    function div_show(table_string) {
            document.getElementById(table_string).style.display = "block";
            }
    //Function to Hide Popup
    function div_hide(table_string){
            document.getElementById(table_string).style.display = "none";
    };
    
    
    
///////////////////////////////////Define Popups
    function load_PopUps(){
        load_TimeCourse_PopUp()
        load_CellNumber_PopUp()
        load_GroupDisplay_PopUp()
        load_color_picker_PopUp()
        load_ConditionName_PopUp()
        load_custom_graphs_PopUp()
    }      

///////////////TimeCourse functions
 //     $(document).ready(function() {
    function load_TimeCourse_PopUp(){
          $("#TimePoint_Table tbody").empty() //remove any previously entered elements of the table
        

        if ($.fn.DataTable.isDataTable("#TimePoint_Table")) {
              $("#TimePoint_Table").DataTable().clear().destroy();
        }        
        
         for(i=0; i<ConditionNames.length; i++){ //build the table, 4 columns (Condition Name, exp_condition, timepoint, time_unit)
             if(Condition_Times != ''){
                $( "#TimePoint_Table tbody" ).append( '<tr class="table_element">' +
                        '<td style="font-size: small; font-family: Arial, Helvetica, sans-serif">' + ConditionNames[i] + "</td>" +
                        '<td><input type="text" id="row-'+i+'-exp_condition" name="row-'+i+'-exp_condition" value='+Condition_Times[i].group_name+'></td>'+
                        '<td><input type="text" id="row-'+i+'-timepoint" name="row-'+i+'-timepoint" style="width: 50px;" value='+Condition_Times[i].timepoint+'></td>'+
                        "</tr>" );

                 $("#UserInputTimeUnits").value=UserInputTimeUnits;
             
                 
             }else{
                $( "#TimePoint_Table tbody" ).append( '<tr class="table_element">' +
                        '<td style="font-size: small; font-family: Arial, Helvetica, sans-serif">' + ConditionNames[i] + "</td>" +
                        '<td><input type="text" id="row-'+i+'-exp_condition" name="row-'+i+'-exp_condition"></td>'+
                        '<td><input type="text" id="row-'+i+'-timepoint" name="row-'+i+'-timepoint" style="width: 50px;"></td>'+
                        "</tr>" ); 
             }
             
             
            input_selector='row-'+i+'-timepoint' 
            setInputFilter(document.getElementById(input_selector), function(value) {
                return /^\d*$/.test(value);
            }); //restricts time point inputs in TimePoint_Table to numbers             
             
        }
    
        //var table_time = $('#TimePoint_Table').DataTable({ //use of DataTable.js API with slightly altered options 
         table_time = $('#TimePoint_Table').DataTable({ //use of DataTable.js API with slightly altered options 
            "retrieve": true,
            "paging":   false, 
            "ordering": false,
            "searching": false,
            "deferRender":    true,
            "scrollY":        350,
            "scrollCollapse": true,
            "scroller":       true           
             
        }); /////AK: As of 18-07-05 Cannot type in 0 or 1 into table inputs? ->Because esher already assigns zoom functionality to these keys

        allow_keystrokes("TimePoint_Table")   
        allow_keystrokes("UserInputTimeUnits")          

    }
        $('#submit_TimePoint_Table_button').click( function() {
            data_time = table_time.$('input, select').serialize();
            //table_time.clear()
            div_hide('PopUp_TimePoint_Table') //closes popup upon click of submit_TimePoint_Table_button

            Condition_Times=process_TimePoint_Table_data(data_time); //sets the variable Condition_times which carriers allows for reorganization of data, specifically Condition_Names into a form condusive for plotting kinetic data (links time points to experimental conditions)
            
            //define Group_Names and Time_Points here AK 19-10-02
            //var All_Group_Names=[]
            //var Time_Points=[]
            //var max_time_point=0;
            //var color=["red","blue","green","purple","orange","yellow","grey","black"]
            //var color=["#B50303","#8C5200","#DDC400","#ADBD01","#81BD01","#35BD00","#01A70A","#01BD8F","#00ACBD","#0174BD","#003BBD","#6061B4","#5201B4","#A000B4","#FF0014"]
            //var circle_radius=4*graph_scale*graph_width_scale;    

            All_Group_Names=[] //resets All_Group_Names
            for(i=0;i<Condition_Times.length;i++){
                if (All_Group_Names.indexOf(Condition_Times[i].group_name) < 0) {
                    All_Group_Names.push(Condition_Times[i].group_name)    
                }
                /*if (Time_Points.indexOf(Condition_Times[i].timepoint) < 0) {
                    Time_Points.push(Condition_Times[i].timepoint)
                    if(Condition_Times[i].timepoint>max_time_point){
                        max_time_point=Condition_Times[i].timepoint;
                    }
                }*/
            }             
            
            
            load_TimeGroupDisplay_PopUp()
            div_show('PopUp_time_group_display_List') //closes popup upon click of submit_TimePoint_Table_button
            
            /*
            document.getElementById("Kin_MPE_button").style.display = "block";       
            document.getElementById("Kin_abundance_button").style.display = "block";       
            reprint_graphs() //reprint graphs with updated menu including kinetic options
            */

            
            return false;
        } );
        
        $('#close_popup').click( function() {
            div_hide('PopUp_TimePoint_Table')

        } );

        function process_TimePoint_Table_data(data){ //extracts information TimePoint_Table and returns Condition_Times
            timepoint_data=data.split("&")
            console.log(timepoint_data)
            var Condition_Times=[]
            var group_name=[]
            var timepoint=[]
           // var time_unit=[]
            var UserInputTimeUnits = document.getElementById("UserInputTimeUnits").value
            
            for(j=0;j<timepoint_data.length;j++){
                timepoint_data_split=timepoint_data[j].split("=")
                if(timepoint_data_split[0].includes("exp_condition")==true){
                    //group_name.push(timepoint_data_split[1])
                    //due to the execution of GET and POST spaces in the string are replaced with '+' and plus signs are replaced with '%2B' the following lines correct these string alterations before updating updated_condition_name
                    new_condition_name=timepoint_data_split[1].replace(/\+/g, " ") //use / /g operator to replace all instances of the string also inorder to use / /g for + signs need to input as \+
                    
                    
                    new_condition_name=decodeURIComponent(new_condition_name) //decodeURIComponent decodes URI compontents introduced by .serialize()
                
                    
                    //new_condition_name=new_condition_name.replace(/%2B/g,"+")
                    group_name.push(new_condition_name)
                }
                if(timepoint_data_split[0].includes("timepoint")==true){
                    timepoint.push(timepoint_data_split[1])
                }
                
            }

            for(k=0;k<group_name.length;k++){
                //Condition_Times[k]={"group_name": group_name[k],"timepoint": timepoint[k],"time_unit": time_unit[k],}
                Condition_Times[k]={"group_name": group_name[k],"timepoint": Number(timepoint[k]),"time_unit": UserInputTimeUnits, "condition_name": ConditionNames[k]}
            }

            return Condition_Times

        }

   // }// )
       
///////////////END TimeCourse Stuff

///////////////ConditionName pupup functions
 //     $(document).ready(function() {
    function load_ConditionName_PopUp(){
          $("#ConditionName_Table tbody").empty() //remove any previously entered elements of the table
        

        if ($.fn.DataTable.isDataTable("#ConditionName_Table")) {
              $("#ConditionName_Table").DataTable().clear().destroy();
        }        
        
        
         for(i=0; i<ConditionNames.length; i++){ //build the table, 4 columns (Condition Name, exp_condition, timepoint, time_unit)
            $( "#ConditionName_Table tbody" ).append( "<tr>" +
                    '<td style="font-size: small; font-family: Arial, Helvetica, sans-serif">' + ConditionNames[i] + "</td>" +
                    '<td><input type="text" id="row-'+i+'-condition_name" name="row-'+i+'-condition_name" value="' + ConditionNames[i] + '"></td>'                                  
            +"</tr>" );
        }
    
        //var table_time = $('#TimePoint_Table').DataTable({ //use of DataTable.js API with slightly altered options 
         table_name = $('#ConditionName_Table').DataTable({ //use of DataTable.js API with slightly altered options 
            //"retrieve": true,
            "paging":   false, 
            "ordering": false,
            "searching": false,
            "deferRender":    true,
            "scrollY":        350,
            "scrollCollapse": true,
            "scroller":       true             
        }); /////AK: As of 18-07-05 Cannot type in 0 or 1 into table inputs? ->Because esher already assigns zoom functionality to these keys

        allow_keystrokes("ConditionName_Table") 
    }

        $('#submit_ConditionName_Table_button').click( function() {
            data_name = table_name.$('input, select').serialize();
            //table_name.clear()
            div_hide('PopUp_ConditionName_Table') //closes popup upon click of submit_TimePoint_Table_button

            Updated_ConditionNames=process_ConditionName_Table_data(data_name); //sets the variable Condition_times which carriers allows for reorganization of data, specifically Condition_Names into a form condusive for plotting kinetic data (links time points to experimental conditions)
            
            console.log(Updated_ConditionNames)
            order_cn=[]
            for(i=0; i<ConditionNames.length;i++){
                order_cn[i]=All_ConditionNames.indexOf(ConditionNames[i]) //stores the indices of the visualized groups (in order) from All_ConditionNames
                    //update file organizer
                
                console.log(fileorganizer)
                if (ConditionNames[i] !== Updated_ConditionNames[i]) { //if ConditionNames[i] has been altered, update the key of fileorganizer
                    Object.defineProperty(fileorganizer, Updated_ConditionNames[i],
                    Object.getOwnPropertyDescriptor(fileorganizer, ConditionNames[i]));
                    delete fileorganizer[ConditionNames[i]];
                }            
                console.log(fileorganizer)
                
                
                
                
                ConditionNames[i]=Updated_ConditionNames[i] //updates ConditionNames with the new names located in Updated_ConditionNames 
                All_ConditionNames[order_cn[i]]=Updated_ConditionNames[i] //updates All_ConditionNames with the new names located in Updated_ConditionNames 

                
            }            
            
            load_PopUps() //resets popups with updated condition names
            reprint_graphs() //reprint graphs with updated condition names

            return false;
        } );
        
        $('#close_popup_conditionname').click( function() {
            div_hide('PopUp_ConditionName_Table')
        } );

        function process_ConditionName_Table_data(data){ //extracts information TimePoint_Table and returns Condition_Times
            conditionname_data=data.split("&")
            console.log(conditionname_data)
            var updated_condition_name=[]
            for(j=0;j<conditionname_data.length;j++){
                conditionname_data_split=conditionname_data[j].split("=")
                if(conditionname_data_split[0].includes("condition_name")==true){
                    //due to the execution of GET and POST spaces in the string are replaced with '+' and plus signs are replaced with '%2B' the following lines correct these string alterations before updating updated_condition_name
                    
                    
                    new_condition_name=conditionname_data_split[1].replace(/\+/g, " ") //use / /g operator to replace all instances of the string also inorder to use / /g for + signs need to input as \+
                    
                    //new_condition_name=new_condition_name.replace(/%2B/g,"+")

                    new_condition_name=decodeURIComponent(new_condition_name) //decodeURIComponent decodes URI compontents introduced by .serialize()
                    
                    updated_condition_name.push(new_condition_name)
                }
            }

            return updated_condition_name

        }

   // }// )
       
///////////////END ConditionName pupup Stuff
    

///////////////CellNumber Stuff
    function load_CellNumber_PopUp(){          
          $("#Normalize_Table tbody").empty() //remove any previously entered elements of the table
          $("#Normalize_Condition_Table tbody").empty() //remove any previously entered elements of the table
          $("#CellNumber_Table tbody").empty() //remove any previously entered elements of the table

        
        if ($.fn.DataTable.isDataTable("#Normalize_Table")) {
              $("#Normalize_Table").DataTable().clear().destroy();
        }
        if ($.fn.DataTable.isDataTable("#Normalize_Condition_Table")) {
              $("#Normalize_Condition_Table").DataTable().clear().destroy();
        }        
        if ($.fn.DataTable.isDataTable("#CellNumber_Table")) {
              $("#CellNumber_Table").DataTable().clear().destroy();
        }        
        
          var Norm_Table_str='';
          //MIDs[Object.keys(MIDs)[0]
            for(var metab_name in selectMID){ //build the table, 1 columns (Frag_name))
                    for(var frag_name in selectMID[metab_name]){
                        //Norm_Table_str=Norm_Table_str+'<option value='+frag_name+' selected="selected">'+frag_name+'</option>'}}  
                        Norm_Table_str=Norm_Table_str+'<option value='+frag_name+'>'+frag_name+'</option>'}
            }  
          
        $( "#Normalize_Table tbody" ).append( '<tr>' +
            '<td><select size="1" id="row-0-norm_metab" name="row-0-norm_metab">'+
                '<option value=N/A>N/A</option>'+                        
                Norm_Table_str+
                //'<option value=N/A selected="selected">N/A</option>'+
               // '<option value=N/A>N/A</option>'+
            '</select></td> '
            +"</tr>");
        
        table_norm = $('#Normalize_Table').DataTable({ //use of DataTable.js API with slightly altered options 
        "retrieve": true,
        "paging":   false, 
        "ordering": false,
        "searching": false,
        "bInfo" : false                       
        }); /////AK: As of 18-07-05 Cannot type in 0 or 1 into table inputs? ->Because esher already assigns zoom functionality to these keys

          var Norm_Condition_Table_str='';
          //MIDs[Object.keys(MIDs)[0]
            for(k=0; k<ConditionNames.length;k++){ //build the table, 1 columns (Frag_name))
                //Norm_Condition_Table_str=Norm_Condition_Table_str+'<option value="'+ConditionNames[k]+'">"'+ConditionNames[k]+'"</option>'
                Norm_Condition_Table_str=Norm_Condition_Table_str+'<option value="'+ConditionNames[k]+'">'+ConditionNames[k]+'</option>'
            }          
        $( "#Normalize_Condition_Table tbody" ).append( '<tr>' +
            '<td><select size="1" id="row-0-norm_metab" name="row-0-norm_metab">'+
                '<option value=N/A>N/A</option>'+                        
                Norm_Condition_Table_str+
                //'<option value=N/A selected="selected">N/A</option>'+
               // '<option value=N/A>N/A</option>'+
            '</select></td> '
            +"</tr>");
        
        table_norm_cond = $('#Normalize_Condition_Table').DataTable({ //use of DataTable.js API with slightly altered options 
        "retrieve": true,
        "paging":   false, 
        "ordering": false,
        "searching": false,
        "bInfo" : false           
        }); /////AK: As of 18-07-05 Cannot type in 0 or 1 into table inputs? ->Because esher already assigns zoom functionality to these keys
        
          
         for(i=0; i<ConditionNames.length; i++){ //build the table, 2 columns (Condition Name, cell_number)
            if(typeof Cell_Numbers[i] == "undefined"){
                Cell_Numbers[i]=1; //prevents issues when new group is added in fileorganizer that has no attached cell number
            }

            $( "#CellNumber_Table tbody" ).append( '<tr class="table_element">' +
                    "<td>" + ConditionNames[i] + "</td>" +
                    '<td><input type="text" value='+Cell_Numbers[i].toString()+' id="row-'+i+'-cell_number" name="row-'+i+'-cell_number"></td>'                                  
            +"</tr>" );
             
            input_selector='row-'+i+'-cell_number' 
            setInputFilter(document.getElementById(input_selector), function(value) {
                return /^\d*$/.test(value);
            }); //restricts inputs in CellNumber_Table to numbers            
             
             
        }        
         table_cellnum = $('#CellNumber_Table').DataTable({ //use of DataTable.js API with slightly altered options
            "retrieve": true, //prevents table from being reinitialized
            "paging":   false, 
            "ordering": false,
            "searching": false,
            "deferRender":    true,
            "scrollX": '100%',
            "scrollY": 200,
            "scrollCollapse": true,
            "scroller":       true               
        }); /////AK: As of 18-07-05 Cannot type in 0 or 1 into table inputs? ->Because esher already assigns zoom functionality to these keys
        $('a[data-toggle="tab"]').on('shown.bs.tab', function(e){
           $($.fn.dataTable.tables(true)).DataTable()
              .scroller.measure();
        });
        allow_keystrokes("CellNumber_Table")  
 
          //var submit_click=0
    }
        $('#submit_CellNumber_Table_button').click( function() {
            //submit_click++
            //console.log("submit_click "+submit_click)
            data_cellnum = table_cellnum.$('input, select').serialize();
            data_norm = table_norm.$('input, select').serialize();
            data_norm_cond = table_norm_cond.$('input, select').serialize();
            Cell_Numbers=process_CellNumber_Table_data(data_cellnum);
            All_Cell_Numbers=update_All_Cell_Numbers(Cell_Numbers)
            normalized_output=process_Normalize_Table_data(data_norm)
            normalized_cond_output=process_Normalize_Condition_Table_data(data_norm_cond)
            norm_frag=normalized_output[0]
            norm_metab=normalized_output[1]
            norm_cond=normalized_cond_output
            
            //remove_graphs("remove_graphs_only") //removes all graphs from the page without resetting Graph_Location

            Generate_MIDs_Shell()
            //GenerateMID(fileorganizer,"OnlyMIDs") 
            GenerateMID(fileorganizer) 
            reprint_graphs()
            div_hide('PopUp_CellNumber_Table') //closes popup upon click of submit_TimePoint_Table_button
            return false;

        })  
 
        $('#close_popup_cellnumber').click( function() {
            div_hide('PopUp_CellNumber_Table')
        } );

        function process_CellNumber_Table_data(data){ //extracts information TimePoint_Table and returns Condition_Times
            Cell_Numbers_data=data.split("&")
            Cell_Numbers=[]

            for(j=0;j<Cell_Numbers_data.length;j++){
                Cell_Numbers_data_split=Cell_Numbers_data[j].split("=")
                if(Cell_Numbers_data_split[0].includes("cell_number")==true){
                    if (Cell_Numbers_data_split[1]==""){
                        Cell_Numbers.push(1)
                    }else{
                    Cell_Numbers.push(Number(Cell_Numbers_data_split[1]))
                    }
                }
            }

            return Cell_Numbers
        
        }
        
        function update_All_Cell_Numbers(Cell_Numbers){
            order_cn=[] 

            for(i=0; i<ConditionNames.length;i++){
                order_cn[i]=All_ConditionNames.indexOf(ConditionNames[i]) //stores the indices of the visualized groups (in order) from All_ConditionNames
            }

            for (i=0; i<order_cn.length; i++){ //resets MIDs and ConditionNames to only have the selected groups in the specified order
                All_Cell_Numbers[order_cn[i]]=Cell_Numbers[i]
            }
            console.log("All_ConditionNames "+All_ConditionNames)
            console.log("All_Cell_Numbers "+All_Cell_Numbers)
            console.log("ConditionNames "+ConditionNames)
            console.log("Cell_Numbers "+Cell_Numbers)
            return All_Cell_Numbers
        }
        
        function process_Normalize_Table_data(data_norm){
            norm_frag=data_norm.split("=")[1]
            
            if(norm_frag=="N%2FA"){ //returns norm_frag and norm_metab as undefined if N/A option is selected by user 
                norm_frag="undefined"
                norm_metab="undefined"
            }else{
            for(metab in selectMID){ //this loops defines norm_metab based on norm_frag
                for(frag in selectMID[metab]){
                    if(frag==norm_frag){
                        norm_metab=metab; 
                    }       
                }
            }
            }
            
            return[norm_frag,norm_metab]
        }
        function process_Normalize_Condition_Table_data(data_norm_cond){
            norm_cond=data_norm_cond.split("=")[1]
            
            if(norm_cond=="N%2FA"){ //returns norm_frag and norm_metab as undefined if N/A option is selected by user 
                norm_cond="undefined"
            }else{
                //due to the execution of GET and POST spaces in the string are replaced with '+' and plus signs are replaced with '%2B' the following lines correct these string alterations before updating updated_condition_name
                norm_cond=norm_cond.replace(/\+/g, " ") //use / /g operator to replace all instances of the string also inorder to use / /g for + signs need to input as \+
                norm_cond=norm_cond.replace(/%2B/g,"+")                
            }
            
            
            
            
            return norm_cond
        }        

    //}
       
///////////////END CellNumber Stuff
    
    
       
/////////////Load Custom Graphs functions

    function load_custom_graphs_PopUp(){

    /////////////Group Display functions
        $("#submit_custom_data_selection").hide(); //removes users ability to submit nonsense custom data selection

        $("#CG_all-groups-list").empty() //remove any previously entered elements of the table
        $("#CG_graph-groups-list").empty() //remove any previously entered elements of the table

        for(i=0; i<ConditionNames.length; i++){ //build the list of all groups/conditions in the dataset
            $( "#CG_all-groups-list" ).append(
                    '<li class="p1 mb1 navy item sortable_list_item" data-id='+ConditionNames[i]+'>' + ConditionNames[i] + '</li>'
                )
        }

        $( "#CG_graph-groups-list" ).append(  
                '<li id="item_place_holder" class="p1 mb1 navy item sortable_list_item" >Insert Items Below</li>'                            
        )    

        
        $('.CG_all-groups-list').sortable({
                group: 'CG-group-shared',
                ghostClass: "sortable-ghost",
                multiDrag: true, // Enable the plugin
                selectedClass: "selected", // Class name for selected item              
                animation: 150,
                onSort: function (evt) {
                    add_sortableJS_functions(evt)
                    update_norm_condition()                            
                }            
            }); 
        
        $('.CG_graph-groups-list').sortable({
                group: 'CG-group-shared',
                ghostClass: "sortable-ghost", 
                multiDrag: true, // Enable the plugin
                selectedClass: "selected", // Class name for selected item             
                animation: 150,
                onSort: function (evt) {
                    add_sortableJS_functions(evt)
                    update_norm_condition()                           
                    
                }            
            });           
        
        
        function update_norm_condition(){
             Number_groupstograph=0

            for(l=0;l<$("#CG_graph-groups-list")[0].childNodes.length;l++){
                if($("#CG_graph-groups-list")[0].childNodes[l].id !="item_place_holder"){
                    Number_groupstograph++
                }   
            }

            if(Number_groupstograph < 1){ //if there are not items in #CG_graph-groups-list or .CG_select-data-type-list then the user is instructed to check their lists
                $("#choose-norm-metab").empty()    
                $("#choose-norm-metab").append('<option value=NA>N/A</option>');                     
                
            }else{
              
                serialized = $('.CG_graph-groups-list')[0].children
                new_group_order=[] //will contain the user specified groups to visualize in order                    
                for (i=0; i<serialized.length;i++){
                    new_group_order[i]=serialized[i].innerText
                }                
                
                //new_group_order=$('.CG_graph-groups-list').sortable('toArray')
                
                $("#choose-norm-metab").empty()
                $("#choose-norm-metab").append('<option value=NA>N/A</option>');                     
                for(var ngo=0; ngo<new_group_order.length; ngo++){
                    $("#choose-norm-metab").append('<option value="'+new_group_order[ngo]+'">' + new_group_order[ngo] + "</option>");              
                }
            }             
        }
        

    /////////////END Group Display functions

    /////////////Data Type Selector Functions
        $('#choose-metab').empty();
        $('#choose-metab').append("<option>Metabolite</option>");            
        for(var metabolites in selectMID){
         $("#choose-metab").append('<option value='+metabolites+'>' + metabolites + "</option>");     
        }    

        $("#choose-metab").change(function() {
            var $dropdown = $(this);
            var key = $dropdown.val();
            var $choose_frag = $("#choose-frag");
                $choose_frag.empty();
                $choose_frag.append("<option>Fragment</option>");

            var choose_iso = $("#choose-iso");
                choose_iso.empty();
                choose_iso.append("<option>Data Type</option>");

            for(var frag in selectMID[key]){
                    $choose_frag.append('<option value='+frag+'>' + frag + "</option>");
            }

                $("#submit_custom_data_selection").hide(); //removes users ability to submit nonsense custom data selection

        });    

        $("#choose-frag").change(function() {

            var $dropdown = $(this);
            var frag = $dropdown.val();
            var metabolite=$('#choose-metab').val()
            console.log(metabolite)

            var choose_iso = $("#choose-iso");
            choose_iso.empty();
            choose_iso.append("<option>Data Type</option>");
            choose_iso.append('<option value="MPE"> MPE </option>');
            choose_iso.append('<option value="Total Abundance"> Total Abundance </option>');
            for(j=0;j<selectMID[metabolite][frag].length;j++){
                iso_string=selectMID[metabolite][frag][j].fragment
                //option_values=option_values+'<option value='+iso_string+'>'+iso_string+'</option>'
                choose_iso.append('<option value='+iso_string+'>'+iso_string+'</option>');
            }
                $("#submit_custom_data_selection").hide(); //removes users ability to submit nonsense custom data selection

        })

        $("#choose-iso").change(function() {
            var $dropdown = $(this);
            var data_type = $dropdown.val();
            var $submit_custom_data_selection = $("#submit_custom_data_selection");

            if(data_type != "Data Type"){
                $submit_custom_data_selection.show();
            }else{
                $submit_custom_data_selection.hide();
            } 

        }); 
        
        $("#CG_graph-groups-list").change(function() {
            var $dropdown = $(this);
            var data_type = $dropdown.val();
            var $submit_custom_data_selection = $("#submit_custom_data_selection");

            if(data_type != "Data Type"){
                $submit_custom_data_selection.show();
            }else{
                $submit_custom_data_selection.hide();
            } 

        });         
        
        

        $('#submit_custom_data_selection').click( function() {
            $("#submit_custom_data_selection").hide(); //removes users ability to submit nonsense custom data selection        

            metabolite=$('#choose-metab').val()
            frag=$('#choose-frag').val()
            iso=$('#choose-iso').val()
            
            //item_custom_id='/+/'+ metabolite + ' /+/ ' + frag +' /+/ '+ iso +' /+end+/'    
            item_custom_id='/+start+/'+ metabolite + ' /+/ ' + frag +' /+/ '+ iso +' /+end+/'    


            if(frag != "Fragment" || iso != "Data Type"){


                $('#choose-metab').empty();
                $('#choose-metab').append("<option>Metabolite</option>");       

                for(var metabolites in selectMID){
                 $("#choose-metab").append('<option value='+metabolites+'>' + metabolites + "</option>");     
                }  

                $('#choose-frag').empty();
                $('#choose-frag').append("<option>Fragment</option>");       

                $('#choose-iso').empty();
                $('#choose-iso').append("<option>Data Type</option>");  
    
                
                $( ".CG_select-data-type-list" ).append(
                        '<li class="p1 mb1 navy item sortable_list_item" id="'+item_custom_id+'" data-id="'+item_custom_id+'" style="font-size: small;">' + frag +' '+ iso + '</li>');  

                //add a remove button to each Data Entry
                var entry=document.getElementById(item_custom_id)  
                var removeGroupImg = document.createElement('img'); 
                removeGroupImg.setAttribute('src','close_x.png');
                removeGroupImg.setAttribute('height','15px');
                removeGroupImg.setAttribute('width','15px');
                removeGroupImg.onclick=function(){
                    entry_id=$(this).parent().attr('id')
                    var element = document.getElementById(entry_id);
                    element.parentNode.removeChild(element);
                }
                entry.appendChild(removeGroupImg);

            }
            
            $('.CG_select-data-type-list').sortable({
                    group: 'CG-data-group-shared',
                    ghostClass: "sortable-ghost",   
                    multiDrag: true, // Enable the plugin
                    selectedClass: "selected", // Class name for selected item                 
                    animation: 150,
                    onSort: function (evt) {
                        add_sortableJS_functions(evt)
                        //update_norm_condition()                           

                    }            
                });            
            

        })


    /////////////End Data Type Selector Functions
    }

        //document.querySelector('#submit_custom_graph_button').addEventListener('click',submit_custom_graph_button_click,{once: true})
        $('#submit_custom_graph_button').click(submit_custom_graph_button_click)
        function submit_custom_graph_button_click() { //this cycles through for some reason

            var Number_datalist=$(".CG_select-data-type-list")[0].childElementCount
            //var Number_groupstograph=$("#CG_graph-groups-list")[0].childNodes.length
            var Number_groupstograph=0

            for(l=0;l<$("#CG_graph-groups-list")[0].childNodes.length;l++){
                if($("#CG_graph-groups-list")[0].childNodes[l].id !="item_place_holder"){
                    Number_groupstograph++
                }   
            }

            if(Number_groupstograph < 1 || Number_datalist < 1){ //if there are not items in #CG_graph-groups-list or .CG_select-data-type-list then the user is instructed to check their lists
                alert("Make sure you have selected conditions and metabolite's to graph")
            }else{
                
                serialized = $('.CG_graph-groups-list')[0].children
                new_group_order=[] //will contain the user specified groups to visualize in order                    
                for (i=0; i<serialized.length;i++){
                    new_group_order[i]=serialized[i].innerText
                    }                    
                
                //var new_group_order=$('.CG_graph-groups-list').sortable('toArray') //will contain the user specified groups to visualize in order                    
                

                //remove "To Graph" and "Condition List" from new_group_order    
                i = new_group_order.indexOf("To Graph");
                if(i != -1) {
                    new_group_order.splice(i, 1);
                }
                i = new_group_order.indexOf("Condition List");
                if(i != -1) {
                    new_group_order.splice(i, 1);
                }          

            //item_custom_id='/+start+/'+ metabolite + ' /+/ ' + frag +' /+/ '+ iso +' /+end+/'  
                  var custom_data_order=[] //will contain the user specified groups to visualize in order                                            
                  
                  var srctext_array=$('.CG_select-data-type-list').sortable('toArray')
                  for (i=0; i<srctext_array.length;i++){
                    re1=srctext_array[i].split('/+start+/') //splits the html text of the specified item
                    re2=re1[1].split(" /+end+/")
                    custom_data_order[i]=re2[0]  //captures the text of the list item (ie the group name)                      
                  }

                CG_data=process_custom_data_list(custom_data_order) 

                CustomMIDs=Generate_CustomMIDs(new_group_order,CG_data)
                CG_container.push(CustomMIDs)
                CG_class="CG_"+CG_container.length.toString();
                if(typeof Graph_Location["CG"] == "undefined"){
                   Graph_Location["CG"]={}
                   Graph_Attribute["CG"]={}
                }
                Graph_Location["CG"][CG_class]= {"CG_graph" :{"x":100,"y":100}}
                //Graph_Attribute["CG"][CG_class]= {"CG_graph" :{"scale":1.75,"height_scale":1,"width_scale":1,"color_index":0, "title":"Custom Graph", "yaxis_label":"% Label"}
                Graph_Attribute["CG"][CG_class]= {"CG_graph" :{"scale":1.75,"height_scale":1,"width_scale":1,"color_index":0, "title":"Custom Graph", "yaxis_label":"% Label","normalized": $('#choose-norm-metab').val()}
                                                         }        

                //d3.select('#'+mass_fragment+'_'+graph_type)

                //location={x_loc:100, y_loc:100}
                //makegraph_CustomGraph(CustomMIDs,location,d3.select('.canvas-group'),CG_class);
                makegraph_CustomGraph({x_loc:100, y_loc:100},d3.select('.canvas-group'),CG_class);
                //sortable('.sortable');

                $('#choose-metab').empty();
                $('#choose-metab').append('<option selected value="base">Metabolite</option>'); 
                
                $("#choose-norm-metab").empty()
                $("#choose-norm-metab").append('<option value=NA>N/A</option>');             

                div_hide('PopUp_custom_graph')

                //document.querySelector('#submit_custom_graph_button').removeEventListener('click',submit_custom_graph_button_click) //eventlistener removed to avoid compounding of event responses
                load_custom_graphs_PopUp()
                load_GroupDisplay_PopUp()

        }
        
        

        }

        function process_custom_data_list(custom_data_order){
            //split up data by " /+/ "
            CG_data=[]
            for(k=0; k<custom_data_order.length;k++){
                split_data=custom_data_order[k].split(' /+/ ')
                CG_data[k]={"title": split_data[1]+"_"+split_data[2],"metabolite":split_data[0],"fragment":split_data[1],"datatype":split_data[2]}            
            }
            return CG_data
        }


        function Generate_CustomMIDs(new_group_order,CG_data){
            var group_counter=1;
            CustomMIDs={}
            for(n=1;n<new_group_order.length+1;n++){
                CustomMIDs["CustomMID"+n.toString()]=[]
                cond_index=ConditionNames.indexOf(new_group_order[n-1])   
                MID_obj_name="MID"+(cond_index+1).toString()            
                for(p=0;p<CG_data.length;p++){
                    CustomMIDs["CustomMID"+n.toString()][p]={}
                    if(CG_data[p].datatype=="MPE"){
                        //[MPE, MPE_error]=calculate_MPE(CG_data[p].metabolite,CG_data[p].fragment,MIDs)    
                        [MPE, MPE_error]=calculate_MPE(CG_data[p].metabolite,CG_data[p].fragment,ConditionNames)    
                        data_value=MPE[cond_index]
                        data_error=MPE_error[cond_index]                    
                    }else if(CG_data[p].datatype=="Total Abundance"){
                        data_value=MIDs[MID_obj_name][CG_data[p].metabolite][CG_data[p].fragment][0].total_abundance
                        data_error=MIDs[MID_obj_name][CG_data[p].metabolite][CG_data[p].fragment][0].total_abundance_error

                    }else{
                        data_value_index=Number(CG_data[p].datatype.split("M")[1])
                        data_value=MIDs[MID_obj_name][CG_data[p].metabolite][CG_data[p].fragment][ data_value_index].frequency
                        data_error=MIDs[MID_obj_name][CG_data[p].metabolite][CG_data[p].fragment][ data_value_index].error
                    }
                        CustomMIDs["CustomMID"+n.toString()][p]={"title":CG_data[p].title, value: data_value, error: data_error, condition: new_group_order[n-1], "x_axis_label": CG_data[p].title}
                    }
                }
            
              var norm_met_CG=$('#choose-norm-metab').val()
            
            
            //include lines for normalizing data here
            if(norm_met_CG != "NA"){
                var norm_CustomMID=""
                var custom_mid_cycle=""
                for(custom_mid_cycle in CustomMIDs){
                    if(CustomMIDs[custom_mid_cycle][0].condition == norm_met_CG){
                        norm_CustomMID=custom_mid_cycle;
                    }
                }

                //var CustomMIDs_copy=Object.assign({}, CustomMIDs)
                var CustomMIDs_copy=JSON.parse(JSON.stringify(CustomMIDs))
                
                for(custom_mid_cycle in CustomMIDs){
                    for(cm_i=0; cm_i<CustomMIDs[custom_mid_cycle].length; cm_i++){
                        CustomMIDs[custom_mid_cycle][cm_i].value=CustomMIDs_copy[custom_mid_cycle][cm_i].value/CustomMIDs_copy[norm_CustomMID][cm_i].value
                        CustomMIDs[custom_mid_cycle][cm_i].error=CustomMIDs_copy[custom_mid_cycle][cm_i].error/CustomMIDs_copy[norm_CustomMID][cm_i].value
                    }  
                }
            }
            
            
                //only allow user to normalize by a condition that will be graphed
            return CustomMIDs
            
            
        }

        $('#close_popup_custom_graph').click( function() {
                div_hide('PopUp_custom_graph')
            } );
/////////////END Load Custom Graphs functions



/////////////Group Display functions

    function load_GroupDisplay_PopUp(){

       
        $("#all-groups-list").empty() //remove any previously entered elements of the table
        $("#graph-groups-list").empty() //remove any previously entered elements of the table


        for(i=0; i<All_ConditionNames.length; i++){ //build the list of all groups/conditions in the dataset
        
        $( "#all-groups-list" ).append(
                    '<li class="p1 mb1 navy item sortable_list_item" data-id='+All_ConditionNames[i]+'>' + All_ConditionNames[i] + '</li>'
                )
        }

        $( "#graph-groups-list" ).append(  
                '<li id="item_place_holder" class="p1 mb1 navy item sortable_list_item" >Insert Items Below</li>'            
        )


        $('.all-groups-list').sortable({
                group: 'group-shared',
                ghostClass: "sortable-ghost", 
                multiDrag: true, // Enable the plugin
                selectedClass: "selected", // Class name for selected item             
                animation: 150,
                onSort: function (evt) {
                    add_sortableJS_functions(evt)
                }            
            }); 
        
        $('.graph-groups-list').sortable({
                group: 'group-shared',
                ghostClass: "sortable-ghost",
                multiDrag: true, // Enable the plugin
                selectedClass: "selected", // Class name for selected item             
                animation: 150,
                onSort: function (evt) {
                    add_sortableJS_functions(evt)
                }            
            });           
        

    }
        $('#submit_graph_groups_button').click(submit_graph_groups_button_click)
        
        function submit_graph_groups_button_click() {
    
            serialized = $('.graph-groups-list')[0].children
            new_group_order=[] //will contain the user specified groups to visualize in order                    
            for (i=0; i<serialized.length;i++){
                new_group_order[i]=serialized[i].innerText
            }               
            
            
            //var new_group_order=$('.graph-groups-list').sortable('toArray') //will contain the user specified groups to visualize in order                    
            process_graph_groups_list(new_group_order)

            div_hide('PopUp_group_display_List')
            //document.querySelector('#submit_graph_groups_button').removeEventListener('click', submit_graph_groups_button_click) //eventlistener removed to avoid compounding of event responses


        }

        function process_graph_groups_list(new_group_order){
            var order=[] 

            for(i=0; i<new_group_order.length;i++){
                order[i]=All_ConditionNames.indexOf(new_group_order[i]) //stores the indices of the visualized groups (in order) from All_ConditionNames
            }
             MIDs={} //reset MIDs
             ConditionNames=[] //reset ConditionNames
             Cell_Numbers=[] //reset Cell_Numbers
            //determine order from new_group_order and All_ConditionNames
            for (i=0; i<order.length; i++){ //resets MIDs and ConditionNames to only have the selected groups in the specified order
                //MIDs[Object.keys(All_MIDs)[order[i]]]=All_MIDs[Object.keys(All_MIDs)[order[i]]]
                MID_i=i+1
                MIDs["MID"+MID_i.toString()]=All_MIDs[Object.keys(All_MIDs)[order[i]]] //may want to make this a stringify/parse statement rather then purely and equivalence
                Cell_Numbers[i]=All_Cell_Numbers[order[i]]
                ConditionNames[i]=All_ConditionNames[[order[i]]]
            }
            ConditionAmount=Object.keys(MIDs).length; //stores the new total number of conditions to visualize

            load_TimeCourse_PopUp()
            load_ConditionName_PopUp()
            load_CellNumber_PopUp()
            load_custom_graphs_PopUp()
           // document.querySelector('#submit_graph_groups_button').removeEventListener('click', submit_graph_groups_button_click)  
            load_GroupDisplay_PopUp()              

            reprint_graphs() //reprint the graphs with the new selected graphs
        }                

        $('#close_popup_group_display').click( function() {
            //sortable('.sortable', 'disable'); //AKSortTest                      
            div_hide('PopUp_group_display_List')
        } );      

/////////////END Group Display functions
    
    
/////////////Group Display functions

    function load_TimeGroupDisplay_PopUp(){

    
        $("#all-time-groups-list").empty() //remove any previously entered elements of the table
        $("#graph-time-groups-list").empty() //remove any previously entered elements of the table


        for(i=0; i<All_Group_Names.length; i++){ //build the list of all groups/conditions in the dataset
            $( "#all-time-groups-list" ).append(
                    '<li class="p1 mb1 navy item sortable_list_item"  data-id='+All_Group_Names[i]+'>' + All_Group_Names[i] + '</li>'
                )
        }

        $( "#graph-time-groups-list" ).append(  
                '<li id="item_place_holder" class="p1 mb1 navy item sortable_list_item" >Insert Items Below</li>'            
        )

        $('.all-time-groups-list').sortable({
                group: 'group-time-shared',
                ghostClass: "sortable-ghost", 
                multiDrag: true, // Enable the plugin
                selectedClass: "selected", // Class name for selected item             
                animation: 150,
                onSort: function (evt) {
                    add_sortableJS_functions(evt)
                }            
            }); 
        
        $('.graph-time-groups-list').sortable({
                group: 'group-time-shared',
                ghostClass: "sortable-ghost",  
                multiDrag: true, // Enable the plugin
                selectedClass: "selected", // Class name for selected item             
                animation: 150,
                onSort: function (evt) {
                    add_sortableJS_functions(evt)
                }            
            }); 
        

    }
        $('#submit_graph_time_groups_button').click(submit_graph_time_groups_button_click)
        
        function submit_graph_time_groups_button_click() {

            serialized = $('.graph-time-groups-list')[0].children
            new_group_order=[] //will contain the user specified groups to visualize in order                    
            for (i=0; i<serialized.length;i++){
                new_group_order[i]=serialized[i].innerText
            }             
            
            //var new_group_order=$('.graph-time-groups-list').sortable('toArray') //will contain the user specified groups to visualize in order                            

            process_time_graph_groups_list(new_group_order)

            div_hide('PopUp_time_group_display_List')
            //document.querySelector('#submit_graph_groups_button').removeEventListener('click', submit_graph_groups_button_click) //eventlistener removed to avoid compounding of event responses
            
        }

        function process_time_graph_groups_list(new_group_order){
            var order=[] 

            for(i=0; i<new_group_order.length;i++){
                order[i]=All_Group_Names.indexOf(new_group_order[i]) //stores the indices of the visualized groups (in order) from All_ConditionNames
            }
            
            Group_Names=[]//reset Group_Names
            for (i=0; i<order.length; i++){ //resets MIDs and ConditionNames to only have the selected groups in the specified order

                Group_Names[i]=All_Group_Names[[order[i]]]
            }
            //ConditionAmount=Object.keys(MIDs).length; //stores the new total number of conditions to visualize

      
            document.getElementById("Kin_MPE_button").style.display = "block";       
            document.getElementById("Kin_abundance_button").style.display = "block";       
            reprint_graphs() //reprint graphs with updated menu including kinetic options        
        }                

        $('#close_popup_time_group_display').click( function() {
            //sortable('.sortable', 'disable'); //AKSortTest                      
            div_hide('PopUp_time_group_display_List')
        } );      

/////////////END Group Display functions
    
    
    
    
/////////////Carbon Diagram functions

    document.getElementById('13C_circles').addEventListener('click', function () {
        document.getElementById("PopUp_13Ccircle").style.display = "block"; 
        make13Ccircles()
    })

        $('#close_popup_13C').click( function() {
            document.getElementById("PopUp_13Ccircle").style.display = "none";
        } );     




    //var carbon_circle_location={}
    var dia_popup=20    //circle diameter in popup
    var dia_map=40 //circle diameter in the map   

    function make13Ccircles(){

        //allow_keystrokes_13C_popup('popup_13C_textlabel')      
        allow_keystrokes('popup_13C_textlabel')      

        //var svg_13C = d3.select("body")
        var svg_13C = d3.select("#_13C_svg_holder")
           /* .append("svg")
            .attr("width", 400)
            .attr("height", 400)*/
            .attr("stroke","black");          

        var initial_position={x:100,y:200}
        var circle_loc_popup=[]
        var n=0
        //var Carbon_nodes_popup=[]

        circle_loc_popup[0]=initial_position
        print_circles_popup()
        //draw_arrows()

        document.onkeyup = function(e) {
          if (e.which == 38) {
              n++;
              collide_test={x:circle_loc_popup[n-1].x,y:circle_loc_popup[n-1].y-dia_popup}
              check_collision(collide_test)          
          } else if (e.which == 40) {
              n++;
              collide_test={x:circle_loc_popup[n-1].x,y:circle_loc_popup[n-1].y+dia_popup}
              check_collision(collide_test) 
          } else if (e.which == 37) {
              n++;
              collide_test={x:circle_loc_popup[n-1].x-dia_popup,y:circle_loc_popup[n-1].y}
              check_collision(collide_test) 
          } else if (e.which == 39) {
              n++;
              collide_test={x:circle_loc_popup[n-1].x+dia_popup,y:circle_loc_popup[n-1].y}
              check_collision(collide_test) 
          }  
        }     

        function check_collision(value){ //identifies if the resulting value (location of newly drawn circle) collides with any existing circles
            for(k=0;k<circle_loc_popup.length;k++){
                if(circle_loc_popup[k].x==value.x){
                    if(circle_loc_popup[k].y==value.y){ //removes node from circle_loc_popup, if it exists already
                        circle_loc_popup.splice(k,1)
                        n=n-1;
                       // n=circle_loc_popup.length-1
                    }
                }
            }
            circle_loc_popup[n]=value
            $('.arrow_line').remove();
            $('.popup_carbon_node').remove();
           // $('.popup_carbon_nodelabel').remove();
            print_circles_popup() 
        }      

        function remove_selected_circle_popup(value){ //identifies if the resulting value (location of newly drawn circle) collides with any existing circles
            var collide_test_result=true
            for(k=0;k<circle_loc_popup.length;k++){
                if(circle_loc_popup[k].x==value.x){
                    if(circle_loc_popup[k].y==value.y){ //removes popup_carbon_node from circle_loc_popup, if it exists already
                        circle_loc_popup.splice(k,1)
                        //n=n-1;
                        n=circle_loc_popup.length-1
                        collide_test_result=false
                    }
                }
            }

            if(collide_test_result!=false){
                circle_loc_popup[n]=value
            }

            $('.arrow_line').remove();
            $('.popup_carbon_node').remove();
            print_circles_popup()        
        }    

        function print_circles_popup(){//print circles on 13C popup
            console.log(circle_loc_popup)
            svg_13C.selectAll(".popup_carbon_node")
                .data(circle_loc_popup)
                .enter()
                .append("circle")
                .on("click",function(d){console.log(this)})
                .attr("class", "popup_carbon_node")
                .attr("cx", function(d) {
                    return d.x
                    })
                .attr("cy", function(d) {
                    return d.y
                    })
                .attr("r", dia_popup/2)
                .attr("fill","white")
                .attr("stroke", function(d,i){
                        if(i==circle_loc_popup.length-1){ //changes selected circle stroke to dodgerblue
                            return "dodgerblue"
                        }else{
                            return "black"
                        }
                        })
                .attr("stroke-width", function(d,i){
                        if(i==circle_loc_popup.length-1){ //changes selected circle stroke-width to 3
                            return 3    
                        }else{
                            return 1
                        }
                        })        
                print_arrows()        
            }

        function remove_circles_popup(){
            d3.selectAll(".popup_carbon_node").remove()
            d3.selectAll(".arrow_line").remove()
            d3.selectAll(".popup_carbon_textlabel").remove()//remove label text from popup
            document.getElementById('popup_13C_textlabel').value=""//reset text input value
        }  //remove circles from 13C popup

        function print_arrows(){
           var coordinates=circle_loc_popup[circle_loc_popup.length-1]

           local_arrows={above:false,below:false,left:false,right:false}

            for(k=0;k<circle_loc_popup.length;k++){
                if(circle_loc_popup[k].x==coordinates.x){
                    if(circle_loc_popup[k].y==coordinates.y-dia_popup){ //checks for circles above
                        local_arrows.above=true
                    }
                    if(circle_loc_popup[k].y==coordinates.y+dia_popup){ //checks for circles below
                        local_arrows.below=true

                    }
                }

                if(circle_loc_popup[k].y==coordinates.y){
                    if(circle_loc_popup[k].x==coordinates.x-dia_popup){ //checks for circles left
                        local_arrows.left=true
                    }
                    if(circle_loc_popup[k].x==coordinates.x+dia_popup){ //checks for circles right
                        local_arrows.right=true

                    }
                }    

            }   

            if(local_arrows.above==false){    
            svg_13C.append("line")          // attach a line
                .attr("class", "arrow_line")    
                .attr("id", "up_line")    
                .style("stroke", "black")  // colour the line
                .attr("stroke-width", 2)
                .attr("x1", coordinates.x)     // x position of the first end of the line
                .attr("y1", coordinates.y-dia_popup/1.3)      // y position of the first end of the line
                .attr("x2", coordinates.x)     // x position of the second end of the line
                .attr("y2", coordinates.y-dia_popup*1.3)    // y position of the second end of the line
                .attr("marker-end", "url(#triangle)")
            }

            if(local_arrows.below==false){        
            svg_13C.append("line")          // attach a line
                .attr("class", "arrow_line")    
                .attr("id", "down_line")
                .style("stroke", "black")  // colour the line
                .attr("stroke-width", 2)
                .attr("x1", coordinates.x)     // x position of the first end of the line
                .attr("y1", coordinates.y+dia_popup/1.3)      // y position of the first end of the line
                .attr("x2", coordinates.x)     // x position of the second end of the line
                .attr("y2", coordinates.y+dia_popup*1.3)    // y position of the second end of the line
                .attr("marker-end", "url(#triangle)")
            }

            if(local_arrows.right==false){    
            svg_13C.append("line")          // attach a line
                .attr("class", "arrow_line")    
                .attr("id", "right_line")
                .style("stroke", "black")  // colour the line
                .attr("stroke-width", 2)
                .attr("x1", coordinates.x+dia_popup/1.3)     // x position of the first end of the line
                .attr("y1", coordinates.y)      // y position of the first end of the line
                .attr("x2", coordinates.x+dia_popup*1.3)     // x position of the second end of the line
                .attr("y2", coordinates.y)    // y position of the second end of the line
                .attr("marker-end", "url(#triangle)")
            }

            if(local_arrows.left==false){    
            svg_13C.append("line")          // attach a line
                .attr("class", "arrow_line")    
                .attr("id", "left_line")
                .style("stroke", "black")  // colour the line
                .attr("stroke-width", 2)
                .attr("x1", coordinates.x-dia_popup/1.3)     // x position of the first end of the line
                .attr("y1", coordinates.y)      // y position of the first end of the line
                .attr("x2", coordinates.x-dia_popup*1.3)     // x position of the second end of the line
                .attr("y2", coordinates.y)    // y position of the second end of the line
                .attr("marker-end", "url(#triangle)")
            }
            svg_13C.append("svg:defs").append("svg:marker")
                .attr("id", "triangle")
                .attr("refX", 6)
                .attr("refY", 6)
                .attr("markerWidth", 20)
                .attr("markerHeight", 20)
                .attr("markerUnits","userSpaceOnUse")
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M 0 0 6 6 0 12 3 6")
                .style("stroke", "black");    

        }  //remove arrows from 13C popup


        document.getElementById('remove_carbon_circle').onclick= function(){ //adds functionality to Remove Carbon button
          //popup_carbon_node
            svg_13C.selectAll(".popup_carbon_node").on("click",function(d){
                console.log("REMOVE")
                console.log(this)
                remove_selected_circle_popup(this.__data__)
            })
                .on("mouseover", function(d){d3.select(this).attr("fill","red")}) //changes color of circle to red on hover, restores to white after mouseout
                .on("mouseout", function(d){d3.select(this).attr("fill","white")})

        }

        document.getElementById('13C_textlabel_submit').onclick= function(){
            var _13C_textlabel = [{x:0, y:20, text:""}]
                _13C_textlabel[0].text=document.getElementById('popup_13C_textlabel').value;
            console.log(_13C_textlabel)
            console.log(svg_13C)


            d3.selectAll(".popup_carbon_textlabel").remove()

            svg_13C.selectAll(".popup_carbon_textlabel") 
                    .data(_13C_textlabel)
                    .enter()      
                    .append("text")
                    .attr("class", "popup_carbon_textlabel")
                    .attr("x",function (d) { 
                        return d.x})
                    .attr("y",function (d) { 
                        return d.y})
                    .attr("fill","black")
                    .attr("font-family","sans-serif")
                    .attr("font-size","20px")
                    .text(function (d) {
                        return d.text; })
                    .style("cursor", "move")            
                    .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended));      
        }

        document.getElementById('submit_carbon_circle').onclick= function(){
            document.getElementById("PopUp_13Ccircle").style.display = "none"; //close popup
            var final_13C_textlabel={x:0,y:0,text:""}//obtain final location of _13C_textlabel
            if(typeof(d3.selectAll(".popup_carbon_textlabel")._groups[0][0]) != "undefined"){
                final_13C_textlabel.x=d3.selectAll(".popup_carbon_textlabel")._groups[0][0].__data__.x
                final_13C_textlabel.y=d3.selectAll(".popup_carbon_textlabel")._groups[0][0].__data__.y
                final_13C_textlabel.text=d3.selectAll(".popup_carbon_textlabel")._groups[0][0].__data__.text
            }
            //var data_reorient=reorient_carbon_circles(circle_loc_popup)  
            remove_circles_popup() //removes all current circles in the popup

            var data_reorient=reorient_carbon_circles(circle_loc_popup,final_13C_textlabel)  

            if(Object.keys(carbon_circle_location).length>0){
                stringsplit=Object.keys(carbon_circle_location)[Object.keys(carbon_circle_location).length-1].split("_")
                i_new_metab_key=Number(stringsplit[1])+1
            }else{
                i_new_metab_key=0
            }
            
            metab_key="metab_"+i_new_metab_key.toString()

            carbon_circle_location[metab_key]={}
            carbon_circle_location[metab_key]={circles:[], textlabel:[], properties:{}}
            carbon_circle_location[metab_key].circles=data_reorient.circles
            carbon_circle_location[metab_key].textlabel=data_reorient.textlabel
            carbon_circle_location[metab_key].properties={label_text_size: 20*dia_map/dia_popup, popup_carbon_dia:dia_popup, map_carbon_dia:dia_map, fill_true: "1e90ff", fill_false: "D3D3D3", diameter: 40}
           /* var dia_popup=20    //circle diameter in popup
            var dia_map=40 //circle diameter in the map */
            circle_loc_popup=[]
            n=0
            circle_loc_popup[0]={x:100,y:100}

            remove_carbon_circles()
            //print_carbon_circles(carbon_circle_location)
            print_carbon_circles()


        }  

        function reorient_carbon_circles(circle_data_in,label_data_in){
            var data_out={}
                data_out={circles:[], textlabel:[]}
            var last_data_index=circle_data_in[circle_data_in.length-1]
            for(j=0;j<circle_data_in.length;j++){
                console.log(j)
                data_out.circles[j]={x:0,y:0,label:false}
                data_out.circles[j].x=(circle_data_in[j].x-last_data_index.x)*dia_map/dia_popup 
                data_out.circles[j].y=(circle_data_in[j].y-last_data_index.y)*dia_map/dia_popup
            }

            data_out.textlabel[0]={x:0,y:0,text:""}
            data_out.textlabel[0].x=(label_data_in.x-last_data_index.x)*dia_map/dia_popup
            data_out.textlabel[0].y=(label_data_in.y+20-last_data_index.y)*dia_map/dia_popup //10 added to account for the initial position being x:0, y:20
            data_out.textlabel[0].text=label_data_in.text
            return data_out
        }    
    }

    //function print_carbon_circles(carbon_circle_location){//prints carbon circles on Escher Map
    function print_carbon_circles(){//prints carbon circles on Escher Map

                    
        for(circle_metabolite in carbon_circle_location){
            var dia_map=carbon_circle_location[circle_metabolite].properties.diameter
            var menu=[]; //variable which will hold the context menu for each metabolite
            menu[0]={title: "delete",
                           onMouseClick: function(elm, d, i) {
                               //svg.selectAll("#"+metab_frag_name+'_CG_graph').remove() //remove old MPE of the selected fragment
                               //Graph_Location[metab_name][metab_frag_name].CG_graph={"x":"X","y":"X"}
                               d3.select('.canvas-group').selectAll('#'+elm.id).remove()
                               delete carbon_circle_location[elm.id]
                               d3.select('.d3-context-menu').style('display', 'none');

                            },

                            onMouseOver: function(elm,d,i){},
                               chidernItems: []
                        } 
            menu[1]={title: "Color",
                           onMouseClick: function(elm, d, i) {
                               
                               
                               d3.select('.d3-context-menu').style('display', 'none');
                               d3.select('#popup_unlabeled_color')._groups[0][0].value=carbon_circle_location[elm.id].properties.fill_false
                               $('#popup_unlabeled_color').css('background-color','#'+carbon_circle_location[elm.id].properties.fill_false)
                               
                               d3.select('#popup_labeled_color')._groups[0][0].value=carbon_circle_location[elm.id].properties.fill_true
                               $('#popup_labeled_color').css('background-color','#'+carbon_circle_location[elm.id].properties.fill_true)                               
  

                               document.getElementById("PopUp_carbon_color_picker").style.display = "block";  //makes popup appear
    
                               
                            d3.select('#submit_carbon_color_picker_button').on("click", function(){
                                
                                carbon_circle_location[elm.id].properties.fill_false=d3.select('#popup_unlabeled_color')._groups[0][0].value
                                carbon_circle_location[elm.id].properties.fill_true=d3.select('#popup_labeled_color')._groups[0][0].value

                                remove_carbon_circles()
                                print_carbon_circles()
                                div_hide("PopUp_carbon_color_picker")

                            });                               
                               
                                $('#close_popup_carbon_color_picker').click(function() {
                                    div_hide("PopUp_carbon_color_picker")
                                } );                               
                               
                            },

                            onMouseOver: function(elm,d,i){},
                               chidernItems: []
                        }
            menu[2]={title: "Size",
                           onMouseClick: function(elm, d, i) {
                                document.getElementById("PopUp_one_slider").style.display = "block";  //makes popup appear
                               d3.select('.d3-context-menu').style('display', 'none');

                               
                                //alters values of the slider outputs to reflect the height value of selected graph
                                document.getElementById("size_range").value = (carbon_circle_location[elm.id].properties.diameter/10).toString()
                                document.getElementById("size_range_display").value = (carbon_circle_location[elm.id].properties.diameter/10).toString()
                                
                                var old_dia=carbon_circle_location[elm.id].properties.diameter;

                                var size_slider = document.getElementById("size_range");
                                var size_output = document.getElementById("size_range_display");
                                size_output.innerHTML = size_slider.value; 

                                size_slider.oninput = function() {
                                    size_output.innerHTML = this.value; //changes value of the range output display dynamically
                                    carbon_circle_location[elm.id].properties.diameter=size_slider.value*10
                                    carbon_circle_location[elm.id].properties.map_carbon_dia=size_slider.value*10
                                    reorient_carbon_circles_resize(elm.id,size_slider.value*10,old_dia)
                                    old_dia=size_slider.value*10//update old_dia to equal the new dia
                                    //dia_map=carbon_circle_location[circle_metabolite].properties.diameter
                                    //reorient x,y locations of all carbon circles
                                    remove_carbon_circles()
                                    print_carbon_circles()
                                    }            
                                        

                                $('#close_popup_one_slider').click(function() {
                                    div_hide("PopUp_one_slider")
                                } );         

                            },

                            onMouseOver: function(elm,d,i){},
                               chidernItems: []
                        }               
            
            
            
                var carbon_circle = d3.select('.canvas-group').selectAll("carbon_circles")
                        .data(carbon_circle_location[circle_metabolite].circles)
                        .enter()
                        .append("circle")
                        .attr("id", circle_metabolite)
                        .attr("class", "carbon_circles_class")
                        //.attr("id", function(d){return d.group})
                        .on("click",function(d,i){
                           if (carbon_circle_location[this.id].circles[i].label==false){
                                d3.select(this).attr("fill", function(d){
                                    return '#'+carbon_circle_location[this.id].properties.fill_true                                    
                                })
                               carbon_circle_location[this.id].circles[i].label=true;
                           } //sets node to blue if link is clicked
                            else{        
                                d3.select(this).attr("fill", function(d){
                                    return '#'+carbon_circle_location[this.id].properties.fill_false                                    
                                })
                                carbon_circle_location[this.id].circles[i].label=false;} //sets node to blue if link is clicked
                        })
                        .on('contextmenu', d3.contextMenu(menu))
                        //.attr("class", "node")
                        //.on("mouseover", carbon_circle_MouseOver)
                        //.on("mouseout", carbon_circle_MouseOut)
                        .attr("cx", function(d) {
                         return d.x})
                        .attr("cy", function(d) {
                         return d.y})
                        //.attr("r", dia_popup/2)
                        .attr("r", carbon_circle_location[circle_metabolite].properties.map_carbon_dia/2)
                        //.attr("fill","lightgrey")
                        .attr("fill",function(d){
                           if (d.label==true){
                                return '#'+carbon_circle_location[this.id].properties.fill_true} //sets node to blue if link is clicked
                            else{        
                                return '#'+carbon_circle_location[this.id].properties.fill_false} //sets node to blue if link is clicked
                        })                
                        .attr("stroke","black")
                        .style("cursor", "move")
                        .call(d3.drag()
                            .on("start", dragstarted)
                            .on("drag", circle_dragged_13C)
                            .on("end", dragended))
                        .append("svg:title")
                            .text("Left Click to Change Color, Right Click to Access Additional Options") 

            

                d3.select('.canvas-group').selectAll("carbon_circles_textlabel_class") 
                    .data(carbon_circle_location[circle_metabolite].textlabel)
                    .enter()      
                    .append("text")
                    .attr("id", circle_metabolite)        
                    .attr("class", "carbon_circles_textlabel_class")
                    .attr("x",function (d) { 
                        return d.x})
                    .attr("y",function (d) { 
                        return d.y})
                    .attr("fill","black")
                    .attr("font-family","sans-serif")
                    //.attr("font-size","14px")
                    .attr("font-size",function (d) {
                        return carbon_circle_location[this.id].properties.label_text_size.toString()+"px"; })
                    .text(function (d) {
                        return d.text; })
                  /*  .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended)); */
        }

    }
    
    function reorient_carbon_circles_resize(circle_metabolite,new_dia,old_dia){
        
        total_circle=carbon_circle_location[circle_metabolite].circles.length
        
        /*
            var data_out={}
                data_out={circles:[], textlabel:[]}*/
            var last_data_index=carbon_circle_location[circle_metabolite].circles[total_circle-1]
            for(j=0;j<total_circle;j++){
                console.log(j)
                //carbon_circle_location[circle_metabolite].circles[j]={x:0,y:0,label:false}
                carbon_circle_location[circle_metabolite].circles[j].x=(carbon_circle_location[circle_metabolite].circles[j].x-last_data_index.x)*new_dia/old_dia+last_data_index.x 
                carbon_circle_location[circle_metabolite].circles[j].y=(carbon_circle_location[circle_metabolite].circles[j].y-last_data_index.y)*new_dia/old_dia+last_data_index.y
            }

            carbon_circle_location[circle_metabolite].textlabel[0].x=(carbon_circle_location[circle_metabolite].textlabel[0].x-last_data_index.x)*new_dia/old_dia+last_data_index.x     
        
            carbon_circle_location[circle_metabolite].textlabel[0].y=(carbon_circle_location[circle_metabolite].textlabel[0].y-last_data_index.y)*new_dia/old_dia+last_data_index.y        
            carbon_circle_location[circle_metabolite].properties.label_text_size=carbon_circle_location[circle_metabolite].properties.label_text_size*new_dia/old_dia
            console.log(carbon_circle_location[circle_metabolite].properties.label_text_size)
            //data_out.textlabel[0].text=label_data_in.text
            //return data_out    
    }

    function remove_carbon_circles(){
        d3.selectAll(".carbon_circles_class").remove()
        d3.selectAll(".carbon_circles_textlabel_class").remove()
    }    

    function circle_dragged_13C(d) {
        //d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);       
        //d3.selectAll("#"+d.group) //selects all nodes within the same group as the selected node and edits their positions
        d3.selectAll("#"+this.id) //selects all nodes within the same group as the selected node and edits their positions
              .attr("cx", function(j){
                return j.x = j.x-d.x+d3.event.x}) //edits the position of node j relative to the selected draging node d, j here cycles through all of the other nodes of the same group
              .attr("cy", function(j){ return j.y = j.y-d.y+d3.event.y})
              .attr("x", function(j){
                return j.x = j.x-d.x+d3.event.x}) //edits the position of node j relative to the selected draging node d, j here cycles through all of the other nodes of the same group
              .attr("y", function(j){ return j.y = j.y-d.y+d3.event.y});    
    }




/////////////END Carbon Diagram functions
    
    
//////////////////////////////////////////End Popup functions           
    
       
function begin_graph_display(){

    load_PopUp_metabolite_display_Table()
    load_PopUps()


///////////////metabolite_display functions
    //$(document).ready(function() {
    function load_PopUp_metabolite_display_Table(){    
    //var metabolites=["pyr","lac","ala"];  
          $("#metabolite_display_Table tbody").empty() //remove any previously entered elements of the table
         //for(i=0; i<metabolites.length; i++){ //build the table, 4 columns (Condition Name, exp_condition, timepoint, time_unit)
        
        if ($.fn.DataTable.isDataTable("#metabolite_display_Table")) {
              $("#metabolite_display_Table").DataTable().clear().destroy();
              $("#metabolite_display_Table").remove(); //removes all traces of previous data_display_Table
            }   
    
            $( "#holder_metabolite_display_Table" ).append(
                '<table id="metabolite_display_Table" class="display" style="cellspacing:0" style="width:100%"><thead><tr class="table_title"><th style="font-size: small; text-align: center">Name</th><th style="font-size: small; text-align: center"> Select All <br><input name="select_all" value="0" id="metabolite_display_Table-select-all" type="checkbox" /></th></tr></thead><tbody></tbody></table>'
            )    //generates shell of data_display_Table and inserts it into insert_table        
        
        
          i_mdt=0;
        
         for(var metabolites in selectMID){ //build the table, 4 columns (Condition Name, exp_condition, timepoint, time_unit)
            $( "#metabolite_display_Table tbody" ).append( '<tr class="table_element">' +
                    '<td>' + metabolites + "</td>" +
                    '<td style="width: 75px"><input type="checkbox" id="row-'+metabolites+'-metabolite" name="row-'+metabolites+'-metabolite"></td>'+                                                                      
            +"</tr>" );
             i_mdt++
        }      

           var table_met_disp = $('#metabolite_display_Table').DataTable({
            "retrieve": true, //prevents table from being reinitialized                           
            "paging":   true, 
            "ordering": false,
              //'ajax': 'https://api.myjson.com/bins/1us28',  
              'columnDefs': [{
                 'targets': 0,
                 'searchable':true,
                 'orderable':false,
                 'className': 'dt-body-center',
              }],
              'order': [1, 'asc']
           });

            allow_keystrokes("metabolite_display_Table_filter")  

           // Handle click on "Select all" control
           $('#metabolite_display_Table-select-all').on('click', function(){
              // Check/uncheck all checkboxes in the table
              var rows = table_met_disp.rows({ 'search': 'applied' }).nodes();
              $('input[type="checkbox"]', rows).prop('checked', this.checked);
           });

           // Handle click on checkbox to set state of "Select all" control
           $('#metabolite_display_Table tbody').on('change', 'input[type="checkbox"]', function(){
              // If checkbox is not checked
              if(!this.checked){
                 var el = $('#metabolite_display_Table-select-all').get(0);
                 // If "Select all" control is checked and has 'indeterminate' property
                 if(el && el.checked && ('indeterminate' in el)){
                    // Set visual state of "Select all" control 
                    // as 'indeterminate'
                    el.indeterminate = true;
                 }
              }
           }); 
    //}

        $('#submit_metabolite_display_Table_button').click( function() {
            var data = table_met_disp.$('input, checkbox').serialize();
            div_hide('PopUp_metabolite_display_Table') //closes popup upon click of submit_TimePoint_Table_button
            console.log(data)
            process_metabolite_display_Table_data(data)
            return false;
        } );
        
        $('#close_popup_metabolite_display').click( function() {
            div_hide('PopUp_metabolite_display_Table')

        } );

        function process_metabolite_display_Table_data(data){ //extracts information TimePoint_Table and returns Condition_Times
            metabolite_display_data=data.split("&")
            console.log(metabolite_display_data)
            var selected_metabolite=[]
            var unselected_metabolite=[]
            for(j=0;j<metabolite_display_data.length;j++){
            selected_metabolite_str=metabolite_display_data[j]    
            selected_metabolite_str = selected_metabolite_str.replace("-metabolite=on", "")    
            selected_metabolite_str = selected_metabolite_str.replace("row-", "") 
            selected_metabolite[j]=selected_metabolite_str
            }
        
            for(var metabolites in selectMID){
                if (selected_metabolite.indexOf(metabolites) < 0) {
                    unselected_metabolite.push(metabolites)
                }                
            }
            remove_graphs("remove_graphs_only") //removes all graphs from the page without resetting Graph_Location
            reset_Graph_Location(unselected_metabolite) //Reset Graph_Location of unselected_metabolite's
            newly_selected_metabolites(selected_metabolite) //Prints (or reprints) graphs of the selected_metabolite's
            
        }

    }
    //} )
       
    function reset_Graph_Location(unselected_metabolites){
//            for(var metab_name in unselected_metabolites){    
            for(k=0;k<unselected_metabolites.length; k++){
                var metab_name=unselected_metabolites[k]
                for(var metab_frag_name in Graph_Location[metab_name]){        
                    for(var graph_type_reset in Graph_Location[metab_name][metab_frag_name]){
                             Graph_Location[metab_name][metab_frag_name][graph_type_reset].x="X"   
                             Graph_Location[metab_name][metab_frag_name][graph_type_reset].y="X"               
                    } 
                }
            }            
       }
    
/////////////start isotopologue_display functions
    $(document).ready(function() {
    //var metabolites=["pyr","lac","ala"];  
          $("#isotopologue_display_Table tbody").empty() //remove any previously entered elements of the table
         //for(i=0; i<metabolites.length; i++){ //build the table, 4 columns (Condition Name, exp_condition, timepoint, time_unit)
          i=0;
        for(var metabolites in selectMID){
             for(var frag in selectMID[metabolites]){ //build the table, 4 columns (Condition Name, exp_condition, timepoint, time_unit)
                 option_values=""
                 for(j=0;j<selectMID[metabolites][frag].length;j++){
                     iso_string=selectMID[metabolites][frag][j].fragment
                     if(j==selectMID[metabolites][frag].length-1){
                        option_values=option_values+'<option value='+iso_string+' selected="selected">'+iso_string+'</option>'
                     }else{
                     option_values=option_values+'<option value='+iso_string+'>'+iso_string+'</option>'
                     }
                 }

                $( "#isotopologue_display_Table tbody" ).append( '<tr class="table_element">' +
                        '<td>' + frag + "</td>" +
                        '<td style="width: 75px"><select size="1" id="row-'+i+'-iso_limit=!!!'+frag+'" name="row-'+i+'-iso_limit=!!!'+frag+'">'+
                            option_values +                                     
                        '</select></td> '  
                +"</tr>" );
                 i++
            }
        }
        
           var table_iso = $('#isotopologue_display_Table').DataTable({
            "retrieve": true, //prevents table from being reinitialized                           
            "paging":   true, 
            "ordering": false,
              //'ajax': 'https://api.myjson.com/bins/1us28',  
              'columnDefs': [{
                 'targets': 0,
                 'searchable':true,
                 'orderable':false,
                 'className': 'dt-body-center',
              }],
              'order': [1, 'asc']
           });

            allow_keystrokes("isotopologue_display_Table_filter")      

        $('#submit_isotopologue_display_Table_button').click( function() {
            data_iso = table_iso.$('input, select').serialize();
            //table_time.clear()
            div_hide('PopUp_isotopologue_display_Table') //closes popup upon click of submit_TimePoint_Table_button

            Isotopologue_Limit=process_isotopologue_display_Table_data(data_iso)  
            reprint_graphs()
            return false;
        } );
        
          $('#close_popup_isotopologue_display').click( function() {
            div_hide('PopUp_isotopologue_display_Table')

        } );

        function process_isotopologue_display_Table_data(data){ //extracts information TimePoint_Table and returns Condition_Times
            iso_data=data.split("&")
            console.log(iso_data)
            var initial_split=[]
            var iso_data_split=[]
            for(j=0;j<iso_data.length;j++){
                initial_split=iso_data[j].split("!!!")
                iso_data_split=initial_split[1].split("=")
                Isotopologue_Limit[iso_data_split[0]]=iso_data_split[1]
            }
            return Isotopologue_Limit
        }

    } )
           
/////////////END isotopologue_display functions


/////////////start quant_standard_display functions
    $(document).ready(function() {
    //var metabolites=["pyr","lac","ala"];  
          $("#quant_standard_display_Table tbody").empty() //remove any previously entered elements of the table
         //for(i=0; i<metabolites.length; i++){ //build the table, 4 columns (Condition Name, exp_condition, timepoint, time_unit)
          i=0;
        for(var metabolites in selectMID){
             for(var frag in selectMID[metabolites]){ //build the table, 4 columns (Condition Name, exp_condition, timepoint, time_unit)
                 option_values='<option value=NA selected="selected">NA</option>' //include NA as an option and make it the initial selected option
                 for(j=0;j<selectMID[metabolites][frag].length;j++){
                     iso_string=selectMID[metabolites][frag][j].fragment
                     option_values=option_values+'<option value='+iso_string+'>'+iso_string+'</option>'
                 }
                
                std_conc_string='""'
                if(Std_Concentration[frag].std_conc!="NA"){
                    std_conc_string=Std_Concentration[frag].std_conc.toString()
                }else{
                    std_conc_string='""' //if Std_Concentration[frag].std_conc="NA" set the eventual text input equal to ""
                }               

                $( "#quant_standard_display_Table tbody" ).append( '<tr class="table_element">' +
                        '<td>' + frag + "</td>" +
                        '<td><select class="iso_std_input" size="1" id="row-'+i+'-iso_std='+frag+'" name="row-'+i+'-iso_std='+frag+'">'+
                            option_values +                                     
                        '</select></td> '+
                   // '<td><input type="text" value='+Cell_Numbers[i].toString()+' id="row-'+i+'-cell_number" name="row-'+i+'-cell_number"></td>'  //taken from the Cell Number popup                                
                        '<td style="width: 50px"><input type="text" value='+std_conc_string+' id="row-'+i+'-std_concentration='+frag+'" name="row-'+i+'-std_concentration='+frag+'" disabled></td>'                                  
                                                            //needt to make an object Std_Concentration that holds the standard concentration of each fragment                                                    

                +"</tr>" );                 
                                           
            i++
    
            }
        }
    
        
            $(".iso_std_input").change(function() { //activates/deactviates std_concentration input depending on input of iso_std_input
                var $dropdown = $(this);
                var key = $dropdown.val();
                var std_conc_id = $dropdown[0].id.replace('iso_std','std_concentration');
                
                if(key != "NA"){
                    document.getElementById(std_conc_id).disabled = false //activates std_concentration input if a standard isotopologue is selected
                    //input_selector='row-'+i+'-std_concentration';
                    setInputFilter(document.getElementById(std_conc_id), function(value) {
                        return /^\d*$/.test(value);
                    }); //restricts inputs in quant_standard_display_Table to numbers                

                    
                }else{
                    document.getElementById(std_conc_id).setAttribute("value", '""') //deactivates std_concentration input if a standard isotopologue is not selected    
                    document.getElementById(std_conc_id).disabled = true    
                }
            });        
        
           var table_iso = $('#quant_standard_display_Table').DataTable({
            "retrieve": true, //prevents table from being reinitialized                           
            "paging":   true, 
            "ordering": false,
              //'ajax': 'https://api.myjson.com/bins/1us28', 
            "deferRender":    true,
            "scrollY":        300,
            "scrollCollapse": true,
            "scroller":       true,                
              'columnDefs': [{
                 'targets': 0,
                 'searchable':true,
                 'orderable':false,
                 'className': 'dt-body-center',
              }],
              'order': [1, 'asc']
           });

            allow_keystrokes("quant_standard_display_Table")      
            allow_keystrokes("UserInputConcentrationUnits")      

        $('#submit_quant_standard_display_Table_button').click( function() {
            data_iso = table_iso.$('input, select').serialize();
            //table_time.clear()
            div_hide('PopUp_quant_standard_display_Table') //closes popup upon click of submit_TimePoint_Table_button
            
            UserInputConcentrationUnits = document.getElementById("UserInputConcentrationUnits").value
            
            Std_Concentration=process_quant_standard_display_Table_data(data_iso)  
            reprint_graphs()
            return false;
        } );
        
        $('#close_popup_quant_standard_display').click( function() {
            div_hide('PopUp_quant_standard_display_Table')

        } );

        function process_quant_standard_display_Table_data(data){ //extracts information TimePoint_Table and returns Condition_Times
            
            /////NEEED TO EDITTTTTT 3/5/19
            var standard_iso=[]
            var standard_conc=[]
            iso_data=data.split("&")
            console.log(iso_data)
            var initial_split=[]
            var iso_data_split=[]
            for(j=0;j<iso_data.length;j++){
                initial_split=iso_data[j].split("=")
                if(initial_split[0].includes("iso_std")==true){
                    iso_data_split=initial_split[0].split("iso_std%3D")
                    Std_Concentration[iso_data_split[1]].std_iso=initial_split[1]
                }
                if(initial_split[0].includes("std_concentration")==true){
                    iso_data_split=initial_split[0].split("std_concentration%3D")
                    Std_Concentration[iso_data_split[1]].std_conc=initial_split[1]
                    if(isNaN(Number(initial_split[1]))){ //if non numerical entry then the Std_Concentration for the fragment will be reset isNAN or 'is Not A Number'checks if the input is a number 
                        Std_Concentration[iso_data_split[1]].std_iso="NA"
                        Std_Concentration[iso_data_split[1]].std_conc="NA"
                    }
                }                
            }
            
            for(m=0;m<Std_Concentration.length;m++){
                if(Std_Concentration[m].std_iso=="NA"){ //sets std_conc of all fragments w/ no specified std_iso to "NA"
                    Std_Concentration[m].std_conc="NA"
                }
            }
            
            
            return Std_Concentration
        }

    } )
           
/////////////END quant_standard_display functions

 
    function newly_selected_metabolites(selected_metabolites){ //used in load_metabolite_display_popup
        unmapped_count=0;
        //The for loop below prints out initial graphs of data for metabolites not included in the escher map
        //for(data_metabolite in selected_metabolites){
        for(k_nsm=0;k_nsm<selected_metabolites.length; k_nsm++){
            var data_metabolite=selected_metabolites[k_nsm]
            if(map_metabolites.indexOf(data_metabolite)<0){
                    unmapped_metabolites.push(data_metabolite)//saves the metabolites that are not displayed on the eshcermap into the array unmapped_metabolites
                    met_MIDs=selectMID[data_metabolite]// selects the metabolite data corresponding to the bigg_id of the metabolite-circle
                    frag_keys=Object.keys(selectMID[data_metabolite]) //returns array of mass fragments of the selected metabolite
                    metab_frag_name =  frag_keys[0] //selects the first mass fragment of the selected metabolite
                    loc_var={"x_loc":75, "y_loc":unmapped_count*200*graph_scale_set.MID}
                    unmapped_count++
                    graphed=CheckforGraph(data_metabolite) //CheckforGraph returns true if there are no defined locations for graphs of data_metabolite
                //if(graph_edited!=true){
                if(graphed==true){
                        Graph_Location[data_metabolite][metab_frag_name].MID.x=loc_var.x_loc
                        Graph_Location[data_metabolite][metab_frag_name].MID.y=loc_var.y_loc                
                        makegraph_MID(metab_frag_name,loc_var,ConditionAmount,data_metabolite,MIDs,ConditionNames,d3.select('.canvas-group')) //spits out graphs of MID data for the metabolite            
                }else{
                    print_graphs({bigg_id: data_metabolite},met_MIDs,d3.select('.canvas-group')) //print_graphs where data was replaced with {bigg_id: data_metabolite}
                }
            }
        }
       //AK:Below initiates display of BIGGCarbonJSON data onto the escher map, by appending the graphs generated by makegraph_MID next to its corresponding metabolite-circle on the escher map
       d3.select('#map_container')
         .selectAll('.metabolite-circle')
         .each(function(data) {
          // only apply the transformation to primary nodes
             if (!data.node_is_primary) {return;}
             // get the circle location
             var circle = d3.select(this)
             var metab_circle=this
            if(typeof selectMID[data.bigg_id] != "undefined"){ //if there is data for a specific metabolite, then execute makegraph_MID
            if(selected_metabolites.indexOf(data.bigg_id)>-1){

                met_MIDs=selectMID[data.bigg_id]// selects the metabolite data corresponding to the bigg_id of the metabolite-circle
                frag_keys=Object.keys(selectMID[data.bigg_id]) //returns array of mass fragments of the selected metabolite
                metab_frag_name =  frag_keys[0] //selects the first mass fragment of the selected metabolite

                loc_var={"x_loc":data.x+75, "y_loc":data.y}
                met_context_menu(metab_circle,loc_var,data.bigg_id) //makes metabolite circles on escher map right clickable for appearance of the context menu
                graphed=CheckforGraph(data.bigg_id) //CheckforGraph returns true if there are no defined locations for graphs of data_metabolite
                //if(graph_edited!=true){
                if(graphed==true){    //checks if Group_Location was defined by the user or the script (if defined by the script all entries will be "X")
                    loc_var={"x_loc":data.x+75, "y_loc":data.y}

                    Graph_Location[data.bigg_id][metab_frag_name].MID.x=loc_var.x_loc
                    Graph_Location[data.bigg_id][metab_frag_name].MID.y=loc_var.y_loc                
                    makegraph_MID(metab_frag_name,loc_var,ConditionAmount,data.bigg_id,MIDs,ConditionNames,d3.select(circle.node().parentNode)) //spits out graphs of MID data for the metabolite

                }else{

                //print_graphs(data,met_MIDs,circle)
                print_graphs(data,met_MIDs,d3.select(circle.node().parentNode))
                }
            }
            }
       });           
           
           
                      
       }
       
    function CheckforGraph(metab_name){ //used in newly_selected_metabolites which is used in load_metabolite_display_popup
        for(var metab_frag_name in Graph_Location[metab_name]){        
            for(var graph_type_reset in Graph_Location[metab_name][metab_frag_name]){
                     x_test=Graph_Location[metab_name][metab_frag_name][graph_type_reset].x  
                     y_test=Graph_Location[metab_name][metab_frag_name][graph_type_reset].y
                if(x_test!="X" && y_test!="X"){
                    return false
                }
            } 
        }
        return true    
    }
       
///////////////END metabolite_display Stuff
    
       
    //Function to Show Popup
    function div_show(table_string) {
            document.getElementById(table_string).style.display = "block";
            }
    //Function to Hide Popup
    function div_hide(table_string){
            document.getElementById(table_string).style.display = "none";
    };  
///////////////END PopUp Stuff
    ///Displays the Graph Option Buttons
         
    document.getElementById("exportJSON").style.display = "block";   

    document.getElementById('exportJSON').onclick = function() {           
    //exportJSON exports all of the MIDs/Graph_Location/ConditionNames into a json allowing the user to safe the exact look of their smart data sheet.    
        el=this;
        date_today = new Date();

        full_date=String(date_today.getFullYear())+'-'+String(date_today.getMonth()+1)+'-'+String(date_today.getDate())+' '+String(date_today.getHours())+':'+String(date_today.getMinutes()+1); //generates the date and time which will be included in the file name
        //var graph_edited=true
        var new_file_name = prompt("Please enter the File name:", "");
            if(new_file_name.length==0){ //if no file name is entered, generate a default file name
                new_file_name="CarbonBIGG("+full_date+")"
            }
                
        
        graph_edited=true

        
        var writedata ='{"MIDs":'+JSON.stringify(MIDs)+
            ',  "FileMIDs":'+JSON.stringify(FileMIDs)+
            ',  "FileNames":'+JSON.stringify(FileNames)+
            ',  "Graph_Location":'+JSON.stringify(Graph_Location)+
            ',  "Graph_Attribute":'+JSON.stringify(Graph_Attribute)+
            ',  "ConditionNames":'+JSON.stringify(ConditionNames)+
            ',  "Condition_Times":'+JSON.stringify(Condition_Times)+
            ',  "Group_Names":'+JSON.stringify(Group_Names)+
            ',  "All_Group_Names":'+JSON.stringify(All_Group_Names)+
            ',  "Isotopologue_Limit":'+JSON.stringify(Isotopologue_Limit)+
            ',  "Std_Concentration":'+JSON.stringify(Std_Concentration)+
            ',  "color_scheme_obj":'+JSON.stringify(color_scheme_obj)+
            ',  "Cell_Numbers":'+JSON.stringify(Cell_Numbers)+
            ',  "All_Cell_Numbers":'+JSON.stringify(All_Cell_Numbers)+
            ',  "graph_scale_set":'+JSON.stringify(graph_scale_set)+
            ',  "All_MIDs":'+JSON.stringify(All_MIDs)+
            ',  "All_ConditionNames":'+JSON.stringify(All_ConditionNames)+
            ',  "norm_metab":'+JSON.stringify(norm_metab)+
            ',  "norm_frag":'+JSON.stringify(norm_frag)+
            ',  "norm_cond":'+JSON.stringify(norm_cond)+
            ',  "carbon_circle_location":'+JSON.stringify(carbon_circle_location)+
            ',  "fileorganizer":'+JSON.stringify(fileorganizer)+            
            ',  "display_legend_metrics":'+JSON.stringify(display_legend_metrics)+
            ',  "display_bar_label":'+JSON.stringify(display_bar_label)+
            ',  "graph_edited":'+JSON.stringify(graph_edited)+
            ',  "CG_container":'+JSON.stringify(CG_container)+
            '}'; //got rid of clickcount
        
        blob=new Blob([writedata], {type: "application/json"})
        
        saveFile(blob,new_file_name)
        
        function saveFile(blob, filename) {
          if (window.navigator.msSaveOrOpenBlob) {
            window.navigator.msSaveOrOpenBlob(blob, filename);
          } else {
            const a = document.createElement('a');
            document.body.appendChild(a);
            const url = window.URL.createObjectURL(blob);
            a.href = url;
            a.download = filename;
            a.click();
            setTimeout(() => {
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
            }, 0)
          }
        }        

    }
        
    
 
    d3.select("#Timecourse_button").on("click", function() {
        div_show('PopUp_TimePoint_Table')
        $($.fn.dataTable.tables(true)).DataTable().columns.adjust();  //corrects for DataTables 'scroller' glitch             
    }); 
    d3.select("#ConditionName_button").on("click", function() {
        div_show('PopUp_ConditionName_Table')
        $($.fn.dataTable.tables(true)).DataTable().columns.adjust();  //corrects for DataTables 'scroller' glitch             
    }); 
    d3.select("#CellNumber_button").on("click", function() {
        div_show('PopUp_CellNumber_Table')
        $($.fn.dataTable.tables(true)).DataTable().columns.adjust();  //corrects for DataTables 'scroller' glitch     
    }); 
    d3.select("#metabolite_display_button").on("click", function() {
        div_show('PopUp_metabolite_display_Table')
    });
    d3.select("#isotopologue_display_button").on("click", function() {
        div_show('PopUp_isotopologue_display_Table')
    });    
    d3.select("#quant_standard_display_button").on("click", function() {
        div_show('PopUp_quant_standard_display_Table')
        $($.fn.dataTable.tables(true)).DataTable().columns.adjust();  //corrects for DataTables 'scroller' glitch     
        
    });   
    
  /*  d3.select("#group_order_button").on("click", function() {
        //sortable('.sortable', 'enable'); //AKSortTest      
        div_show('PopUp_group_display_List')
    }); */
    
    d3.select("#group_order_button").on("click", function(){group_order_button_function(Condition_Times)});     
    
    function group_order_button_function(Condition_Times){
        console.log(Condition_Times)
        
        if(Condition_Times == ""){
            div_show('PopUp_group_display_List')
        }else{
            load_TimeGroupDisplay_PopUp()            
            div_show('PopUp_time_group_display_List')
        }
        
    }
    
    d3.select("#file_order_button").on("click", function() {
        //remove_graphs("remove_graphs_only")
        //sortable('.sortable', 'enable'); //AKSortTest        
        div_show('PopUp_file_display_List')
    });
    d3.select("#custom_graph_button").on("click", function() {
        //load_custom_graphs_PopUp()
        div_show('PopUp_custom_graph')
    }); 
    
    d3.select("#color_picker_button").on("click", function() {
        div_show('PopUp_color_picker')
        
        d3.select('#submit_color_picker_button').on("click", function(){
             
            sel_color_index=get_new_color_scheme_obj($("#all-color-schemes")[0].children) 
            
            for(metab_name in Graph_Attribute){
                for(metab_frag_name in Graph_Attribute[metab_name]){
                    for(graph_type in Graph_Attribute[metab_name][metab_frag_name]){
                        Graph_Attribute[metab_name][metab_frag_name][graph_type].color_index=sel_color_index
                    }
                }
            }
            
            div_hide('PopUp_color_picker')// to close             
            load_color_picker_PopUp()
            reprint_graphs() 
        });    
    });
    d3.select("#label_switch").on("click", function() {
        if(display_bar_label==false){
            display_bar_label=true
        }else{
        display_bar_label=false
        }
        reprint_graphs() 
    })

    d3.select("#legend_metrics").on("click", function() {
        if(display_legend_metrics==false){
            display_legend_metrics=true
        }else{
        display_legend_metrics=false
        }
        reprint_graphs() 
    })    
    
        
    
   /////////AK: Buttons below replace all graphs currently dislpayed with those specified by the button (use replace_graphs function)
    d3.select("#MID_button").on("click", function() {
        r = confirm("Are you sure you want to replace ALL current graphs with MID graphs?");
        if(r==true){
            console.log("MID button clicked!")
            replace_graphs("MID")
        }
    }); 

    d3.select("#Stacked_MID_button").on("click", function() {
        r = confirm("Are you sure you want to replace ALL current graphs with Stacked MID graphs?");
        if(r==true){
            console.log("stacked_MID button clicked!")
            replace_graphs("stacked_MID")
        }

    });

    d3.select("#Stacked_Abundance_button").on("click", function() {
        r = confirm("Are you sure you want to replace ALL current graphs with Stacked Abundance graphs?");
        if(r==true){
            replace_graphs("stacked_abundance")
        }
            
    });

    d3.select("#Total_Abundance_button").on("click", function() { 
        r = confirm("Are you sure you want to replace ALL current graphs with Total Abundance graphs?");
        if(r==true){
            replace_graphs("total_abundance")
        }
    });    

    d3.select("#Abundance_button").on("click", function() {
        r = confirm("Are you sure you want to replace ALL current graphs with Abundance graphs?");
        if(r==true){
            replace_graphs("abundance")
        }
    });

    d3.select("#MPE_button").on("click", function() {
        r = confirm("Are you sure you want to replace ALL current graphs with MPE graphs?");
        if(r==true){
            replace_graphs("MPE")
        }
        
    });
    
    d3.select("#Kin_MPE_button").on("click", function() {
        r = confirm("Are you sure you want to replace ALL current graphs with Kinetic MPE graphs?");
        if(r==true){
            replace_graphs("Kin_MPE")
        }
    });    
    
    d3.select("#Kin_abundance_button").on("click", function() {
        r = confirm("Are you sure you want to replace ALL current graphs with Kinetic MPE graphs?");
        if(r==true){
            replace_graphs("Kin_abundance")
        }
    });        
    
                    

    /////////END

    /////////AK: Buttons below alter and reprint all graphs currently displayed (use reprint_graphs function)

    d3.select("#Total_Size_slide_graphs_button").on("click", function() {
            
        //document.getElementById("slidecontainer").style.display = "block";  
        document.getElementById("PopUp_slider").style.display = "block";  
        var height_slider = document.getElementById("height_range");
        var height_output = document.getElementById("height_range_display");
        height_output.innerHTML = height_slider.value;

        height_slider.oninput = function() {
            height_output.innerHTML = this.value;
            for(metab_name in Graph_Attribute){
                for(metab_frag_name in Graph_Attribute[metab_name]){
                    for(graph_type in Graph_Attribute[metab_name][metab_frag_name]){
                        //graph_scale=Graph_Attribute[metab_name][metab_frag_name][graph_type].scale
                        Graph_Attribute[metab_name][metab_frag_name][graph_type].height_scale=height_slider.value*1/7
                    }
                }
            }        

            reprint_graphs()               
        }  
        
        var width_slider = document.getElementById("width_range");
        var width_output = document.getElementById("width_range_display");
        width_output.innerHTML = width_slider.value;

        width_slider.oninput = function() {
            width_output.innerHTML = this.value;
            for(metab_name in Graph_Attribute){
                for(metab_frag_name in Graph_Attribute[metab_name]){
                    for(graph_type in Graph_Attribute[metab_name][metab_frag_name]){
                        //graph_scale=Graph_Attribute[metab_name][metab_frag_name][graph_type].scale
                        Graph_Attribute[metab_name][metab_frag_name][graph_type].width_scale=width_slider.value*1/7
                    }
                }
            }        

            reprint_graphs()               
        }        
        
        $('#close_popup_slider').click( function() {
            div_hide("PopUp_slider")
        } );         
                        

    });     
     
 
    /////////END

}
function initilize_graphs(initilize_graphs_mode){ //initilize_graphs_mode determines whether custom graphs are printed, if initilize_graphs_mode="CG_present" customs graphs will not be printed (as remove_graphs doesn't remove them)
    
    print_carbon_circles()//prints all carbon diagrams    
    
    d3.select('#map_container')
     .selectAll('.metabolite-circle')
     .each(function(data) {
        if(map_metabolites.indexOf(data.bigg_id)<0){
            map_metabolites.push(data.bigg_id) //stores all nonrepeat metabolites on the escher map into map_metabolites
        }
        //console.log(map_metabolites)
        })
    
    unmapped_count=0;
    //The for loop below prints out initial graphs of data for metabolites not included in the escher map
    for(data_metabolite in selectMID){
        if(map_metabolites.indexOf(data_metabolite)<0){
                unmapped_metabolites.push(data_metabolite)//saves the metabolites that are not displayed on the eshcermap into the array unmapped_metabolites
                met_MIDs=selectMID[data_metabolite]// selects the metabolite data corresponding to the bigg_id of the metabolite-circle
                frag_keys=Object.keys(selectMID[data_metabolite]) //returns array of mass fragments of the selected metabolite
                metab_frag_name =  frag_keys[0] //selects the first mass fragment of the selected metabolite
                loc_var={"x_loc":75, "y_loc":unmapped_count*200*graph_scale_set.MID}
                unmapped_count++
            if(graph_edited!=true){
                    Graph_Location[data_metabolite][metab_frag_name].MID.x=loc_var.x_loc
                    Graph_Location[data_metabolite][metab_frag_name].MID.y=loc_var.y_loc                
                    makegraph_MID(metab_frag_name,loc_var,ConditionAmount,data_metabolite,MIDs,ConditionNames,d3.select('.canvas-group')) //spits out graphs of MID data for the metabolite            
            }else{
                print_graphs({bigg_id: data_metabolite},met_MIDs,d3.select('.canvas-group')) //print_graphs where data was replaced with {bigg_id: data_metabolite}
                //Insert Custom Graph function here
                //makegraph_CustomGraph(loc_var,svg,mass_fragment)
            }
        }
   }

       
       //AK:Below initiates display of BIGGCarbonJSON data onto the escher map, by appending the graphs generated by makegraph_MID next to its corresponding metabolite-circle on the escher map
   d3.select('#map_container')
     .selectAll('.metabolite-circle')
     .each(function(data) {
      // only apply the transformation to primary nodes
         if (!data.node_is_primary) {return;}
         // get the circle location
         var circle = d3.select(this)
         var metab_circle=this
        if(typeof selectMID[data.bigg_id] != "undefined"){ //if there is data for a specific metabolite, then execute makegraph_MID
            met_MIDs=selectMID[data.bigg_id]// selects the metabolite data corresponding to the bigg_id of the metabolite-circle
            frag_keys=Object.keys(selectMID[data.bigg_id]) //returns array of mass fragments of the selected metabolite
            metab_frag_name =  frag_keys[0] //selects the first mass fragment of the selected metabolite

            loc_var={"x_loc":data.x+75, "y_loc":data.y}
            met_context_menu(metab_circle,loc_var,data.bigg_id) //makes metabolite circles on escher map right clickable for appearance of the context menu
            //if(Graph_Location[data.bigg_id][metab_frag_name].MID.x=="X"){    //checks if Group_Location was defined by the user or the script (if defined by the script all entries will be "X")
            if(graph_edited!=true){    //checks if Group_Location was defined by the user or the script (if defined by the script all entries will be "X")
                loc_var={"x_loc":data.x+75, "y_loc":data.y}

                Graph_Location[data.bigg_id][metab_frag_name].MID.x=loc_var.x_loc
                Graph_Location[data.bigg_id][metab_frag_name].MID.y=loc_var.y_loc                
                //makegraph_MID(metab_frag_name,loc_var,ConditionAmount,data.bigg_id,MIDs,ConditionNames,d3.select(circle.node().parentNode)) //spits out graphs of MID data for the metabolite
                makegraph_MID(metab_frag_name,loc_var,ConditionAmount,data.bigg_id,MIDs,ConditionNames,d3.select('.canvas-group')) //spits out graphs of MID data for the metabolite

            }else{

            //print_graphs(data,met_MIDs,circle)
            print_graphs(data,met_MIDs,d3.select(circle.node().parentNode))
            }
        }
   });
    
//Insert Draw Custom Graphs here
    
    if(initilize_graphs_mode!="CG_present"){    
        if(typeof Graph_Location["CG"] != "undefined"){   
            for(CG_index in Graph_Location["CG"]){
                if(Graph_Location["CG"][CG_index].CG_graph.x != "X"){
                    //var location={}
                    loc_var={"x_loc": Graph_Location["CG"][CG_index].CG_graph.x, "y_loc": Graph_Location["CG"][CG_index].CG_graph.y}
                    makegraph_CustomGraph(loc_var,d3.select('.canvas-group'),CG_index);    
                }
            }
        }
    }
        
                     
} //End begin_graph_display    
       
////color_picker and color_scheme functions

function load_color_picker_PopUp(){     //located outside of begin_graph_dislpay so it can be accessed by context_menu     

    $("#all-color-schemes").empty() //remove any previously entered elements of the table

    var j_color_index=0
    
    for(j_color_index=0; j_color_index<color_scheme_obj.length;j_color_index++){ //prints out existing color schemes

        var color_scheme=color_scheme_obj[j_color_index]
        $( "#all-color-schemes" ).append('<input type="radio" name="color" style="display: inline; vertical-align: sub" value='+j_color_index.toString()+'>') //draws a radio input at the start of each color scheme
         for(i=0; i<color_scheme.length; i++){ //build the list of all colors in each color scheme

             /*$( "#all-color-schemes" ).append(
                   '<button id="button_input" class="jscolor {valueElement:null,value:\''+color_scheme[i]+'\'}" style="width:20px; height:20px; border:0.01em solid black; padding: 0.01em;"></button>'                
            );*/

            var input = document.createElement('INPUT') //generates new color input
            input.style.width="40px"
            input.style.fontSize="xx-small"
            input.style.height="20px"
            input.style.textAlign="center"
            input.style.border="0.01em solid black"
            input.id="new_input"
            var picker = new jscolor(input)
            picker.fromString(color_scheme[i]) //sets color of new color inputs to white #FFFFFF
            //input.style.color=color_scheme[i]
            //input.value="" //initially sets text color to nothing
            document.getElementById('all-color-schemes').appendChild(input) //appends new color input to the unordered list 'all-color-schemes'                 



        }
         $( "#all-color-schemes" ).append('<br>') //inserts line break after each color scheme

    }

     d3.select("#add_color").on("click", function() {
         if(j_color_index<=color_scheme_obj.length){
            $( "#all-color-schemes" ).append('<input type="radio" name="color" style="display: inline; vertical-align: sub" value='+j_color_index.toString()+'>')
            j_color_index++
         }
         item_custom_id="color_"+j_color_index.toString()
        var input = document.createElement('INPUT') //generates new color input
        input.style.width="40px"
        input.style.fontSize="x-small"
        input.style.height="20px"
        input.style.textAlign="center"         
        input.style.border="0.01em solid black"
        input.id="new_input"
        var picker = new jscolor(input)
        picker.fromRGB(255,255,255) //sets color of new color inputs to white #FFFFFF
        document.getElementById('all-color-schemes').appendChild(input) //appends new color input to the unordered list 'all-color-schemes'

     })


      $('#close_popup_color_picker').click( function() {
        //sortable('.sortable', 'disable'); //AKSortTest                      
        div_hide('PopUp_color_picker')
    } );


}// )         
    
function get_new_color_scheme_obj(color_array){
    color_scheme_obj=[]
    sel_color_index=0;
    l=-1

    for(m=0;m<color_array.length;m++){
        if(color_array[m].type == "radio"){
            l++
            color_scheme_obj[l]=[] //adds new array to color_scheme_obj to hold a new color scheme
            if(color_array[m].checked == true){
                sel_color_index=l; //stores the selected color scheme as color_index
            }
        }else if(color_array[m].id == "button_input"){ //two separate else if statements are necessary because previous color inputs were buttons and color inputs added by clicking "#add_color" are inputs
            color_scheme_obj[l].push(color_array[m].jscolor.value) 
        }else if(color_array[m].id == "new_input"){
            color_scheme_obj[l].push("#"+color_array[m].value)

        }
    }

        console.log(color_scheme_obj)
        console.log("sel_color_index "+sel_color_index)
        //return [color_scheme_obj,sel_color_index]
        return sel_color_index

}     
    
////END color_picker and color_scheme functions
    
    
function met_context_menu(metab_circle,location,metab_name){ //AK: As of 07-05-18 this is a work in progress... attempting to allow user to click metabolite circles and display context_menu

    svg=d3.select('.canvas-group');    
    //svg=d3.select(d3.select(metab_circle).node().parentNode)
    var menu=[]; //variable which will hold the context menu for each metabolite
    i_count=0; // counter which allows for the number of context menu options to equal the number of integrated peaks
        counter_rand=0; //counter which allows for all condition data to be ploted via the data().enter() structure

    menu=make_menu(menu,i_count,met_MIDs,metab_name,location,0)        
    
    d3.select(metab_circle)
        .on('contextmenu', d3.contextMenu(menu))
        .on('mouseover', function(d){
                    d3.select(this).attr("r",40) //increases size of tick text upon mouseover to make it easier for the user to select the isotopologue MID
                        })
        .on('mouseout', function(d){
                    d3.select(this).attr("r",20) //returns the size of tick text upon mouse over
                        })
}

function replace_graphs(graph_type){ //replaces all currently dislpayed graphs to the graph type specified by the input graph_type

visualized_metab=[] //array to store the names of metabolites that are currently visualized
    
for(metab in Graph_Location){    
    for(frag in Graph_Location[metab]){
        for(graph_type_check in Graph_Location[metab][frag]){
            if(Graph_Location[metab][frag][graph_type_check].x != "X" || Graph_Location[metab][frag][graph_type_check].y != "X"){
                visualized_metab.push(metab)
                //continue
                break
            }
        }
    }
}
    
 remove_graphs() //deletes all graphs currently displayed, resets all locations in Graph_Location to (X,X)

   d3.select('#map_container')
     .selectAll('.metabolite-circle')
     .each(function(data) {
         // only apply the transformation to primary nodes
         if (!data.node_is_primary) {return;}
         // get the circle location
         var circle = d3.select(this)                    
        if(typeof selectMID[data.bigg_id] != "undefined"){ //if there is data for a specific metabolite, then execute makegraph_MID
            for(i1=0; i1<visualized_metab.length;i1++){
                if(visualized_metab[i1]==data.bigg_id){
                    met_MIDs=selectMID[data.bigg_id]// selects the metabolite data corresponding to the bigg_id of the metabolite-circle
                    frag_keys=Object.keys(selectMID[data.bigg_id]) //returns array of mass fragments of the selected metabolite
                    metab_frag_name =  frag_keys[0] //selects the first mass fragment of the selected metabolite
                    loc_var={"x_loc":data.x+75, "y_loc":data.y}
                    Graph_Location[data.bigg_id][metab_frag_name][graph_type].x=loc_var.x_loc
                    Graph_Location[data.bigg_id][metab_frag_name][graph_type].y=loc_var.y_loc  
                    print_graphs(data,met_MIDs,d3.select('.canvas-group'))                    
                }
            }   
        }
   });

console.log("FINISHED RUNNING THROUGH MAP METABOLTIES")    
    
    //The for loop below prints out graphs of data for metabolites not included in the escher map
    unmapped_count=0;
    for(data_metabolite in selectMID){
        if(map_metabolites.indexOf(data_metabolite)<0){
            unmapped_metabolites.push(data_metabolite)//saves the metabolites that are not displayed on the eshcermap into the array unmapped_metabolites
            for(i2=0; i2<visualized_metab.length;i2++){
                if(visualized_metab[i2]==data_metabolite){                
                    met_MIDs=selectMID[data_metabolite]// selects the metabolite data corresponding to the bigg_id of the metabolite-circle
                    frag_keys=Object.keys(selectMID[data_metabolite]) //returns array of mass fragments of the selected metabolite
                    metab_frag_name =  frag_keys[0] //selects the first mass fragment of the selected metabolite
                    loc_var={"x_loc":75, "y_loc":unmapped_count*200*graph_scale_set.MID}
                    Graph_Location[data_metabolite][metab_frag_name][graph_type].x=loc_var.x_loc
                    Graph_Location[data_metabolite][metab_frag_name][graph_type].y=loc_var.y_loc 
                    print_graphs({bigg_id: data_metabolite},met_MIDs,d3.select('.canvas-group')) //print_graphs where data was replaced with {bigg_id: data_metabolite}
                    unmapped_count++
                }
            }
        }
    } 
}
     
function remove_graphs(mode){
    for(var metab_name in Graph_Location){
        if(metab_name != "CG"){ //added to prevent the removal of custom graphs
            for(var metab_frag_name in Graph_Location[metab_name]){        
                for(var graph_type_reset in Graph_Location[metab_name][metab_frag_name]){
                    if(mode!="remove_graphs_only"){
                    //if(mode!="remove_graphs_only" && metab_name!="CG"){
                         Graph_Location[metab_name][metab_frag_name][graph_type_reset].x="X"   
                         Graph_Location[metab_name][metab_frag_name][graph_type_reset].y="X" 
                    }

                     try{ //allows for an exit incase invalid mass_fragment (any id starting without a letter)
                        if(d3.select('#'+metab_frag_name+'_'+graph_type_reset)._groups[0][0]!=null){ //maybe rather then check if the groups exist, check to ensure that their locations are defined?

                        d3.select('#'+metab_frag_name+'_'+graph_type_reset).remove() //removes previous all MIDs

                        }
                     }
                    catch (e){
                        console.log("ERROR in remove_graphs")
                    }                 
                } 
            }
        }
    }   
}

function print_graphs(data,met_MIDs,svg_car){
    if(unmapped_metabolites.indexOf(data.bigg_id)>0){ //if the specified metabolite_fragment is an "unmapped_metabolite" 
            svg_car=d3.select('.canvas-group');
    }        

    for(var frag in met_MIDs){
        metab_frag_name=frag;
        CheckGraph=Graph_Location[data.bigg_id][metab_frag_name]

        for(var graph_type_loop in CheckGraph){
            if(CheckGraph[graph_type_loop].x != "X"){

            loc_var={"x_loc":Graph_Location[data.bigg_id][metab_frag_name][graph_type_loop].x,
                     "y_loc":Graph_Location[data.bigg_id][metab_frag_name][graph_type_loop].y}
               if(graph_type_loop=="MID"){
                   makegraph_MID(metab_frag_name,loc_var,ConditionAmount,data.bigg_id,MIDs,ConditionNames,svg_car)  
               }
               if(graph_type_loop=="stacked_MID"){
                   makegraph_stacked_MID(metab_frag_name,loc_var,ConditionAmount,data.bigg_id,MIDs,ConditionNames,svg_car)  
               }                
               if(graph_type_loop=="MPE"){
                   makegraph_MPE(metab_frag_name,loc_var,ConditionAmount,data.bigg_id,MIDs,ConditionNames,svg_car)  
               }
               if(graph_type_loop=="stacked_abundance"){
                   makegraph_stacked_abundance(metab_frag_name,loc_var,ConditionAmount,data.bigg_id,MIDs,ConditionNames,svg_car)  
               }
               if(graph_type_loop=="total_abundance"){
                   makegraph_total_abundance(metab_frag_name,loc_var,ConditionAmount,data.bigg_id,MIDs,ConditionNames,svg_car)  
               }                
               if(graph_type_loop=="abundance"){
                   makegraph_abundance(metab_frag_name,loc_var,ConditionAmount,data.bigg_id,MIDs,ConditionNames,svg_car)  
               }
               if(graph_type_loop=="Kin_abundance"){
                //selected_Iso_MID=obtain_isotopologue_data(data.bigg_id,metab_frag_name,0) //obtain the isotopologue specific data via obtain_isotopologue_data of M0 as M0 contains total_abundance and total_abundance_error
                   makegraph_timecourse(metab_frag_name,loc_var,ConditionAmount,data.bigg_id,MIDs,ConditionNames,svg_car,"total_abundance")
               }
               if(graph_type_loop=="Kin_MPE"){
                   makegraph_timecourse(metab_frag_name,loc_var,ConditionAmount,data.bigg_id,MIDs,ConditionNames,svg_car,"MPE")
               }
               if(graph_type_loop=="CG_graph"){
                    //d3.select('#'+mass_fragment+'_'+graph_type).remove()                           
                   makegraph_CustomGraph(loc_var,svg_car,metab_frag_name);
                    //Insert Custom Graph function here
               }                
            }
        }

        for(M_index=0; M_index< selectMID[data.bigg_id][metab_frag_name].length; M_index++){ //Checks for the existence of single isotopologue MIDs
            if(CheckGraph['MID_M'+M_index.toString()].x != "X"){ //if there is location data for the single isotopologue then it will be printed below
                    loc_var={"x_loc":Graph_Location[data.bigg_id][metab_frag_name]['MID_M'+M_index.toString()].x,
                            "y_loc":Graph_Location[data.bigg_id][metab_frag_name]['MID_M'+M_index.toString()].y}
                    selected_Iso_MID=obtain_isotopologue_data(data.bigg_id,metab_frag_name,M_index) //obtain the isotopologue specific data via obtain_isotopologue_data.

                makegraph_MID(metab_frag_name,loc_var,ConditionAmount,data.bigg_id,selected_Iso_MID,ConditionNames,svg_car,"select_iso")
            }
            if(CheckGraph['Kin_MID_M'+M_index.toString()].x != "X"){ //if there is location data for the single isotopologue then it will be printed below
                    loc_var={"x_loc":Graph_Location[data.bigg_id][metab_frag_name]['Kin_MID_M'+M_index.toString()].x,
                            "y_loc":Graph_Location[data.bigg_id][metab_frag_name]['Kin_MID_M'+M_index.toString()].y}
                    selected_Iso_MID=obtain_isotopologue_data(data.bigg_id,metab_frag_name,M_index) //obtain the isotopologue specific data via obtain_isotopologue_data.

                makegraph_timecourse(metab_frag_name,loc_var,ConditionAmount,data.bigg_id,selected_Iso_MID,ConditionNames,svg_car,"MID_select_iso")
            }
            if(CheckGraph['abundance_M'+M_index.toString()].x != "X"){ //if there is location data for the single isotopologue then it will be printed below
                    loc_var={"x_loc":Graph_Location[data.bigg_id][metab_frag_name]['abundance_M'+M_index.toString()].x,
                            "y_loc":Graph_Location[data.bigg_id][metab_frag_name]['abundance_M'+M_index.toString()].y}
                    selected_Iso_abundance=obtain_isotopologue_data(data.bigg_id,metab_frag_name,M_index) //obtain the isotopologue specific data via obtain_isotopologue_data.

                makegraph_abundance(metab_frag_name,loc_var,ConditionAmount,data.bigg_id,selected_Iso_abundance,ConditionNames,svg_car,"select_iso")
            }
            if(CheckGraph['Kin_abundance_M'+M_index.toString()].x != "X"){ //if there is location data for the single isotopologue then it will be printed below
                    loc_var={"x_loc":Graph_Location[data.bigg_id][metab_frag_name]['Kin_abundance_M'+M_index.toString()].x,
                            "y_loc":Graph_Location[data.bigg_id][metab_frag_name]['Kin_abundance_M'+M_index.toString()].y}
                    selected_Iso_abundance=obtain_isotopologue_data(data.bigg_id,metab_frag_name,M_index) //obtain the isotopologue specific data via obtain_isotopologue_data.

                makegraph_timecourse(metab_frag_name,loc_var,ConditionAmount,data.bigg_id,selected_Iso_abundance,ConditionNames,svg_car,"abundance_select_iso")
            }            
        }
    }

}        
       
function reprint_graphs(){ //removes previously displayed graphs, replaces them with updated color scheme/size info
    for(var metabolite_fragment in Graph_Location){
        for(var mass_fragment in Graph_Location[metabolite_fragment]){
        graph_coord=Graph_Location[metabolite_fragment][mass_fragment] 
            for(var graph_type in Graph_Location[metabolite_fragment][mass_fragment]){
                try{ //allows for an exit incase invalid mass_fragment (any id starting without a letter)
                    if(d3.select('#'+mass_fragment+'_'+graph_type)._groups[0][0]!=null){ //maybe rather then check if the groups exist, check to ensure that their locations are defined
                        svg_car=d3.select('.canvas-group');
                        
                        loc_var={"x_loc":Graph_Location[metabolite_fragment][mass_fragment][graph_type].x,
                                "y_loc":Graph_Location[metabolite_fragment][mass_fragment][graph_type].y}

                        if(graph_type=="MID"){
                            d3.select('#'+mass_fragment+'_'+graph_type).remove() //removes previous MIDs
                            makegraph_MID(mass_fragment,loc_var,ConditionAmount,metabolite_fragment,MIDs,ConditionNames,svg_car)  //reprints new MIDs
                           }
                        if(graph_type=="MPE"){
                            d3.select('#'+mass_fragment+'_'+graph_type).remove() //removes previous MPEs
                            makegraph_MPE(mass_fragment,loc_var,ConditionAmount,metabolite_fragment,MIDs,ConditionNames,svg_car)  //reprints new MIDs
                           }
                        if(graph_type=="stacked_MID"){
                            d3.select('#'+mass_fragment+'_'+graph_type).remove() //removes previous stacked_MIDs
                            makegraph_stacked_MID(mass_fragment,loc_var,ConditionAmount,metabolite_fragment,MIDs,ConditionNames,svg_car)  //reprints new MIDs
                           }
                        if(graph_type=="abundance"){
                            d3.select('#'+mass_fragment+'_'+graph_type).remove() //removes previous abundance
                            makegraph_abundance(mass_fragment,loc_var,ConditionAmount,metabolite_fragment,MIDs,ConditionNames,svg_car)  //reprints new MIDs
                           }
                        if(graph_type=="stacked_abundance"){
                            d3.select('#'+mass_fragment+'_'+graph_type).remove() //removes previous stacked_abundance                
                            makegraph_stacked_abundance(mass_fragment,loc_var,ConditionAmount,metabolite_fragment,MIDs,ConditionNames,svg_car)  //reprints new MIDs
                           }
                        if(graph_type=="total_abundance"){
                            d3.select('#'+mass_fragment+'_'+graph_type).remove() //removes previous stacked_abundance                
                            makegraph_total_abundance(mass_fragment,loc_var,ConditionAmount,metabolite_fragment,MIDs,ConditionNames,svg_car)  //reprints new MIDs
                           }                        
                        if(graph_type=="Kin_abundance"){
                            d3.select('#'+mass_fragment+'_'+graph_type).remove() //removes previous Kin_abundance                
                            
                            //selected_Iso_MID=obtain_isotopologue_data(metabolite_fragment,mass_fragment,0)//obtain the isotopologue specific data via obtain_isotopologue_data of M0 as M0 contains total_abundance and total_abundance_error
                            //makegraph_timecourse(mass_fragment,loc_var,ConditionAmount,metabolite_fragment,selected_Iso_MID,ConditionNames,svg_car,"total_abundance")
                            makegraph_timecourse(mass_fragment,loc_var,ConditionAmount,metabolite_fragment,MIDs,ConditionNames,svg_car,"total_abundance")
                       }
                        if(graph_type=="Kin_MPE"){
                            d3.select('#'+mass_fragment+'_'+graph_type).remove() //removes previous Kin_MPE                
                            makegraph_timecourse(mass_fragment,loc_var,ConditionAmount,metabolite_fragment,MIDs,ConditionNames,svg_car,"MPE")
                            //makegraph_timecourse(metab_frag_name,location,ConditionAmount,metab_name,MIDs,ConditionNames,svg,mode)
                            
                       }
                        if(graph_type=="CG_graph"){
                            d3.select('#'+mass_fragment+'_'+graph_type).remove()                           
                            makegraph_CustomGraph(loc_var,svg,mass_fragment);
                            //Insert Custom Graph function here
                           }
                    }
                }
                catch (e){
                    console.log(mass_fragment)
                } 
            }
           
            if(typeof selectMID[metabolite_fragment] != "undefined"){ //avoids complications with CG's
                for(M_index=0; M_index< selectMID[metabolite_fragment][mass_fragment].length; M_index++){ //adds MID and abundance locations for individual mass isotopologues to Graph_Locations
                    //reprinting of select isotopologue MID graphs
                    try{ //allows for an exit incase invalid mass_fragment (any id starting without a letter)
                        if(d3.select('#'+mass_fragment+'_MID_M'+M_index.toString())._groups[0][0]!=null){

                            svg_car=d3.select('.canvas-group');                   

                            d3.select('#'+mass_fragment+'_MID_M'+M_index.toString()).remove() //removes previous all MIDs

                            loc_var={"x_loc":Graph_Location[metabolite_fragment][mass_fragment]['MID_M'+M_index.toString()].x,
                                    "y_loc":Graph_Location[metabolite_fragment][mass_fragment]['MID_M'+M_index.toString()].y}

                            selected_Iso_MID=obtain_isotopologue_data(metabolite_fragment,mass_fragment,M_index)
                            makegraph_MID(mass_fragment,loc_var,ConditionAmount,metabolite_fragment,selected_Iso_MID,ConditionNames,svg_car,"select_iso")  //reprints new MIDs
                        }
                    }
                    catch (e){
                        console.log(mass_fragment)
                    }
                    //reprinting of select Kinetic isotopologue MID graphs
                    try{ //allows for an exit incase invalid mass_fragment (any id starting without a letter)
                        if(d3.select('#'+mass_fragment+'_Kin_MID_M'+M_index.toString())._groups[0][0]!=null){

                            svg_car=d3.select('.canvas-group');                          

                            d3.select('#'+mass_fragment+'_Kin_MID_M'+M_index.toString()).remove() //removes previous all Kinetic MIDs

                            loc_var={"x_loc":Graph_Location[metabolite_fragment][mass_fragment]['Kin_MID_M'+M_index.toString()].x,
                                    "y_loc":Graph_Location[metabolite_fragment][mass_fragment]['Kin_MID_M'+M_index.toString()].y}

                            selected_Iso_MID=obtain_isotopologue_data(metabolite_fragment,mass_fragment,M_index)
                            makegraph_timecourse(mass_fragment,loc_var,ConditionAmount,metabolite_fragment,selected_Iso_MID,ConditionNames,svg_car,"MID_select_iso")  //reprints new MIDs
                        }
                    }
                    catch (e){
                        console.log(mass_fragment)
                    }
                    try{ //allows for an exit incase invalid mass_fragment (any id starting without a letter)
                        if(d3.select('#'+mass_fragment+'_abundance_M'+M_index.toString())._groups[0][0]!=null){

                            svg_car=d3.select('.canvas-group');                   

                            d3.select('#'+mass_fragment+'_abundance_M'+M_index.toString()).remove() //removes previous all MIDs

                            loc_var={"x_loc":Graph_Location[metabolite_fragment][mass_fragment]['abundance_M'+M_index.toString()].x,
                                    "y_loc":Graph_Location[metabolite_fragment][mass_fragment]['abundance_M'+M_index.toString()].y}

                            selected_Iso_abundance=obtain_isotopologue_data(metabolite_fragment,mass_fragment,M_index)
                            makegraph_abundance(mass_fragment,loc_var,ConditionAmount,metabolite_fragment,selected_Iso_abundance,ConditionNames,svg_car,"select_iso")  //reprints new MIDs
                        }
                    }
                    catch (e){
                        console.log(mass_fragment)
                    }
                    //reprinting of select Kinetic isotopologue MID graphs
                    try{ //allows for an exit incase invalid mass_fragment (any id starting without a letter)
                        if(d3.select('#'+mass_fragment+'_Kin_abundance_M'+M_index.toString())._groups[0][0]!=null){

                            svg_car=d3.select('.canvas-group');                          

                            d3.select('#'+mass_fragment+'_Kin_abundance_M'+M_index.toString()).remove() //removes previous all Kinetic MIDs

                            loc_var={"x_loc":Graph_Location[metabolite_fragment][mass_fragment]['Kin_abundance_M'+M_index.toString()].x,
                                    "y_loc":Graph_Location[metabolite_fragment][mass_fragment]['Kin_abundance_M'+M_index.toString()].y}

                            selected_Iso_abundance=obtain_isotopologue_data(metabolite_fragment,mass_fragment,M_index)
                            makegraph_timecourse(mass_fragment,loc_var,ConditionAmount,metabolite_fragment,selected_Iso_abundance,ConditionNames,svg_car,"abundance_select_iso")  //reprints new MIDs
                        }
                    }
                    catch (e){
                        console.log(mass_fragment)
                    }                    
                    
               }
            }
        }

    }   
}

function obtain_isotopologue_data(metab_name,metab_frag_name,iso_index){ //takes in a metabolite name, fragment name, and specified isotopomer and returns labeling data for that specific isotopomer of the metabolite fragment
    var selected_Iso_MID='{"selected_Iso_MID":{';
    for(var prop4 in MIDs){
        //the line below creates a string which will converted into a json object, that holds the data of the selected Isotopologue
        selected_Iso_MID=selected_Iso_MID+'"'+prop4+'":{"'+metab_name+'":{"'+metab_frag_name+'":['+JSON.stringify(MIDs[prop4][metab_name][metab_frag_name][iso_index])+']}},'
        }
    selected_Iso_MID=selected_Iso_MID.slice(0, -1)+'}}'
    selected_Iso_MID_parse=JSON.parse(selected_Iso_MID) //select_Iso_MID from a string to an object
    selected_Iso_MID=selected_Iso_MID_parse.selected_Iso_MID //selects the select_Iso_MID key from the object created above (provide the the data for the selected isotopologue in a format identical to MID)   
    return  selected_Iso_MID  
}       

///////AK: From here onward are the makegraph_ functions which produce all graphs currently possible (makegraph_MID,makegraph_MPE,makegraph_stacked_MID,makegraph_abundance,makegraph_stacked_abundance,makegraph_timecourse)       
function Limit_MID(metab_frag_name,met_MIDs){
    frag_MID_full=met_MIDs[metab_frag_name]
    frag_MID=[]
    final_iso=Isotopologue_Limit[metab_frag_name] //make an object
    final_iso_i=frag_MID_full.length-1
    
    for(j=0;j<frag_MID_full.length;j++){
        if (frag_MID_full[j].fragment==final_iso){
            final_iso_i=j
        }
    }
    
    for(i=0;i<=final_iso_i;i++){
        frag_MID[i]=frag_MID_full[i]
    }
    
    return frag_MID  
}

    
function makegraph_CustomGraph(location,svg,metab_frag_name){
    
/*
INPUTS:
metab_frag_name= the name of the metabolite fragment (ex. pyr174)
location=location to print the graph
ConditionAmount=total number of experimental conditions in the data set
metab_name= the BIGG_id of the metabolite (ex. pyr_c)
MIDs=all MID/abundance data for all metabolites+fragments
ConditionNames=Names of the experimental conditions in the data set
svg= svg container that all further svg's are being appended to (this is the canvas that the generated shapes/graphs will be pinned to)
*/
    
    
/*
color=["#0077B5","#66418C","#DD5143","#BD5C14","#00AEB3","#EDB220","#DC4B89","#5B912D","#606264"],
graph_scale=1.75
title_text="Custom Graph"    
yaxis_label_text="% Label"*/ 
    
    
CustomMIDs=CG_container[Number(metab_frag_name.split("_")[1])-1]
//CustomMIDs=CG_container[Number(CG_class.split("_")[1])-1]
           
    
    
metab_name="CG"
//metab_frag_name=CG_class    
   
color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name].CG_graph.color_index]
graph_scale=Graph_Attribute[metab_name][metab_frag_name].CG_graph.scale
title_text=Graph_Attribute[metab_name][metab_frag_name].CG_graph.title    
yaxis_label_text=Graph_Attribute[metab_name][metab_frag_name].CG_graph.yaxis_label      
graph_height_scale=Graph_Attribute[metab_name][metab_frag_name].CG_graph.height_scale
graph_width_scale=Graph_Attribute[metab_name][metab_frag_name].CG_graph.width_scale
graph_avg_scale=(graph_width_scale+graph_height_scale)/2    

if(typeof Graph_Attribute[metab_name][metab_frag_name].CG_graph.normalized== "undefined"){
    Graph_Attribute[metab_name][metab_frag_name].CG_graph.normalized="NA"
}    
    
graph_normalized=Graph_Attribute[metab_name][metab_frag_name].CG_graph.normalized
    

    
if(graph_normalized != "NA" && yaxis_label_text.indexOf("Relative to") == -1){
    yaxis_label_text=yaxis_label_text+" Relative to "+graph_normalized 
    Graph_Attribute[metab_name][metab_frag_name].CG_graph.yaxis_label=yaxis_label_text
}    
    
    
if(typeof graph_height_scale=='undefined' || graph_width_scale=='undefined'){        
    graph_height_scale=1
    graph_width_scale=1  
}    
    
ybound=0; //will hold the maximum y axis value
//finds maximum value of the y axis and lengths of the mass fragment for all conditions
ConditionNames_CG=[]
var ConditionAmount_CG=0;
for(var prop in CustomMIDs){    //cycles through conditions
ConditionNames_CG.push(CustomMIDs[prop][0].condition)    
//frag_MID_cyc=Limit_MID(metab_frag_name,MIDs[prop][metab_name])
//frag_MID_cyc=MIDs[prop][metab_name][metab_frag_name] // frag_MID_cyc is a temporary holder for the MIDS of the specific mass fragment that is cycled through the conditions
frag_MID_cyc=CustomMIDs[prop]
    for(j=0;j<frag_MID_cyc.length;j++){   //cycles through the fragments of the specified mass fragment
        if (frag_MID_cyc[j].value>ybound) {
            //ybound=frag_MID_cyc[j].value
            ybound=frag_MID_cyc[j].value+frag_MID_cyc[j].error //includes error in the ybound

        }
    }
}
    
var index_totalabundance=0
var mode=""
for(j=0;j<CustomMIDs[prop].length;j++){
    if(CustomMIDs[prop][j].title.indexOf("Total Abundance")!=-1){
        index_totalabundance++ //if all datatypes are Total Abundance then mode will be switched to "Total Abundance"
    }
}
    
    
ConditionAmount_CG=ConditionNames_CG.length    
    
if(index_totalabundance==CustomMIDs[prop].length){
    mode="Total Abundance"
}    


var xpos=location.x_loc;
var ypos=location.y_loc;
var current_location=location

MID_xy= [{"x":xpos, "y":ypos}]; 
    
var g = svg.append("g")
    .attr("id",metab_frag_name+"_CG_graph")
    .attr("class","custom_graph")
    .data(MID_xy)
    .attr("transform", "translate(" + xpos + "," + ypos + ")")
    .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", function(d){
                        dragended                          
                        Graph_Location[metab_name][metab_frag_name].CG_graph=d;
                        current_location.x_loc=d.x;
                        current_location.y_loc=d.y;
                    }
           ),
         )


var bargraph_width=(60+18.5*(frag_MID_cyc.length*ConditionAmount_CG))*graph_scale*graph_width_scale, //alters graph width based on length of MID
//    bargraph_height=125*graph_scale;    
    bargraph_height=250*graph_scale*graph_height_scale;    

var //svg = d3.select("svg"),
    margin = {top: 70, right: 20, bottom: 10, left: 40},
    width = bargraph_width - margin.left - margin.right,
    height = bargraph_height - margin.top - margin.bottom;
    //width = bargraph_width - margin.left - margin.right-100,
    //height = bargraph_height - margin.top - margin.bottom-100;    

// var x = d3.scaleBand().rangeRound([0, width]).padding(0.2),//generates the x axis, padding changes thickness of bars
//     y = d3.scaleLinear().rangeRound([height, 0]);//generates the y axis
var x = d3.scaleBand().rangeRound([0, width]).padding(0.2),//generates the x axis, padding changes thickness of bars
    y = d3.scaleLinear().rangeRound([height, 0]);//generates the y axis

ConditionIndex=0;
for(var prop3 in CustomMIDs){ //cycles through conditions
    frag_MID=CustomMIDs[prop3]

    x.domain(frag_MID.map(function(d) {  return d.x_axis_label;})); //sets the domain of the x axis
    y.domain([0, ybound]); //sets the domain of the y axis

    var bar_width=x.bandwidth()/ConditionAmount_CG; //sets the width of each bar in the bar graph   
    
    var menu=[]; //variable which will hold the context menu for each metabolite
    i_count=0; // counter which allows for the number of context menu options to equal the number of integrated peaks
        counter_rand=0; //counter which allows for all condition data to be ploted via the data().enter() structure
    menu[i_count]={title: "delete",
                   onMouseClick: function(elm, d, i) {
                       svg.selectAll("#"+metab_frag_name+'_CG_graph').remove() //remove old MPE of the selected fragment
                       Graph_Location[metab_name][metab_frag_name].CG_graph={"x":"X","y":"X"}
                    
                       d3.select('.d3-context-menu').style('display', 'none');

                    },
                
                    onMouseOver: function(elm,d,i){},
                       chidernItems: []
                }
        i_count=i_count+1


    menu=make_menu(menu,i_count,"CG",metab_name,current_location,bargraph_height,metab_frag_name,"CG_graph",svg,d3.select('#'+metab_frag_name+'_CG_graph'))    



    g.selectAll(".bar") //generates the individual bars of the MID graph
      //g.append("g")
        .data(frag_MID, function(d){counter_rand=counter_rand+1
         return counter_rand})
        //.data(MIDs)
        .attr("id", "bargraphdata")
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", function(d,i) { 
        return x(d.title)+bar_width*ConditionIndex}) //x.bandwidth()*ConditionIndex/ConditionAmount is what allows for the addition of multiple conditions on one graph. ConditionIndex/ConditionAmounts shifts all of the bars for a given condition over by a constant amount
        .attr("width", bar_width)//thins each bar based on the amount of conditions
        .attr("y", function (d) { return height; })
        .attr("height", 0)
        .transition()
        .duration(1000)//time in ms            
        .attr("y", function (d, i) {
                if(d.value<0){
                    return 0}
                else{
                    return y(d.value);}})
        .attr("height", function (d, i) {
                if(d.value<0){
                    return 0}
                else{
                    return height - y(d.value);}})

        //.attr("fill",color[ConditionIndex]) //sets a different bar color for each condition
        .attr("fill",function(d){
        return color[ConditionIndex]})//sets a different bar color for each condition
       // .style("fill", "url(#circles-1)")
        //.attr("fill", "url(#diagonal-stripe-2)")
        .attr("stroke","black") 

/*
    //Adds text of the value of each bar above each bar
      g.selectAll(".barlabel")
      //g.append("g")
           .attr("id", "barlabel")                
           .data(frag_MID,function(d){counter_rand=counter_rand+1
                 return counter_rand})
           .enter()
           .append("text")
           .attr("x",function(d){
                    if (Math.round(d.value*100)<10){
                    return (x(d.title)+bar_width*ConditionIndex)+bar_width/3
                    }else if(Math.round(d.value*100)<100){
                    return (x(d.title)+bar_width*ConditionIndex)+bar_width/6
                    }else{
                    return (x(d.title)+bar_width*ConditionIndex)
                    }                    
                
                })
            .attr("y", function (d) { return y(d.error)-5; })
            .transition()
            .duration(1000)
            .attr("y", function (d) { return y(d.value+d.error)-5; })
            .attr("class","barlabel")
            .attr("fill",function(d){
                    if(d.value<0){
                        return "red"}
                    else{
                        return "black"}})    
            //.attr("font-family","Palatino Linotype", "Book Antiqua", "Palatino, serif")
            //.attr("font-family","Times New Roman")
            .attr("font-family","Helvetica Neue", "Helvetica", "Arial", "sans-serif")
            .attr("font-weight","normal")    
            .attr("font-size",String(10*graph_scale)+"px")
           //.text(function(d){return d.value.toFixed(2)*100});
           .text(function(d){return Math.round(d.value*100)});
*/    
    
    var legend_scale=30*graph_avg_scale
    
    g.append("rect")//creates box with condition color
        .attr("class", "legend")
        .attr("width", legend_scale/1.5)
        .attr("height", legend_scale/3)    
        .attr("x", width)
        .attr("y", legend_scale/1.5*ConditionIndex)
        .attr("fill", color[ConditionIndex])
        .attr("stroke","black");    

    g.append("text") //creates text next to legend box's
        .attr("class", "legendlabel")
        .attr("x", width+legend_scale/1.5+graph_scale)
        //.attr("y", (bar_width)*(ConditionIndex+.75))
        //.attr("y", (bar_width/1.5)*(ConditionIndex+.6))
        .attr("y",function(d){ return (legend_scale/1.5)*(ConditionIndex+.6)
            }             
        )
        .style("fill","black")
        .attr("font-size",String(10*graph_scale*graph_avg_scale)+"px")
        .text(function(d){
                          return ConditionNames_CG[ConditionIndex]}); //includes the total_frequency next to the legendlabel

    g.selectAll(".errorbar")
       .data(frag_MID)//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
//           .attr("stroke-width","1")
       .attr("stroke-width",String(1*graph_scale*graph_width_scale))
       //.attr("class", "errorbar")
       .attr("x1",function(d){return (x(d.title)+bar_width*ConditionIndex)+bar_width/2})
       .attr("x2",function(d){return (x(d.title)+bar_width*ConditionIndex)+bar_width/2})
       .attr("y1",function (d) { return y(d.value);})
       .attr("y2",function (d) { return y(d.value);})
       .transition() //below allows for animation of bar graphs to occur
       .delay(1000)
       .duration(500)    
       .attr("y1",function (d) { return y(d.value-d.error);})
       .attr("y2",function (d) { return y(d.value+d.error);})
       .attr("fill", "none") 
       .attr("stroke", "black");

    g.selectAll(".errorbar_edge1")
       .data(frag_MID)//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
       //.attr("stroke-width","1")
       .attr("stroke-width",String(1*graph_scale*graph_width_scale))
       //.attr("class", "errorbar")
       .attr("y1",function (d) { return y(d.value-d.error);})
       .attr("y2",function (d) { return y(d.value-d.error);})
       .attr("x1",function(d){return (x(d.title)+bar_width*ConditionIndex)+bar_width/2})
       .attr("x2",function(d){return (x(d.title)+bar_width*ConditionIndex)+bar_width/2})
       .transition() //below allows for animation of bar graphs to occur
       .delay(1500)
       .duration(500) 
       .attr("x1",function(d){return (x(d.title)+bar_width*ConditionIndex)+bar_width/2+5*graph_scale*graph_width_scale})
       .attr("x2",function(d){return (x(d.title)+bar_width*ConditionIndex)+bar_width/2-5*graph_scale*graph_width_scale})
       .attr("fill", "none") 
       .attr("stroke", "black");

    g.selectAll(".errorbar_edge2")
       .data(frag_MID)//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
       //.attr("stroke-width","1")
       .attr("stroke-width",String(1*graph_scale*graph_width_scale))
       //.attr("class", "errorbar")
       .attr("y1",function (d) { return y(d.value+d.error);})
       .attr("y2",function (d) { return y(d.value+d.error);})
       .attr("x1",function(d){return (x(d.title)+bar_width*ConditionIndex)+bar_width/2})
       .attr("x2",function(d){return (x(d.title)+bar_width*ConditionIndex)+bar_width/2})
       .transition() //below allows for animation of bar graphs to occur
       .delay(1500)
       .duration(500)
       .attr("x1",function(d){return (x(d.title)+bar_width*ConditionIndex)+bar_width/2+5*graph_scale*graph_width_scale})
       .attr("x2",function(d){return (x(d.title)+bar_width*ConditionIndex)+bar_width/2-5*graph_scale*graph_width_scale})
       .attr("fill", "none") 
       .attr("stroke", "black");    
    ConditionIndex=ConditionIndex+1;
    }


if (mode=="Total Abundance" || graph_normalized != "NA"){
    g.append("g")
        .attr("id", "MID_yaxis")
        .attr("class", "axis axis--y")
        .call(d3.axisLeft(y).tickFormat(d3.format(".1e"))) //leads to scientific notation
        .call(d3.axisLeft(y).ticks(3))
        //.attr("font-size","12px");
      .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
      .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px");
}else{    
    g.append("g")
      .attr("id", "MID_yaxis")
      .attr("class", "axis axis--y")
      .call(d3.axisLeft(y).ticks(3, "%"))
      //.attr("font-size","12px");
      .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
      .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px");
}


//block which makes MID clickable
g.append("rect")//creates box with condition color
    .attr("id", "click_box")
    .attr("class", "click_box")
    .on('contextmenu', d3.contextMenu(menu))
    /*.on('touchstart', d3.contextMenu(menu))
    .on("touchmove", function(d){
		d3.select('.d3-context-menu').style('display', 'none');
                      // Clear timeout
                      return false;
                    }) */    
    .attr("height",bargraph_height+25*graph_scale)
    .attr("width",bargraph_width+60*graph_scale)    
    .attr("x", -60*graph_scale)
    .attr("y", -50*graph_scale)
    .style("opacity", 0)    
    .attr("fill", "white")    
    //.attr("fill", "transparent")    
    .style("cursor", "move")
    .append("svg:title")
        .text("Right Click to Access Additional Options");    
    
g.append("text") //adds clickable arrow to induce contextmenu
  .attr("id", "context_button")     
  .attr("class", "context_button")     
  .attr("x",-60*graph_height_scale)
  .attr("y",-50*graph_height_scale)
  .attr("style","font-family:FontAwesome; cursor:pointer;")    
  .attr("font-weight", 300)
  .attr("fill","#337ab7")
  .attr('font-size', function(d) { return (graph_height_scale*50).toString()+'px';} )
  .text(function(d) { return '\uf152'; })
  .on('click', d3.contextMenu(menu))
  .on('touchstart', d3.contextMenu(menu));      

g.append("text")
   .on('contextmenu', d3.contextMenu(menu))
   .attr("class","titlelabel")
   .attr("id",metab_frag_name+"titlelabel")  
   //.attr("x", width/2-15*graph_scale)
   .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
   .attr("transform", "translate("+ (width/2) +","+(-25*graph_scale)+")")  // text is drawn off the screen top left, move down and out and rotate    
 /*  .attr("x",function(d){
                        if(mode=="select_iso"){
                            return  width/2-32*graph_scale;
                        }else{
                            return  width/2-15*graph_scale;}
                    }
        )    
   .attr("y", -25*graph_scale) //changed from -15 to -25 to avoid collision of text and errorbars/percentages*/
    //.attr("font-family","Palatino Linotype", "Book Antiqua", "Palatino, serif")
   .attr("font-size",String(13*graph_scale*graph_avg_scale)+"px")
  .text(title_text)
  .on("click", function(d){make_editable(this,d,'title',metab_name,metab_frag_name,"CG_graph")})    
    
g.append("text")  //adds y axis label
  .attr("class", "y_axis_label")
  .attr("id", metab_frag_name+"MID_y_axis_label")
  .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
  .attr("transform", "translate("+ (-40*graph_scale*graph_avg_scale) +","+(height/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate    
  .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px")
  .text(yaxis_label_text)
  .on("click", function(d){make_editable(this,d,'y_axis_label',metab_name,metab_frag_name,"CG_graph")})    
//make_editable(this_one,d,field,metab_name,metab_frag_name,graph_type) 

g.append("g")
  .attr("id", "MID_xaxis")
  .attr("class", "axis axis--x")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(x))
    .selectAll("text")	
    .style("text-anchor", "end")
    /*.attr("id", function(d,i){
                          return "tick_"+i.toString()
                          })*/
    .attr("class","x_axis_tick")
    .attr("id",function(d,i){
            return "tick_"+i.toString()})
    .attr("dx", "-.8em")
    .attr("dy", ".15em")
    .attr("transform", function(d) {
        return "rotate(-65)" 
        })
  //.attr("font-size","11px");
  .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
  .attr("tick-size",6*graph_scale*graph_avg_scale)    
  .attr("font-size",String(11*graph_scale*graph_avg_scale)+"px")  
    
    
  g.selectAll('.tick') //makes axis ticks clickable and identifiable
      .style("cursor", "pointer")  
  //    .on("click", function(d){make_editable_tick(this,d,'x_axis_label',metab_name,metab_frag_name,"CG_graph")})   
      .on("click", function(d,i){
      make_editable_tick(this.childNodes[1],d,'x_axis_label',metab_name,metab_frag_name,"CG_graph")}) 
      .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px");  
    
     
}
    

function makegraph_MID(metab_frag_name,location,ConditionAmount,metab_name,MIDs,ConditionNames,svg,mode){
/*
INPUTS:
metab_frag_name= the name of the metabolite fragment (ex. pyr174)
location=location to print the graph
ConditionAmount=total number of experimental conditions in the data set
metab_name= the BIGG_id of the metabolite (ex. pyr_c)
MIDs=all MID/abundance data for all metabolites+fragments
ConditionNames=Names of the experimental conditions in the data set
svg= svg container that all further svg's are being appended to (this is the canvas that the generated shapes/graphs will be pinned to)
*/  
    
color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name].MID.color_index]
graph_scale=Graph_Attribute[metab_name][metab_frag_name].MID.scale
graph_height_scale=Graph_Attribute[metab_name][metab_frag_name].MID.height_scale
graph_width_scale=Graph_Attribute[metab_name][metab_frag_name].MID.width_scale
graph_avg_scale=(graph_width_scale+graph_height_scale)/2
title_text=Graph_Attribute[metab_name][metab_frag_name].MID.title    
yaxis_label_text=Graph_Attribute[metab_name][metab_frag_name].MID.yaxis_label      
    
if(typeof graph_height_scale=='undefined' || graph_width_scale=='undefined'){        
    graph_height_scale=1
    graph_width_scale=1  
}
    
    
ybound=0; //will hold the maximum y axis value
//finds maximum value of the y axis and lengths of the mass fragment for all conditions
for(var prop in MIDs){    //cycles through conditions
    
frag_MID_cyc=Limit_MID(metab_frag_name,MIDs[prop][metab_name])
//frag_MID_cyc=MIDs[prop][metab_name][metab_frag_name] // frag_MID_cyc is a temporary holder for the MIDS of the specific mass fragment that is cycled through the conditions

    for(j=0;j<frag_MID_cyc.length;j++){   //cycles through the fragments of the specified mass fragment
        if (frag_MID_cyc[j].frequency>ybound) {
            //ybound=frag_MID_cyc[j].frequency
            ybound=frag_MID_cyc[j].frequency+frag_MID_cyc[j].error //includes error in the ybound

        }
    }
}



if(mode=="select_iso"){
        var select_iso_name=MIDs[Object.keys(MIDs)[0]][metab_name][metab_frag_name][0].fragment
        var select_iso_id=  metab_frag_name+'_MID_'+select_iso_name
        
        //graph_scale=Graph_Attribute[metab_name][metab_frag_name]['MID_'+select_iso_name].scale 
        //color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name]['MID_'+select_iso_name].color_index]
    
        color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name]['MID_'+select_iso_name].color_index]
        graph_scale=Graph_Attribute[metab_name][metab_frag_name]['MID_'+select_iso_name].scale    
        title_text=Graph_Attribute[metab_name][metab_frag_name]['MID_'+select_iso_name].title    
        yaxis_label_text=Graph_Attribute[metab_name][metab_frag_name]['MID_'+select_iso_name].yaxis_label   
        graph_height_scale=Graph_Attribute[metab_name][metab_frag_name]['MID_'+select_iso_name].height_scale
        graph_width_scale=Graph_Attribute[metab_name][metab_frag_name]['MID_'+select_iso_name].width_scale
        graph_avg_scale=(graph_width_scale+graph_height_scale)/2

    
}


var xpos=location.x_loc;
var ypos=location.y_loc;
var current_location=location

MID_xy= [{"x":xpos, "y":ypos}]; 
    
//var svg2=svg.append("svg")    
var g = svg.append("g")
//var g = svg2.append("g")
    .attr("id", function(d){
                    if(mode=="select_iso"){
                        //select_iso_name=MIDs[Object.keys(MIDs)[0]][metab_name][metab_frag_name][0].fragment
                            return select_iso_id
                    }else{
                       return  metab_frag_name+'_MID'
                    }
    })
    .attr("class",metab_name)
    .data(MID_xy)
    .attr("transform", "translate(" + xpos + "," + ypos + ")")
    .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", function(d){
                        dragended
                        if(mode=="select_iso"){
                            Graph_Location[metab_name][metab_frag_name]['MID_'+select_iso_name]=d;
                        }else{                           
                            Graph_Location[metab_name][metab_frag_name].MID=d;
                        }
                        current_location.x_loc=d.x;
                        current_location.y_loc=d.y;
                    }
           ),
         )


var bargraph_width=(60+18.5*(frag_MID.length*ConditionAmount))*graph_scale*graph_width_scale, //alters graph width based on length of MID
    bargraph_height=185*graph_scale*graph_height_scale;    

var //svg = d3.select("svg"),
    margin = {top: 70, right: 20, bottom: 10, left: 40},
    width = bargraph_width - margin.left - margin.right,
    height = bargraph_height - margin.top - margin.bottom;
    //width = bargraph_width - margin.left - margin.right-100,
    //height = bargraph_height - margin.top - margin.bottom-100;    

// var x = d3.scaleBand().rangeRound([0, width]).padding(0.2),//generates the x axis, padding changes thickness of bars
//     y = d3.scaleLinear().rangeRound([height, 0]);//generates the y axis
var x = d3.scaleBand().rangeRound([0, width]).padding(0.2),//generates the x axis, padding changes thickness of bars
    y = d3.scaleLinear().rangeRound([height, 0]);//generates the y axis

ConditionIndex=0;
for(var prop3 in MIDs){ //cycles through conditions
    met_MIDs=MIDs[prop3][metab_name] //pulls all of the data a specific metabolite within a specific condition
    //frag_MID=met_MIDs[metab_frag_name] //pulls the data for a specific mass fragment
    frag_MID=Limit_MID(metab_frag_name,met_MIDs)
    total_frequency=0;
    //loop which sums up the frequency accross the isotopologues for each mass fragment
    for(n=0; n<frag_MID.length; n++){
        total_frequency=total_frequency+frag_MID[n].frequency
    }

    x.domain(frag_MID.map(function(d) {  return d.fragment;})); //sets the domain of the x axis
    y.domain([-.01, ybound]); //sets the domain of the y axis

    var bar_width=x.bandwidth()/ConditionAmount; //sets the width of each bar in the bar graph   

    
    var menu=[]; //variable which will hold the context menu for each metabolite
    i_count=0; // counter which allows for the number of context menu options to equal the number of integrated peaks
        counter_rand=0; //counter which allows for all condition data to be ploted via the data().enter() structure
    menu[i_count]={title: "delete",
                   onMouseClick: function(elm, d, i) {

                    if(mode=="select_iso"){
                       svg.selectAll("#"+select_iso_id).remove() //remove old MPE of the selected fragment
                       Graph_Location[metab_name][metab_frag_name]['MID_'+select_iso_name]={"x":"X","y":"X"}
                    }else{                           
                       svg.selectAll("#"+metab_frag_name+'_MID').remove() //remove old MPE of the selected fragment
                       Graph_Location[metab_name][metab_frag_name].MID={"x":"X","y":"X"}
                    }
                       d3.select('.d3-context-menu').style('display', 'none');

                    },
                    onMouseOver: function(elm,d,i){},
                       chidernItems: []
                }
        i_count=i_count+1

    //    menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height)
    if(mode=="select_iso"){
        console.log('MID_'+select_iso_name)
        console.log(Graph_Attribute[metab_name][metab_frag_name])
        console.log(Graph_Attribute[metab_name][metab_frag_name]['MID_'+select_iso_name])
        //menu=make_menu2(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height,metab_frag_name,'MID_'+select_iso_name,svg,d3.select('#'+select_iso_id))
        menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height,metab_frag_name,'MID_'+select_iso_name,svg,d3.select('#'+select_iso_id))

    }else{   
        //menu=make_menu2(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height,metab_frag_name,"MID",svg,d3.select('#'+metab_frag_name+'_MID'))
        menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height,metab_frag_name,"MID",svg,d3.select('#'+metab_frag_name+'_MID'))
    }    


    
    
    

    g.selectAll(".bar") //generates the individual bars of the MID graph
      //g.append("g")
        .data(frag_MID, function(d){counter_rand=counter_rand+1
         return counter_rand})
        //.data(MIDs)
        .attr("id", "bargraphdata")
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", function(d,i) { 
        return x(d.fragment)+bar_width*ConditionIndex}) //x.bandwidth()*ConditionIndex/ConditionAmount is what allows for the addition of multiple conditions on one graph. ConditionIndex/ConditionAmounts shifts all of the bars for a given condition over by a constant amount
        .attr("width", bar_width)//thins each bar based on the amount of conditions
        .attr("y", function (d) { return height; })
        .attr("height", 0)
        .transition()
        .duration(1000)//time in ms            
        .attr("y", function (d, i) {
                if(d.frequency<0){
                    return 0}
                else{
                    return y(d.frequency);}})
        .attr("height", function (d, i) {
                if(d.frequency<0){
                    return 0}
                else{
                    return height - y(d.frequency);}})

        //.attr("fill",color[ConditionIndex]) //sets a different bar color for each condition
        .attr("fill",function(d){
        return color[ConditionIndex]})//sets a different bar color for each condition
       // .style("fill", "url(#circles-1)")
        //.attr("fill", "url(#diagonal-stripe-2)")
        .attr("stroke","black") 


    //Adds text of the value of each bar above each bar
    
    if(display_bar_label==true){
      g.selectAll(".barlabel")
      //g.append("g")
           .attr("id", "barlabel")                
           .data(frag_MID,function(d){counter_rand=counter_rand+1
                 return counter_rand})
           .enter()
           .append("text")
           .attr("x",function(d){
                if(mode=="select_iso"){
                    if (Math.round(d.frequency*100)<10){
                    return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2.5
                    }else if(Math.round(d.frequency*100)<100){
                    return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/3.8
                    }else{
                    return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/8
                    }
                }else{
                    if (Math.round(d.frequency*100)<10){
                    return (x(d.fragment)+bar_width*ConditionIndex+bar_width/3)
                    }else if(Math.round(d.frequency*100)<100){
                    return (x(d.fragment)+bar_width*ConditionIndex+bar_width/6)
                    }else{
                    return (x(d.fragment)+bar_width*ConditionIndex)
                    }                    
                }
                })
            .attr("y", function (d) { return y(d.error)-5; })
            .transition()
            .duration(1000)
            .attr("y", function (d) { return y(d.frequency+d.error)-5; })
            .attr("class","barlabel")
            .attr("fill",function(d){
                    if(d.frequency<0 && display_legend_metrics==true){
                        return "red"}
                    else{
                        return "black"}})    
            //.attr("font-family","Palatino Linotype", "Book Antiqua", "Palatino, serif")
            //.attr("font-family","Times New Roman")
            .attr("font-family","Helvetica Neue", "Helvetica", "Arial", "sans-serif")
            .attr("font-weight","normal")    
            .attr("font-size",String(10*graph_scale*graph_width_scale)+"px")
           //.text(function(d){return d.frequency.toFixed(2)*100});
           .text(function(d){return Math.round(d.frequency*100)});
    }
    //var legend_scale=30*graph_height_scale
    legend_scale=30*graph_avg_scale
    
    g.append("rect")//creates box with condition color
        .attr("class", "legend")
        .attr("width", legend_scale/1.5)
        .attr("height", legend_scale/3)    
        .attr("x", width)
        .attr("y", legend_scale/1.5*ConditionIndex)
        .attr("fill", color[ConditionIndex])
        .attr("stroke","black");
        //.call(drag);

    g.append("text") //creates text next to legend box's
        .attr("class", "legendlabel")
        .attr("x", width+legend_scale/1.5+graph_scale)
        //.attr("y", (bar_width)*(ConditionIndex+.75))
        //.attr("y", (bar_width/1.5)*(ConditionIndex+.6))
        .attr("y",function(d){
            if (mode=="select_iso"){
                return (legend_scale/1.5)*(ConditionIndex+.53)                
            }else{
                return (legend_scale/1.5)*(ConditionIndex+.6)
            }             
        })
        .style("fill",function(d){
            if(total_frequency<0.95 && mode!="select_iso" && display_legend_metrics==true){ //if total_frequency is below .95 alert user with red text
                    return "red"
                }else{"black"}})
       // .attr("font-size",String(10*graph_scale*graph_height_scale)+"px")
        .attr("font-size",String(10*graph_scale*graph_avg_scale)+"px")
        .text(function(d){
                        if (mode=="select_iso" || display_legend_metrics==false){
                          return ConditionNames[ConditionIndex];
                        }else{
                          return ConditionNames[ConditionIndex]+' '+(Math.round(total_frequency*100)).toString()+'%'}}); //includes the total_frequency next to the legendlabel

    g.selectAll(".errorbar")
       .data(frag_MID)//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
//           .attr("stroke-width","1")
       .attr("stroke-width",String(1*graph_scale*graph_width_scale))
       //.attr("class", "errorbar")
       .attr("x1",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2})
       .attr("x2",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2})
       .attr("y1",function (d) { return y(d.frequency);})
       .attr("y2",function (d) { return y(d.frequency);})
       .transition() //below allows for animation of bar graphs to occur
       .delay(1000)
       .duration(500)    
       .attr("y1",function (d) { return y(d.frequency-d.error);})
       .attr("y2",function (d) { return y(d.frequency+d.error);})
       .attr("fill", "none") 
       .attr("stroke", "black");

    g.selectAll(".errorbar_edge1")
       .data(frag_MID)//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
       //.attr("stroke-width","1")
       .attr("stroke-width",String(1*graph_scale*graph_width_scale))
       //.attr("class", "errorbar")
       .attr("y1",function (d) { return y(d.frequency-d.error);})
       .attr("y2",function (d) { return y(d.frequency-d.error);})
       .attr("x1",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2})
       .attr("x2",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2})
       .transition() //below allows for animation of bar graphs to occur
       .delay(1500)
       .duration(500) 
       .attr("x1",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2+5*graph_scale*graph_width_scale})
       .attr("x2",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2-5*graph_scale*graph_width_scale})
       .attr("fill", "none") 
       .attr("stroke", "black");

    g.selectAll(".errorbar_edge2")
       .data(frag_MID)//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
       //.attr("stroke-width","1")
       .attr("stroke-width",String(1*graph_scale*graph_width_scale))
       //.attr("class", "errorbar")
       .attr("y1",function (d) { return y(d.frequency+d.error);})
       .attr("y2",function (d) { return y(d.frequency+d.error);})
       .attr("x1",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2})
       .attr("x2",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2})
       .transition() //below allows for animation of bar graphs to occur
       .delay(1500)
       .duration(500)
       .attr("x1",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2+5*graph_scale*graph_width_scale})
       .attr("x2",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2-5*graph_scale*graph_width_scale})
       .attr("fill", "none") 
       .attr("stroke", "black");    
    ConditionIndex=ConditionIndex+1;
    }

g.append("g")
  .attr("id", "MID_yaxis")
  .attr("class", "axis axis--y")
  .call(d3.axisLeft(y).ticks(3, "%"))
  //.attr("font-size","12px");
  .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
  .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px");
    
var pressTimer;

//block which makes MID clickable
g.append("rect")//creates box with condition color
    .attr("id", "click_box")
    .attr("class", "click_box")
    //.attr("title", "Right Click to Acess Additional Options")
   //.on('contextmenu', d3.contextMenu(menu))
   /* .on('contextmenu', function(d,i){
        return d3.contextMenu(menu)
            }
       )*/
    //.on('click',context_menu_click(this))
    .on('contextmenu', d3.contextMenu(menu))
    //.on('touchstart', context_menu_touch(this))
    /*.on('touchstart', d3.contextMenu(menu))
    .on("touchmove", function(d){
		d3.select('.d3-context-menu').style('display', 'none');
                      // Clear timeout
                      return false;
                    })    */
    /*.on('touchstart',function(d){
        console.log(this)
        if (d3.event.defaultPrevented){
            //alert('no contextmenu')
            return;} // dragged
            //alert(' contextmenu next')
    
            d3.contextMenu(menu)
        })*/
    /*.on("touchstart", function(d){
                        //pressTimer = setTimeout(function() {
                        setTimeout(function(this) {
                            console.log(pressTimer)
                            d3.contextMenu(menu)    
                        },10);
                      // Clear timeout
                      return false;
                    })   */   
    /*.on("touchmove", function(d){
		d3.select('.d3-context-menu').style('display', 'none');
                      // Clear timeout
                      return false;
                    })  */  
    /*.on("touchend", function(d){
                     clearTimeout(pressTimer);
                      // Clear timeout
                      return false;
                    })*/    
    .attr("height",bargraph_height+25*graph_scale)
    .attr("width",bargraph_width+60*graph_scale)    
    .attr("x", -60*graph_scale)
    .attr("y", -50*graph_scale)
    .style("opacity", 0)    
    .attr("fill", "white")    
    //.attr("fill", "transparent")    
    .style("cursor", "move")
    .append("svg:title")
        .text("Right Click to Access Additional Options");
    
g.append("text") //adds clickable arrow to induce contextmenu
  .attr("id", "context_button")     
  .attr("class", "context_button")     
  .attr("x",-60*graph_height_scale)
  .attr("y",-50*graph_height_scale)
  .attr("style","font-family:FontAwesome; cursor:pointer;")    
  .attr("font-weight", 300)
  .attr("fill","#337ab7")
  .attr('font-size', function(d) { return (graph_height_scale*50).toString()+'px';} )
  .text(function(d) { return '\uf152'; })
  .on('click', d3.contextMenu(menu))
  .on('touchstart', d3.contextMenu(menu));
    
    

g.append("text")
   .on('contextmenu', d3.contextMenu(menu))
   .attr("class","titlelabel")
   .attr("id",metab_name+"titlelabel")  
   //.attr("x", width/2-15*graph_scale)
   .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
   .attr("transform", "translate("+ (width/2) +","+(-25*graph_scale)+")")  // text is drawn off the screen top left, move down and out and rotate    
    //.attr("font-family","Palatino Linotype", "Book Antiqua", "Palatino, serif")
   .attr("font-size",String(13*graph_scale*graph_avg_scale)+"px")
  .text(title_text)
  .on("click", function(d){make_editable(this,d,'title',metab_name,metab_frag_name,"MID")})    
  //.on("click", function(d){make_slider(this,d,'title',metab_name,metab_frag_name,"MID")})    
    
    
//make_slider    
    
g.append("text")  //adds y axis label
  .attr("class", "y_axis_label")
  .attr("id", metab_name+"MID_y_axis_label")
  /*.attr("transform", function(d) {
        return "rotate(-90)" 
        })*/
  .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
  .attr("transform", "translate("+ (-40*graph_scale*graph_avg_scale) +","+(height/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate    
  .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px")
  .text(yaxis_label_text)
  .on("click", function(d){make_editable(this,d,'y_axis_label',metab_name,metab_frag_name,"MID")})    
//make_editable(this_one,d,field,metab_name,metab_frag_name,graph_type) 

g.append("g")
  .attr("id", "MID_xaxis")
  .attr("class", "axis axis--x")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(x))
  //.attr("font-size","13px");
  .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
  .attr("tick-size",6*graph_scale*graph_avg_scale)
  .attr("font-size",String(13*graph_scale*graph_avg_scale)+"px");
        
    
if (mode!="select_iso"){ 
    
  g.selectAll('.tick') //makes axis ticks clickable and identifiable
      .style("cursor", "pointer")        
      .on('mouseover', function(d){
                 el_mo =  d3.select(this)._groups[0][0].getElementsByTagName('text')[0]
                 style_mo = window.getComputedStyle(el_mo, null).getPropertyValue('font-size');
                 fontSize = parseFloat(style_mo);     
                 d3.select(this).attr("font-size",String(fontSize*3)+"px") //increases size of tick text upon mouseover to make it easier for the user to select the isotopologue MID
                    })
      .on('mouseout', function(d){
                 el_mo =  d3.select(this)._groups[0][0].getElementsByTagName('text')[0]
                 style_mo = window.getComputedStyle(el_mo, null).getPropertyValue('font-size');
                 fontSize = parseFloat(style_mo);        
                 d3.select(this).attr("font-size",String(fontSize/3)+"px") //returns the size of tick text upon mouse over
                    })
      .on('click', function(d) {// console.log(MIDs[prop][metab_name][metab_frag_name]),
                              iso_index=Number(d.replace("M","")) //index of the selected isotopologue
                                console.log("click")
                             // console.log(MIDs[prop][metab_name][metab_frag_name][dumm]);
                             var selected_Iso_MID='{"selected_Iso_MID":{';
                                 for(var prop4 in MIDs){
                                //the line below creates a string which will converted into a json object, that holds the data of the selected Isotopologue
                                selected_Iso_MID=selected_Iso_MID+'"'+prop4+'":{"'+metab_name+'":{"'+metab_frag_name+'":['+JSON.stringify(MIDs[prop4][metab_name][metab_frag_name][iso_index])+']}},'
                                 }
                                selected_Iso_MID=selected_Iso_MID.slice(0, -1)+'}}'
                                selected_Iso_MID_parse=JSON.parse(selected_Iso_MID) //select_Iso_MID from a string to an object
                                selected_Iso_MID=selected_Iso_MID_parse.selected_Iso_MID //selects the select_Iso_MID key from the object created above (provide the the data for the selected isotopologue in a format identical to MID)
                                current_location.y_loc=current_location.y_loc+bargraph_height+25*graph_scale
                                Graph_Location[metab_name][metab_frag_name]['MID_M'+iso_index]={"x":current_location.x_loc, "y":current_location.y_loc} //assigns a location to the isotopologue MID
                             makegraph_MID(metab_frag_name,current_location,ConditionAmount,metab_name,selected_Iso_MID,ConditionNames,svg,"select_iso")
                             if(Condition_Times != ''){
                                current_location.x_loc=current_location.x_loc+bargraph_width/2
                                Graph_Location[metab_name][metab_frag_name]['Kin_MID_M'+iso_index]={"x":current_location.x_loc, "y":current_location.y_loc} //assigns a location to the isotopologue MID
                                makegraph_timecourse(metab_frag_name,current_location,ConditionAmount,metab_name,selected_Iso_MID,ConditionNames,svg,"MID_select_iso")
                             }

                             }
       )
     .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px");
}

} 
/* 
function calculate_MPE(metab_name,metab_frag_name){ //updated 5/24/19 to correctly calculate MPE avg and error
MPE=[];
MPE_error=[]; 
All_MPE=[]
All_MPE_inorder=[]
file_names=''
o=0;
    
Object.keys(fileorganizer)
    
    
for(Conditions in fileorganizer){
    All_MPE[o]=[]
    for(k=0;k<fileorganizer[Conditions].length;k++){
        file_names=fileorganizer[Conditions][k]              
        full_file_MID=FileMIDs["File"+(FileNames.indexOf(file_names)+1).toString()][metab_name]
        full_MID={}
        full_MID[metab_frag_name]=full_file_MID[metab_frag_name].labeling
        frag_MID_cyc=Limit_MID(metab_frag_name,full_MID) 
        All_MPE[o][k]=0;

        for(j=0;j<frag_MID_cyc.length;j++){   //cycles through the fragments of the specified mass fragment
            All_MPE[o][k]=All_MPE[o][k]+frag_MID_cyc[j].frequency*j/(frag_MID_cyc.length-1)
        }
        All_MPE_inorder.push(All_MPE[o][k])
    }
    MPE[o]=math.mean(All_MPE[o])
    MPE_error[o]=math.std(All_MPE[o])
    o++
}

return [MPE, MPE_error, All_MPE_inorder] 

} 
  */  
function calculate_MPE(metab_name,metab_frag_name,ConditionNames_MPE){ //updated 5/24/19 to correctly calculate MPE avg and error
Condition_Array=[];
MPE=[];
MPE_error=[]; 
All_MPE=[]
All_MPE_inorder=[]
file_names=''
//o=0;

if(typeof ConditionNames_MPE == "undefined"){
    Condition_Array=Object.keys(fileorganizer)
}else{
    Condition_Array=ConditionNames_MPE
}    
    
    
//for(Conditions in fileorganizer){
for(o=0; o<Condition_Array.length; o++){
    Conditions=Condition_Array[o]
    All_MPE[o]=[]
    for(k=0;k<fileorganizer[Conditions].length;k++){
        file_names=fileorganizer[Conditions][k]              
        full_file_MID=FileMIDs["File"+(FileNames.indexOf(file_names)+1).toString()][metab_name]
        full_MID={}
        full_MID[metab_frag_name]=full_file_MID[metab_frag_name].labeling
        frag_MID_cyc=Limit_MID(metab_frag_name,full_MID) 
        All_MPE[o][k]=0;

        for(j=0;j<frag_MID_cyc.length;j++){   //cycles through the fragments of the specified mass fragment
            All_MPE[o][k]=All_MPE[o][k]+frag_MID_cyc[j].frequency*j/(frag_MID_cyc.length-1)
        }
        All_MPE_inorder.push(All_MPE[o][k])
    }
    MPE[o]=math.mean(All_MPE[o])
    MPE_error[o]=math.std(All_MPE[o])
    //o++
}

return [MPE, MPE_error, All_MPE_inorder] 

}        
    /////Start MPE GRAPH      
function makegraph_MPE(metab_frag_name,location,ConditionAmount,metab_name,MIDs,ConditionNames,svg){
/*
INPUTS:
metab_frag_name= the name of the metabolite fragment (ex. pyr174)
location=location to print the graph
ConditionAmount=total number of experimental conditions in the data set
metab_name= the BIGG_id of the metabolite (ex. pyr_c)
MIDs=all MID/abundance data for all metabolites+fragments
ConditionNames=Names of the experimental conditions in the data set
svg= svg container that all further svg's are being appended to (this is the canvas that the generated shapes/graphs will be pinned to)
*/

/////////////////////////////////////////////////////////////////////////////////////////////
//[MPE, MPE_error]=calculate_MPE(metab_name,metab_frag_name,MIDs)    
[MPE, MPE_error]=calculate_MPE(metab_name,metab_frag_name,ConditionNames)    
/*    
MPE=MPE.slice(0,ConditionNames.length)    
MPE_error=MPE_error.slice(0,ConditionNames.length)  */  
    
/////////////////////////////////////////////////////////////////////////////////////////////

//color=color_set.MPE;
//graph_scale=graph_scale_set.MPE
    
color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name].MPE.color_index]
graph_scale=Graph_Attribute[metab_name][metab_frag_name].MPE.scale  
graph_height_scale=Graph_Attribute[metab_name][metab_frag_name].MPE.height_scale
graph_width_scale=Graph_Attribute[metab_name][metab_frag_name].MPE.width_scale
graph_avg_scale=(graph_width_scale+graph_height_scale)/2    
title_text=Graph_Attribute[metab_name][metab_frag_name].MPE.title    
yaxis_label_text=Graph_Attribute[metab_name][metab_frag_name].MPE.yaxis_label       
    
if(typeof graph_height_scale=='undefined' || graph_width_scale=='undefined'){        
    graph_height_scale=1
    graph_width_scale=1  
}    
    
var xpos=location.x_loc;
var ypos=location.y_loc;
var current_location=location

MID_xy= [{"x":xpos, "y":ypos}]; 

var g = svg.append("g")
    //.attr("id", metab_name)
    .attr("id", metab_frag_name+'_MPE')
    .attr("class",metab_name)
    .data(MID_xy)
    .attr("transform", "translate(" + xpos + "," + ypos + ")")
    .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", function(d){
                    dragended
                    Graph_Location[metab_name][metab_frag_name].MPE=d;
                    current_location.x_loc=d.x;
                    current_location.y_loc=d.y;                        }
           ),
         )

var bargraph_width=(60+18.5*(ConditionAmount))*graph_scale*graph_width_scale,
    bargraph_height=185*graph_scale*graph_height_scale;    

var //svg = d3.select("svg"),
    margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = bargraph_width - margin.left - margin.right,
    height = bargraph_height - margin.top - margin.bottom;

var x = d3.scaleBand().rangeRound([0, width]).padding(0.2),//padding changes thickness of bars
    y = d3.scaleLinear().rangeRound([height, 0]);

  x.domain(ConditionNames.map(function(d) {  return d}));

MPE_plus_error=[]
for(i=0;i<ConditionNames.length;i++){
    MPE_plus_error[i]=MPE[i]+MPE_error[i]        
}  
  y.domain([0, Math.max.apply(null, MPE_plus_error)]);

var bar_width=x.bandwidth();

counter_rand=0; //counter which allows for all condition data to be ploted via the data().enter() structure
    
//ContextMenuStuff
g.selectAll(".bar")
        .data(MPE, function(d){counter_rand=counter_rand+1
         return counter_rand})
        //.data(MPE[ConditionIndex])
        .attr("id", "bargraphdata")
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", function(d,i) { return x(ConditionNames[i]); })
        .attr("width", bar_width)//thins each bar based on the amount of conditions
        .attr("y", function (d) { return height; })
        .attr("height", 0)
        .transition() //below allows for animation of bar graphs to occur
        .duration(1000)
        .attr("y", function (d, i) {
                    if(d<0){
                        return y(0)}
                    else{
                    return y(d);}})
        .attr("height", function(d,i){
                    if(d<0){
                        return 0}
                    else{
                        return height - y(d)}})
        //.attr("fill",function (d, i) {return color[i]}) //sets a different bar color for each condition
        .attr("fill", function(d,i){
                        return color[i]
                                }) //sets a different bar color for each condition
        .attr("stroke","black") ;


if(display_bar_label==true){
g.selectAll(".barlabel")
       .attr("id", "barlabel")                
       .data(MPE,function(d){counter_rand=counter_rand+1
             return counter_rand})
       .enter()
       .append("text")
       .attr("x",function(d,i){
            if (Math.round(d*100)<10){
            return x(ConditionNames[i])+bar_width/3
            }else if(Math.round(d*100)<100){
            return x(ConditionNames[i])+bar_width/5
            }else{
            return x(ConditionNames[i])+bar_width/7
            }
            })
        .attr("y", function (d) {return y(0)-5*graph_scale})
        .transition()
        .duration(1000)
        .attr("y", function (d,i) {
                if(d<0){
                    return y(0+MPE_error[i])-5*graph_scale}
                else{
                    return y(d+MPE_error[i])-5*graph_scale;}})
        .attr("class","barlabel")
        .attr("fill",function(d){
                if(d<0){
                    return "red"}
                else{
                    return "black"}})
        //.attr("stroke", "black")
        //.attr("font-family","Palatino Linotype", "Book Antiqua", "Palatino, serif")
        //.attr("font-family","Times New Roman")
        .attr("font-family","Helvetica Neue", "Helvetica", "Arial", "sans-serif")
        //.attr("font-weight",-1)
        .attr("font-weight","normal")
        //.attr("font-size","6.5px")
        //.attr("font-size","9px")
        //.attr("font-size","10px")
        .attr("font-size",String(10*graph_scale*graph_width_scale)+"px")
       .text(function(d){return Math.round(d*100)});

}

g.selectAll(".errorbar")
       .data(MPE,function(d){counter_rand=counter_rand+1
             return counter_rand})
       .enter()
       .append("line")
       .attr("stroke-width",String(1*graph_scale*graph_width_scale))
       .attr("x1", function(d,i) { return x(ConditionNames[i])+bar_width/2; })
       .attr("x2", function(d,i) { return x(ConditionNames[i])+bar_width/2; })
       .attr("y1", function (d) { return height; })
       .attr("y2", function (d) { return height; })
       .transition() //below allows for animation of bar graphs to occur
       .duration(1000)    
       .attr("y1", function (d, i) {
                    if(d<0){
                        return y(0+MPE_error[i])}
                    else{                            
                    return y(d+MPE_error[i]);}})
       .attr("y2", function (d, i) {
                    if(d<0){
                        return y(0-MPE_error[i])}
                    else{
                    return y(d-MPE_error[i]);}})    
       .attr("fill", "none") 
       .attr("stroke", "black");

g.selectAll(".errorbar_edge1")
       .data(MPE,function(d){counter_rand=counter_rand+1
             return counter_rand})
       .enter()
       .append("line")
       //.attr("stroke-width","1")
       .attr("stroke-width",String(1*graph_scale*graph_width_scale))
       //.attr("class", "errorbar")
       .attr("x1", function(d,i) { return x(ConditionNames[i])+bar_width/2; })
       .attr("x2", function(d,i) { return x(ConditionNames[i])+bar_width/2; })
       .attr("y1", function (d, i) {
                    if(d<0){
                        return y(0+MPE_error[i])}
                    else{
                    return y(d+MPE_error[i]);}})
       .attr("y2", function (d, i) {
                    if(d<0){
                        return y(0+MPE_error[i])}
                    else{
                    return y(d+MPE_error[i]);}})       
       .transition()
       .duration(2000)    
       .attr("x1", function(d,i) { return x(ConditionNames[i])+bar_width/2+5*graph_scale*graph_width_scale; })
       .attr("x2", function(d,i) { return x(ConditionNames[i])+bar_width/2-5*graph_scale*graph_width_scale; })
        .attr("fill", "none") 
       .attr("stroke", "black");

g.selectAll(".errorbar_edge2")
       .data(MPE,function(d){counter_rand=counter_rand+1
             return counter_rand})
       .enter()
       .append("line")
       //.attr("stroke-width","1")
       .attr("stroke-width",String(1*graph_scale*graph_width_scale))
       //.attr("class", "errorbar")
       .attr("x1", function(d,i) { return x(ConditionNames[i])+bar_width/2; })
       .attr("x2", function(d,i) { return x(ConditionNames[i])+bar_width/2; })
       .attr("y1", function (d, i) {
                    if(d<0){
                        return y(0-MPE_error[i])}
                    else{
                    return y(d-MPE_error[i]);}})
       .attr("y2", function (d, i) {
                    if(d<0){
                        return y(0-MPE_error[i])}
                    else{
                    return y(d-MPE_error[i]);}})       
       .transition()
       .duration(2000)     
       .attr("x1", function(d,i) { return x(ConditionNames[i])+bar_width/2+5*graph_scale*graph_width_scale; })
       .attr("x2", function(d,i) { return x(ConditionNames[i])+bar_width/2-5*graph_scale*graph_width_scale; })
       .attr("fill", "none") 
       .attr("stroke", "black");     

ConditionIndex=0;
for(var prop3 in MIDs){ //cycles through conditions
    met_MIDs=MIDs[prop3][metab_name]
    //frag_MID=met_MIDs[metab_frag_name]
    frag_MID=Limit_MID(metab_frag_name,met_MIDs)

    var menu=[]; //variable which will hold the context menu for each metabolite
    i_count=0; // counter which allows for the number of context menu options to equal the number of integrated peaks
    menu[i_count]={title: "delete",
                   onMouseClick: function(elm, d, i) {                          
                       svg.selectAll("#"+metab_frag_name+'_MPE').remove() //remove old MPE of the selected fragment
                       Graph_Location[metab_name][metab_frag_name].MPE={"x":"X","y":"X"}
                       d3.select('.d3-context-menu').style('display', 'none');
                    },
                    onMouseOver: function(elm,d,i){},
                       chidernItems: []
                }
        i_count=i_count+1

    //menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height)
    menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height,metab_frag_name,"MPE",svg,d3.select('#'+metab_frag_name+'_MPE'))
    ConditionIndex=ConditionIndex+1;
}
g.append("g")
  .attr("id", "MID_xaxis")
  .attr("class", "axis axis--x")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(x))
    .selectAll("text")	
    .style("text-anchor", "end")
    .attr("dx", "-.8em")
    .attr("dy", ".15em")
    .attr("transform", function(d) {
        return "rotate(-65)" 
        })
  //.attr("font-size","11px");
  .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
  .attr("tick-size",6*graph_scale*graph_avg_scale)
  .attr("font-size",String(11*graph_scale*graph_avg_scale)+"px");    
  //.attr("transform", "rotate(45)")
  //.style("text-anchor", "start");;

g.append("g")
  .attr("id", "MID_yaxis")
  .attr("class", "axis axis--y")
  .call(d3.axisLeft(y).ticks(3, "%"))
  .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
  .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px");

//block which makes graph clickable
g.append("rect")//creates box with condition color
    .attr("id", "click_box")
    .attr("class", "click_box")
    .on('contextmenu', d3.contextMenu(menu))
   /* .on('touchstart', d3.contextMenu(menu))
    .on("touchmove", function(d){
		d3.select('.d3-context-menu').style('display', 'none');
                      // Clear timeout
                      return false;
                    })     */
    .attr("height",function(d){
            return this.parentElement.getBBox().height+40*graph_scale
        })
    .attr("width",function(d){
            return this.parentElement.getBBox().width+40*graph_scale*graph_avg_scale
        })
    .attr("x",function(d){
            return this.parentElement.getBBox().x-40*graph_scale*graph_avg_scale
        })     
    .attr("y",function(d){
            return this.parentElement.getBBox().y-40*graph_scale
        })      
   /* .attr("width",width)    
    .attr("x", -40*graph_scale*graph_avg_scale)    
    .attr("y", -50*graph_height_scale)*//*    
    .attr("height",bargraph_height+25*graph_scale)
    .attr("width",width)    
    .attr("x", 0)    
    .attr("y", -25*graph_scale)*/
    .style("opacity", 0)    
    .attr("fill", "white")        
    //.attr("fill", "transparent")
    .style("cursor", "move")
    .append("svg:title")
        .text("Right Click to Access Additional Options"); 
    
    
g.append("text") //adds clickable arrow to induce contextmenu
  .attr("id", "context_button")     
  .attr("class", "context_button")     
  .attr("x",-50*graph_scale*graph_avg_scale)
  .attr("y",-50*graph_height_scale)
  .attr("style","font-family:FontAwesome; cursor:pointer;")    
  .attr("font-weight", 300)
  .attr("fill","#337ab7")
  .attr('font-size', function(d) { return (graph_height_scale*50).toString()+'px';} )
  .text(function(d) { return '\uf152'; })
  .on('click', d3.contextMenu(menu))
  .on('touchstart', d3.contextMenu(menu))

g.append("text")  //adds y axis label
  .attr("class", "y_axis_label")
  .attr("id", metab_name+"MPE_y_axis_label")
  .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
  .attr("transform", "translate("+ (-40*graph_scale*graph_avg_scale) +","+(height/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate       
  .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px")
  //.text(function(d){return "% Enrichment"})
  //.on("click", function(d){make_editable(this,d)});
  .text(yaxis_label_text)
  .on("click", function(d){make_editable(this,d,'y_axis_label',metab_name,metab_frag_name,"MPE")})       
    

g.append("text")
   .on('contextmenu', d3.contextMenu(menu))
   .attr("class","titlelabel")
   .attr("id",metab_name+"titlelabel")
   .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
   .attr("transform", "translate("+ (width/2) +","+(-25*graph_scale)+")")  // text is drawn off the screen top left, move down and out and rotate      
   .attr("font-size",String(13*graph_scale*graph_avg_scale)+"px")
   //.text(function(d){return metab_frag_name.charAt(0).toUpperCase() + metab_frag_name.slice(1)+" MPE";})
  // .on("click", function(d){make_editable(this,d)});
   .text(title_text)
   .on("click", function(d){make_editable(this,d,'title',metab_name,metab_frag_name,"MPE")})



}
/////End MPE GRAPH      
    
    
/////Start MID Stacked graph
function makegraph_stacked_MID(metab_frag_name,location,ConditionAmount,metab_name,MIDs,ConditionNames,svg){
/*
INPUTS:
metab_frag_name= the name of the metabolite fragment (ex. pyr174)
location=location to print the graph
ConditionAmount=total number of experimental conditions in the data set
metab_name= the BIGG_id of the metabolite (ex. pyr_c)
MIDs=all MID/abundance data for all metabolites+fragments
ConditionNames=Names of the experimental conditions in the data set
svg= svg container that all further svg's are being appended to (this is the canvas that the generated shapes/graphs will be pinned to)
*/
ybound=0;
//finds maximum values and lengths of the mass fragment for all conditions
//var graph_scale=1.75;
for(var prop in MIDs){    //cycles through conditions
frag_MID_cyc=Limit_MID(metab_frag_name,MIDs[prop][metab_name])
    
//frag_MID_cyc=MIDs[prop][metab_name][metab_frag_name] // frag_MID_cyc is a temporary holder for the MIDS of the specific mass fragment that is cycled through the conditions

    for(j=0;j<frag_MID_cyc.length;j++){   //cycles through the fragments of the specified mass fragment
        if (frag_MID_cyc[j].frequency>ybound) {
            ybound=frag_MID_cyc[j].frequency

        }
    }
}

//color=color_set.stacked_MID;
//graph_scale=graph_scale_set.stacked_MID

color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name].stacked_MID.color_index]
graph_scale=Graph_Attribute[metab_name][metab_frag_name].stacked_MID.scale   
title_text=Graph_Attribute[metab_name][metab_frag_name].stacked_MID.title    
yaxis_label_text=Graph_Attribute[metab_name][metab_frag_name].stacked_MID.yaxis_label  
graph_height_scale=Graph_Attribute[metab_name][metab_frag_name].stacked_MID.height_scale
graph_width_scale=Graph_Attribute[metab_name][metab_frag_name].stacked_MID.width_scale
graph_avg_scale=(graph_width_scale+graph_height_scale)/2    
    
if(typeof graph_height_scale=='undefined' || graph_width_scale=='undefined'){        
    graph_height_scale=1
    graph_width_scale=1  
}    
    

var xpos=location.x_loc;
var ypos=location.y_loc;
var current_location=location    

MID_xy= [{"x":xpos, "y":ypos}]; 

var g = svg.append("g")
    //.attr("id", metab_name)
    .attr("id", metab_frag_name+'_stacked_MID')
    .attr("class",metab_name)
    .data(MID_xy)
    .attr("transform", "translate(" + xpos + "," + ypos + ")")
    .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", function(d){
                    dragended
                    Graph_Location[metab_name][metab_frag_name].stacked_MID=d;
                    current_location.x_loc=d.x;
                    current_location.y_loc=d.y;                        }
           ),
         )

var bargraph_width=(60+18.5*ConditionAmount)*graph_scale*graph_width_scale,
    bargraph_height=185*graph_scale*graph_height_scale;  

var //svg = d3.select("svg"),
    margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = bargraph_width - margin.left - margin.right,
    height = bargraph_height - margin.top - margin.bottom;

var x = d3.scaleBand().rangeRound([0, width]).padding(0.2),//padding changes thickness of bars
    y = d3.scaleLinear().rangeRound([height, 0]);

x.domain(ConditionNames.map(function(d) {  return d}));
//y.domain([-.01, ybound]);
//y.domain([-.01, 1]);
y.domain([0, 1]);

var bar_width=x.bandwidth();

ConditionIndex=0;
for(var prop3 in MIDs){ //cycles through conditions
    met_MIDs=MIDs[prop3][metab_name]
    //frag_MID=met_MIDs[metab_frag_name]    
    frag_MID=Limit_MID(metab_frag_name,met_MIDs)


    //ContextMenuStuff

    var menu=[]; //variable which will hold the context menu for each metabolite
    i_count=0; // counter which allows for the number of context menu options to equal the number of integrated peaks
        counter_rand=0; //counter which allows for all condition data to be ploted via the data().enter() structure
    menu[i_count]={title: "delete",
                   onMouseClick: function(elm, d, i) {                          
                       svg.selectAll("#"+metab_frag_name+'_stacked_MID').remove() //remove old MPE of the selected fragment
                       Graph_Location[metab_name][metab_frag_name].stacked_MID={"x":"X","y":"X"}
                       d3.select('.d3-context-menu').style('display', 'none');
                    },
                    onMouseOver: function(elm,d,i){},
                       chidernItems: []
                }
        i_count=i_count+1
    
    //menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height)
    menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height,metab_frag_name,"stacked_MID",svg,d3.select('#'+metab_frag_name+'_stacked_MID'))
    
    sum_bar=0; //sum_bar allows for bars to stack ontop of eachother
    g.selectAll(".bar")
            .data(frag_MID, function(d){counter_rand=counter_rand+1
             return counter_rand})
            .attr("id", "bargraphdata")
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function(d) { return x(ConditionNames[ConditionIndex]); })
            .attr("width", bar_width)//thins each bar based on the amount of conditions
            .attr("y", function (d) { return height; })
            .attr("height", 0)
            .transition() //below allows for animation of bar graphs to occur
            .duration(1000)
            .attr("y", function (d, i) {
                        if(d.frequency>0){
                            sum_bar=sum_bar+d.frequency
                            return y(sum_bar)}
                        else{
                        return y(sum_bar);}})
            .attr("height", function(d,i){
                            return y(0) - y(d.frequency)})
            .attr("fill",function (d, i) {return color[i]}) //sets a different bar color for each condition
            .attr("stroke","black") 

    sum_bar1=0; //sum_bar allows for bars to stack ontop of eachother
    sum_bar2=0; //sum_bar allows for bars to stack ontop of eachother
    sum_bar3=0; //sum_bar allows for bars to stack ontop of eachother
    g.selectAll(".errorbar")
       .data(frag_MID)//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
       //.attr("stroke-width","1")
       .attr("stroke-width",String(0.5*graph_scale*graph_width_scale))
       //.attr("class", "errorbar")
       .attr("x1",function(d){return x(ConditionNames[ConditionIndex])+bar_width/2})
       //.attr("y1",function (d) { return y(d.frequency-d.error);})
       .attr("y1", function (d, i) {
                        if(d.frequency<0){
                            return y(sum_bar1)}
                        else{
                            //return y(d.frequency);}
                        sum_bar1=sum_bar1+d.frequency
                        return y(sum_bar1);}})
       .attr("x2",function(d){return x(ConditionNames[ConditionIndex])+bar_width/2})
       //.attr("y2",function (d) { return y(d.frequency+d.error);})
       .attr("y2", function (d, i) {
                        if(d.frequency<0){
                            return y(sum_bar2)}
                        else{
                            //return y(d.frequency);}
                        //sum_bar2=sum_bar2+d.frequency+d.error
                        sum_bar2=sum_bar2+d.frequency
                        return y(sum_bar2);}}) //error added here to avoid error compounding on sum_bar2
       .transition()
       .delay(1000)
       .duration(250)      
       .attr("y2", function (d, i) {
                        if(d.frequency<0){
                            return y(sum_bar3)}
                        else{
                            //return y(d.frequency);}
                        //sum_bar2=sum_bar2+d.frequency+d.error
                        sum_bar3=sum_bar3+d.frequency
                        return y(sum_bar3+d.error);}}) //error added here to avoid error compounding on sum_bar2        
       .attr("fill", "none") 
       .attr("stroke", "black");

    sum_bar1=0; //sum_bar allows for bars to stack ontop of eachother
    sum_bar2=0; //sum_bar allows for bars to stack ontop of eachother 
    g.selectAll(".errorbar_edge1")
       .data(frag_MID)//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
       //.attr("stroke-width","1")
       .attr("stroke-width",String(0.5*graph_scale*graph_width_scale))
    //.attr("class", "errorbar")
       .attr("x1",function(d){return x(ConditionNames[ConditionIndex])+bar_width/2})
       //.attr("y1", function (d, i) {
    //                    sum_bar1=sum_bar1+d.frequency+d.error
    //                    return y(sum_bar1);})
       .attr("y1", function (d, i) {
                        if(d.frequency<0){
                            return y(sum_bar1)}
                        else{
                        sum_bar1=sum_bar1+d.frequency
                        return y(sum_bar1+d.error);}}) 
       .attr("x2",function(d){return x(ConditionNames[ConditionIndex])+bar_width/2})
       //.attr("y2", function (d, i) {
    //                    sum_bar2=sum_bar2+d.frequency+d.error
    //                    return y(sum_bar2);})
       .attr("y2", function (d, i) {
                        if(d.frequency<0){
                            return y(sum_bar2)}
                        else{
                        sum_bar2=sum_bar2+d.frequency
                        return y(sum_bar2+d.error);}}) //error added here to avoid error compounding on sum_bar2
       .transition()
       .delay(1250)
       .duration(250)
       .attr("x1",function(d){return x(ConditionNames[ConditionIndex])+bar_width/2+5*graph_scale*graph_width_scale})        
       .attr("x2",function(d){return x(ConditionNames[ConditionIndex])+bar_width/2-5*graph_scale*graph_width_scale})        
       .attr("fill", "none") 
       .attr("stroke", "black");   

    ConditionIndex=ConditionIndex+1;
}
    
g.append("g")
  .attr("id", "MID_xaxis")
  .attr("class", "axis axis--x")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(x))
    .selectAll("text")	
    .style("text-anchor", "end")
    .attr("dx", "-.8em")
    .attr("dy", ".15em")
    .attr("transform", function(d) {
        return "rotate(-65)" 
        })
  .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
  .attr("tick-size",6*graph_scale*graph_avg_scale)    
  .attr("font-size",String(11*graph_scale*graph_avg_scale)+"px");


g.append("g")
  .attr("id", "MID_yaxis")
  .attr("class", "axis axis--y")
  .call(d3.axisLeft(y).ticks(3, "%"))
  .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
  .attr("tick-size",6*graph_scale*graph_avg_scale)
  .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px");    
    
legend_scale=200*graph_avg_scale    

g.selectAll(".stacked_legend")
    .attr("class", "stacked_legend")
    .data(frag_MID, function(d){counter_rand=counter_rand+1
     return counter_rand})
    .enter().append("rect")
    //.attr("class", "bar")
    .attr("width", legend_scale/10)
    .attr("height", legend_scale/20)    
    .attr("x", width)
    .attr("y", function(d,i){return legend_scale/15*i})
    .attr("fill", function(d,i){return color[i]})
    .attr("stroke","black") ;


g.selectAll(".legendlabel")
    .attr("class", "legendlabel")
    .data(frag_MID, function(d){counter_rand=counter_rand+1
     return counter_rand})
    .enter().append("text")
    .attr("x", width+legend_scale/10+1)
    .attr("y", function(d,i){return legend_scale/15*(i+.77)})
    .attr("font-size",String(7*graph_scale*graph_avg_scale)+"px")
    .text(function(d){
   return d.fragment});  

//block which makes MID clickable
g.append("rect")//creates box with condition color
    .attr("id", "click_box")
    .attr("class", "click_box")
    .on('contextmenu', d3.contextMenu(menu))
   /* .on('touchstart', d3.contextMenu(menu))
    .on("touchmove", function(d){
		d3.select('.d3-context-menu').style('display', 'none');
                      // Clear timeout
                      return false;
                    })*/
    .attr("height",function(d){
            return this.parentElement.getBBox().height+40*graph_scale
        })
    .attr("width",function(d){
            return this.parentElement.getBBox().width+40*graph_scale*graph_avg_scale
        })
    .attr("x",function(d){
            return this.parentElement.getBBox().x-40*graph_scale*graph_avg_scale
        })     
    .attr("y",function(d){
            return this.parentElement.getBBox().y-40*graph_scale
        })    
    /*.attr("height",bargraph_height)
    .attr("width",bargraph_width)    
    .attr("x", 0)
    .attr("y", -25)*/
    .style("opacity", 0)    
    .attr("fill", "white")        
    //.attr("fill", "transparent")
    .style("cursor", "move")
    .append("svg:title")
        .text("Right Click to Access Additional Options");    
    
    
g.append("text") //adds clickable arrow to induce contextmenu
  .attr("id", "context_button")     
  .attr("class", "context_button")     
  .attr("x",-50*graph_scale*graph_avg_scale)
  .attr("y",-50*graph_height_scale)
  .attr("style","font-family:FontAwesome; cursor:pointer;")    
  .attr("font-weight", 300)
  .attr("fill","#337ab7")
  .attr('font-size', function(d) { return (graph_height_scale*50).toString()+'px';} )
  .text(function(d) { return '\uf152'; })
  .on('click', d3.contextMenu(menu))
  .on('touchstart', d3.contextMenu(menu));
    
g.append("text")  //adds y axis label
  .attr("class", "y_axis_label")
  .attr("id", metab_name+"stacked_MID_y_axis_label")
  .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
  .attr("transform", "translate("+ (-40*graph_scale*graph_avg_scale) +","+(height/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate      
  .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px")   
  .text(yaxis_label_text)
  .on("click", function(d){make_editable(this,d,'y_axis_label',metab_name,metab_frag_name,"stacked_MID")})       


g.append("text")
   .on('contextmenu', d3.contextMenu(menu))
   .attr("class","titlelabel")
   .attr("id",metab_name+"titlelabel")
   .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
   .attr("transform", "translate("+ (width/2) +","+(-25*graph_scale)+")")  // text is drawn off the screen top left, move down and out and rotate      
   .attr("font-size",String(13*graph_scale*graph_avg_scale)+"px")
   .text(title_text)
   .on("click", function(d){make_editable(this,d,'title',metab_name,metab_frag_name,"stacked_MID")})    
      


    
    
    
}
/////End MID Stacked GRAPH            

 /////START Abundance GRAPH
function makegraph_abundance(metab_frag_name,location,ConditionAmount,metab_name,MIDs,ConditionNames,svg,mode){
/*
INPUTS:
metab_frag_name= the name of the metabolite fragment (ex. pyr174)
location=location to print the graph
ConditionAmount=total number of experimental conditions in the data set
metab_name= the BIGG_id of the metabolite (ex. pyr_c)
MIDs=all MID/abundance data for all metabolites+fragments
ConditionNames=Names of the experimental conditions in the data set
svg= svg container that all further svg's are being appended to (this is the canvas that the generated shapes/graphs will be pinned to)
*/
ybound=0;
ConditionIndex=0;
ybound_index=0;
//var graph_scale=1.75;

//finds maximum values and lengths of the mass fragment for all conditions
for(var prop in MIDs){    //cycles through conditions
frag_MID_cyc=Limit_MID(metab_frag_name,MIDs[prop][metab_name])
    
//frag_MID_cyc=MIDs[prop][metab_name][metab_frag_name] // frag_MID_cyc is a temporary holder for the MIDS of the specific mass fragment that is cycled through the conditions

    for(j=0;j<frag_MID_cyc.length;j++){   //cycles through the fragments of the specified mass fragment
        if (frag_MID_cyc[j].abundance>ybound) {
            ybound=frag_MID_cyc[j].abundance
            ybound_index=ConditionIndex;
            //ybound=frag_MID_cyc[j].abundance+frag_MID_cyc[j].error*total_abundance //includes error in the ybound

        }
    }
    ConditionIndex++
}


//color=color_set.abundance;
//graph_scale=graph_scale_set.abundance
    
color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name].abundance.color_index]
graph_scale=Graph_Attribute[metab_name][metab_frag_name].abundance.scale
graph_height_scale=Graph_Attribute[metab_name][metab_frag_name].abundance.height_scale
graph_width_scale=Graph_Attribute[metab_name][metab_frag_name].abundance.width_scale
graph_avg_scale=(graph_width_scale+graph_height_scale)/2    
title_text=Graph_Attribute[metab_name][metab_frag_name].abundance.title    
yaxis_label_text=Graph_Attribute[metab_name][metab_frag_name].abundance.yaxis_label       
    
if(typeof graph_height_scale=='undefined' || graph_width_scale=='undefined'){        
    graph_height_scale=1
    graph_width_scale=1  
}
    
if(mode=="select_iso"){
        var select_iso_name=MIDs[Object.keys(MIDs)[0]][metab_name][metab_frag_name][0].fragment
        var select_iso_id=  metab_frag_name+'_abundance_'+select_iso_name
        
        //graph_scale=Graph_Attribute[metab_name][metab_frag_name]['MID_'+select_iso_name].scale 
        //color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name]['MID_'+select_iso_name].color_index]
    
        color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name]['abundance_'+select_iso_name].color_index]
        graph_scale=Graph_Attribute[metab_name][metab_frag_name]['abundance_'+select_iso_name].scale    
        title_text=Graph_Attribute[metab_name][metab_frag_name]['abundance_'+select_iso_name].title    
        yaxis_label_text=Graph_Attribute[metab_name][metab_frag_name]['abundance_'+select_iso_name].yaxis_label   
        graph_height_scale=Graph_Attribute[metab_name][metab_frag_name]['abundance_'+select_iso_name].height_scale
        graph_width_scale=Graph_Attribute[metab_name][metab_frag_name]['abundance_'+select_iso_name].width_scale
        graph_avg_scale=(graph_width_scale+graph_height_scale)/2

    
}    
    
    
//color=["#4F5060","#67819D","#ADBD37","#588133","purple","gold","silver","light brown"]
var xpos=location.x_loc;
var ypos=location.y_loc;
var current_location=location

MID_xy= [{"x":xpos, "y":ypos}]; 
//var g = svg.append("svg:g")   
    
    
var g = svg.append("g")
    //.attr("id", metab_name)
    .attr("id", function(d){
                    if(mode=="select_iso"){
                        //select_iso_name=MIDs[Object.keys(MIDs)[0]][metab_name][metab_frag_name][0].fragment
                            return select_iso_id
                    }else{
                       return  metab_frag_name+'_abundance'
                    }
    }) 
    //.attr("id", metab_frag_name+'_abundance')
    .attr("class",metab_name)
    .data(MID_xy)
    .attr("transform", "translate(" + xpos + "," + ypos + ")")
   /* .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", function(d){
                    dragended
                    Graph_Location[metab_name][metab_frag_name].abundance=d;
                    current_location.x_loc=d.x;
                    current_location.y_loc=d.y;
                    }
           ),
         )*/
    .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", function(d){
                        dragended
                        if(mode=="select_iso"){
                            Graph_Location[metab_name][metab_frag_name]['abundance_'+select_iso_name]=d;
                        }else{                           
                            Graph_Location[metab_name][metab_frag_name].abundance=d;
                        }
                        current_location.x_loc=d.x;
                        current_location.y_loc=d.y;
                    }
           ),
         )


ConditionIndex=0;
    
for(var prop3 in MIDs){ //cycles through conditions
    met_MIDs=MIDs[prop3][metab_name]
    //frag_MID=met_MIDs[metab_frag_name]
    frag_MID=Limit_MID(metab_frag_name,met_MIDs)

    var total_abundance=0; //holds the total abundance of the fragment (include this in stacked_abundance as well for use as a label)    
    for(k=0;k<frag_MID.length;k++){
        total_abundance=total_abundance+frag_MID[k].abundance //sums up isotopologue abundances to determine total fragment abundance
    }

   // var bargraph_width=60+18.5*(frag_MID.length*ConditionAmount),
    //    bargraph_height=100;  
    var bargraph_width=(60+18.5*(frag_MID.length*ConditionAmount))*graph_scale*graph_width_scale,
        bargraph_height=185*graph_scale*graph_height_scale;  

    var //svg = d3.select("svg"),
        margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = bargraph_width - margin.left - margin.right,
        height = bargraph_height - margin.top - margin.bottom;

    var x = d3.scaleBand().rangeRound([0, width]).padding(0.2),//padding changes thickness of bars
        y = d3.scaleLinear().rangeRound([height, 0]);

      x.domain(frag_MID.map(function(d) {  return d.fragment;}));
      y.domain([0, ybound]);

    var bar_width=x.bandwidth()/ConditionAmount;
    //ContextMenuStuff

   /* var menu=[]; //variable which will hold the context menu for each metabolite
    i_count=0; // counter which allows for the number of context menu options to equal the number of integrated peaks
        counter_rand=0; //counter which allows for all condition data to be ploted via the data().enter() structure
    menu[i_count]={title: "delete",
                   onMouseClick: function(elm, d, i) {                          
                       svg.selectAll("#"+metab_frag_name+'_abundance').remove() //remove old MPE of the selected fragment
                       Graph_Location[metab_name][metab_frag_name].abundance={"x":"X","y":"X"}
                       d3.select('.d3-context-menu').style('display', 'none');
                    },
                    onMouseOver: function(elm,d,i){},
                       chidernItems: []
                }
        i_count=i_count+1
    
    //menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height)
    menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height,metab_frag_name,"abundance",svg,d3.select('#'+metab_frag_name+'_abundance'))

    */
    
    var menu=[]; //variable which will hold the context menu for each metabolite
    i_count=0; // counter which allows for the number of context menu options to equal the number of integrated peaks
        counter_rand=0; //counter which allows for all condition data to be ploted via the data().enter() structure
    menu[i_count]={title: "delete",
                   onMouseClick: function(elm, d, i) {

                    if(mode=="select_iso"){
                       svg.selectAll("#"+select_iso_id).remove() //remove old MPE of the selected fragment
                       Graph_Location[metab_name][metab_frag_name]['abundance_'+select_iso_name]={"x":"X","y":"X"}
                    }else{                           
                       svg.selectAll("#"+metab_frag_name+'_abundance').remove() //remove old MPE of the selected fragment
                       Graph_Location[metab_name][metab_frag_name].MID={"x":"X","y":"X"}
                    }
                       d3.select('.d3-context-menu').style('display', 'none');

                    },
                    onMouseOver: function(elm,d,i){},
                       chidernItems: []
                }
        i_count=i_count+1

    //    menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height)
    if(mode=="select_iso"){
        //menu=make_menu2(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height,metab_frag_name,'MID_'+select_iso_name,svg,d3.select('#'+select_iso_id))
        menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height,metab_frag_name,'abundance_'+select_iso_name,svg,d3.select('#'+select_iso_id))

    }else{   
        //menu=make_menu2(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height,metab_frag_name,"MID",svg,d3.select('#'+metab_frag_name+'_MID'))
        menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height,metab_frag_name,"abundance",svg,d3.select('#'+metab_frag_name+'_abundance'))
    }     
    
    
    
    
    
    g.selectAll(".bar")
      //g.append("g")
        .data(frag_MID, function(d){counter_rand=counter_rand+1
         return counter_rand})
        //.data(MIDs)
        .attr("id", "bargraphdata")
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", function(d) { return x(d.fragment)+bar_width*ConditionIndex}) //x.bandwidth()*ConditionIndex/ConditionAmount is what allows for the addition of multiple conditions on one graph. ConditionIndex/ConditionAmounts shifts all of the bars for a given condition over by a constant amount
        .attr("width", bar_width)//thins each bar based on the amount of conditions
        .attr("y", function (d) { return height; })
        .attr("height", 0)
        .transition() //below allows for animation of bar graphs to occur
        .duration(1000)
        .attr("y", function (d, i) {
                if(d.abundance<0){
                    return 0}
                else{
                    return y(d.abundance);}})
        .attr("height", function (d, i) {
                if(d.abundance<0){
                    return 0}
                else{
                    return height - y(d.abundance);}})
        .attr("fill",color[ConditionIndex]) //sets a different bar color for each condition
        .attr("stroke","black")

    legend_scale=30*graph_avg_scale
    
    g.append("rect")//creates box with condition color
        .attr("class", "legend")
        .attr("width", legend_scale/1.5)
        .attr("height", legend_scale/3)    
        .attr("x", width)
        .attr("y", legend_scale/1.5*ConditionIndex)
        .attr("fill", color[ConditionIndex])
        .attr("stroke","black");
        //.call(drag);

    g.append("text") //creates text next to legend box's
        .attr("class", "legendlabel")
        .attr("x", width+legend_scale/1.5+graph_scale)
        //.attr("y", (bar_width)*(ConditionIndex+.75))
       // .attr("y", (legend_scale/1.5)*(ConditionIndex+.6))
        .attr("y",function(d){
            if (mode=="select_iso"){
                return (legend_scale/1.5)*(ConditionIndex+.53)                
            }else{
                return (legend_scale/1.5)*(ConditionIndex+.6)
            }             
        })    
        .attr("font-size",String(10*graph_scale*graph_avg_scale)+"px")
        .text(function(d){return ConditionNames[ConditionIndex]});

    g.selectAll(".errorbar")
       .data(frag_MID)//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
       //.attr("stroke-width","1")
       .attr("stroke-width",String(1*graph_scale*graph_width_scale))
    //.attr("class", "errorbar")
       .attr("x1",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2})
       .attr("y1",function (d) { return y((d.abundance))})
       .attr("x2",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2})
       .attr("y2",function (d) { return y((d.abundance));})
       .transition()
       .delay(1000)
       .duration(500)
       .attr("y1",function (d) { return y((d.abundance-d.error*total_abundance))})
       .attr("y2",function (d) { return y((d.abundance+d.error*total_abundance));})
       .attr("fill", "none") 
       .attr("stroke", "black");

    g.selectAll(".errorbar_edge1")
       .data(frag_MID)//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
       //.attr("stroke-width","1")
       .attr("stroke-width",String(1*graph_scale*graph_width_scale))
       //.attr("class", "errorbar")
       .attr("x1",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2})
       .attr("y1",function (d) { return y((d.abundance-d.error*total_abundance));})
       .attr("x2",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2})
       .attr("y2",function (d) { return y((d.abundance-d.error*total_abundance));})
       .transition()
       .delay(1500)
       .duration(500)
       .attr("x1",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2+5*graph_scale*graph_width_scale})
       .attr("x2",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2-5*graph_scale*graph_width_scale})
       .attr("fill", "none") 
       .attr("stroke", "black");

    g.selectAll(".errorbar_edge2")
       .data(frag_MID)//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
       //.attr("stroke-width","1")
       .attr("stroke-width",String(1*graph_scale*graph_width_scale))
    //.attr("class", "errorbar")
       .attr("x1",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2})
       .attr("y1",function (d) { return y((d.abundance+d.error*total_abundance));})
       .attr("x2",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2})
       .attr("y2",function (d) { return y((d.abundance+d.error*total_abundance));})
       .transition()
       .delay(1500)
       .duration(500)
       .attr("x1",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2+5*graph_scale*graph_width_scale})
       .attr("x2",function(d){return (x(d.fragment)+bar_width*ConditionIndex)+bar_width/2-5*graph_scale*graph_width_scale})
       .attr("fill", "none") 
       .attr("stroke", "black");    
    ConditionIndex=ConditionIndex+1;
}
    
    
//block which makes graph clickable
g.append("rect")//creates box with condition color
    .attr("id", "click_box")
    .attr("class", "click_box")
    .on('contextmenu', d3.contextMenu(menu))
    /*.on('touchstart', d3.contextMenu(menu))
    .on("touchmove", function(d){
		d3.select('.d3-context-menu').style('display', 'none');
                      // Clear timeout
                      return false;
                    })    */ 
    .attr("height",bargraph_height)
    .attr("width",bargraph_width)    
    .attr("x", 0)
    .attr("y", -25)
    .style("opacity", 0)    
    .attr("fill", "white")        
    //.attr("fill", "transparent")
    .style("cursor", "move")
    .append("svg:title")
        .text("Right Click to Access Additional Options");    
    
g.append("text") //adds clickable arrow to induce contextmenu
  .attr("id", "context_button")     
  .attr("class", "context_button")     
  .attr("x",-60*graph_height_scale)
  .attr("y",-50*graph_height_scale)
  .attr("style","font-family:FontAwesome; cursor:pointer;")    
  .attr("font-weight", 300)
  .attr("fill","#337ab7")
  .attr('font-size', function(d) { return (graph_height_scale*50).toString()+'px';} )
  .text(function(d) { return '\uf152'; })
  .on('click', d3.contextMenu(menu))
  .on('touchstart', d3.contextMenu(menu));    

g.append("g")
  .attr("id", "MID_xaxis")
  .attr("class", "axis axis--x")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(x))
  .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
  .attr("tick-size",6*graph_scale*graph_avg_scale)
  .attr("font-size",String(13*graph_scale*graph_avg_scale)+"px");


g.selectAll('.tick') //makes axis ticks clickable and identifiable
  .on('click', function(d) {// console.log(MIDs[prop][metab_name][metab_frag_name]),
                          iso_index=Number(d.replace("M","")) //index of the selected isotopologue
                         // console.log(MIDs[prop][metab_name][metab_frag_name][dumm]);
                         var selected_Iso_MID='{"selected_Iso_MID":{';
                             for(var prop4 in MIDs){
                            //the line below creates a string which will converted into a json object, that holds the data of the selected MID
                            selected_Iso_MID=selected_Iso_MID+'"'+prop4+'":{"'+metab_name+'":{"'+metab_frag_name+'":['+JSON.stringify(MIDs[prop4][metab_name][metab_frag_name][iso_index])+']}},'
                             }
                            selected_Iso_MID=selected_Iso_MID.slice(0, -1)+'}}'
                            selected_Iso_MID_parse=JSON.parse(selected_Iso_MID)
                            selected_Iso_MID=selected_Iso_MID_parse.selected_Iso_MID
                            makegraph_abundance(metab_frag_name,location,ConditionAmount,metab_name,selected_Iso_MID,svg)
                         }
   );        

g.append("g")
  .attr("id", "MID_yaxis")
  .attr("class", "axis axis--y")
  .call(d3.axisLeft(y)
        .ticks(3)
        .tickFormat(d3.format(".1g")))    
//        .tickFormat(d3.format(".1e")))    
//        .tickFormat(d3.format(".1e")))    
//        .tickFormat(d3.format(".1e")))    
  //.call(d3.axisLeft(y).tickFormat(d3.format(".1e"))) //leads to scientific notation
//axis.tickFormat(d3.format(",.0f"));
    
  .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")  
  .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px");
        
g.append("text")
   .on('contextmenu', d3.contextMenu(menu))
   .attr("class","titlelabel")
   .attr("id",metab_name+"titlelabel")
   .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
   .attr("transform", "translate("+ (width/2) +","+(-25*graph_scale)+")")  // text is drawn off the screen top left, move down and out and rotate     
   .attr("font-size",String(13*graph_scale*graph_avg_scale)+"px")      
   .text(title_text)
   .on("click", function(d){make_editable(this,d,'title',metab_name,metab_frag_name,"abundance")})
    
    
if (mode!="select_iso"){ 
    
  g.selectAll('.tick') //makes axis ticks clickable and identifiable
      .style("cursor", "pointer")        
      .on('mouseover', function(d){
                 el_mo =  d3.select(this)._groups[0][0].getElementsByTagName('text')[0]
                 style_mo = window.getComputedStyle(el_mo, null).getPropertyValue('font-size');
                 fontSize = parseFloat(style_mo);     
                 d3.select(this).attr("font-size",String(fontSize*3)+"px") //increases size of tick text upon mouseover to make it easier for the user to select the isotopologue MID
                    })
      .on('mouseout', function(d){
                 el_mo =  d3.select(this)._groups[0][0].getElementsByTagName('text')[0]
                 style_mo = window.getComputedStyle(el_mo, null).getPropertyValue('font-size');
                 fontSize = parseFloat(style_mo);        
                 d3.select(this).attr("font-size",String(fontSize/3)+"px") //returns the size of tick text upon mouse over
                    })
      .on('click', function(d) {// console.log(MIDs[prop][metab_name][metab_frag_name]),
                              iso_index=Number(d.replace("M","")) //index of the selected isotopologue
                                console.log("click")
                             // console.log(MIDs[prop][metab_name][metab_frag_name][dumm]);
                             var selected_Iso_abundance='{"selected_Iso_abundance":{';
                                 for(var prop4 in MIDs){
                                //the line below creates a string which will converted into a json object, that holds the data of the selected Isotopologue
                                selected_Iso_abundance=selected_Iso_abundance+'"'+prop4+'":{"'+metab_name+'":{"'+metab_frag_name+'":['+JSON.stringify(MIDs[prop4][metab_name][metab_frag_name][iso_index])+']}},'
                                 }
                                selected_Iso_abundance=selected_Iso_abundance.slice(0, -1)+'}}'
                                selected_Iso_abundance_parse=JSON.parse(selected_Iso_abundance) //select_Iso_MID from a string to an object
                                selected_Iso_abundance=selected_Iso_abundance_parse.selected_Iso_abundance //selects the select_Iso_MID key from the object created above (provide the the data for the selected isotopologue in a format identical to MID)
                                current_location.y_loc=current_location.y_loc+bargraph_height+25*graph_scale
                                Graph_Location[metab_name][metab_frag_name]['abundance_M'+iso_index]={"x":current_location.x_loc, "y":current_location.y_loc} //assigns a location to the isotopologue MID
                             makegraph_abundance(metab_frag_name,current_location,ConditionAmount,metab_name,selected_Iso_abundance,ConditionNames,svg,"select_iso")
                             if(Condition_Times != ''){
                                current_location.x_loc=current_location.x_loc+bargraph_width/2
                                Graph_Location[metab_name][metab_frag_name]['Kin_abundance_M'+iso_index]={"x":current_location.x_loc, "y":current_location.y_loc} //assigns a location to the isotopologue MID
                                makegraph_timecourse(metab_frag_name,current_location,ConditionAmount,metab_name,selected_Iso_abundance,ConditionNames,svg,"abundance_select_iso")
                             }

                             }
       )
     .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px");
}    
    
    
          
}
/////End Abundance GRAPH  


/////Start Stacked abundance Abundance    
function makegraph_stacked_abundance(metab_frag_name,location,ConditionAmount,metab_name,MIDs,ConditionNames,svg){
/*
INPUTS:
metab_frag_name= the name of the metabolite fragment (ex. pyr174)
location=location to print the graph
ConditionAmount=total number of experimental conditions in the data set
metab_name= the BIGG_id of the metabolite (ex. pyr_c)
MIDs=all MID/abundance data for all metabolites+fragments
ConditionNames=Names of the experimental conditions in the data set
svg= svg container that all further svg's are being appended to (this is the canvas that the generated shapes/graphs will be pinned to)
*/

ybound_abundance=0;
ConditionIndex=0;
ybound_abundance_index=0;

//finds maximum values and lengths of the mass fragment for all conditions
for(var prop in MIDs){    //cycles through conditions
    frag_MID_cyc=Limit_MID(metab_frag_name,MIDs[prop][metab_name])
    
    ybound_abundance_temp=(frag_MID_cyc[0].total_abundance+frag_MID_cyc[0].total_abundance_error)
    
    if(ybound_abundance_temp>ybound_abundance){
        ybound_abundance=ybound_abundance_temp
    }

    //if()
    
    ConditionIndex++;
}
//color=color_set.stacked_abundance;
//graph_scale=graph_scale_set.stacked_abundance

color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name].stacked_abundance.color_index]
graph_scale=Graph_Attribute[metab_name][metab_frag_name].stacked_abundance.scale   
title_text=Graph_Attribute[metab_name][metab_frag_name].stacked_abundance.title    
yaxis_label_text=Graph_Attribute[metab_name][metab_frag_name].stacked_abundance.yaxis_label    
graph_height_scale=Graph_Attribute[metab_name][metab_frag_name].stacked_abundance.height_scale
graph_width_scale=Graph_Attribute[metab_name][metab_frag_name].stacked_abundance.width_scale
graph_avg_scale=(graph_width_scale+graph_height_scale)/2    
    
if(typeof graph_height_scale=='undefined' || graph_width_scale=='undefined'){        
    graph_height_scale=1
    graph_width_scale=1  
}     
    
var xpos=location.x_loc;
var ypos=location.y_loc;
var current_location=location
   
MID_xy= [{"x":xpos, "y":ypos}]; 
var g = svg.append("g")
    //.attr("id", metab_name)
    .attr("id", metab_frag_name+'_stacked_abundance')
    .attr("class",metab_name)
    .data(MID_xy)
    .attr("transform", "translate(" + xpos + "," + ypos + ")")
    .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", function(d){
                    dragended
                    Graph_Location[metab_name][metab_frag_name].stacked_abundance=d;
                    current_location.x_loc=d.x;
                    current_location.y_loc=d.y;                        }
           ),
         )

var bargraph_width=(60+18.5*ConditionAmount)*graph_scale*graph_width_scale,
    bargraph_height=185*graph_scale*graph_height_scale;  


var //svg = d3.select("svg"),
    margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = bargraph_width - margin.left - margin.right,
    height = bargraph_height - margin.top - margin.bottom;

var x = d3.scaleBand().rangeRound([0, width]).padding(0.2),//padding changes thickness of bars
    //y = d3.scaleLinear().rangeRound([height, 0]);
    y = d3.scaleLinear().range([height,0]); //using range instead of rangeRound allows for elimination of issues w rounding error in abundances

x.domain(ConditionNames.map(function(d) {return d}));
y.domain([0, ybound_abundance]);

var bar_width=x.bandwidth();


ConditionIndex=0;
for(var prop3 in MIDs){ //cycles through conditions
    met_MIDs=MIDs[prop3][metab_name]
    //frag_MID=met_MIDs[metab_frag_name]    
    frag_MID=Limit_MID(metab_frag_name,met_MIDs)

    //ContextMenuStuff

    var menu=[]; //variable which will hold the context menu for each metabolite
    i_count=0; // counter which allows for the number of context menu options to equal the number of integrated peaks
        counter_rand=0; //counter which allows for all condition data to be ploted via the data().enter() structure
    menu[i_count]={title: "delete",
                   onMouseClick: function(elm, d, i) {                          
                       svg.selectAll("#"+metab_frag_name+'_stacked_abundance').remove() //remove old MPE of the selected fragment
                       Graph_Location[metab_name][metab_frag_name].stacked_abundance={"x":"X","y":"X"}
                       d3.select('.d3-context-menu').style('display', 'none');
                    },
                    onMouseOver: function(elm,d,i){},
                       chidernItems: []
                }
        i_count=i_count+1
    
    //menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height)
    menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height,metab_frag_name,"stacked_abundance",svg,d3.select('#'+metab_frag_name+'_stacked_abundance'))
    

    sum_bar=0; //sum_bar allows for bars to stack ontop of eachother
    g.selectAll(".bar")
        .data(frag_MID, function(d){counter_rand=counter_rand+1
         return counter_rand})
        .attr("id", "bargraphdata")
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", function(d) { return x(ConditionNames[ConditionIndex]); })
        .attr("width", bar_width)//thins each bar based on the amount of conditions
        .attr("y", function (d) { return height; })
        .attr("height", 0)
        .transition() //below allows for animation of bar graphs to occur
        .duration(1000)
        .delay(function (d, i) {
                return i * 100;})
        .attr("y", function (d, i) {
                   if(d.abundance<0){
                       return (y(sum_bar))
                   }else{
                    sum_bar=sum_bar+d.abundance;
                    return y(sum_bar);}})
        .attr("height", function(d){
                   if(d.abundance<0){
                       return (height-y(0))
                   }else{
                        return y(0) - y(d.abundance);}})
        .attr("fill",function (d, i) {return color[i]}) //sets a different bar color for each condition  
        .attr("stroke","black") ;

    g.selectAll(".errorbar")
        .data(frag_MID,function(d){counter_rand=counter_rand+1
                 return counter_rand})//says find the data to connect attributes to in the links object of the  data object 
        .enter()
        .append("line")
        .attr("stroke-width",String(0.5*graph_scale*graph_width_scale))   
        .attr("x1",function(d){
            if(typeof d.total_abundance!='undefined'){        
            return x(ConditionNames[ConditionIndex])+bar_width/2}})
        .attr("x2",function(d){
            if(typeof d.total_abundance!='undefined'){        
            return x(ConditionNames[ConditionIndex])+bar_width/2}})
        .attr("y1",function (d) { 
            if(typeof d.total_abundance!='undefined'){        
            return y((d.total_abundance))}})
        .attr("y2",function (d) { 
            if(typeof d.total_abundance!='undefined'){        
            return y((d.total_abundance));}})    
        .transition() //below allows for animation of bar graphs to occur
        .delay(1000)
        .duration(500)    
        .attr("y1",function (d) { 
        if(typeof d.total_abundance!='undefined'){        
        return y((d.total_abundance-d.total_abundance_error))}})
        .attr("y2",function (d) { 
        if(typeof d.total_abundance!='undefined'){        
        return y((d.total_abundance+d.total_abundance_error));}})
        .attr("fill", "none") 
        .attr("stroke", "black");

    g.selectAll(".errorbar_edge1")
       .data(frag_MID,function(d){counter_rand=counter_rand+1
                 return counter_rand})//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
       //.attr("stroke-width","1")
       .attr("stroke-width",String(0.5*graph_scale*graph_width_scale))
       .attr("x1",function(d){
        if(typeof d.total_abundance!='undefined'){
        return x(ConditionNames[ConditionIndex])+bar_width/2}})
       .attr("x2",function(d){
        if(typeof d.total_abundance!='undefined'){        
        return x(ConditionNames[ConditionIndex])+bar_width/2}})
       .attr("y1",function (d) { 
        if(typeof d.total_abundance!='undefined'){
        return y((d.total_abundance-d.total_abundance_error))}})
       .attr("y2",function (d) {
        if(typeof d.total_abundance!='undefined'){        
        return y((d.total_abundance-d.total_abundance_error));}})    
       .transition() //below allows for animation of bar graphs to occur
       .delay(1500) 
       .duration(500) 
       .attr("x1",function(d){
        if(typeof d.total_abundance!='undefined'){
        return x(ConditionNames[ConditionIndex])+bar_width/2+5*graph_scale*graph_width_scale}})
       .attr("x2",function(d){
        if(typeof d.total_abundance!='undefined'){
        return x(ConditionNames[ConditionIndex])+bar_width/2-5*graph_scale*graph_width_scale}})
        .attr("fill", "none") 
       .attr("stroke", "black");
    
    g.selectAll(".errorbar_edge2")
       .data(frag_MID,function(d){counter_rand=counter_rand+1
                 return counter_rand})//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
       //.attr("stroke-width","1")
       .attr("stroke-width",String(0.5*graph_scale*graph_width_scale))
       //.attr("class", "errorbar")
       .attr("x1",function(d){
        if(typeof d.total_abundance!='undefined'){        
        return x(ConditionNames[ConditionIndex])+bar_width/2}})
       .attr("x2",function(d){
        if(typeof d.total_abundance!='undefined'){
        return x(ConditionNames[ConditionIndex])+bar_width/2}})
       .attr("y1",function (d) {
        if(typeof d.total_abundance!='undefined'){
        return y((d.total_abundance+d.total_abundance_error))}})
       .attr("y2",function (d) {
        if(typeof d.total_abundance!='undefined'){
        return y((d.total_abundance+d.total_abundance_error));}})    
       .transition() //below allows for animation of bar graphs to occur
       .delay(1500)   
       .duration(500) 
       .attr("x1",function(d){
        if(typeof d.total_abundance!='undefined'){
        return x(ConditionNames[ConditionIndex])+bar_width/2+5*graph_scale*graph_width_scale}})
       .attr("x2",function(d){
        if(typeof d.total_abundance!='undefined'){
        return x(ConditionNames[ConditionIndex])+bar_width/2-5*graph_scale*graph_width_scale}})
        .attr("fill", "none") 
       .attr("stroke", "black");     
    
    ConditionIndex=ConditionIndex+1;
}

g.append("g")
    .attr("id", "MID_xaxis")
    .attr("class", "axis axis--x")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x))
    .selectAll("text")	
    .style("text-anchor", "end")
    .attr("dx", "-.8em")
    .attr("dy", ".15em")
    .attr("transform", function(d) {
        return "rotate(-65)" 
        })
    //          .attr("font-size","11px");
  .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
  .attr("tick-size",6*graph_scale*graph_avg_scale)    
  .attr("font-size",String(11*graph_scale*graph_avg_scale)+"px");

g.append("g")
    .attr("id", metab_frag_name+"_stacked_abundance_yaxis")
    .attr("class", "axis axis--y")
    .call(d3.axisLeft(y).tickFormat(d3.format(".1e"))) //leads to scientific notation
    .call(d3.axisLeft(y).ticks(3))
  .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
  .attr("tick-size",6*graph_scale*graph_avg_scale)
  .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px"); 
    
yaxis_label_x=document.getElementById(metab_frag_name+"_stacked_abundance_yaxis").lastChild.lastChild.getBBox().x - 12.5*graph_scale //sets the location of the yaxis_label to be to the left of the text of the top tick of the y axis   
    
g.append("text")  //adds y axis label
  .attr("class", "y_axis_label")
  .attr("id", metab_name+"stacked_abundance_y_axis_label")
  .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
  //.attr("transform", "translate("+ (-30*graph_scale) +","+(height/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate      
  .attr("transform", "translate("+ yaxis_label_x +","+(height/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate      
  .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px")    
  .text(yaxis_label_text)
  .on("click", function(d){make_editable(this,d,'y_axis_label',metab_name,metab_frag_name,"stacked_abundance")})       
    
legend_scale=225*graph_avg_scale    

    
g.selectAll(".stacked_abundance_legend")
    .attr("class", "stacked_abundance_legend")
    .data(frag_MID, function(d){counter_rand=counter_rand+1
     return counter_rand})
    .enter().append("rect")
    .attr("width", legend_scale/10)
    .attr("height", legend_scale/20)    
    .attr("x", width)
    .attr("y", function(d,i){return legend_scale/15*i})
    .attr("fill", function(d,i){return color[i]})
    .attr("stroke","black") ;


g.selectAll(".legendlabel")
    .attr("class", "legendlabel")
    .data(frag_MID, function(d){counter_rand=counter_rand+1
     return counter_rand})
    .enter().append("text")
    .attr("x", width+legend_scale/10+1)
    .attr("y", function(d,i){return legend_scale/15*(i+.77)})
    .attr("font-size",String(7*graph_scale*graph_avg_scale)+"px")
    .text(function(d){return d.fragment}); 

//block which makes MID clickable
g.append("rect")//creates box with condition color
    .attr("id", "click_box")
    .attr("class", "click_box")
    .on('contextmenu', d3.contextMenu(menu))
    /*.on('touchstart', d3.contextMenu(menu))
    .on("touchmove", function(d){
		d3.select('.d3-context-menu').style('display', 'none');
                      // Clear timeout
                      return false;
                    })  */   
    .attr("height",function(d){
            return this.parentElement.getBBox().height+40*graph_scale
        })
    .attr("width",function(d){
            return this.parentElement.getBBox().width+40*graph_scale*graph_avg_scale
        })
    .attr("x",function(d){
            return this.parentElement.getBBox().x-40*graph_scale*graph_avg_scale
        })     
    .attr("y",function(d){
            return this.parentElement.getBBox().y-40*graph_scale
        })    
   /* .attr("height",bargraph_height)
    .attr("width",bargraph_width)    
    .attr("x", 0)
    .attr("y", -25)*/
    .style("opacity", 0)    
    .attr("fill", "white")        
    //.attr("fill", "transparent")
    .style("cursor", "move")
    .append("svg:title")
        .text("Right Click to Access Additional Options");    
    
g.append("text") //adds clickable arrow to induce contextmenu
  .attr("id", "context_button")     
  .attr("class", "context_button")     
  .attr("x",-50*graph_scale*graph_avg_scale)
  .attr("y",-50*graph_height_scale)
  .attr("style","font-family:FontAwesome; cursor:pointer;")    
  .attr("font-weight", 300)
  .attr("fill","#337ab7")
  .attr('font-size', function(d) { return (graph_height_scale*50).toString()+'px';} )
  .text(function(d) { return '\uf152'; })
  .on('click', d3.contextMenu(menu))
  .on('touchstart', d3.contextMenu(menu));
        
g.append("text")
    .on('contextmenu', d3.contextMenu(menu))
    .attr("class","titlelabel")
    .attr("id",metab_name+"titlelabel")  
    .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
    .attr("transform", "translate("+ (width/2) +","+(-25*graph_scale)+")")  // text is drawn off the screen top left, move down and out and rotate     
    /*.attr("x", width/2-55*graph_scale)
    .attr("y", -15*graph_scale)*/
    .attr("font-size",String(13*graph_scale*graph_avg_scale)+"px")
    //.text(function(d){return metab_frag_name.charAt(0).toUpperCase() + metab_frag_name.slice(1)+ " Abundance";})
    //.on("click", function(d){make_editable(this,d)});
    .text(title_text)
    .on("click", function(d){make_editable(this,d,'title',metab_name,metab_frag_name,"stacked_abundance")})    
      


    
} 
/////End Stacked abundance Abundance

/////Start Stacked abundance Abundance    
function makegraph_total_abundance(metab_frag_name,location,ConditionAmount,metab_name,MIDs,ConditionNames,svg){
/*
INPUTS:
metab_frag_name= the name of the metabolite fragment (ex. pyr174)
location=location to print the graph
ConditionAmount=total number of experimental conditions in the data set
metab_name= the BIGG_id of the metabolite (ex. pyr_c)
MIDs=all MID/abundance data for all metabolites+fragments
ConditionNames=Names of the experimental conditions in the data set
svg= svg container that all further svg's are being appended to (this is the canvas that the generated shapes/graphs will be pinned to)
*/

ybound_abundance=0;
ConditionIndex=0;
ybound_abundance_index=0;
total_abundance_array=[];
total_abundance_error_array=[];
total_abundance_ybound=[];
    
console.log(fileorganizer)
    
if(Std_Concentration[metab_frag_name].std_iso!="NA" && Std_Concentration[metab_frag_name].std_conc!="NA"){
   standard_isotopologue=Std_Concentration[metab_frag_name].std_iso
   standard_concentration=Number(Std_Concentration[metab_frag_name].std_conc)
    standard_isotopologue_split=standard_isotopologue.split("M")
    standard_isotopologue_index=Number(standard_isotopologue_split[1])
    for(j=0; j<ConditionNames.length; j++){
        var quant_abundance_array=[]
        for(k=0; k<fileorganizer[ConditionNames[j]].length; k++){
            file_name_k=fileorganizer[ConditionNames[j]][k]
            file_index=FileNames.indexOf(file_name_k)+1
            std_label=FileMIDs["File"+file_index.toString()][metab_name][metab_frag_name].labeling[standard_isotopologue_index].frequency
            quant_abundance_array.push((1-std_label)/std_label*standard_concentration)
        }
        total_abundance_array.push(math.mean(quant_abundance_array)) 
        total_abundance_error_array.push(math.std(quant_abundance_array))   
        total_abundance_ybound.push(math.mean(quant_abundance_array)+math.std(quant_abundance_array))   
    }
    
    ybound_abundance=math.max(total_abundance_ybound)
    
}else{
    for(var prop in MIDs){    //cycles through conditions
        frag_MID_cyc=MIDs[prop][metab_name][metab_frag_name]
        total_abundance_array.push(frag_MID_cyc[0].total_abundance) //stores total abundances in total_abundace_array
        total_abundance_error_array.push(frag_MID_cyc[0].total_abundance_error)  //stores total abundance errors in total_abundace_array
        ybound_abundance_temp=(frag_MID_cyc[0].total_abundance+frag_MID_cyc[0].total_abundance_error)

        if(ybound_abundance_temp>ybound_abundance){
            ybound_abundance=ybound_abundance_temp
        }        
    }    
}    
 

color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name].total_abundance.color_index]
graph_scale=Graph_Attribute[metab_name][metab_frag_name].total_abundance.scale   
title_text=Graph_Attribute[metab_name][metab_frag_name].total_abundance.title    
yaxis_label_text=Graph_Attribute[metab_name][metab_frag_name].total_abundance.yaxis_label    
graph_height_scale=Graph_Attribute[metab_name][metab_frag_name].stacked_MID.height_scale
graph_width_scale=Graph_Attribute[metab_name][metab_frag_name].stacked_MID.width_scale
graph_avg_scale=(graph_width_scale+graph_height_scale)/2    
    
if(typeof graph_height_scale=='undefined' || graph_width_scale=='undefined'){        
    graph_height_scale=1
    graph_width_scale=1  
}    
        
    

if(Std_Concentration[metab_frag_name].std_iso!="NA" && Std_Concentration[metab_frag_name].std_conc!="NA" && yaxis_label_text=="Counts"){ //if a standard has been entered for the metabolit and the current yaxis_label_text is still the default "Counts", then update the y_axis_label include UserInputConcentrationUnits
    Graph_Attribute[metab_name][metab_frag_name].total_abundance.yaxis_label="Concentration ("+UserInputConcentrationUnits+")" 
    yaxis_label_text=Graph_Attribute[metab_name][metab_frag_name].total_abundance.yaxis_label    
}    
    
var xpos=location.x_loc;
var ypos=location.y_loc;
var current_location=location
   
MID_xy= [{"x":xpos, "y":ypos}]; 
var g = svg.append("g")
    //.attr("id", metab_name)
    .attr("id", metab_frag_name+'_total_abundance')
    .attr("class",metab_name)
    .data(MID_xy)
    .attr("transform", "translate(" + xpos + "," + ypos + ")")
    .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", function(d){
                    dragended
                    Graph_Location[metab_name][metab_frag_name].total_abundance=d;
                    current_location.x_loc=d.x;
                    current_location.y_loc=d.y;                        }
           ),
         )

var bargraph_width=(60+18.5*ConditionAmount)*graph_scale*graph_width_scale,
    bargraph_height=185*graph_scale*graph_height_scale;   

var //svg = d3.select("svg"),
    margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = bargraph_width - margin.left - margin.right,
    height = bargraph_height - margin.top - margin.bottom;

var x = d3.scaleBand().rangeRound([0, width]).padding(0.2),//padding changes thickness of bars
    //y = d3.scaleLinear().rangeRound([height, 0]);
    y = d3.scaleLinear().range([height,0]); //using range instead of rangeRound allows for elimination of issues w rounding error in abundances

x.domain(ConditionNames.map(function(d) {return d}));
y.domain([0, ybound_abundance]);

var bar_width=x.bandwidth();


ConditionIndex=0;
counter_rand=0; //counter which allows for all condition data to be ploted via the data().enter() structure
    
g.selectAll(".bar")
        .data(total_abundance_array, function(d){counter_rand=counter_rand+1
         return counter_rand})
        //.data(MPE[ConditionIndex])
        .attr("id", "bargraphdata")
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", function(d,i) { return x(ConditionNames[i]); })
        .attr("width", bar_width)//thins each bar based on the amount of conditions
        .attr("y", function (d) { return height; })
        .attr("height", 0)
        .transition() //below allows for animation of bar graphs to occur
        .duration(1000)
        .attr("y", function (d, i) {
                    if(d<0){
                        return y(0)}
                    else{
                    return y(d);}})
        .attr("height", function(d,i){
                    if(d<0){
                        return 0}
                    else{
                        return height - y(d)}})
        //.attr("fill",function (d, i) {return color[i]}) //sets a different bar color for each condition
        .attr("fill", function(d,i){
                        return color[i]
                                }) //sets a different bar color for each condition
        .attr("stroke","black") ;


g.selectAll(".errorbar")
       .data(total_abundance_array,function(d){counter_rand=counter_rand+1
             return counter_rand})
       .enter()
       .append("line")
       .attr("stroke-width",String(0.5*graph_scale*graph_width_scale))
       .attr("x1", function(d,i) { return x(ConditionNames[i])+bar_width/2; })
       .attr("x2", function(d,i) { return x(ConditionNames[i])+bar_width/2; })
       .attr("y1", function (d) { return height; })
       .attr("y2", function (d) { return height; })
       .transition() //below allows for animation of bar graphs to occur
       .duration(1000)    
       .attr("y1", function (d, i) {
                    if(d<0){
                        return y(0+total_abundance_error_array[i])}
                    else{                            
                    return y(d+total_abundance_error_array[i]);}})
       .attr("y2", function (d, i) {
                    if(d<0){
                        return y(0-total_abundance_error_array[i])}
                    else{
                    return y(d-total_abundance_error_array[i]);}})    
       .attr("fill", "none") 
       .attr("stroke", "black");

g.selectAll(".errorbar_edge1")
       .data(total_abundance_array,function(d){counter_rand=counter_rand+1
             return counter_rand})
       .enter()
       .append("line")
       //.attr("stroke-width","1")
       .attr("stroke-width",String(0.5*graph_scale*graph_width_scale))
       //.attr("class", "errorbar")
       .attr("x1", function(d,i) { return x(ConditionNames[i])+bar_width/2; })
       .attr("x2", function(d,i) { return x(ConditionNames[i])+bar_width/2; })
       .attr("y1", function (d, i) {
                    if(d<0){
                        return y(0+total_abundance_error_array[i])}
                    else{
                    return y(d+total_abundance_error_array[i]);}})
       .attr("y2", function (d, i) {
                    if(d<0){
                        return y(0+total_abundance_error_array[i])}
                    else{
                    return y(d+total_abundance_error_array[i]);}})       
       .transition()
       .duration(2000)    
       .attr("x1", function(d,i) { return x(ConditionNames[i])+bar_width/2+5*graph_scale*graph_width_scale; })
       .attr("x2", function(d,i) { return x(ConditionNames[i])+bar_width/2-5*graph_scale*graph_width_scale; })
        .attr("fill", "none") 
       .attr("stroke", "black");

g.selectAll(".errorbar_edge2")
       .data(total_abundance_array,function(d){counter_rand=counter_rand+1
             return counter_rand})
       .enter()
       .append("line")
       //.attr("stroke-width","1")
       .attr("stroke-width",String(0.5*graph_scale*graph_width_scale))
       //.attr("class", "errorbar")
       .attr("x1", function(d,i) { return x(ConditionNames[i])+bar_width/2; })
       .attr("x2", function(d,i) { return x(ConditionNames[i])+bar_width/2; })
       .attr("y1", function (d, i) {
                    if(d<0){
                        return y(0-total_abundance_error_array[i])}
                    else{
                    return y(d-total_abundance_error_array[i]);}})
       .attr("y2", function (d, i) {
                    if(d<0){
                        return y(0-total_abundance_error_array[i])}
                    else{
                    return y(d-total_abundance_error_array[i]);}})       
       .transition()
       .duration(2000)     
       .attr("x1", function(d,i) { return x(ConditionNames[i])+bar_width/2+5*graph_scale*graph_width_scale; })
       .attr("x2", function(d,i) { return x(ConditionNames[i])+bar_width/2-5*graph_scale*graph_width_scale; })
       .attr("fill", "none") 
       .attr("stroke", "black");     
    
    
for(var prop3 in MIDs){ //cycles through conditions
    met_MIDs=MIDs[prop3][metab_name]
    //frag_MID=met_MIDs[metab_frag_name]    
    frag_MID=Limit_MID(metab_frag_name,met_MIDs)

    //ContextMenuStuff

    var menu=[]; //variable which will hold the context menu for each metabolite
    i_count=0; // counter which allows for the number of context menu options to equal the number of integrated peaks
        counter_rand=0; //counter which allows for all condition data to be ploted via the data().enter() structure
    menu[i_count]={title: "delete",
                   onMouseClick: function(elm, d, i) {                          
                       svg.selectAll("#"+metab_frag_name+'_total_abundance').remove() //remove old MPE of the selected fragment
                       Graph_Location[metab_name][metab_frag_name].total_abundance={"x":"X","y":"X"}
                       d3.select('.d3-context-menu').style('display', 'none');
                    },
                    onMouseOver: function(elm,d,i){},
                       chidernItems: []
                }
        i_count=i_count+1
    
    //menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height)
    menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height,metab_frag_name,"total_abundance",svg,d3.select('#'+metab_frag_name+'_total_abundance'))
    
}

g.append("g")
    .attr("id", "MID_xaxis")
    .attr("class", "axis axis--x")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x))
    .selectAll("text")	
    .style("text-anchor", "end")
    .attr("dx", "-.8em")
    .attr("dy", ".15em")
    .attr("transform", function(d) {
        return "rotate(-65)" 
        })
    //          .attr("font-size","11px");
    .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
    .attr("tick-size",6*graph_scale*graph_avg_scale)    
    .attr("font-size",String(11*graph_scale*graph_avg_scale)+"px");

g.append("g")
    .attr("id", metab_frag_name+"_total_abundance_yaxis")
    .attr("class", "axis axis--y")
    .call(d3.axisLeft(y).tickFormat(d3.format(".1e"))) //leads to scientific notation
    .call(d3.axisLeft(y).ticks(3))
    //.attr("font-size","12px");
  .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
  .attr("tick-size",6*graph_scale*graph_avg_scale)
  .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px");
    
    
yaxis_label_x=document.getElementById(metab_frag_name+"_total_abundance_yaxis").lastChild.lastChild.getBBox().x - 12.5*graph_scale //sets the location of the yaxis_label to be to the left of the text of the top tick of the y axis      
    
g.append("text")  //adds y axis label
  .attr("class", "y_axis_label")
  .attr("id", metab_name+"total_abundance_y_axis_label")
  .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
  .attr("transform", "translate("+ yaxis_label_x +","+(height/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate      
  .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px")    
  .text(yaxis_label_text)
  .on("click", function(d){make_editable(this,d,'y_axis_label',metab_name,metab_frag_name,"total_abundance")})     

//block which makes MID clickable
g.append("rect")//creates box with condition color
    .attr("id", "click_box")
    .attr("class", "click_box")
    .on('contextmenu', d3.contextMenu(menu))
    /*.on('touchstart', d3.contextMenu(menu))
    .on("touchmove", function(d){
		d3.select('.d3-context-menu').style('display', 'none');
                      // Clear timeout
                      return false;
                    })*/
    .attr("height",function(d){
            return this.parentElement.getBBox().height+40*graph_scale
        })
    .attr("width",function(d){
            return this.parentElement.getBBox().width+40*graph_scale*graph_avg_scale
        })
    .attr("x",function(d){
            return this.parentElement.getBBox().x-40*graph_scale*graph_avg_scale
        })     
    .attr("y",function(d){
            return this.parentElement.getBBox().y-40*graph_scale
        })    
    /*.attr("height",bargraph_height)
    .attr("width",bargraph_width)    
    .attr("x", 0)
    .attr("y", -25)*/
    .style("opacity", 0)    
    .attr("fill", "white")        
    //.attr("fill", "transparent")
    .style("cursor", "move")
    .append("svg:title")
        .text("Right Click to Access Additional Options");

g.append("text") //adds clickable arrow to induce contextmenu
  .attr("id", "context_button")     
  .attr("class", "context_button")     
  .attr("x",-50*graph_scale*graph_avg_scale)
  .attr("y",-50*graph_height_scale)
  .attr("style","font-family:FontAwesome; cursor:pointer;")    
  .attr("font-weight", 300)
  .attr("fill","#337ab7")
  .attr('font-size', function(d) { return (graph_height_scale*50).toString()+'px';} )
  .text(function(d) { return '\uf152'; })
  .on('click', d3.contextMenu(menu))
  .on('touchstart', d3.contextMenu(menu));
        
g.append("text")
    .on('contextmenu', d3.contextMenu(menu))
    .attr("class","titlelabel")
    .attr("id",metab_name+"titlelabel")  
    .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
    .attr("transform", "translate("+ (width/2) +","+(-25*graph_scale)+")")  // text is drawn off the screen top left, move down and out and rotate     
    /*.attr("x", width/2-55*graph_scale)
    .attr("y", -15*graph_scale)*/
    .attr("font-size",String(13*graph_scale*graph_avg_scale)+"px")
    //.text(function(d){return metab_frag_name.charAt(0).toUpperCase() + metab_frag_name.slice(1)+ " Abundance";})
    //.on("click", function(d){make_editable(this,d)});
    .text(title_text)
    .on("click", function(d){make_editable(this,d,'title',metab_name,metab_frag_name,"total_abundance")})    
      


    
} 
/////End Stacked abundance Abundance
    
    
//////AK: As of 07-05-18 makegraph_timecourse is not fully complete, currently only is able to display kinetic data for individual MIDs would be good to be able to create kinetic graphs for MPEs, and even abundances
function makegraph_timecourse(metab_frag_name,location,ConditionAmount,metab_name,MIDs,ConditionNames,svg,mode){
   //Kin_abundance  Kin_MPE "Kin_MID_M"+M_index.toString()
    
    if(mode=="MID_select_iso"){
        iso_name=MIDs[Object.keys(MIDs)[0]][metab_name][metab_frag_name][0].fragment
        graph_scale=Graph_Attribute[metab_name][metab_frag_name]["Kin_MID_"+iso_name].scale
        title_text=Graph_Attribute[metab_name][metab_frag_name]["Kin_MID_"+iso_name].title    
        yaxis_label_text=Graph_Attribute[metab_name][metab_frag_name]["Kin_MID_"+iso_name].yaxis_label 
        graph_height_scale=Graph_Attribute[metab_name][metab_frag_name]["Kin_MID_"+iso_name].height_scale
        graph_width_scale=Graph_Attribute[metab_name][metab_frag_name]["Kin_MID_"+iso_name].width_scale 
        color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name]["Kin_MID_"+iso_name].color_index]
        
    }
    else if(mode=="abundance_select_iso"){
        iso_name=MIDs[Object.keys(MIDs)[0]][metab_name][metab_frag_name][0].fragment
        graph_scale=Graph_Attribute[metab_name][metab_frag_name]["Kin_abundance_"+iso_name].scale
        title_text=Graph_Attribute[metab_name][metab_frag_name]["Kin_abundance_"+iso_name].title    
        yaxis_label_text=Graph_Attribute[metab_name][metab_frag_name]["Kin_abundance_"+iso_name].yaxis_label 
        graph_height_scale=Graph_Attribute[metab_name][metab_frag_name]["Kin_abundance_"+iso_name].height_scale
        graph_width_scale=Graph_Attribute[metab_name][metab_frag_name]["Kin_abundance_"+iso_name].width_scale 
        color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name]["Kin_abundance_"+iso_name].color_index]
        
    }    
    else if(mode=="total_abundance"){
        graph_scale=Graph_Attribute[metab_name][metab_frag_name].Kin_abundance.scale
        title_text=Graph_Attribute[metab_name][metab_frag_name].Kin_abundance.title    
        yaxis_label_text=Graph_Attribute[metab_name][metab_frag_name].Kin_abundance.yaxis_label 
        graph_height_scale=Graph_Attribute[metab_name][metab_frag_name].Kin_abundance.height_scale
        graph_width_scale=Graph_Attribute[metab_name][metab_frag_name].Kin_abundance.width_scale      
        color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name].Kin_abundance.color_index]
        
    }
    else if(mode=="MPE"){
        graph_scale=Graph_Attribute[metab_name][metab_frag_name].Kin_MPE.scale
        title_text=Graph_Attribute[metab_name][metab_frag_name].Kin_MPE.title    
        yaxis_label_text=Graph_Attribute[metab_name][metab_frag_name].Kin_MPE.yaxis_label
        graph_height_scale=Graph_Attribute[metab_name][metab_frag_name].Kin_MPE.height_scale
        graph_width_scale=Graph_Attribute[metab_name][metab_frag_name].Kin_MPE.width_scale 
        color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name].Kin_MPE.color_index]
    }  
    
    
    
    if(typeof graph_height_scale=='undefined' || graph_width_scale=='undefined'){        
        graph_height_scale=1
        graph_width_scale=1  
    }
    
    graph_avg_scale=(graph_width_scale+graph_height_scale)/2
    
    //color=color_scheme_obj[Graph_Attribute[metab_name][metab_frag_name].MID.color_index]

    
    //var Group_Names=[]
    var Time_Points=[]
    var max_time_point=0;
    //var color=["red","blue","green","purple","orange","yellow","grey","black"]
    //var color=["#B50303","#8C5200","#DDC400","#ADBD01","#81BD01","#35BD00","#01A70A","#01BD8F","#00ACBD","#0174BD","#003BBD","#6061B4","#5201B4","#A000B4","#FF0014"]
    var circle_radius=4*graph_scale*graph_width_scale;    

    
    
    var included_MIDs_keys=[]
    var included_ConditionNames=[]
    for (l=0;l<Condition_Times.length;l++){
        if(Group_Names.indexOf(Condition_Times[l].group_name)>-1){
            included_MIDs_keys.push(Object.keys(MIDs)[l])
            included_ConditionNames.push(ConditionNames[l])
        }        
    }
    
    
    for(i=0;i<Condition_Times.length;i++){
        if(Group_Names.indexOf(Condition_Times[i].group_name)>-1){
            if (Time_Points.indexOf(Condition_Times[i].timepoint) < 0) {
                Time_Points.push(Condition_Times[i].timepoint)
                if(Condition_Times[i].timepoint>max_time_point){
                    max_time_point=Condition_Times[i].timepoint;
                }
            }
        }
    }
    
    //var bargraph_width=(60+18.5*(frag_MID.length*ConditionAmount))*graph_scale, //alters graph width based on length of MID
    var bargraph_width=(60+50*Time_Points.length)*graph_scale*graph_width_scale, //alters graph width based on length of MID
    bargraph_height=150*graph_scale*graph_height_scale;    

    var //svg = d3.select("svg"),
    margin = {top: 70, right: 20, bottom: 10, left: 40},
    width = bargraph_width - margin.left - margin.right,
    height = bargraph_height - margin.top - margin.bottom;

    var Kinetic_Condition_data={}
    var select_MID=MIDs[Object.keys(MIDs)[0]]
    met_MIDs=select_MID[metab_name] //used to hold transfter the existing fragments of a metabolite
    
    for(i=0;i<Group_Names.length;i++){
    Kinetic_Condition_data[Group_Names[i]]=[]
    }

    if(mode=="MPE"){
        //[MPE, MPE_error]=calculate_MPE(metab_name,metab_frag_name,MIDs)    
        [MPE, MPE_error]=calculate_MPE(metab_name,metab_frag_name,ConditionNames)    
        //[MPE, MPE_error]=calculate_MPE(metab_name,metab_frag_name,included_ConditionNames)    
    }

    for(j=0;j<Group_Names.length;j++){
        k_tc=0;
        for(i=0;i<Condition_Times.length;i++){
            if(Condition_Times[i].group_name==Group_Names[j]){
                if(mode=="MID_select_iso"){
                    Kinetic_Condition_data[Group_Names[j]][k_tc]={x: Condition_Times[i].timepoint, y: MIDs[Object.keys(MIDs)[i]][metab_name][metab_frag_name][0].frequency, y_error: MIDs[Object.keys(MIDs)[i]][metab_name][metab_frag_name][0].error}
                }
                else if(mode=="abundance_select_iso"){
                    Kinetic_Condition_data[Group_Names[j]][k_tc]={x: Condition_Times[i].timepoint, y: MIDs[Object.keys(MIDs)[i]][metab_name][metab_frag_name][0].abundance, y_error: MIDs[Object.keys(MIDs)[i]][metab_name][metab_frag_name][0].abundance_error}
                }                
                else if(mode=="total_abundance"){
                    Kinetic_Condition_data[Group_Names[j]][k_tc]={x: Condition_Times[i].timepoint, y: MIDs[Object.keys(MIDs)[i]][metab_name][metab_frag_name][0].total_abundance, y_error: MIDs[Object.keys(MIDs)[i]][metab_name][metab_frag_name][0].total_abundance_error}
                }
                else if(mode=="MPE"){
                    Kinetic_Condition_data[Group_Names[j]][k_tc]={x: Condition_Times[i].timepoint, y: MPE[i], y_error: MPE_error[i]}
                }

                k_tc++;
            }
        }
    }

    for(group_key in Kinetic_Condition_data){
        Kinetic_Condition_data[group_key].sort((a, b) => (a.x > b.x) ? 1 : -1) //sorts the timecourse points in order
    }
        
    
    ybound=0; //will hold the maximum y axis value
    //finds maximum value of the y axis and lengths of the mass fragment for all conditions
    k_tc=0

    
    //for(var prop in MIDs){    //cycles through conditions ***Make more specific, only go through MIDs keys which correspond to group_names of Condition_Times whos Groups are inlcuded in Group_Names**AK 19-10-02
    for(l=0;l<included_MIDs_keys.length;l++){    //cycles through conditions ***Make more specific, only go through MIDs keys which correspond to group_names of Condition_Times whos Groups are inlcuded in Group_Names**AK 19-10-02
    prop=included_MIDs_keys[l] 
        
    frag_MID_cyc=MIDs[prop][metab_name][metab_frag_name] // frag_MID_cyc is a temporary holder for the MIDS of the specific mass fragment that is cycled through the conditions
        for(j=0;j<frag_MID_cyc.length;j++){   //cycles through the fragments of the specified mass fragment
            if(mode=="MID_select_iso"){
                if (frag_MID_cyc[j].frequency+frag_MID_cyc[j].error>ybound) {
                    ybound=frag_MID_cyc[j].frequency+frag_MID_cyc[j].error //includes error in the ybound
                }
            }
            else if(mode=="abundance_select_iso"){
                if (frag_MID_cyc[j].abundance+frag_MID_cyc[j].abundance_error>ybound) {
                    ybound=frag_MID_cyc[j].abundance+frag_MID_cyc[j].abundance_error //includes error in the ybound
                }
            }        
            else if(mode=="total_abundance"){
                if (frag_MID_cyc[j].total_abundance+frag_MID_cyc[j].total_abundance_error>ybound) {
                    ybound=frag_MID_cyc[j].total_abundance+frag_MID_cyc[j].total_abundance_error //includes error in the ybound
                }
            }             
        }

        if(mode=="MPE"){
            condition_index=ConditionNames.indexOf(included_ConditionNames[l])
            if (MPE[condition_index]+MPE_error[condition_index]>ybound) {
                ybound=MPE[condition_index]+MPE_error[condition_index] //includes error in the ybound
            }
        }
        //k++
    }
        

    function xValue(d) { return d.x; }      // accessors
    function yValue(d) { return d.y; }

    var x = d3.scaleLinear()                // interpolator for X axis -- inner plot region
    .domain([0,max_time_point])
    .range([0,width]);

    var y = d3.scaleLinear()                // interpolator for Y axis -- inner plot region
    .domain([-.01, ybound])
    .range([height,0]);                  // remember, (0,0) is upper left -- this reverses "y"

    var line = d3.line()                     // SVG line generator
    .x(function(d) { return x(d.x); } )
    .y(function(d) { return y(d.y); } );
 
    var xpos=location.x_loc;
    var ypos=location.y_loc;
    var current_location=location
    MID_xy= [{"x":xpos, "y":ypos}]; 

    var select_iso_name=MIDs[Object.keys(MIDs)[0]][metab_name][metab_frag_name][0].fragment
    //var select_iso_id=  metab_frag_name+'_MID_'+select_iso_name
    
    if(mode=="MID_select_iso"){
        select_Kin_iso_id=  metab_frag_name+'_Kin_MID_'+select_iso_name
        graph_location_id='Kin_MID_'+select_iso_name
    }else if(mode=="abundance_select_iso"){
        select_Kin_iso_id=  metab_frag_name+'_Kin_abundance_'+select_iso_name
        graph_location_id='Kin_abundance_'+select_iso_name    
    }else if(mode=="total_abundance"){
        select_Kin_iso_id=  metab_frag_name+'_Kin_abundance'
        graph_location_id='Kin_abundance'
    }else if(mode=="MPE"){
        select_Kin_iso_id=  metab_frag_name+'_Kin_MPE'
        graph_location_id='Kin_MPE'   
    }
    

    var g = svg.append("g")
    .attr("id",function(d){
        return select_Kin_iso_id})
    .attr("class",metab_name)
    .data(MID_xy)
    .attr("transform", "translate(" + xpos + "," + ypos + ")")
        .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", function(d){
                        dragended
                        if(mode=="MID_select_iso"){
                            Graph_Location[metab_name][metab_frag_name]['Kin_MID_'+select_iso_name]=d; 
                        }else if(mode=="abundance_select_iso"){
                            Graph_Location[metab_name][metab_frag_name]['Kin_abundance_'+select_iso_name]=d; 
                        }else if(mode=="total_abundance"){
                            Graph_Location[metab_name][metab_frag_name].Kin_abundance=d;                         
                        }else if(mode=="MPE"){
                            Graph_Location[metab_name][metab_frag_name].Kin_MPE=d;                         
                        }                        
                        
                        current_location.x_loc=d.x;
                        current_location.y_loc=d.y;
                }
           ),
         )

        //block which makes MID clickable
        var menu=[]; //variable which will hold the context menu for each metabolite
        i_count=0; // counter which allows for the number of context menu options to equal the number of integrated peaks
            counter_rand=0; //counter which allows for all condition data to be ploted via the data().enter() structur
        menu[i_count]={title: "delete",
                      isotopologue_holder: select_Kin_iso_id,                                                         
                      onMouseClick: function(elm, d, i) {
                            if(mode=="MID_select_iso"){
                                svg.selectAll("#"+this.isotopologue_holder).remove() //remove old MPE of the selected fragment                                
                                Graph_Location[metab_name][metab_frag_name]['Kin_MID_'+select_iso_name]={"x":"X","y":"X"};
                            }else if(mode=="abundance_select_iso"){
                                svg.selectAll("#"+this.isotopologue_holder).remove() //remove old MPE of the selected fragment                                
                                Graph_Location[metab_name][metab_frag_name]['Kin_abundance_'+select_iso_name]={"x":"X","y":"X"};                                
                            }else if(mode=="total_abundance"){
                                svg.selectAll("#"+metab_frag_name+'_Kin_abundance').remove() //remove old MPE of the selected fragment                                                                
                                Graph_Location[metab_name][metab_frag_name].Kin_abundance={"x":"X","y":"X"};                         
                            }else if(mode=="MPE"){
                                svg.selectAll("#"+metab_frag_name+'_Kin_MPE').remove() //remove old MPE of the selected fragment                                                                
                                Graph_Location[metab_name][metab_frag_name].Kin_MPE={"x":"X","y":"X"};                         
                            }                                  
                           //svg.selectAll("#"+select_Kin_iso_id).remove() //remove old MPE of the selected fragment
                           //Graph_Location[metab_name][metab_frag_name][graph_location_id]={"x":"X","y":"X"}
                           d3.select('.d3-context-menu').style('display', 'none');

                        },
                      onMouseOver: function(elm,d,i){
                      },
                      chidernItems: [
                      ]                       
                    }
    
        i_count=i_count+1
    menu=make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height,metab_frag_name,graph_location_id,svg,d3.select('#'+select_Kin_iso_id))
    
        //END generation of ContextMenu 


    g.append("g")
    .attr("id", "Timecourse_xaxis")
    .attr("class", "axis axis--x")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).ticks(5))
    .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
    .attr("tick-size",6*graph_scale*graph_avg_scale)
    .attr("font-size",String(13*graph_scale*graph_avg_scale)+"px");

if(mode=="total_abundance" || mode=="abundance_select_iso"){
    g.append("g")
    .attr("id", select_Kin_iso_id+"_yaxis")
    .attr("class", "axis axis--y")
    .call(d3.axisLeft(y).ticks(3))
    .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
    .attr("font-size",String(13*graph_scale*graph_avg_scale)+"px");        
}else{
    g.append("g")
    .attr("id", select_Kin_iso_id+"_yaxis")
    .attr("class", "axis axis--y")
    .call(d3.axisLeft(y).ticks(3,"%"))
    .attr("stroke-width",String(1*graph_scale*graph_avg_scale)+"px")
    .attr("font-size",String(13*graph_scale*graph_avg_scale)+"px");        
}

yaxis_label_x=document.getElementById(select_Kin_iso_id+"_yaxis").lastChild.lastChild.getBBox().x - 12.5*graph_scale //sets the location of the yaxis_label to be to the left of the text of the top tick of the y axis      
    

    g.append("text")                         // outer x-axis label
    //.attr("class", "x label")
    //.attr("text-anchor", "end")
    /*.attr("x", width/3.5)
    .attr("y", height+30*graph_scale)*/
    .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
    .attr("transform", "translate("+ (width/2) +","+(height+30*graph_scale*graph_avg_scale)+")")  // text is drawn off the screen top left, move down and out and rotate        
    //.attr("stroke","black")
    .attr("font-family","sans-serif") 
    .attr("font-weight","bold") 
    .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px")
    .text(function(d){
                return "Time ("+Condition_Times[0].time_unit.toString()+")"});


  
    for(i=0;i<Group_Names.length;i++){    
    //var data=Kinetic_Condition_data[Object.keys(Kinetic_Condition_data)[i]]
    var data=Kinetic_Condition_data[Group_Names[i]]

    g.append("path")                         // plot the data as a line
        .datum(data)
        .attr("class", "line")
        .attr("d", line)
        .style('fill', 'none')
        .style('stroke', color[i])


    g.selectAll(".dot")                      // plot a circle at each data location
        .data(data)
        .enter()
        .append("circle")
        //.attr("class", "dot")
        .attr("fill",color[i])
        .attr("cx", function(d) {
                                return x(d.x); } )
        .attr("cy", function(d) {
                                return y(d.y); } )
        .attr("r", circle_radius);


    g.selectAll(".errorbar")
       .data(data)//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
       .attr("stroke-width",String(1*graph_scale*graph_width_scale))
       .attr("x1",function(d){ return x(d.x); })
       .attr("y1",function (d) { return y(d.y-d.y_error);})
       .attr("x2",function(d){ return x(d.x); })
       .attr("y2",function (d) { return y(d.y+d.y_error);})
       .attr("fill", "none") 
       .attr("stroke", color[i]);

    g.selectAll(".errorbar_edge1")
       .data(data)//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
       .attr("stroke-width",String(1*graph_scale*graph_width_scale))
       .attr("x1",function(d){ return x(d.x)+circle_radius; })
       .attr("y1",function (d) { return y(d.y-d.y_error);})
       .attr("x2",function(d){ return x(d.x)-circle_radius; })
       .attr("y2",function (d) { return y(d.y-d.y_error);})
       .attr("fill", "none") 
       .attr("stroke", color[i]);

    g.selectAll(".errorbar_edge2")
       .data(data)//says find the data to connect attributes to in the links object of the  data object 
       .enter()
       .append("line")
       .attr("stroke-width",String(1*graph_scale*graph_width_scale))
       .attr("x1",function(d){ return x(d.x)+circle_radius; })
       .attr("y1",function (d) { return y(d.y+d.y_error);})
       .attr("x2",function(d){ return x(d.x)-circle_radius; })
       .attr("y2",function (d) { return y(d.y+d.y_error);})
       .attr("fill", "none") 
       .attr("stroke", color[i]);

    g.append("circle")//creates box with condition color
        .attr("class", "legend")
        .attr("fill", color[i])
        .attr("cx", bargraph_width)
        .attr("cy", circle_radius*i*3)
        .attr("r", circle_radius);    
       

    g.append("text") //creates text next to legend box's
        .attr("class", "legendlabel")
        .attr("x", bargraph_width+circle_radius+1)
        .attr("y", circle_radius*i*3+circle_radius/1.2)
        .attr("font-size",String(10*graph_scale*graph_width_scale)+"px") //graph_scale*graph_width_scale
        .text(function(d){
            return Group_Names[Object.keys(Group_Names)[i]]}); //includes the total_frequency next to the legendlabel     
    } 

        
  g.append("rect")//creates box with condition color
    .attr("id", "click_box")
    .attr("class", "click_box")
    .on('contextmenu', d3.contextMenu(menu))
    /*.on('touchstart', d3.contextMenu(menu))
    .on("touchmove", function(d){
		d3.select('.d3-context-menu').style('display', 'none');
                      // Clear timeout
                      return false;
                    })  */   
    .attr("height",bargraph_height)
    .attr("width",bargraph_width)    
    .attr("x", 0)
    .attr("y", -25)
    .style("opacity", 0)    
    .attr("fill", "white")        
    //.attr("fill", "transparent")
    .style("cursor", "move")
    .append("svg:title")
        .text("Right Click to Access Additional Options");    

g.append("text") //adds clickable arrow to induce contextmenu
  .attr("id", "context_button")     
  .attr("class", "context_button")     
  .attr("x",-60*graph_height_scale)
  .attr("y",-50*graph_height_scale)
  .attr("style","font-family:FontAwesome; cursor:pointer;")    
  .attr("font-weight", 300)
  .attr("fill","#337ab7")
  .attr('font-size', function(d) { return (graph_height_scale*50).toString()+'px';} )
  .text(function(d) { return '\uf152'; })
  .on('click', d3.contextMenu(menu))
  .on('touchstart', d3.contextMenu(menu));
        
  g.append("text")
    //.on('contextmenu', d3.contextMenu(menu))
    .attr("class","titlelabel")
    .attr("id",metab_name+"titlelabel")
    //.attr("text-anchor", "end")
    //.attr("x", width/4)
    //    .attr("x", width/2-15*graph_scale)
    .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
    .attr("transform", "translate("+ (width/2) +","+(-25*graph_scale*graph_avg_scale)+")")  // text is drawn off the screen top left, move down and out and rotate        
   /* .attr("y", -25*graph_scale) //changed from -15 to -25 to avoid collision of text and errorbars/percentages 
    .attr("x",function(d){
            if(mode=="MID_select_iso"){
                return width/8;
            }else if(mode=="total_abundance"){
                return -width/12;
            }else if(mode=="MPE"){
                return width/12;
            }    
    })    */
    .attr("font-size",String(13*graph_scale*graph_avg_scale)+"px")
    /*.text(function(d){
            if(mode=="MID_select_iso"){
                return "Kinetic "+ metab_frag_name.charAt(0).toUpperCase() + metab_frag_name.slice(1)+" "+select_MID[metab_name][metab_frag_name][0].fragment;
            }else if(mode=="total_abundance"){
                return "Kinetic "+ metab_frag_name.charAt(0).toUpperCase() + metab_frag_name.slice(1)+" Abundance";
            }else if(mode=="MPE"){
                return "Kinetic "+ metab_frag_name.charAt(0).toUpperCase() + metab_frag_name.slice(1)+" MPE";
            }    
    })*/
    .text(title_text)
    .on("click", function(d){make_editable(this,d,'title',metab_name,metab_frag_name,graph_location_id)})    
    

    g.append("text")// outer y-axis label
     .attr("class", "y_axis_label")
     .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
     .attr("transform", "translate("+ yaxis_label_x +","+(height/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate     
    .attr("font-size",String(12*graph_scale*graph_avg_scale)+"px")
    .text(yaxis_label_text)    
    .on("click", function(d){make_editable(this,d,'y_axis_label',metab_name,metab_frag_name,graph_location_id)})    
    
    
    


}
       
    
function load_data_table(metab_name,metab_frag_name,graph_type){              
            if ($.fn.DataTable.isDataTable("#data_display_Table")) {
              $("#data_display_Table").DataTable().clear().destroy();
              $("#data_display_Table").remove(); //removes all traces of previous data_display_Table
            }   
    
            $( "#insert_table" ).append(
                '<table id="data_display_Table" class="display compact cell-border" style="cellspacing:0; width:100%; word-wrap: break-word"><thead><tr id="data_display_ConditionNames" class="table_title"></tr><tr id="data_display_FileNames"></tr></thead><tbody class="table_element"></tbody></table>'
            )    //generates shell of data_display_Table and inserts it into insert_table
                  
                $( "#data_display_ConditionNames" ).append(
                    '<th rowspan="2">'+metab_frag_name+'</th>'
                    )

                file_names_inorder=[]
                file_index_inorder=[]
                for(Conditions in fileorganizer){

                    $( "#data_display_ConditionNames" ).append(
                            '<th colspan="'+fileorganizer[Conditions].length+'">'+ Conditions +'</th>'            
                    );             

                    //for(file_names in fileorganizer[Conditions]){
                    for(k=0;k<fileorganizer[Conditions].length;k++){
                        file_names=fileorganizer[Conditions][k]
                         $( "#data_display_FileNames" ).append(
                                '<th>'+ file_names +'</th>'            
                        );               


                        file_names_inorder.push(file_names)
                        file_index_inorder.push(FileNames.indexOf(file_names))
                    }

                }
                isotopologue_number=FileMIDs.File1[metab_name][metab_frag_name].labeling.length
                for(l=0;l<isotopologue_number+1;l++){                    
                    
                    if(l<isotopologue_number){
                        row_string='<tr><td>M'+l+'</td>'
                        for(m=0;m<file_index_inorder.length;m++){
                            total_abundance_data=FileMIDs['File'+(file_index_inorder[m]+1).toString()][metab_name][metab_frag_name].abundance                        
                            isotopologue_frequency=FileMIDs['File'+(file_index_inorder[m]+1).toString()][metab_name][metab_frag_name].labeling[l].frequency;
                            isotopologue_abundance=isotopologue_frequency*total_abundance_data
                            if(graph_type=='abundance' || graph_type=='stacked_abundance' || graph_type=='total_abundance'|| graph_type=='Kin_abundance'){
                                row_string=row_string+'<td>'+isotopologue_abundance.toFixed(0)+'</td>'
                            }else{
                                row_string=row_string+'<td>'+(100*isotopologue_frequency).toFixed(3)+'</td>'
                            }
                        }                        
                       
                       }else{
                           
                            if(graph_type=='abundance' || graph_type=='stacked_abundance' || graph_type=='total_abundance'|| graph_type=='Kin_abundance'){
                                row_string='<tr><td>Total Abundance</td>'
                                for(m=0;m<file_index_inorder.length;m++){
                                    total_abundance_data=FileMIDs['File'+(file_index_inorder[m]+1).toString()][metab_name][metab_frag_name].abundance                                                    
                                    row_string=row_string+'<td>'+total_abundance_data.toFixed(0)+'</td>'
                                }                            
                            }else{
                                row_string='<tr><td>MPE</td>'
                                MPE_inorder=[]
                                
                                
                                MPE_inorder = calculate_MPE(metab_name,metab_frag_name)
                                for(m=0;m<MPE_inorder[2].length;m++){
                                    row_string=row_string+'<td>'+(100*MPE_inorder[2][m]).toFixed(3)+'</td>'
                                }
                            }                            
                           
                       }

                    row_string=row_string+'</tr>'
                    $( "#data_display_Table tbody" ).append(row_string)   
                    row_string=''

                }
              
                var table_display_data = $('#data_display_Table').DataTable({
                       //"dom":'frtipB', //allows copy button to be added to the table
                        "dom":'tB', //allows copy button to be added to the table
                        "retrieve": true,
                        "scrollX": true,                    
                        "paging":   false, 
                        "ordering": false,
                        "searching": false,
                        "fixedColumns": true,  //allows first column in table to remain in position
                        "buttons": [
                                    {
                                        extend: 'copy', //inserts COPY button in data table
                                        text: 'Copy Table',
                                        exportOptions: {
                                            header: 'true',
                                        }
                                    }                        ]                    
                                    
                    });
              
              $('#close_popup_data_display').click( function() {
                    div_hide('PopUp_data_display_Table')            
                });    
    
    
}     


function make_menu(menu,i_count,met_MIDs,metab_name,current_location,bargraph_height,metab_frag_name,graph_type,svg,graph_svg){
    
    if(graph_type=='abundance' || graph_type=='stacked_abundance' || graph_type=='total_abundance'|| graph_type=='MID'|| graph_type=='stacked_MID'|| graph_type=='MPE'|| graph_type=='Kin_abundance'|| graph_type=='Kin_MPE'){ //restricts ability to pull out data to only abundance and MID graphs
        menu[i_count] ={
          title: "Show Data",
          // Exceute Action 
          onMouseClick: function(elm, d, i) {
              d3.select('.d3-context-menu').style('display', 'none'); //inserted because contextmenu was not dissapearing on click
              
              div_show('PopUp_data_display_Table')
            
              load_data_table(metab_name,metab_frag_name,graph_type) //generates data table in PopUp_data_display_Table
            
               
          },
          onMouseOver: function(elm,d,i){
          },
          chidernItems: []
        }
                i_count=i_count+1    
    
    }
      
        menu[i_count] ={
          title: "Download Graph",
          // Exceute Action 
          onMouseClick: function(elm, d, i) {
              
              //writeDownloadLink_svg(graph_svg,metab_frag_name+'_'+graph_type)
 
          },
          onMouseOver: function(elm,d,i){
          },
          chidernItems: [
            {              
                title: "SVG",
                onMouseClick:
                    function(elm, d, i) {
                        writeDownloadLink_svg(graph_svg,metab_frag_name+'_'+graph_type)

                    },
                onMouseOver: function(elm,d,i){},
                chidernItems: []
                
            },
            {              
                title: "PNG",
                onMouseClick:
                    function(elm, d, i) {
                        writeDownloadLink_png(graph_svg,metab_frag_name+'_'+graph_type)

                    },
                onMouseOver: function(elm,d,i){},
                chidernItems: []
                
            },              
              
          ]
        }
                i_count=i_count+1
    
        menu[i_count] ={
          title: "Change Graph",
          // Exceute Action 
          onMouseClick: function(elm, d, i) {},
          onMouseOver: function(elm,d,i){},
          chidernItems: [
         
            {              
                title: "Size",
                onMouseClick:
                    function(elm, d, i) {
                        
                        document.getElementById("PopUp_slider").style.display = "block";  //makes popup appear
                        
                        //alters values of the slider outputs to reflect the height value of selected graph
                        document.getElementById("height_range").value = (Graph_Attribute[metab_name][metab_frag_name][graph_type].height_scale*7).toString()
                        document.getElementById("height_range_display").value = (Graph_Attribute[metab_name][metab_frag_name][graph_type].height_scale*7).toString()
                        
                        
                        var height_slider = document.getElementById("height_range");
                        var height_output = document.getElementById("height_range_display");
                        height_output.innerHTML = height_slider.value; 

                        height_slider.oninput = function() {
                            height_output.innerHTML = this.value; //changes value of the range output display dynamically
        
                            Graph_Attribute[metab_name][metab_frag_name][graph_type].height_scale=height_slider.value*1/7
                            reprint_specific_graph(metab_name,metab_frag_name,graph_type,svg)
                        }  
                        
                        //alters values of the slider outputs to reflect the width value of selected graph                        
                        document.getElementById("width_range").value = (Graph_Attribute[metab_name][metab_frag_name][graph_type].width_scale*7).toString()
                        document.getElementById("width_range_display").value = (Graph_Attribute[metab_name][metab_frag_name][graph_type].width_scale*7).toString()
                        var width_slider = document.getElementById("width_range");
                        var width_output = document.getElementById("width_range_display");
                        width_output.innerHTML = width_slider.value;

                        width_slider.oninput = function() {
                            width_output.innerHTML = this.value;  //changes value of the range output display dynamically
                            
                            Graph_Attribute[metab_name][metab_frag_name][graph_type].width_scale=width_slider.value*1/7
                            reprint_specific_graph(metab_name,metab_frag_name,graph_type,svg)               
                        }        

                        $('#close_popup_slider').click( function() {
                            div_hide("PopUp_slider")
                        } );         

                        
            

                    },
                onMouseOver: function(elm,d,i){},
                chidernItems: []
                
            },                
            {              
                title: "Color",
                onMouseClick:
                    function(elm, d, i) {
                        
                            div_show('PopUp_color_picker')

                            d3.select('#submit_color_picker_button').on("click", function(){

                                sel_color_index=get_new_color_scheme_obj($("#all-color-schemes")[0].children) 
                                Graph_Attribute[metab_name][metab_frag_name][graph_type].color_index=sel_color_index
                        
                                div_hide('PopUp_color_picker')// to close  
                                
                                load_color_picker_PopUp()
                                reprint_specific_graph(metab_name,metab_frag_name,graph_type,svg)   

                            });    
                  
                    },
                onMouseOver: function(elm,d,i){},
                chidernItems: []

            }              
              
          ]
        }
                i_count=i_count+1   
    
 

    
    if(met_MIDs != "CG"){        
        
        for (var prop2 in met_MIDs) { //cycle through the fragments of the selected metabolite, synonymous with metab_frag_name
        //START generation of ContextMenu\
            //menu[] hold the options generated by right clicking the graph, allows user to access additional graph types

        menu[i_count] ={
            title: prop2,
            // Exceute Action 
            onMouseClick: function(elm, d, i) {
            },
            onMouseOver: function(elm,d,i){
            },
            chidernItems: [
                            {
                            title: "Labeling",
                            // Exceute Action 
                            onMouseClick: function(elm, d, i) {
                            },
                            onMouseOver: function(elm,d,i){
                            },
                            chidernItems: [
                                   {              
                                    title: prop2+' MID',
                                    onMouseClick:
                                        function(elm, d, i) {
                                            selectMID=MIDs[Object.keys(MIDs)[0]]
                                            met_MIDs=selectMID[metab_name]// selects the 
                                            frag_keys=Object.keys(selectMID[metab_name]) //returns array of mass fragments of met prop2
                                            metab_frag_name =  frag_keys[0]
                                            prop2=this.title.replace(' MID', '') //selects the mass fragment corresponding to the title
                                            current_location.y_loc=current_location.y_loc+bargraph_height+25*graph_scale
                                            Graph_Location[metab_name][prop2].MID={"x":current_location.x_loc, "y":current_location.y_loc}
                                            makegraph_MID(prop2,current_location,ConditionAmount,metab_name,MIDs,ConditionNames,svg)
                                        return
                                        },
                                    onMouseOver: function(elm,d,i){},
                                    chidernItems: []
                                       
                                },
                                {
                                    title: prop2+' stacked MID',
                                    onMouseClick:
                                        function(elm, d, i) {
                                            selectMID=MIDs[Object.keys(MIDs)[0]]
                                            met_MIDs=selectMID[metab_name]// selects the 
                                            frag_keys=Object.keys(selectMID[metab_name]) //returns array of mass fragments of met prop2
                                            metab_frag_name =  frag_keys[0]
                                            prop2=this.title.replace(' stacked MID', '') //selects the mass fragment corresponding to the title
                                            current_location.y_loc=current_location.y_loc+bargraph_height+25*graph_scale
                                            Graph_Location[metab_name][prop2].stacked_MID={"x":current_location.x_loc, "y":current_location.y_loc}
                                            makegraph_stacked_MID(prop2,current_location,ConditionAmount,metab_name,MIDs,ConditionNames,svg)
                                        return
                                        },
                                    onMouseOver: function(elm,d,i){},
                                    chidernItems: []
                                    
                                },                                
                                ]
                            },
                
                            {
                            title: "Abundance",
                            // Exceute Action 
                            onMouseClick: function(elm, d, i) {
                            },
                            onMouseOver: function(elm,d,i){
                            },
                            chidernItems: [
                                {
                                    title: prop2+' abundance',
                                    onMouseClick:
                                        function(elm, d, i) {
                                            selectMID=MIDs[Object.keys(MIDs)[0]]
                                            met_MIDs=selectMID[metab_name]// selects the 
                                            frag_keys=Object.keys(selectMID[metab_name]) //returns array of mass fragments of met prop2
                                            metab_frag_name =  frag_keys[0]
                                            prop2=this.title.replace(' abundance', '') //selects the mass fragment corresponding to the title
                                            current_location.y_loc=current_location.y_loc+bargraph_height+25*graph_scale
                                            Graph_Location[metab_name][prop2].abundance={"x":current_location.x_loc, "y":current_location.y_loc}
                                            makegraph_abundance(prop2,current_location,ConditionAmount,metab_name,MIDs,ConditionNames,svg)

                                //makegraph_stacked_abundance(metab_frag_name,MID_location[prop2],ConditionAmount,prop2,MIDs)

                                        return
                                        },
                                    onMouseOver: function(elm,d,i){},
                                    chidernItems: []                                    
                                },
                                {
                                    title: prop2+' stacked abundance',
                                    onMouseClick:
                                        function(elm, d, i) {
                                            selectMID=MIDs[Object.keys(MIDs)[0]]
                                            met_MIDs=selectMID[metab_name]// selects the 
                                            frag_keys=Object.keys(selectMID[metab_name]) //returns array of mass fragments of met prop2
                                            metab_frag_name =  frag_keys[0]
                                            prop2=this.title.replace(' stacked abundance', '') //selects the mass fragment corresponding to the title
                                            current_location.y_loc=current_location.y_loc+bargraph_height+25*graph_scale
                                            Graph_Location[metab_name][prop2].stacked_abundance={"x":current_location.x_loc, "y":current_location.y_loc}
                                            makegraph_stacked_abundance(prop2,current_location,ConditionAmount,metab_name,MIDs,ConditionNames,svg)
                                                                  
                                        return
                                        },
                                    onMouseOver: function(elm,d,i){},
                                    chidernItems: []                                    
                                },
                                {
                                    title: prop2+' total abundance',
                                    onMouseClick:
                                        function(elm, d, i) {
                                            selectMID=MIDs[Object.keys(MIDs)[0]]
                                            met_MIDs=selectMID[metab_name]// selects the 
                                            frag_keys=Object.keys(selectMID[metab_name]) //returns array of mass fragments of met prop2
                                            metab_frag_name =  frag_keys[0]
                                            prop2=this.title.replace(' total abundance', '') //selects the mass fragment corresponding to the title
                                            current_location.y_loc=current_location.y_loc+bargraph_height+25*graph_scale
                                            Graph_Location[metab_name][prop2].total_abundance={"x":current_location.x_loc, "y":current_location.y_loc}
                                            makegraph_total_abundance(prop2,current_location,ConditionAmount,metab_name,MIDs,ConditionNames,svg)
                                                                   
                                        return
                                        },
                                    onMouseOver: function(elm,d,i){},
                                    chidernItems: []
                                    
                                },                
                                ]
                            },  
                
                            {
                            title: "MPE",
                            // Exceute Action 
                            onMouseClick: function(elm, d, i) {
                            },
                            onMouseOver: function(elm,d,i){
                            },
                            chidernItems: [
                                {
                                    title: prop2+' MPE',
                                    onMouseClick:
                                        function(elm, d, i) {
                                            selectMID=MIDs[Object.keys(MIDs)[0]]
                                            met_MIDs=selectMID[metab_name]// selects the 
                                            frag_keys=Object.keys(selectMID[metab_name]) //returns array of mass fragments of met prop2
                                            metab_frag_name =  frag_keys[0]
                                            prop2=this.title.replace(' MPE', '') //selects the mass fragment corresponding to the title
                                            current_location.y_loc=current_location.y_loc+bargraph_height+25*graph_scale
                                            Graph_Location[metab_name][prop2].MPE={"x":current_location.x_loc, "y":current_location.y_loc}
                                            makegraph_MPE(prop2,current_location,ConditionAmount,metab_name,MIDs,ConditionNames,svg)
                                                                       
                                        return
                                        },
                                    onMouseOver: function(elm,d,i){},
                                    chidernItems: []                                    
                                }                
                            ]
                            },                 

                        ]
        }
            
    ////////// START Individual Isotopologues
            for(o=0;o<met_MIDs[prop2].length;o++){
                iso_name_menu=met_MIDs[prop2][o].fragment
                
                iso_menu={
                        title: prop2+' '+iso_name_menu,
                        onMouseClick:function(elm,d,i){
                            },
                        onMouseOver: function(elm,d,i){},
                        chidernItems: [
                                {
                                    title: prop2+' '+iso_name_menu+' bar',
                                    fragment_holder:prop2,
                                    isotopologue_holder:iso_name_menu,                                                        
                                    onMouseClick:
                                        function(elm, d, i) {
                                            selectMID=MIDs[Object.keys(MIDs)[0]]
                                            met_MIDs=selectMID[metab_name]// selects the 
                                            frag_keys=Object.keys(selectMID[metab_name]) //returns array of mass fragments of met prop2
                                            metab_frag_name =  frag_keys[0]
                                            prop2=this.fragment_holder //selects the mass fragment corresponding to the title
                                            //prop2=this.title.replace(' '+iso_name_menu+' bar', '') //selects the mass fragment corresponding to the title
                                            current_location.y_loc=current_location.y_loc+bargraph_height+25*graph_scale

                                            isotopologue=this.isotopologue_holder.split("M")
                                            M_index=Number(isotopologue[1])      

                                            select_iso_MID_location="MID_M"+M_index.toString();
                            
                                            Graph_Location[metab_name][metab_frag_name][select_iso_MID_location]={"x":current_location.x_loc, "y":current_location.y_loc} //assigns a location to the isotopologue MID

                                            selected_Iso_MID=obtain_isotopologue_data(metab_name,prop2,M_index)

                                            makegraph_MID(prop2,current_location,ConditionAmount,metab_name,selected_Iso_MID,ConditionNames,svg,"select_iso")
                                        return
                                        },
                                    onMouseOver: function(elm,d,i){},
                                    chidernItems: []                                    
                                }
                        ]
                }
            menu[i_count].chidernItems[0].chidernItems.push(iso_menu)
                
                
                iso_menu={
                        title: prop2+' '+iso_name_menu,
                        onMouseClick:function(elm,d,i){
                            },
                        onMouseOver: function(elm,d,i){},
                        chidernItems: [
                                {
                                    title: prop2+' '+iso_name_menu+' bar',
                                    fragment_holder:prop2,
                                    isotopologue_holder:iso_name_menu,                                                        
                                    onMouseClick:
                                        function(elm, d, i) {
                                            selectMID=MIDs[Object.keys(MIDs)[0]]
                                            met_MIDs=selectMID[metab_name]// selects the 
                                            frag_keys=Object.keys(selectMID[metab_name]) //returns array of mass fragments of met prop2
                                            metab_frag_name =  frag_keys[0]
                                            prop2=this.fragment_holder //selects the mass fragment corresponding to the title
                                            //prop2=this.title.replace(' '+iso_name_menu+' bar', '') //selects the mass fragment corresponding to the title
                                            current_location.y_loc=current_location.y_loc+bargraph_height+25*graph_scale

                                            isotopologue=this.isotopologue_holder.split("M")
                                            M_index=Number(isotopologue[1])      

                                            select_iso_abundance_location="abundance_M"+M_index.toString();
                            
                                            Graph_Location[metab_name][metab_frag_name][select_iso_abundance_location]={"x":current_location.x_loc, "y":current_location.y_loc} //assigns a location to the isotopologue MID

                                            selected_Iso_abundance=obtain_isotopologue_data(metab_name,prop2,M_index)

                                            makegraph_abundance(prop2,current_location,ConditionAmount,metab_name,selected_Iso_abundance,ConditionNames,svg,"select_iso")
                                        return
                                        },
                                    onMouseOver: function(elm,d,i){},
                                    chidernItems: []                                    
                                }
                        ]
                }
            menu[i_count].chidernItems[1].chidernItems.push(iso_menu)                
                
            }
            
    ////////// END Individual Isotopologues        
                
        if(Condition_Times != ''){
            for(o=0;o<met_MIDs[prop2].length;o++){
                iso_name_menu=met_MIDs[prop2][o].fragment
                
                iso_kin_menu={
                            title: prop2+' '+iso_name_menu+' kinetic',
                            fragment_holder:prop2,                    
                            isotopologue_holder:iso_name_menu,                    
                            onMouseClick:
                                function(elm, d, i) {
                                    selectMID=MIDs[Object.keys(MIDs)[0]]
                                    met_MIDs=selectMID[metab_name]// selects the 
                                    frag_keys=Object.keys(selectMID[metab_name]) //returns array of mass fragments of met prop2
                                    metab_frag_name =  frag_keys[0]
                                    prop2=this.fragment_holder //selects the mass fragment corresponding to the title                                            
                                    //prop2=this.title.replace(' '+iso_name_menu+' kinetic', '') //selects the mass fragment corresponding to the title
                                    current_location.y_loc=current_location.y_loc+bargraph_height+25*graph_scale

                                    isotopologue=this.isotopologue_holder.split("M")
                                    M_index=Number(isotopologue[1])      

                                    select_iso_MID_location="Kin_MID_M"+M_index.toString();

                                    Graph_Location[metab_name][metab_frag_name][select_iso_MID_location]={"x":current_location.x_loc, "y":current_location.y_loc} //assigns a location to the isotopologue MID

                                    selected_Iso_MID=obtain_isotopologue_data(metab_name,prop2,M_index)

                                    makegraph_timecourse(prop2,current_location,ConditionAmount,metab_name,selected_Iso_MID,ConditionNames,svg,"MID_select_iso")
                                return
                                },
                            onMouseOver: function(elm,d,i){},
                            chidernItems: []                    
                            }
                       
            menu[i_count].chidernItems[0].chidernItems[o+2].chidernItems.push(iso_kin_menu)
    
                iso_kin_menu={
                            title: prop2+' '+iso_name_menu+' kinetic',
                            fragment_holder:prop2,                    
                            isotopologue_holder:iso_name_menu,                    
                            onMouseClick:
                                function(elm, d, i) {
                                    selectMID=MIDs[Object.keys(MIDs)[0]]
                                    met_MIDs=selectMID[metab_name]// selects the 
                                    frag_keys=Object.keys(selectMID[metab_name]) //returns array of mass fragments of met prop2
                                    metab_frag_name =  frag_keys[0]
                                    prop2=this.fragment_holder //selects the mass fragment corresponding to the title                                            
                                    //prop2=this.title.replace(' '+iso_name_menu+' kinetic', '') //selects the mass fragment corresponding to the title
                                    current_location.y_loc=current_location.y_loc+bargraph_height+25*graph_scale

                                    isotopologue=this.isotopologue_holder.split("M")
                                    M_index=Number(isotopologue[1])      

                                    select_iso_abundance_location="Kin_abundance_M"+M_index.toString();

                                    Graph_Location[metab_name][metab_frag_name][select_iso_abundance_location]={"x":current_location.x_loc, "y":current_location.y_loc} //assigns a location to the isotopologue MID

                                    selected_Iso_abundance=obtain_isotopologue_data(metab_name,prop2,M_index)

                                    makegraph_timecourse(prop2,current_location,ConditionAmount,metab_name,selected_Iso_abundance,ConditionNames,svg,"abundance_select_iso")
                                return
                                },
                            onMouseOver: function(elm,d,i){},
                            chidernItems: []                    
                            }
                       
            menu[i_count].chidernItems[1].chidernItems[o+3].chidernItems.push(iso_kin_menu)                
                
            }            
            
            
            
            
            
        kinetic_menu={
                        
                        title: prop2+' Kinetic MPE',
                        onMouseClick:
                            function(elm, d, i) {
                                selectMID=MIDs[Object.keys(MIDs)[0]]
                                met_MIDs=selectMID[metab_name]// selects the 
                                frag_keys=Object.keys(selectMID[metab_name]) //returns array of mass fragments of met prop2
                                metab_frag_name =  frag_keys[0]
                                prop2=this.title.replace(' Kinetic MPE', '') //selects the mass fragment corresponding to the title
                                current_location.y_loc=current_location.y_loc+bargraph_height+25*graph_scale
                                Graph_Location[metab_name][metab_frag_name].Kin_MPE={"x":current_location.x_loc, "y":current_location.y_loc} //assigns a location to the isotopologue MID
                                makegraph_timecourse(prop2,current_location,ConditionAmount,metab_name,MIDs,ConditionNames,svg,"MPE")
                            return
                            },
                        onMouseOver: function(elm,d,i){},
                        chidernItems: []
            
                        }
                menu[i_count].chidernItems[2].chidernItems.push(kinetic_menu)
            
            
        kinetic_menu={
                        title: prop2+' Kinetic abundance',
                        onMouseClick:
                            function(elm, d, i) {
                                selectMID=MIDs[Object.keys(MIDs)[0]]
                                met_MIDs=selectMID[metab_name]// selects the 
                                frag_keys=Object.keys(selectMID[metab_name]) //returns array of mass fragments of met prop2
                                metab_frag_name =  frag_keys[0]
                                prop2=this.title.replace(' Kinetic abundance', '') //selects the mass fragment corresponding to the title
                                current_location.y_loc=current_location.y_loc+bargraph_height+25*graph_scale
                                Graph_Location[metab_name][metab_frag_name].Kin_abundance={"x":current_location.x_loc, "y":current_location.y_loc} //assigns a location to the isotopologue MID
                                //selected_Iso_MID=obtain_isotopologue_data(metab_name,prop2,0)
                                makegraph_timecourse(prop2,current_location,ConditionAmount,metab_name,MIDs,ConditionNames,svg,"total_abundance")
                                //makegraph_timecourse(prop2,current_location,ConditionAmount,metab_name,selected_Iso_MID,ConditionNames,svg,"total_abundance")
                            return
                            },
                        onMouseOver: function(elm,d,i){},
                        chidernItems: []
            
                        }
                
                //menu[i_count].chidernItems[1].chidernItems.push(kinetic_menu)
                menu[i_count].chidernItems[1].chidernItems.splice(3,0,kinetic_menu)
                //menu[i_count].chidernItems[1].chidernItems[3].push(kinetic_menu)
                //menu[i_count].chidernItems=[menu[i_count].chidernItems,kinetic_menu]
                //console.log(menu[i_count].chidernItems)
            }
            
            
        i_count=i_count+1
        }    
    }
    
    return menu
} 
    
    

function make_editable(this_one,d,field,metab_name,metab_frag_name,graph_type) {
        console.log(this_one)
        if(graph_type=="CG_graph" && field=="x_axis_label"){
        var p = this_one.parentNode.parentNode;
        }else{
        var p = this_one.parentNode;
        }
        //console.log(this_one, arguments);
    
    //make_editable(this,d,metab_name,metab_frag_name,"MID")
    
        // inject a HTML form to edit the content here...

        // bug in the getBBox logic here, but don't know what I've done wrong here;
        // anyhow, the coordinates are completely off & wrong. :-((
        var xy = this_one.getBBox();
        var p_xy = p.getBBox();

        xy.x -= p_xy.x;
        xy.y -= p_xy.y;

        var el = d3.select(this_one);
        var p_el = d3.select(p);

        var frm = p_el.append("foreignObject");
        //var field="title"

        var inp = frm
            //.attr("x", xy.x)
            //.attr("y", xy.y)
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", 500)
            .attr("height", 70)
            .append("xhtml:form")
                    .append("input")
                        .attr("id","edit_text_input")
                        .attr("value", function() {
                            // nasty spot to place this_one call, but here we are sure that the <input> tag is available
                            // and is handily pointed at by 'this_one':
                            this.focus();
                            return this_one.innerHTML;
                            //return d[field];
                        })
                       // .attr("style", "width: 500px; font-size: 35px")
                        //.attr("style", "width: 500px;")
                        .attr("style", "font-size: 4rem;")
                        // make the form go away when you jump out (form looses focus) or hit ENTER:
                        .on("blur", function() {
                            //console.log("blur", this_one, arguments);

                            var txt = inp.node().value;

                            d[field] = txt;
                            el
                                .text(function(d) { return d[field]; });

                            p_el.select("foreignObject").remove();
                        })        
                        .on("keypress", function() {
                          //  console.log("keypress", this_one, arguments);

                            // IE fix
                            if (!d3.event)
                                d3.event = window.event;

                            var e = d3.event;
                            if (e.keyCode == 13) //if "enter" is clicked
                            {
                                if (typeof(e.cancelBubble) !== 'undefined') // IE
                                  e.cancelBubble = true;
                                if (e.stopPropagation)
                                  e.stopPropagation();
                                e.preventDefault();

                                var txt = inp.node().value;
                                if(field=="title"){
                                    Graph_Attribute[metab_name][metab_frag_name][graph_type].title=txt
                                }else if(field=="y_axis_label"){
                                    Graph_Attribute[metab_name][metab_frag_name][graph_type].yaxis_label=txt                                    
                                }else if(field=="x_axis_label"){
                                    //CustomMIDs["CustomMID"+n.toString()][p].x_axis_label=txt
                                    console.log(CG_container)
                                }
                                d[field] = txt;
                                el
                                    .text(function(d) { return d[field]; });

                                // odd. Should work in Safari, but the debugger crashes on this_one instead.
                                // Anyway, it SHOULD be here and it doesn't hurt otherwise.
                                p_el.select("foreignObject").remove();
                            }
                            
                        });
            allow_keystrokes("edit_text_input") //need to allow_keystrokes here

      };    
   
function make_editable_tick(this_one,d,field,metab_name,metab_frag_name,graph_type) {
        var p = this_one.parentNode.parentNode;
        d={}
        //console.log(this_one, arguments);
    
        // inject a HTML form to edit the content here...

        // bug in the getBBox logic here, but don't know what I've done wrong here;
        // anyhow, the coordinates are completely off & wrong. :-((
        var xy = this_one.getBBox();
        var p_xy = p.getBBox();

        xy.x -= p_xy.x;
        xy.y -= p_xy.y;

        var el = d3.select(this_one);
        var p_el = d3.select(p);
        var frm = p_el.append("foreignObject");
        var inp = frm
            //.attr("x", xy.x)
            //.attr("y", xy.y)
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", 500)
            .attr("height", 70)
            .append("xhtml:form")
                    .append("input")
                        .attr("id","edit_text_input")
                        .attr("value", function() {
                            // nasty spot to place this_one call, but here we are sure that the <input> tag is available
                            // and is handily pointed at by 'this_one':
                            this.focus();
                            //return this_one.innerHTML;
                            return this_one.textContent;
                            //return d[field];
                        })
                      //  .attr("style", "width: 500px; height: 150px; padding: 12px 0px; font-size: 35px")
                        //.attr("style", "width: 500px; height: 300%; font-size: 300%")
                        //.attr("style", "width: 500px;")
                        .attr("style", "font-size: 4rem;")
        
                        // make the form go away when you jump out (form looses focus) or hit ENTER:
                        .on("blur", function() {
                            console.log("blur", this_one, arguments);

                            var txt = inp.node().value;

                            d[field] = txt;
                            el.text(d[field]);


                            p_el.select("foreignObject").remove();
                        })       
                        .on("keypress", function() {
                            console.log("keypress", this_one, arguments);

                            // IE fix
                            if (!d3.event)
                                d3.event = window.event;

                            var e = d3.event;
                            if (e.keyCode == 13) //if "enter" is clicked
                            {
                                if (typeof(e.cancelBubble) !== 'undefined') // IE
                                  e.cancelBubble = true;
                                if (e.stopPropagation)
                                  e.stopPropagation();
                                e.preventDefault();

                                var txt = inp.node().value;
                                if(field=="title"){
                                    Graph_Attribute[metab_name][metab_frag_name][graph_type].title=txt
                                }else if(field=="y_axis_label"){
                                    Graph_Attribute[metab_name][metab_frag_name][graph_type].yaxis_label=txt                                    
                                }else if(field=="x_axis_label"){
                                    //CustomMIDs["CustomMID"+n.toString()][p]={"title":CG_data[p].title, value: data_value, error: data_error, condition: new_group_order[n-1], "x_axis_label": CG_data[p].title}
                                    //CustomMIDs["CustomMID"+n.toString()][p].x_axis_label=txt
                                    tick_index=Number(this_one.id.split("_")[1])
                                    
                                    for(cg_conditions in CG_container[Number(metab_frag_name.split("_")[1])-1]){
                                        CG_container[Number(metab_frag_name.split("_")[1])-1][cg_conditions][tick_index].x_axis_label=txt
                                    
                                        CG_container[Number(metab_frag_name.split("_")[1])-1][cg_conditions][tick_index].title=txt
                                        
                                    }
                                }
                                d[field] = txt;
                                //el.text(function(d) { return d[field]; });
                                el.text(d[field]);

                                // odd. Should work in Safari, but the debugger crashes on this_one instead.
                                // Anyway, it SHOULD be here and it doesn't hurt otherwise.
                                p_el.select("foreignObject").remove();
                            }
                            
                        });
            allow_keystrokes("edit_text_input") //need to allow_keystrokes here

      };    
   
    
function make_slider(this_one,d,field,metab_name,metab_frag_name,graph_type) {
        if(graph_type=="CG_graph" && field=="x_axis_label"){
        var p = this_one.parentNode.parentNode;
        }else{
        var p = this_one.parentNode;
        }
    
    //make_editable(this,d,metab_name,metab_frag_name,"MID")
    
        // inject a HTML form to edit the content here...

        // bug in the getBBox logic here, but don't know what I've done wrong here;
        // anyhow, the coordinates are completely off & wrong. :-((
        var xy = this_one.getBBox();
        var p_xy = p.getBBox();

        xy.x -= p_xy.x;
        xy.y -= p_xy.y;

        var el = d3.select(this_one);
        var p_el = d3.select(p);

        var frm = p_el.append("foreignObject");
        //var field="title"

        var inp = frm
            //.attr("x", xy.x)
            //.attr("y", xy.y)
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", 500)
            .attr("height", 70)
            .append("xhtml:form")
                    .append("input")
                        .attr("id","myRange")
                        .attr("type", "range")
                        .attr("min", 1)
                        .attr("max", 100)
                        .attr("value", 50)
      };        
 

function writeDownloadLink_svg(svg,title){ //downloads svg to user
    try {
        var isFileSaverSupported = !!new Blob();
    } catch (e) {
        alert("blob not supported");
    }
    
    svg2=svg._groups[0][0].cloneNode(true) //clones the svg object (done because 'click_box' will be removed from downloaded svg to avoid issues with Adobe Illustrator)
    click_box_var=svg2.getElementsByClassName('click_box')[0] //stores the transparent clickable rectangle click_box as click_box_var
    svg2.getElementsByTagName('rect')["click_box"].parentNode.removeChild(click_box_var) //deletes click_box_var from svg2
    context_button_var=svg2.getElementsByClassName('context_button')[0] //stores the triangle context_button as context_button_var
    svg2.getElementsByTagName('text')["context_button"].parentNode.removeChild(context_button_var) //deletes context_button_var from svg2
    
    var html = svg2 //obtain the innerHTML (string) of the graph svg //stores innerHTML of svg2 as html
        .innerHTML;
    
    delete svg2 //delete svg2 from memory
    
    html1=''
    //below obtains the dimensions of the graph svg    
    left_bb=svg.node().getBBox().x
    top_bb=svg.node().getBBox().y
    height_bb=svg.node().getBBox().height
    width_bb=svg.node().getBBox().width  
    viewbox_str=left_bb.toString()+' '+top_bb.toString()+' '+width_bb.toString()+' '+height_bb.toString()
    html1='<svg title="'+title+'" viewBox="'+viewbox_str+'" style="overflow:visible" version="1.1" xmlns="http://www.w3.org/2000/svg">'+html+'</svg>' //encase the <g> element svg in <svg> tags    
    
    var blob = new Blob([html1], {type: "image/svg+xml"});
    saveAs(blob, title+".svg"); //generate svg grom html1 string blob    
};     
    
function writeDownloadLink_png(svg,title){ //converts svg to png and downloads to user
    
    /*var html = svg //obtain the innerHTML (string) of the graph svg
        .attr("title", "test2")
        .attr("version", 1.1)
        
        .attr("xmlns", "http://www.w3.org/2000/svg")
        .node().innerHTML;*/
    
    svg2=svg._groups[0][0].cloneNode(true) //clones the svg object (done because 'click_box' will be removed from downloaded svg to avoid issues with Adobe Illustrator)
    click_box_var=svg2.getElementsByClassName('click_box')[0] //stores the transparent clickable rectangle click_box as click_box_var
    svg2.getElementsByTagName('rect')["click_box"].parentNode.removeChild(click_box_var) //deletes click_box_var from svg2
    context_button_var=svg2.getElementsByClassName('context_button')[0] //stores the triangle context_button as context_button_var
    svg2.getElementsByTagName('text')["context_button"].parentNode.removeChild(context_button_var) //deletes context_button_var from svg2
    
    var html = svg2 //obtain the innerHTML (string) of the graph svg //stores innerHTML of svg2 as html
        .innerHTML;
    
    var parser = new DOMParser();
    //below obtains the dimensions of the graph svg
    left_bb=svg.node().getBBox().x
    top_bb=svg.node().getBBox().y
    height_bb=svg.node().getBBox().height
    width_bb=svg.node().getBBox().width    
    
    html2='<svg title="'+title+'" version="1.1" xmlns="http://www.w3.org/2000/svg">'+html+'</svg>' //encase the <g> element svg in <svg> tags    
    var doc1 = parser.parseFromString(html2, "image/svg+xml"); //converts the string html2 into an svg
    
    //generate PNG of SVG graph with highest image quality (encoderOptions=1), larger scale (scale:2) and svg dimensions (top,left, height, width [necessary due to elements of svg occuring at negative indices])
    saveSvgAsPng(doc1.firstChild, title+".png",{top:top_bb, left:left_bb, height: height_bb, width: width_bb, encoderOptions: 1, scale: 2}); 

};    
    
function reprint_specific_graph(metab_name,metab_frag_name,graph_type,svg){ //reprints only the selected graph svg
            svg.selectAll("#"+metab_frag_name+'_'+graph_type).remove() //removes the selected svg     
            loc_var={"x_loc":Graph_Location[metab_name][metab_frag_name][graph_type].x,
                     "y_loc":Graph_Location[metab_name][metab_frag_name][graph_type].y}
            
            if(graph_type=="MID"){
                makegraph_MID(metab_frag_name,loc_var,ConditionAmount,metab_name,MIDs,ConditionNames,svg)
            }else if(graph_type=="abundance"){
                makegraph_abundance(metab_frag_name,loc_var,ConditionAmount,metab_name,MIDs,ConditionNames,svg)
                
            }else if(graph_type=="stacked_abundance"){
                makegraph_stacked_abundance(metab_frag_name,loc_var,ConditionAmount,metab_name,MIDs,ConditionNames,svg)
                
            }else if(graph_type=="total_abundance"){
                makegraph_total_abundance(metab_frag_name,loc_var,ConditionAmount,metab_name,MIDs,ConditionNames,svg)

            }else if(graph_type=="stacked_MID"){
                makegraph_stacked_MID(metab_frag_name,loc_var,ConditionAmount,metab_name,MIDs,ConditionNames,svg)

            }else if(graph_type=="MPE"){
                makegraph_MPE(metab_frag_name,loc_var,ConditionAmount,metab_name,MIDs,ConditionNames,svg)
                
            }else if(graph_type=="Kin_abundance"){
                //selected_Iso_MID=obtain_isotopologue_data(metab_name,metab_frag_name,0)
                makegraph_timecourse(metab_frag_name,loc_var,ConditionAmount,metab_name,MIDs,ConditionNames,svg,"total_abundance")                     
                
            }else if(graph_type=="Kin_MPE"){
                makegraph_timecourse(metab_frag_name,loc_var,ConditionAmount,metab_name,MIDs,ConditionNames,svg,"MPE")                     
            
            }else if(graph_type=="CG_graph"){
                //makegraph_timecourse(metab_frag_name,loc_var,ConditionAmount,metab_name,MIDs,ConditionNames,svg,"MPE")  
                makegraph_CustomGraph(loc_var,svg,metab_frag_name);
                
                
            }else{ //for kinetic and isotopologue specific graphs see below...
            
                graph_type_spl=graph_type.split("_")
            
                if(graph_type_spl[0]=="MID"){
                    isotopologue=graph_type_spl[1].split("M")
                    M_index=Number(isotopologue[1])
                    selected_Iso_MID=obtain_isotopologue_data(metab_name,metab_frag_name,M_index)
                    makegraph_MID(metab_frag_name,loc_var,ConditionAmount,metab_name,selected_Iso_MID,ConditionNames,svg,"select_iso")  //reprints new MIDs
                    
                    
                }else if(graph_type_spl[0]=="Kin" && graph_type_spl[1]=="MID"){
                    isotopologue=graph_type_spl[2].split("M")
                    M_index=Number(isotopologue[1])                    
                    selected_Iso_MID=obtain_isotopologue_data(metab_name,metab_frag_name,M_index)
                    makegraph_timecourse(metab_frag_name,loc_var,ConditionAmount,metab_name,selected_Iso_MID,ConditionNames,svg,"MID_select_iso")                     
                
                }else if(graph_type_spl[0]=="abundance"){
                    isotopologue=graph_type_spl[1].split("M")
                    M_index=Number(isotopologue[1])
                    selected_Iso_abundance=obtain_isotopologue_data(metab_name,metab_frag_name,M_index)
                    makegraph_abundance(metab_frag_name,loc_var,ConditionAmount,metab_name,selected_Iso_abundance,ConditionNames,svg,"select_iso")  //reprints new MIDs
                    
                    
                }else if(graph_type_spl[0]=="Kin" && graph_type_spl[1]=="abundance"){
                    isotopologue=graph_type_spl[2].split("M")
                    M_index=Number(isotopologue[1])                    
                    selected_Iso_abundance=obtain_isotopologue_data(metab_name,metab_frag_name,M_index)
                    makegraph_timecourse(metab_frag_name,loc_var,ConditionAmount,metab_name,selected_Iso_abundance,ConditionNames,svg,"abundance_select_iso")                     
                    
                }                
            }
    
    
}    
    
//AK: the functions dragstarted(),dragged(), and dragended() all allow for objects to be clicked and dragged around the page
function dragstarted(d) {
    //alert('dragstarted')
  d3.select(this).raise().classed("active", true);
}

function dragged(d) {
//function [d.x,d.y]=dragged(d) {
            d.x += d3.event.dx
            d.y += d3.event.dy
            d3.select(this).attr("transform", function(d,i){
                return "translate(" + [ d.x,d.y ] + ")"
                //return "translate(" +  d.x + "," + d.y  + ")"
            })
}

function dragended(d) {
  d3.select(this).classed("active", false);
}   

//} //End begin_graph_display     


/////////////rounding function
function roundTo(num,digits){
 n = num;
if(n<1 && n>0){    
     r = n.toFixed(digits-1-Math.floor(Math.log(n)/Math.log(10)));    
       return Number(r)
    }else if(n<0){
        r=0
       return Number(r)
    }else if(n>=100){
        r= math.round(n)
       return Number(r)
    }else{
        r= math.round(n,digits)
       return Number(r)
    }
}       
/////////////       
       
////////////// Start allow keystrokes    
function allow_keystrokes(textinputDOM){
            $("#"+textinputDOM).keydown(function (e) { //function which allows user to type in 1 and 0 in TimePoint_Table
            switch(e.which){
                     case 8: e.stopPropagation();return true; //keycode for "backspace"
                     case 13: e.stopPropagation();return true; //keycode for "enter"
                     case 37: e.stopPropagation();return true; //keycode for "0"
                     case 38: e.stopPropagation();return true; //keycode for "left arrow"
                     case 39: e.stopPropagation();return true; //keycode for "right arrow"
                     case 40: e.stopPropagation();return true; //keycode for "up arrow"
                     case 48: e.stopPropagation();return true; //keycode for "down arrow"
                     case 49: e.stopPropagation();return true; //keycode for "1"            
                     case 70: e.stopPropagation();return true; //keycode for "f"
                     case 71: e.stopPropagation();return true; //keycode for "g"
                     case 80: e.stopPropagation();return true; //keycode for "p"
                     case 82: e.stopPropagation();return true; //keycode for "r"
                     case 90: e.stopPropagation();return true; //keycode for "z"
                     case 86: e.stopPropagation();return true; //keycode for "v"
                     case 66: e.stopPropagation();return true; //keycode for "b"
                     case 78: e.stopPropagation();return true; //keycode for "n"
                     case 84: e.stopPropagation();return true; //keycode for "t"
                     case 67: e.stopPropagation();return true; //keycode for "c"
                     case 187: e.stopPropagation();return true; //keycode for "="
                     case 188: e.stopPropagation();return true; //keycode for ","
                     case 189: e.stopPropagation();return true;} //keycode for "-"               
            });
    
}      
/////////////// END allow keystrokes        

    

function setInputFilter(textbox, inputFilter) {
    //function to restrict inputs in text inputs
    /* inputFilters
        Integer values (both positive and negative):
        /^-?\d*$/.test(value)
        Integer values (positive only):
        /^\d*$/.test(value)
        Integer values (positive and up to a particular limit):
        /^\d*$/.test(value) && (value === "" || parseInt(value) <= 500)
        Floating point values (allowing both . and , as decimal separator):
        /^-?\d*[.,]?\d*$/.test(value)
        Currency values (i.e. at most two decimal places):
        /^-?\d*[.,]?\d{0,2}$/.test(value)
        Hexadecimal values:
        /^[0-9a-f]*$/i.test(value)    
    */    
    
  ["input", "keydown", "keyup", "mousedown", "mouseup", "select", "contextmenu", "drop"].forEach(function(event) {
    textbox.addEventListener(event, function() {
      if (inputFilter(this.value)) {
        this.oldValue = this.value;
        this.oldSelectionStart = this.selectionStart;
        this.oldSelectionEnd = this.selectionEnd;
      } else if (this.hasOwnProperty("oldValue")) {
        this.value = this.oldValue;
        this.setSelectionRange(this.oldSelectionStart, this.oldSelectionEnd);
      }
    });
  });
}    
    
    
    
    
    
function space_replace(str){
     rep_sp= str.replace(" ", "%20");
}
function replace_space(str){
     rep_sp= str.replace("%20", " ");
}    
       
}

        
      
function returnFileMIDs(FileMIDs,rawFileCounts,Fragment_Formulas){
    //ISSUE: CURRENTLY NEED ISOTOPOLOGUES BEYOND THE NUMBER OF CARBONS (VISUALIZED) INORDER TO OBTAIN CORRECT MSCORRECT
    var File_Number=Object.keys(rawFileCounts).length

    Generate_FileMIDs_Shell()
    function Generate_FileMIDs_Shell(){ //generates a shell object of FileMIDs
        for(n=1;n<=File_Number;n++){
            FileMIDs["File"+n.toString()]={}
            for(metab in rawFileCounts.rawFile1){
                    FileMIDs["File"+n.toString()][metab]={}
                    for(frag in rawFileCounts.rawFile1[metab]){
                        FileMIDs["File"+n.toString()][metab][frag]={}
                        FileMIDs["File"+n.toString()][metab][frag].abundance=0
                        FileMIDs["File"+n.toString()][metab][frag].labeling=[]
                        for(j=0; j<rawFileCounts.rawFile1[metab][frag].uncorrected_counts.length;j++){
                            FileMIDs["File"+n.toString()][metab][frag].labeling[j]={"fragment": "M"+(j).toString(),"frequency": 0}
                        }
                    }
            }
        }
    }

    var dbquery={
        "H":{"mass": [1.007825,2.014102], "natural_abundance": [.999844,.000156], "atomic_number": 1},
        "He":{"mass": [1.007825,2.014102], "natural_abundance": [.00000137,.99999863], "atomic_number": 2},
        "Li":{"mass": [6.015122,7.016004], "natural_abundance": [.0759 ,.9241], "atomic_number": 3},
        "Be":{"mass": [9.012182], "natural_abundance": [1], "atomic_number": 4},
        "B":{"mass": [10.012937,11.009305], "natural_abundance": [.199,.801 ], "atomic_number": 5},
        "C":{"mass": [12,13.003355], "natural_abundance": [.989184,.010816], "atomic_number": 6},
        "N":{"mass": [14.003074,15.000109], "natural_abundance": [.996337,.003663], "atomic_number": 7},
        "O":{"mass": [15.994915,16.999132,17.999160], "natural_abundance":[.99758,.00038,.00204], "atomic_number": 8},
        "F":{"mass": [18.998403], "natural_abundance": [1.00], "atomic_number": 9},
        "Ne":{"mass": [19.992440,20.993847,21.991386], "natural_abundance": [.9048,.0027,.0925], "atomic_number": 10},
        "Na":{"mass": [22.989770], "natural_abundance": [1.00], "atomic_number": 11},
        "Mg":{"mass": [23.985042,24.985837,25.982593], "natural_abundance": [.7899,.1000,.1101], "atomic_number": 12},
        "Al":{"mass": [26.981538], "natural_abundance": [1.00], "atomic_number": 13},
        "Si":{"mass": [27.976927,28.976495,29.973770], "natural_abundance": [.9222,.0469,.0309], "atomic_number": 14},
        "P":{"mass": [30.973762], "natural_abundance": [1.00], "atomic_number": 15},
        "S":{"mass": [31.972071,32.971458,33.967867,34.967867,35.967081], "natural_abundance": [.95039,.00749,.04197,0,.00015], "atomic_number": 16},
        "Cl":{"mass": [34.968853,35.9,36.965903], "natural_abundance": [.7578,0,.2422], "atomic_number": 17},
        "Ar":{"mass": [35.967546,37.962732,39.962383], "natural_abundance": [.003365,.000632,.996003], "atomic_number": 18},
        "K":{"mass":[38.963707,39.963999,40.961826],"natural_abundance": [0.932581, 0.000117, 0.067302],"atomic_number": 19},
        "Ca":{"mass":[39.962591,40.962591,41.958618,42.958767,43.955481,44.955481,45.953693,46.953693,47.952534],"natural_abundance":[0.96941,0,0.00647,0.00135,0.02086,0,0.00004,0,0.00187],"atomic_number":20},
        "Sc":{"mass":[44.95591],"natural_abundance":[1],"atomic_number":21},
        "Ti":{"mass":[45.952629,46.951764,47.947947,48.947871,49.944792],"natural_abundance":[0.0825,0.07440000000000001,0.7372,0.0541,0.0518],"atomic_number":22},
        "V":{"mass":[49.947163,50.943964],"natural_abundance":[0.0025,0.9975],"atomic_number":23},
        "Cr":{"mass":[49.94605,50.94605,51.940512,52.940654,53.938885],"natural_abundance":[0.043449999999999996,0,0.83789,0.09501,0.02365],"atomic_number":24},
        "Mn":{"mass":[54.93805],"natural_abundance":[1],"atomic_number":25},
        "Fe":{"mass":[53.939615,54.939615,55.934942,56.935399,57.93328],"natural_abundance":[0.058449999999999995,0,0.91754,0.02119,0.0028199999999999996],"atomic_number":26},
        "Co":{"mass":[58.9332],"natural_abundance":[1],"atomic_number":27},
        "Ni":{"mass":[57.935348,58.935348,59.930791,60.93106,61.928349,62.928349,63.92797],"natural_abundance":[0.680769,0,0.262231,0.011399,0.036345,0,0.009256],"atomic_number":28},
        "Cu":{"mass":[62.929601,63.929601,64.927794],"natural_abundance":[0.6917,0,0.30829999999999996],"atomic_number":29},
        "Zn":{"mass":[63.929147,64.929147,65.926037,66.927131,67.924848,68.924848,69.925325],"natural_abundance":[0.4863,0,0.27899999999999997,0.040999999999999995,0.1875,0,0.0062],"atomic_number":30},
        "Ga":{"mass":[68.925581,70.924705],"natural_abundance":[0.60108,0.39892000000000005],"atomic_number":31},
        "Ge":{"mass":[69.92425,70.92425,71.922076,72.923459,73.921178,74.921178,75.921403],"natural_abundance":[0.2084,0,0.2754,0.07730000000000001,0.3628,0,0.0761],"atomic_number":32},
        "As":{"mass":[74.921596],"natural_abundance":[1],"atomic_number":33},"Se":{"mass":[73.922477,74.922477,75.919214,76.919915,77.91731,78.91731,79.916522,80.916522,81.9167],"natural_abundance":[0.0089,0,0.09369999999999999,0.07629999999999999,0.2377,0,0.4961,0,0.0873],"atomic_number":34},
        "Br":{"mass":[78.918338,79.918338,80.916291],"natural_abundance":[0.5069,0,0.49310000000000004],"atomic_number":35},
        "Kr":{"mass":[77.920386,78.920386,79.916378,80.916378,81.913485,82.914136,83.911507,84.911507,85.91061],"natural_abundance":[0.0034999999999999996,0,0.022799999999999997,0,0.1158,0.1149,0.57,0,0.17300000000000001],"atomic_number":36},
        "Rb":{"mass":[84.911789,85.911789,86.909183],"natural_abundance":[0.7217,0,0.2783],"atomic_number":37},
        "Sr":{"mass":[83.913425,84.913425,85.909262,86.908879,87.905614],"natural_abundance":[0.005600000000000001,0,0.0986,0.07,0.8258],"atomic_number":38},
        "Y":{"mass":[88.905848],"natural_abundance":[1],"atomic_number":39},
        "Zr":{"mass":[89.904704,90.905645,91.90504,92.90504,93.906316,94.906316,95.908276],"natural_abundance":[0.5145000000000001,0.11220000000000001,0.17149999999999999,0,0.17379999999999998,0,0.027999999999999997],"atomic_number":40},
        "Nb":{"mass":[92.906378],"natural_abundance":[1],"atomic_number":41},
        "Mo":{"mass":[91.90681,92.90681,93.905088,94.905841,95.904679,96.906021,97.905408,98.905408,99.907477],"natural_abundance":[0.1484,0,0.0925,0.1592,0.1668,0.0955,0.2413,0,0.09630000000000001],"atomic_number":42},
        "Ru":{"mass":[95.907598,97.905287,98.905939,99.90422,100.905582,101.90435,102.90435,103.90543],"natural_abundance":[0.0554,0.0187,0.1276,0.126,0.17059999999999997,0.3155,0,0.1862],"atomic_number":44},
        "Rh":{"mass":[102.905504],"natural_abundance":[1],"atomic_number":45},
        "Pd":{"mass":[101.905608,102.905608,103.904035,104.905084,105.903483,106.903483,107.903894,108.903894,109.905152],"natural_abundance":[0.0102,0,0.1114,0.22329999999999997,0.2733,0,0.2646,0,0.11720000000000001],"atomic_number":46},
        "Ag":{"mass":[106.905093,107.905093,108.904756],"natural_abundance":[0.51839,0,0.48161000000000004],"atomic_number":47},
        "Cd":{"mass":[105.906458,106.906458,107.904183,108.904183,109.903006,110.904182,111.902757,112.904401,113.903358,115.904755,116.904755,117.904755,118.904755],"natural_abundance":[0.0125,0,0.0089,0,0.1249,0.128,0.2413,0.1222,0.2873,0.07490000000000001,0,0,0],"atomic_number":48},
        "In":{"mass":[112.904061,113.904061,114.903878],"natural_abundance":[0.0429,0,0.9571],"atomic_number":49},
        "Sn":{"mass":[111.904821,112.904821,113.902782,114.903346,115.901744,116.902954,117.901606,118.903309,119.902197,120.902197,121.90344,122.90344,123.905275],"natural_abundance":[0.0097,0,0.0066,0.0034000000000000002,0.1454,0.0768,0.2422,0.0859,0.3258,0,0.0463,0,0.0579],"atomic_number":50},
        "Sb":{"mass":[120.903818,121.903818,122.904216],"natural_abundance":[0.5721,0,0.4279],"atomic_number":51},
        "Te":{"mass":[119.90402,120.90402,121.903047,122.904273,123.902819,124.904425,125.903306,126.903306,127.904461,128.904461,129.906223],"natural_abundance":[0.0009,0,0.0255,0.0089,0.047400000000000005,0.0707,0.1884,0,0.31739999999999996,0,0.3408],"atomic_number":52},
        "I":{"mass":[126.904468],"natural_abundance":[1],"atomic_number":53},
        "Xe":{"mass":[123.905896,124.905896,125.904269,126.904269,127.90353,128.904779,129.903508,130.905082,131.904154,132.904154,133.905395,134.905395,135.90722],"natural_abundance":[0.0009,0,0.0009,0,0.0192,0.2644,0.0408,0.2118,0.26890000000000003,0,0.10439999999999999,0,0.08869999999999999],"atomic_number":54},
        "Cs":{"mass":[132.905447],"natural_abundance":[1],"atomic_number":55},
        "Ba":{"mass":[129.90631,130.90631,131.905056,132.905056,133.904503,134.905683,135.90457,136.905821,137.905241],"natural_abundance":[0.00106,0,0.00101,0,0.024169999999999997,0.06591999999999999,0.07854,0.11231999999999999,0.71698],"atomic_number":56},
        "La":{"mass":[137.907107,138.906348],"natural_abundance":[0.0009,0.9991],"atomic_number":57},
        "Ce":{"mass":[135.907144,136.907144,137.905986,138.905986,139.905434,140.905434,141.90924],"natural_abundance":[0.00185,0,0.00251,0,0.8845000000000001,0,0.11114],"atomic_number":58},
        "Pr":{"mass":[140.907648],"natural_abundance":[1],"atomic_number":59},
        "Nd":{"mass":[141.907719,142.90981,143.910083,144.912569,145.913112,146.913112,147.916889,148.916889,149.920887],"natural_abundance":[0.272,0.122,0.23800000000000002,0.083,0.172,0,0.057,0,0.055999999999999994],"atomic_number":60},"Sm":{"mass":[143.911995,144.911995,145.911995,146.914893,147.914818,148.91718,149.917271,150.917271,151.919728,152.919728,153.922205],"natural_abundance":[0.030699999999999998,0,0,0.1499,0.1124,0.1382,0.0738,0,0.2675,0,0.2275],"atomic_number":62},
        "Eu":{"mass":[150.919846,151.919846,152.921226],"natural_abundance":[0.4781,0,0.5219],"atomic_number":63},
        "Gd":{"mass":[151.919788,152.919788,153.920862,154.922619,155.92212,156.923957,157.924101,158.924101,159.927051],"natural_abundance":[0.002,0,0.0218,0.14800000000000002,0.2047,0.1565,0.2484,0,0.2186],"atomic_number":64},
        "Tb":{"mass":[158.925343],"natural_abundance":[1],"atomic_number":65},
        "Dy":{"mass":[155.924278,156.924278,157.924405,158.924405,159.925194,160.92693,161.926795,162.928728,163.929171],"natural_abundance":[0.0006,0,0.001,0,0.023399999999999997,0.1891,0.2551,0.249,0.2818],"atomic_number":66},
        "Ho":{"mass":[164.930319],"natural_abundance":[1],"atomic_number":67},
        "Er":{"mass":[161.928775,162.928775,163.929197,164.929197,165.93029,166.932045,167.932368,168.932368,169.93546],"natural_abundance":[0.0014000000000000002,0,0.0161,0,0.3361,0.2293,0.26780000000000004,0,0.1493],"atomic_number":68},
        "Tm":{"mass":[168.934211],"natural_abundance":[1],"atomic_number":69},
        "Yb":{"mass":[167.933894,168.933894,169.934759,170.936322,171.936378,172.938207,173.938858,174.938858,175.942568],"natural_abundance":[0.0013,0,0.0304,0.14279999999999998,0.2183,0.1613,0.31829999999999997,0,0.1276],"atomic_number":70},
        "Lu":{"mass":[174.940768,175.942682],"natural_abundance":[0.9741,0.0259],"atomic_number":71},
        "Hf":{"mass":[173.94004,174.94004,175.941402,176.94322,177.943698,178.945815,179.946549],"natural_abundance":[0.0016,0,0.0526,0.18600000000000003,0.2728,0.1362,0.3508],"atomic_number":72},
        "Ta":{"mass":[179.947466,180.947996],"natural_abundance":[0.00012,0.99988],"atomic_number":73},
        "W":{"mass":[179.946706,180.946706,181.948206,182.950224,183.950933,184.950933,185.954362],"natural_abundance":[0.0012,0,0.265,0.1431,0.3064,0,0.2843],"atomic_number":74},
        "Re":{"mass":[184.952956,185.952956,186.955751],"natural_abundance":[0.374,0,0.626],"atomic_number":75},
        "Os":{"mass":[183.952491,184.952491,185.953838,186.955748,187.955836,188.958145,189.958445,190.958445,191.961479],"natural_abundance":[0.0002,0,0.0159,0.0196,0.1324,0.16149999999999998,0.2626,0,0.4078],"atomic_number":76},
        "Ir":{"mass":[190.960591,191.960591,192.962924],"natural_abundance":[0.373,0,0.627],"atomic_number":77},
        "Pt":{"mass":[189.95993,190.95993,191.961035,192.961035,193.962664,194.964774,195.964935,196.964935,197.967876],"natural_abundance":[0.00014000000000000001,0,0.00782,0,0.32966999999999996,0.33832,0.25242000000000003,0,0.07163],"atomic_number":78},
        "Au":{"mass":[196.966552],"natural_abundance":[1],"atomic_number":79},
        "Hg":{"mass":[195.965815,196.965815,197.966752,198.968262,199.968309,200.970285,201.970626,202.970626,203.973476],"natural_abundance":[0.0015,0,0.09970000000000001,0.16870000000000002,0.231,0.1318,0.2986,0,0.0687],"atomic_number":80},
        "Tl":{"mass":[202.972329,203.972329,204.974412],"natural_abundance":[0.29524,0,0.7047599999999999],"atomic_number":81},
        "Pb":{"mass":[203.973029,204.973029,205.974449,206.975881,207.976636],"natural_abundance":[0.013999999999999999,0,0.24100000000000002,0.221,0.524],"atomic_number":82},
        "Bi":{"mass":[208.980383],"natural_abundance":[1],"atomic_number":83},
        "Th":{"mass":[232.03805],"natural_abundance":[1],"atomic_number":90},
        "Pa":{"mass":[231.035879],"natural_abundance":[1],"atomic_number":91},
        "U":{"mass":[234.040946,235.043923,236.043923,237.043923,238.050783],"natural_abundance":[0.000054999999999999995,0.0072,0,0,0.992745],"atomic_number":92}
        
    }

    var Parsed_Fragment_Formulas={}

    for(frag_string in Fragment_Formulas){ //Goes through the fragments in Fragment_Formula and parses them. Returns  the varible Parsed_Fragment_Formulas, an object that hold the number of each element in each fragment
        Parsed_Fragment_Formulas[frag_string]=[]    
        parsed_compound=compound_parser(Fragment_Formulas[frag_string]) //generates the parsed_compound formula
        Parsed_Fragment_Formulas[frag_string]=parsed_compound //insertes the parsed_compound into the object Parsed_Fragment_Formulas
    }

    console.log(Fragment_Formulas)
    console.log(Parsed_Fragment_Formulas)

    FileMIDs=generate_FileMID()
    console.log(FileMIDs)
    return FileMIDs
    console.log(FileMIDs)

    function compound_parser(compound_str){    
        compound_array=[]
        
        for(i=0;i<compound_str.length;i++){ //this loop goes through the string compound_str and separates the individual elements producing compound_array
            stringbuild="" //stringbuild is used to hold element names or element numbers that have length > 1
            continueloop=true
            if(compound_str[i].split(/[A-Z]/g).length>1){ //checks if string is uppercase letter
                //console.log(compound_str[i]+" is a capitol letter")
                stringbuild=compound_str[i]

                if(i==compound_str.length-1){ //breaks out if on last index i of compound_str
                    compound_array.push(stringbuild)
                    break
                }


                if(compound_str[i+1].split(/[A-Z]/g).length>1 || compound_str[i+1].split(/[0-9]/g).length>1 ){ //checks if the next letter is uppercase, if so add the current letter to compound_array and move on 
                    compound_array.push(compound_str[i])
                }

                if(compound_str[i+1].split(/[a-z]/g).length>1){ //checks if the next letter is lowercase, if so add the upper and lowercase letters together, insert into compound_array and move on (past the lowercase letter by shifting i by 1)
                    stringbuild=stringbuild+compound_str[i+1]
                    compound_array.push(stringbuild)
                    stringbuild=""
                    i=i+1
                }

            }//end checking if string is uppercase letter

            if(compound_str[i].split(/[a-z]/g).length>1){ //checks if string is lowercase letter
                //console.log(compound_str[i]+" is a lowercase letter")    
            }//end checking if string is lowercase letter

            if(compound_str[i].split(/[0-9]/g).length>1){ //checks if string is number
                //console.log(compound_str[i]+" is a number")
                stringbuild=compound_str[i]

                if(i==compound_str.length-1){ //breaks out if on last index i of compound_str
                    compound_array.push(stringbuild)
                    break
                }            

                if(compound_str[i+1].split(/[A-Z]/g).length>1){ //checks if the next string index is uppercase letter, if so add the current number to compound_array and move on
                    compound_array.push(compound_str[i])

                }
                if(compound_str[i+1].split(/[0-9]/g).length>1){ //checks if the next string index is also a number, adds the set of digits to compound_array, shifts i till it is beyond a streak of numbers and moves on
                    while(continueloop==true){ //continues adding consecutive numbers to stringbuild until a nondigit is reached when continueloop=false
                        if(i==compound_str.length-1){ //breaks out if on last index i of compound_str
                            compound_array.push(stringbuild)
                            break
                        }                       

                        if(compound_str[i+1].split(/[0-9]/g).length>1){ //checks if the next index of compound_str is also a number, if so adds it to stringbuild, if not insert stringbuild to compound_array and end the loop
                            stringbuild=stringbuild+compound_str[i+1]
                            i=i+1
                        }else{
                            compound_array.push(stringbuild)
                            stringbuild=""
                            continueloop=false

                        } 
                    }
                }

            }
        }


        if(compound_array[compound_array.length-1].split(/[a-zA-Z]/g).length>1){ //adds 1 to end of compound_array if compound_array ends with an element letter
            compound_array.push("1")
        }    

        el_name=[]
        el_count=[]

        for(i=0;i<compound_array.length-1;i++){ //this for loop runs through compound_array and generates two new arrays, el_name (containing element names) and el_count (element counts)
            if(compound_array[i].split(/[a-zA-Z]/g).length>1){ //checks if string is uppercase/lower letter
            el_name.push(compound_array[i])
                if(compound_array[i+1].split(/[0-9]/g).length>1){ //checks if string is numbers
                    el_count.push(parseFloat(compound_array[i+1]))
                    i=i+1                        
                }else{//if an entry of compound_array is not followed by a number then it is assumed that the user put el_names next to eachother and thus the el_name is said to have a number of 1
                    el_count.push(1) //adds a value of 1 to el_count
                }     
            }
        }

        element_obj={}

        for(i=0;i<el_name.length;i++){   //compiles all el_name and el_counts into the object element_obj, compiles repeating el_names into single key and compounds their values into a single value   
            if(element_obj[el_name[i]] ==  undefined){ //if the element name el_name[i] is not currently a key in element_obj it is created
                element_obj[el_name[i]]=el_count[i]
            }else{
                element_obj[el_name[i]]=element_obj[el_name[i]]+el_count[i] //if the element name el_name[i] is already a keyof element_obj the corresponding element count el_count[i] is added to the existing element_obj key's value
            }
        }

        ///make function to extract object keys (el_name) and values (el_name_num) into arrays

        return element_obj    

    }

    //GENERAL WARNING: NEED TO ROUND OFF CALCULATED VALUES, CURRENTLY DOUBLES ARE DISPLAYING THROUGH 10+ DIGITS BEYOND DECIMAL, LIMIT TO ~6 DIGITS BEYOND DECIMAL   

    function generate_FileMID(){
        //var element=["C","H","N","O","Si"]
        var element=[]
        var element_num=[]
        //c_measured=[]
   

        for(n=1;n<=File_Number;n++){
            for(metab in rawFileCounts["rawFile"+n.toString()]){
                for(frag in rawFileCounts["rawFile"+n.toString()][metab]){
                    element=[]
                    element_num=[]
                    uncorrected_frequencies=[]
                    uncorrected_count_array=[]
                    total_abundance=0;                     
                    for(element_name in Parsed_Fragment_Formulas[frag]){ //this loop extracts the element and element_num from Parsed_Fragment_Formulas
                        element.push(element_name)
                        element_num.push(Parsed_Fragment_Formulas[frag][element_name])
                    }
 
                    for(j=0; j<rawFileCounts["rawFile"+n.toString()][metab][frag].uncorrected_counts.length;j++){ //loops through the uncorrected_counts of frag, and collects the values in uncorrected_count_array
                        uncorrected_count_array[j]=rawFileCounts["rawFile"+n.toString()][metab][frag].uncorrected_counts[j].counts  //19-10-11 MAY BE ERROR, IF CORRECTED FREQUENCIES AMOUNT OF ISOTOPOLOGUE IS LIMITED TO THE NUMBER OF CARBONS, TOTAL ABUNDANCE ALSO NEEDS TO BE
                        }
                    total_abundance=math.sum(uncorrected_count_array)  //sums the values in uncorrected_count_array  
                    uncorrected_frequencies = uncorrected_count_array.map(function(x) { return x/total_abundance; }); //generates uncorrected_frequencies by dividing each element of uncorrected_count_array by total_abundance     

                   // element_num=Fragment_Formulas[frag] //redifines element_num as the array for the specific fragment
                    corrected_frequencies=mscorrect(element,element_num,uncorrected_frequencies) //corrects uncorrected_frequencies

                    FileMIDs["File"+n.toString()][metab][frag].abundance=total_abundance //throws total abundance value into FileMIDs


                    for(j=0; j<FileMIDs["File"+n.toString()][metab][frag].labeling.length;j++){ //throws corrected frequencies into FileMIDs       
                        //FileMIDs["File"+n.toString()][metab][frag].labeling[j].frequency=corrected_frequencies.subset(math.index(j)) 
                        FileMIDs["File"+n.toString()][metab][frag].labeling[j].frequency=corrected_frequencies[j] 
                        }
                    }
            }
        }  

        return FileMIDs

        function mscorrect(element,element_num,c_measured){   //takes in an an array containing the element names (element) corresponding element amounts (element_num) and measured MID (c_measured) and returns a corrected MID c_corrected
            ncarbons=element_num[0]
            l=math.min(ncarbons+1,c_measured.length)
            c_measured_length=c_measured.length
            c_measured=c_measured.slice(0, l);

            const M=math.zeros(l,l)    

            for(q=1;q<=l;q++){
                nat=msnatural(l-q+1)
                for(p=q;p<=l;p++){
                    M.subset(math.index(q-1,p-1), math.subset(nat, math.index(p-q)))
                }
                element_num[0]=element_num[0]-1 //only for carbon labeling currently
            }
 
            c_corrected=math.multiply(c_measured, math.inv(M))        // worrkkssss
            
            if(c_measured_length>c_corrected._data.length){
                for(q=0;q<c_measured_length-l;q++){
                    c_corrected._data.push(0)
                }
            }            
            
            return c_corrected._data    
        }

        function msnatural(l){
            x=math.zeros(l)
            x.subset(math.index(0),1)
            for(e=0;e<element.length;e++){
                c_nat=dbquery[element[e]].natural_abundance
                const A=math.zeros(l,l)    
                for(j=0;j<l;j++){
                    for(i=0;i<l;i++){
                        if(i>=j && i-j<c_nat.length){
                        A.subset(math.index(i,j),c_nat[i-j])
                        }
                    }
                }
                //console.log(A)
                x=math.multiply(math.pow(A,element_num[e]),x)
            }
            
            return x
        }

    }
    
}
    
   // load the map and embedded CSS
   //AK: This will be the first bit of javascript to be executed, despite being located near the end of the file. 
   //d3.json('RECON1.Glycolysis TCA compact final.json', function(e, data) { //access data in the map file (RECON1.Glycolysis TCA (Presentable 2).json)
   d3.json('RECON1.Glycolysis TCA Serine Lactate.json', function(e, data) { //access data in the map file (RECON1.Glycolysis TCA (Presentable 2).json)
       if (e) console.warn(e);
       /*var options = {
           menu: 'all',
           use_3d_transform: true,
           enable_editing: false,
           fill_screen: true,
           reaction_styles: ['abs', 'color', 'size', 'text'],
           identifiers_on_map: 'name',
           never_ask_before_quit: true,
           //make the primary metabolites larger to make room for structues
           primary_metabolite_radius: 20
       };*/
       var options = { menu: 'all', fill_screen: true, identifiers_on_map:'name' };

       // make a Builder
       var builder = escher.Builder(data, null, null, d3.select('#map_container'), options); //AK: Heavy lifting line which calls upon escher.Builder to generate the escher UI with custom options specified by the var options

        d3.select("#enter_data").on("click", function() {
            document.getElementById('PopUp_Upload_Data').style.display = "block";
        });       
       
       
        //Have user import a JSON file and then proceed to draw the graphs       

        document.getElementById('import').onclick = function() { //translates to "upon click of the button 'import' execute the function below
          

            
              var files = document.getElementById('selectFiles').files; //sets the var files equal to the user selected files
              if (files.length <= 0) { //check to ensure the user selected a file, if yes, then move on
                alert("No file selected for upload. Please select a JSON file to upload.") //warning
                return false;
              }
            
            
            var fileTypes = ['json'];  
            
            readJSONFile(files)
            function readJSONFile(files) {
                if (files && files[0]) {
                    var extension = files[0].name.split('.').pop().toLowerCase(),  //file extension from input file
                        isSuccess = fileTypes.indexOf(extension) > -1;  //is extension in acceptable types

                    if (isSuccess) { //yes
                      var user_file = new FileReader();
                      user_file.onload = function(e) { 
                                            var result = JSON.parse(e.target.result); //AK: this is the magic line, var result holds the data from the users file



                                            document.getElementById("PopUp_Upload_Data").style.display = "none";   
                                            document.getElementById("enter_data").style.display = "none";                     
                                            add_structures(result); //AK: calls the add_structures() function which runs AK generated content (graph generation and manipulation)
                                          }

                    user_file.readAsText(files.item(0)); //allows for the user_file to be read
                    }
                    else { //no
                       alert("Incorrect file type upload. Please upload a JSON file.") //warning
                    }
                }
            }        

         };  //closes import of MIDs document.getElementById('import').onclick
       

        document.getElementById('import_csv').onclick = function() { //translates to "upon click of the button 'import_csv' execute the function below
  
            document.getElementById("loading-background").style.display = "block";   
            document.getElementById("PopUp_Upload_Data").style.display = "none";   
            document.getElementById("enter_data").style.display = "none";  
            
            var files = document.getElementById('selectFiles_csv').files; //sets the var files equal to the user selected files
              if (files.length <= 0) { //check to ensure the user selected a file, if yes, then move on
                return false;
              }
            
            
            var fileTypes = ['csv'];  

            readUncorCSVFile(files)
            function readUncorCSVFile(files) {
                if (files && files[0]) {
                    var extension = files[0].name.split('.').pop().toLowerCase(),  //file extension from input file
                        isSuccess = fileTypes.indexOf(extension) > -1;  //is extension in acceptable types

                    if (isSuccess) { //yes
                          var user_file = new FileReader();
                          user_file.onload = function(e) {
                                var csv_data = e.target.result; //AK: this is the magic line, var result holds the data from the users file
                                var parsed_Data=d3.csvParse(csv_data);
                                var rawFileCounts= {}
                                var Fragment_Formulas={}
                                var FileMIDs={}
                                var ColumnisSuccess=false
                                
                                if(parsed_Data.columns[0]=="Metabolite" && parsed_Data.columns[1]=="Formula" && parsed_Data.columns[2]=="Fragment"){
                                    ColumnisSuccess=true;
                                }
                                //console.log(parsed_Data[0])
                                
                                ///CHECK COLUMN TITLES
                                if(ColumnisSuccess){
                                    file_number=parsed_Data.columns.length-3 //currently -3 due to presence of Metabolite, Formula, Fragment columns
                                    FileNames=[]
                                    for(i=3;i<parsed_Data.columns.length;i++){ //currently i=3 due to presence of Metabolite, Formula, Fragment columns
                                        FileNames.push(parsed_Data.columns[i])
                                    } 
                                    console.log(FileNames)

                                    metab=""
                                    frag=""
                                    j=-1
                                    iso=0
                                    //plan, make shell by going through the first file, then copy the shell x(file number) times, then fill it  
                                    for(i=0;i<parsed_Data.length;i++){ // this loo generates the shell
                                        if(parsed_Data[i].Metabolite!=""){
                                            metab=parsed_Data[i].Metabolite
                                            frag=parsed_Data[i].Fragment
                                            frag=frag.split('(M0)')[0] //removes (M0) from the fragment names                        
                                            Fragment_Formulas[frag]=parsed_Data[i].Formula
                                            for(k=0;k<FileNames.length;k++){
                                                if(typeof rawFileCounts["rawFile"+(k+1).toString()]== 'undefined'){
                                                    rawFileCounts["rawFile"+(k+1).toString()]={}
                                                }
                                                if(typeof rawFileCounts["rawFile"+(k+1).toString()][metab]== 'undefined'){
                                                    rawFileCounts["rawFile"+(k+1).toString()][metab]={}
                                                }
                                                rawFileCounts["rawFile"+(k+1).toString()][metab][frag]={}
                                                rawFileCounts["rawFile"+(k+1).toString()][metab][frag].uncorrected_counts=[]
                                            }   
                                        }
                                    }

                                    for(i=0;i<parsed_Data.length;i++){
                                        if(parsed_Data[i].Metabolite!=""){ //if currently at a row of the csv where there is a metabolite name entered, then enter the count as M0
                                            iso=0;
                                            metab=parsed_Data[i].Metabolite
                                            frag=parsed_Data[i].Fragment
                                            frag=frag.split('(M0)')[0] //removes (M0) from the fragment names                        
                                            Fragment_Formulas[frag]=parsed_Data[i].Formula
                                            for(k=0;k<FileNames.length;k++){
                                                rawFileCounts["rawFile"+(k+1).toString()][metab][frag].uncorrected_counts[0]={"fragment":"M0","counts":Number(parsed_Data[i][FileNames[k]])}
                                        }
                                        iso++                        
                                        }else{
                                            for(k=0;k<FileNames.length;k++){
                                                rawFileCounts["rawFile"+(k+1).toString()][metab][frag].uncorrected_counts[iso]={"fragment":"M"+iso.toString(),"counts":Number(parsed_Data[i][FileNames[k]])}
                                            }
                                        iso++    
                                       }
                                    }
                                    
                                    var FinalCheckisSuccess=true
                                            //var regex = /^[A-Za-z0-9 ]+$/
                                    var regex = /^[a-z0-9]+$/i //regex for onl alpha numeric characters
 
                                            //Validate TextBox value against the Regex.
                                    
                                    for(i=0;i<Object.keys(Fragment_Formulas).length;i++){
                                        current_formula=Fragment_Formulas[Object.keys(Fragment_Formulas)[i]]
                                        if(current_formula.length<1){
                                            FinalCheckisSuccess=false
                                        }
                                        
                                        isValid = regex.test(current_formula); //test to ensure only alpha numeric characters are included in current_formula
                                        if(isValid==false){
                                            FinalCheckisSuccess=false
                                        }
    
                                    }
                                    
                                    if(FinalCheckisSuccess){
                                        FileMIDs=returnFileMIDs(FileMIDs,rawFileCounts,Fragment_Formulas) //submits rawFileCounts to be corrected, outputs FileMIDs
                                        result={"FileMIDs":FileMIDs, "FileNames":FileNames}
                                        console.log(result)                                        
                                        document.getElementById("loading-background").style.display = "none";   
                                        add_structures(result); //AK: calls the add_structures() function which runs AK generated content (graph generation and manipulation)
                                    }else{
                                        alert("There was a problem reading your data. Please check __ and make sure you are following all of the requirements") //warning
                                        Uncorrected_CSV_Reset()                        
                                    }
                                    
                                }else{
                                    alert("Incorrect CSV Schema. Please make sure CSV follows the schema found at ____") //warning
                                    Uncorrected_CSV_Reset()                        

                                }

                          }
                          
                          user_file.readAsText(files.item(0)); //allows for the user_file to be read
                    }
                    else { //no
                        alert("Incorrect file type upload. Please upload a CSV file.") //warning
                        Uncorrected_CSV_Reset()                        
                    }
                }
            }              
            
        
         function Uncorrected_CSV_Reset(){
            document.getElementById("loading-background").style.display = "none";   
            document.getElementById("PopUp_Upload_Data").style.display = "block";   
            document.getElementById("enter_data").style.display = "block"; 
         }


         };  //closes import of MIDs document.getElementById('import_csv').onclick
               
       
       
       
        document.getElementById('import_corrected_csv').onclick = function() { //translates to "upon click of the button 'import_csv' execute the function below
            document.getElementById("PopUp_Upload_Data").style.display = "none";   
            document.getElementById("enter_data").style.display = "none";   

            document.getElementById("loading-background").style.display = "block";   
               
             
              var files = document.getElementById('select_corrected_Files_csv').files; //sets the var files equal to the user selected files
              if (files.length <= 0) { //check to ensure the user selected a file, if yes, then move on
                return false;
              }

              var user_file = new FileReader();
              user_file.onload = function(e) {
                    var csv_data = e.target.result; //AK: this is the magic line, var result holds the data from the users file
                    var parsed_Data=d3.csvParse(csv_data);
                    var FileMIDs={}
                    FileNames=[]
                    for(i=2;i<parsed_Data.columns.length;i++){ //currently i=3 due to presence of Metabolite, Fragment columns
                        FileNames.push(parsed_Data.columns[i])
                    } 
                    metab=""
                    frag=""
                    j=-1
                    iso=-1;//changed from 0 to -1
                    //plan, make shell by going through the first file, then copy the shell x(file number) times, then fill it  
                    for(i=0;i<parsed_Data.length;i++){ // this loo generates the shell
                        if(parsed_Data[i].Metabolite!=""){
                            metab=parsed_Data[i].Metabolite
                            frag=parsed_Data[i+1].Fragment //changed from i to i+1 because the row below will contain the fragment name
                            frag=frag.split('(M0)')[0] //removes (M0) from the fragment names                        
                            for(k=0;k<FileNames.length;k++){
                                
                                if(typeof FileMIDs["File"+(k+1).toString()]== 'undefined'){
                                    FileMIDs["File"+(k+1).toString()]={}
                                }
                                if(typeof FileMIDs["File"+(k+1).toString()][metab]== 'undefined'){
                                    FileMIDs["File"+(k+1).toString()][metab]={}
                                }
                                FileMIDs["File"+(k+1).toString()][metab][frag]={}
                                FileMIDs["File"+(k+1).toString()][metab][frag].abundance=0                                
                                FileMIDs["File"+(k+1).toString()][metab][frag].labeling=[]                                
                            }   
                        }
                    }

                    for(i=0;i<parsed_Data.length;i++){
                        if(parsed_Data[i].Metabolite!=""){ //if currently at a row of the csv where there is a metabolite name entered, then enter the count as M0
                            iso=-1;//changed from 0 to -1
                            metab=parsed_Data[i].Metabolite
                            frag=parsed_Data[i+1].Fragment //changed from i to i+1 because the row below will contain the fragment name
                            frag=frag.split('(M0)')[0] //removes (M0) from the fragment names                        
                            for(k=0;k<FileNames.length;k++){
                                FileMIDs["File"+(k+1).toString()][metab][frag].abundance=Number(parsed_Data[i][FileNames[k]])
                            }
                                
                        iso++                        
                        }else{
                            for(k=0;k<FileNames.length;k++){
                                FileMIDs["File"+(k+1).toString()][metab][frag].labeling[iso]={"fragment":"M"+iso.toString(),"frequency":Number(parsed_Data[i][FileNames[k]])}
                            }
                        iso++    
                       }
                    }  
                    result={"FileMIDs":FileMIDs, "FileNames":FileNames}
                    console.log(result)
                    document.getElementById("loading-background").style.display = "none";   
                    add_structures(result); //AK: calls the add_structures() function which runs AK generated content (graph generation and manipulation)

               } //closes user_file.onload = function(e)
              user_file.readAsText(files.item(0)); //allows for the user_file to be read

         };  //closes import of MIDs document.getElementById('import_csv').onclick
               
       
       
       
        $('#close_popup_upload_data').click( function() {
            document.getElementById("PopUp_Upload_Data").style.display = "none";   
        } );
 
    function dragstarted(d) {
      d3.select(this).raise().classed("active", true);
    }

    function dragged(d) {
    //function [d.x,d.y]=dragged(d) {
                d.x += d3.event.dx
                d.y += d3.event.dy
                d3.select(this).attr("transform", function(d,i){
                    return "translate(" + [ d.x,d.y ] + ")"
                    //return "translate(" +  d.x + "," + d.y  + ")"
                })
    }

    function dragended(d) {
      d3.select(this).classed("active", false);
    }          
        
        
       
  }); //closes d3.json()
      
      
      
  </script>
</html>      
      
 